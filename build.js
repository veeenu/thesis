(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({"/Volumes/Storage/andrea/web/thesis/src/Context.js":[function(require,module,exports){var canvas=document.getElementById("thesis-canvas"),gl=canvas.getContext("webgl"),bcr=canvas.getBoundingClientRect(),w=bcr.width,h=bcr.height;canvas.width=w;canvas.height=h;canvas.style.background="black";module.exports={canvas:canvas,gl:gl,w:w,h:h,aspectRatio:w/h}},{}],"/Volumes/Storage/andrea/web/thesis/src/Renderer.js":[function(require,module,exports){var Util=require("./lib/util.js"),glMatrix=require("gl-matrix"),vec3=glMatrix.vec3,mat3=glMatrix.mat3,mat4=glMatrix.mat4,Context=require("./Context"),gl=Context.gl,BuildingSHG=require("./generators/BuildingSHG.js");var programPass=gl.createProgram(),programLight=gl.createProgram(),vshPass=gl.createShader(gl.VERTEX_SHADER),fshPass=gl.createShader(gl.FRAGMENT_SHADER),vshLight=gl.createShader(gl.VERTEX_SHADER),fshLight=gl.createShader(gl.FRAGMENT_SHADER),extDrawbuffers,extDepthTexture,vsrcPass,vsrcLight,fsrcPass,fsrcLight;vsrcPass="uniform mat4 projection, viewmodel;\nuniform mat3 normalM;\n\nattribute vec3 vertex, normal, uv, extra;\n\nvarying vec4 vPosition;\nvarying vec3 texUV, vNormal, vExtra;\n\nvoid main() {\n  \n  vec4 viewPos = viewmodel * vec4(vertex, 1.);\n  gl_Position = projection * viewPos;\n\n  vPosition = viewPos;\n  vNormal = normalize(normalM * normal);\n  vExtra = extra;\n  texUV = uv;\n\n}\n\n";fsrcPass="#extension GL_OES_standard_derivatives : require\n#extension GL_EXT_draw_buffers : require\n\nprecision highp float;\n\nvarying vec4 vPosition;\nvarying vec3 texUV, vNormal, vExtra;\n\n////////////////////////////////////////////////////////////////////////////////\n// https://github.com/ashima/webgl-noise/blob/master/src/noise2D.glsl         //\n////////////////////////////////////////////////////////////////////////////////\n\nvec3 mod289(vec3 x) { return x - floor(x * (1.0 / 289.0)) * 289.0; }\nvec2 mod289(vec2 x) { return x - floor(x * (1.0 / 289.0)) * 289.0; }\nvec3 permute(vec3 x) { return mod289(((x*34.0)+1.0)*x); }\nfloat snoise(vec2 v) {\n  const vec4 C = vec4(0.211324865405187,  // (3.0-sqrt(3.0))/6.0\n                      0.366025403784439,  // 0.5*(sqrt(3.0)-1.0)\n                     -0.577350269189626,  // -1.0 + 2.0 * C.x\n                      0.024390243902439); // 1.0 / 41.0\n  vec2 i  = floor(v + dot(v, C.yy) );\n  vec2 x0 = v -   i + dot(i, C.xx);\n  vec2 i1;\n  i1 = (x0.x > x0.y) ? vec2(1.0, 0.0) : vec2(0.0, 1.0);\n  vec4 x12 = x0.xyxy + C.xxzz;\n  x12.xy -= i1;\n  i = mod289(i);\n  vec3 p = permute( permute( i.y + vec3(0.0, i1.y, 1.0 ))\n		+ i.x + vec3(0.0, i1.x, 1.0 ));\n  vec3 m = max(0.5 - vec3(dot(x0,x0), dot(x12.xy,x12.xy), dot(x12.zw,x12.zw)), 0.0);\n  m = m*m ;\n  m = m*m ;\n  vec3 x = 2.0 * fract(p * C.www) - 1.0;\n  vec3 h = abs(x) - 0.5;\n  vec3 ox = floor(x + 0.5);\n  vec3 a0 = x - ox;\n  m *= 1.79284291400159 - 0.85373472095314 * ( a0*a0 + h*h );\n  vec3 g;\n  g.x  = a0.x  * x0.x  + h.x  * x0.y;\n  g.yz = a0.yz * x12.xz + h.yz * x12.yw;\n  return 130.0 * dot(m, g);\n}\n\n////////////////////////////////////////////////////////////////////////////////\n// Procedural textures\n////////////////////////////////////////////////////////////////////////////////\n\nvec3 bumpMap(vec3 fvert, vec3 fnorm, float bump) {\n\n  vec3 bU = dFdx(bump) * cross(fnorm, normalize(dFdy(fvert))),\n       bV = dFdy(bump) * cross(normalize(dFdx(fvert)), fnorm),\n       bD = fnorm + (bU + bV) * .5;\n\n  return normalize(bD);\n}\n\nstruct TTextureInfo {\n  vec3 color;\n  vec3 normal;\n};\n\n#define textureBrickI(x, p, notp) ((floor(x)*(p))+max(fract(x)-(notp), 0.0))\nTTextureInfo textureBrick(vec3 fvert, vec3 fnorm, float fdepth, vec2 uv, vec3 brickColor) {\n\n  const float bW  = .125,\n              bH  = .0625,\n              mS  = 1. / 128.,\n              mWf = mS * .5 / bW,\n              mHf = mS * .5 / bH;\n  const vec3 mortarColor = vec3(.9, .9, .9);\n\n  float u = uv.s / bW,\n        v = uv.t / bH,\n        brU = floor(u),\n        brV = floor(v);\n\n  if(mod(v * .5, 1.) > .5)\n    u += .5;\n  brU = floor(u);\n\n  float noisev = 1. +\n                 //snoise(uv * 16.) * .0625 +\n                 snoise(uv * 64.) * .125;\n  float brickDamp = 1. + .125 * sin(1.57 * (brU + 1.)) * sin(2. * (brV + 1.));\n\n  vec2 uuv = vec2(u, v),\n       fw = 2. * vec2(fwidth(uuv.x), fwidth(uuv.y)),\n       mortarPct = vec2(mWf, mHf),\n       brickPct = vec2(1., 1.) - mortarPct,\n       ub = (textureBrickI(uuv + fw, brickPct, mortarPct) -\n             textureBrickI(uuv, brickPct, mortarPct)) / fw;\n\n  vec3 color = mix(mortarColor, brickColor * brickDamp, ub.x * ub.y);\n\n  float bump = noisev / fdepth + 4. * ((ub.x * ub.y) - dFdx(ub.x) * dFdy(ub.y));\n\n  return TTextureInfo(\n    color,\n    bumpMap(fvert, fnorm, bump)\n  );\n}\n\n/******************************************************************************\\\n * Window texture\n\\******************************************************************************/\n\nTTextureInfo textureWindow(vec3 fvert, vec3 fnorm, float fdepth, vec2 uv, vec3 windowColor) {\n\n  const vec2 patternPct   = vec2(1., 1.),\n             patternStart = vec2(0., 0.), //(1. - patternPct) * .25,\n             patternEnd   = patternStart + patternPct,\n             framePct     = vec2(1. / 32., 1. / 32.),\n             frameStart   = patternStart + framePct,\n             frameEnd     = patternEnd   - framePct;\n  //const vec3 windowColor  = vec3(.8, .94, .99),\n  const vec3 frameColor   = vec3(.5, .5, .5);\n\n  vec2 fk   = fwidth(uv) * 2.,\n       uuv  = mod(uv, .5 - 1. / 64.),\n       patF = (smoothstep(frameEnd, frameEnd + fk, uuv) - smoothstep(frameStart, frameStart + fk, uuv));\n  float noisep = 1. + \n                snoise(-uv * .5) * .25;\n  float noisev = 1. + \n                 snoise(uv * 16.) * .0625 +\n                 abs(snoise(uv * 512.)) * .0625;\n\n  return TTextureInfo(\n    mix(frameColor, windowColor * noisep, patF.x * patF.y),\n    bumpMap(fvert, fnorm, patF.x * patF.y)\n  );\n}\n\n/******************************************************************************\\\n * Road texture\n\\******************************************************************************/\n\nvec3 textureRoad(vec2 uuv) {\n  const float padding = 1. / 32.,\n              tapeW   = 1. / 32.,\n              tapeL0  = padding,\n              tapeL1  = padding + tapeW,\n              tapeR1  = 1. - tapeL0,\n              tapeR0  = 1. - tapeL1,\n              tapeC0  = .5 - tapeW * .5,\n              tapeC1  = .5 + tapeW * .5,\n              vertDiv = 4.;\n  const vec3 asphaltColor = vec3(.2, .2, .2),\n             stripColor = vec3(.8, .8, .8);\n\n  vec2 uv = uuv + vec2(0, .5), fk = fwidth(uv);\n  float csSpacing = mod(.25 + uv.t * vertDiv, 1.),\n        q = \n    (\n      smoothstep(tapeL0, tapeL0 + fk.x, uv.s) - \n      smoothstep(tapeL1, tapeL1 + fk.x, uv.s)\n    ) +\n    (\n      smoothstep(tapeR0, tapeR0 + fk.x, uv.s) - \n      smoothstep(tapeR1, tapeR1 + fk.x, uv.s)\n    ) +\n    (\n      smoothstep(tapeC0, tapeC0 + fk.x, uv.s) - \n      smoothstep(tapeC1, tapeC1 + fk.x, uv.s)\n    ) * \n    (\n      smoothstep(.5 - fk.y, .5 + fk.y, csSpacing) *\n      (1. - smoothstep(1. - 2. * fk.y, 1., csSpacing))\n    )\n    ;\n\n  float noiseA = 1. +\n                 abs(snoise(uv * 16.))  * .0625 +\n                 abs(snoise(uv * 32.))  * .0625 +\n                 abs(snoise(uv * 128.)) * .125,\n        noiseS = 1. + \n                 abs(snoise(uv * 128.)) * .125;\n\n  return mix(asphaltColor * noiseA, stripColor * noiseS, q);\n}\n\nvec3 textureAsphalt(vec2 uuv) {\n  const vec3 asphaltColor = vec3(.2, .2, .2);\n\n  vec2 uv = uuv + vec2(0, .5);\n  float noiseA = 1. +\n                 abs(snoise(uv * 16.))  * .0625 +\n                 abs(snoise(uv * 32.))  * .0625 +\n                 abs(snoise(uv * 128.)) * .125;\n  return asphaltColor * 1.5 * noiseA;\n}\n////////////////////////////////////////////////////////////////////////////////\n\nvoid main() {\n\n  TTextureInfo ti; // = textureBrick(vPosition.xyz, vNormal.xyz, vNormal.w, texUV.st, vExtra.xyz);\n  vec3 color, normal;\n\n  float depth = gl_FragCoord.z / gl_FragCoord.w;\n\n  normal = normalize(faceforward(vNormal, gl_FragCoord.xyz, vNormal));\n\n  if(texUV.z > 5.1) {\n    ti = textureBrick(vPosition.xyz, vNormal, gl_FragCoord.z, mod(texUV.xy, 1.), vExtra);\n    color = ti.color;\n    normal = ti.normal;\n  }\n  else if(texUV.z > 4.1) {\n    ti = textureWindow(vPosition.xyz, vNormal, gl_FragCoord.z, mod(texUV.yx, 1.), vec3(1., 1., .7));\n    color = ti.color;\n    normal = ti.normal;\n  }\n  else if(texUV.z > 3.1) {\n    ti = textureWindow(vPosition.xyz, vNormal, gl_FragCoord.z, mod(texUV.yx, 1.), vec3(.3, .3, .3));\n    color = ti.color;\n    normal = ti.normal;\n  }\n  else if(texUV.z > 2.1)\n    color = textureAsphalt(mod(texUV.yx, 1.));\n  else if(texUV.z > 1.1)\n    color = textureRoad(mod(texUV.xy, 1.));\n  else\n    color = textureAsphalt(mod(texUV.yx, 1.)); //textureWindow(uuv, fextra);\n\n  gl_FragData[0] = vPosition;\n  gl_FragData[1] = vec4(normal, depth);\n  gl_FragData[2] = vec4(color, 1.);\n}\n";vsrcLight="uniform mat4 viewMatrix;\nuniform vec3 lightPos;\n\nattribute vec2 position;\n//attribute vec3 lightPosition;\nvarying vec2 coord;\n\nvarying vec3 lPos;\n\nvoid main() {\n  gl_Position = vec4(position, 0., 1.);\n  coord = .5 + .5 * position;\n  lPos = vec3(0., 0., 0.); //(viewMatrix * vec4(lightPos, 1.)).xyz;\n  //lPos = (viewMatrix * vec4(lightPos, 1.)).xyz;\n}\n";fsrcLight="#extension GL_OES_standard_derivatives : enable\nprecision highp float;\n\n/* #pragma glslify: fxaa = require(glsl-fxaa) */\n\nuniform sampler2D target0, target1, target2, depthBuffer, randMap;\nuniform mat4 viewMatrix;\nuniform vec3 lightPos;\n\nvarying vec2 coord;\nvarying vec3 lPos;\n\n//uniform vec3 lightPos;\n\nfloat sample(vec3 p, vec3 n, vec2 uv) {\n  vec3 dstP = texture2D(target0, uv).xyz,\n       posV = dstP - p;\n\n  float intens = max(dot(normalize(posV), n) - .05, 0.),\n        dist = length(posV),\n        att  = 1. / (2. + (5. * dist));\n  return intens * att;\n}\n\nhighp float rand(vec2 co)\n{\n    highp float a = 12.9898;\n    highp float b = 78.233;\n    highp float c = 43758.5453;\n    highp float dt= dot(co.xy ,vec2(a,b));\n    highp float sn= mod(dt,3.14);\n    return fract(sin(sn) * c);\n}\n\n\n////////////////////////////////////////////////////////////////////////////////\n// Main\n////////////////////////////////////////////////////////////////////////////////\n\n\nvoid main() {\n  /*vec3 lights[4];\n  lights[0] = vec3(6. - .025, .2, 6. - .025);\n  lights[1] = vec3(6. - .025, .2, 6. + .025);\n  lights[2] = vec3(6. + .025, .2, 6. + .025);\n  lights[3] = vec3(6. + .025, .2, 6. - .025);*/\n  /*vec4 t0 = fxaa(target0, coord, res),\n       t1 = fxaa(target1, coord, res),\n       t2 = fxaa(target2, coord, res);*/\n  /*vec2 fw = .5 * fwidth(coord),\n       nfw = vec2(fw.x, -fw.y),\n       c0 = coord - fw,\n       c1 = coord + fw,\n       c2 = coord - nfw,\n       c3 = coord + nfw;*/\n\n  vec4 t0 = texture2D(target0, coord),\n       t1 = texture2D(target1, coord),\n       /*t1 = mix( mix(texture2D(target1, c0), texture2D(target1, c1), .5), \n                 mix(texture2D(target1, c2), texture2D(target1, c3), .5), \n                 .5),*/\n       t2 = texture2D(target2, coord);\n\n  vec3  vertex = t0.xyz,\n        normal = normalize(t1.xyz),\n        color  = t2.xyz;\n  float depth  = t1.w;\n\n\n\n  vec3 lightDir = lPos - vertex;\n  float lambert = max(dot(faceforward(-normal, lightDir, normal), normalize(lightDir)), 0.),\n        dist = length(lightDir),\n        att = min(1., 1. / (1. + 2.5 * dist + 5. * dist * dist));\n\n  /*float lambert = 0., att = 1.;\n  for(int i = 0; i < 4; i++) {\n    vec3 lightDir = (viewMatrix * vec4(lights[i], 1.)).xyz - vertex;\n    float llambert = max(dot(faceforward(-normal, lightDir, normal), normalize(lightDir)), 0.),\n          dist = length(lightDir),\n          latt = min(1., 1. / (1. + .5 * dist + 5. * dist * dist));\n    lambert += llambert * latt * .25;\n  }*/\n\n  //////////////////////////////////////////////////////////////////////////////\n  // SSAO\n  //////////////////////////////////////////////////////////////////////////////\n  vec2 kernel[4];\n  kernel[0] = vec2(0., 1.);\n  kernel[1] = vec2(1., 0.);\n  kernel[2] = vec2(0., -1.);\n  kernel[3] = vec2(-1., 0.);\n\n  const float sin45 = .707107, sRad = 80.;\n\n  float occlusion = 0., kRad = sRad * (1. - depth);\n\n  for(int i = 0; i < 4; ++i) {\n    vec2 k1 = reflect(kernel[i], .6 * vec2(rand(sin(coord)), rand(-coord)));\n    vec2 k2 = vec2(k1.x * sin45 - k1.y * sin45,\n                   k1.x * sin45 + k1.y * sin45);\n    occlusion += sample(vertex, normal, coord + k1 * kRad);\n    occlusion += sample(vertex, normal, coord + k1 * kRad * .75);\n    occlusion += sample(vertex, normal, coord + k1 * kRad * .5);\n    occlusion += sample(vertex, normal, coord + k1 * kRad * .25);\n  }\n  occlusion /= 16.;\n  occlusion = clamp(occlusion, 0., 1.);\n\n  color = clamp(color - occlusion, 0., 1.);\n  gl_FragColor = vec4(lambert * att * 2. * color, 1.);\n  //gl_FragColor = vec4(color, 1.);\n}\n";gl.clearColor(0,0,0,0);gl.depthFunc(gl.LESS);gl.getExtension("OES_standard_derivatives");gl.getExtension("OES_texture_float");gl.getExtension("OES_texture_float_linear");extDrawbuffers=gl.getExtension("WEBGL_draw_buffers");extDepthTexture=gl.getExtension("WEBGL_depth_texture");gl.shaderSource(vshPass,vsrcPass);gl.shaderSource(fshPass,fsrcPass);gl.compileShader(vshPass);gl.compileShader(fshPass);gl.attachShader(programPass,vshPass);gl.attachShader(programPass,fshPass);gl.linkProgram(programPass);gl.shaderSource(vshLight,vsrcLight);gl.shaderSource(fshLight,fsrcLight);gl.compileShader(vshLight);gl.compileShader(fshLight);gl.attachShader(programLight,vshLight);gl.attachShader(programLight,fshLight);gl.linkProgram(programLight);console.log("VP:",gl.getShaderInfoLog(vshPass),"FP:",gl.getShaderInfoLog(fshPass),"VL:",gl.getShaderInfoLog(vshLight),"FL:",gl.getShaderInfoLog(fshLight));var target0=gl.createTexture(),target1=gl.createTexture(),target2=gl.createTexture(),depthTex=gl.createTexture(),framebuffer=gl.createFramebuffer(),drawbuffers;gl.bindTexture(gl.TEXTURE_2D,depthTex);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);gl.texImage2D(gl.TEXTURE_2D,0,gl.DEPTH_COMPONENT,Context.w,Context.h,0,gl.DEPTH_COMPONENT,gl.UNSIGNED_SHORT,null);[target0,target1,target2].forEach(function(target){gl.bindTexture(gl.TEXTURE_2D,target);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,Context.w,Context.h,0,gl.RGBA,gl.FLOAT,null)});gl.bindTexture(gl.TEXTURE_2D,null);gl.bindFramebuffer(gl.FRAMEBUFFER,framebuffer);try{drawbuffers=[extDrawbuffers.COLOR_ATTACHMENT0_WEBGL,extDrawbuffers.COLOR_ATTACHMENT1_WEBGL,extDrawbuffers.COLOR_ATTACHMENT2_WEBGL];extDrawbuffers.drawBuffersWEBGL(drawbuffers);gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.TEXTURE_2D,depthTex,0);gl.framebufferTexture2D(gl.FRAMEBUFFER,drawbuffers[0],gl.TEXTURE_2D,target0,0);gl.framebufferTexture2D(gl.FRAMEBUFFER,drawbuffers[1],gl.TEXTURE_2D,target1,0);gl.framebufferTexture2D(gl.FRAMEBUFFER,drawbuffers[2],gl.TEXTURE_2D,target2,0)}catch(e){}gl.bindFramebuffer(gl.FRAMEBUFFER,null);var quadBuf=gl.createBuffer(),lightBuf=gl.createBuffer(),quadArr=[],projection=mat4.create();for(var i=0;i<128;i++){quadArr.push(1,-1,-1,-1,-1,1,1,-1,-1,1,1,1)}gl.bindBuffer(gl.ARRAY_BUFFER,quadBuf);gl.bufferData(gl.ARRAY_BUFFER,new Float32Array([1,-1,-1,-1,-1,1,1,-1,-1,1,1,1]),gl.STATIC_DRAW);gl.bindBuffer(gl.ARRAY_BUFFER,null);mat4.perspective(projection,Math.PI/2,Context.aspectRatio,.001,1e3);["vertex","normal","uv","extra"].forEach(function(i){programPass[i]=gl.getAttribLocation(programPass,i)});["projection","viewmodel","normalM"].forEach(function(i){programPass[i]=gl.getUniformLocation(programPass,i)});["position","lightPosition"].forEach(function(i){programLight[i]=gl.getAttribLocation(programLight,i)});["target0","target1","target2","depthBuffer","viewMatrix","lightPos"].forEach(function(i){programLight[i]=gl.getUniformLocation(programLight,i)});programPass.activate=function(scene){gl.useProgram(programPass);gl.bindFramebuffer(gl.FRAMEBUFFER,framebuffer);gl.enable(gl.DEPTH_TEST);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);var viewmodel=mat4.create(),normalM=mat3.create();mat4.mul(viewmodel,scene.view,scene.model);mat3.normalFromMat4(normalM,viewmodel);gl.uniformMatrix4fv(programPass.projection,false,projection);gl.uniformMatrix4fv(programPass.viewmodel,false,viewmodel);gl.uniformMatrix3fv(programPass.normalM,false,normalM);gl.enableVertexAttribArray(programPass.vertex);gl.enableVertexAttribArray(programPass.normal);gl.enableVertexAttribArray(programPass.uv);gl.enableVertexAttribArray(programPass.extra);scene.meshes.forEach(function(mesh){gl.bindBuffer(gl.ARRAY_BUFFER,mesh.vBuf);gl.vertexAttribPointer(programPass.vertex,3,gl.FLOAT,false,0,0);gl.bindBuffer(gl.ARRAY_BUFFER,mesh.nBuf);gl.vertexAttribPointer(programPass.normal,3,gl.FLOAT,false,0,0);gl.bindBuffer(gl.ARRAY_BUFFER,mesh.uBuf);gl.vertexAttribPointer(programPass.uv,3,gl.FLOAT,false,0,0);gl.bindBuffer(gl.ARRAY_BUFFER,mesh.eBuf);gl.vertexAttribPointer(programPass.extra,3,gl.FLOAT,false,0,0);gl.drawArrays(gl.TRIANGLES,0,mesh.count)});gl.bindBuffer(gl.ARRAY_BUFFER,null)};var sc=function(lights){console.log(lights)};programPass.deactivate=function(){gl.bindFramebuffer(gl.FRAMEBUFFER,null);gl.disableVertexAttribArray(programPass.vertex);gl.disableVertexAttribArray(programPass.normal);gl.disableVertexAttribArray(programPass.uv);gl.disableVertexAttribArray(programPass.extra);gl.disable(gl.DEPTH_TEST)};var __do=false,cnt=0;programLight.activate=function(scene){gl.useProgram(programLight);gl.enable(gl.BLEND);gl.blendFunc(gl.ONE,gl.ONE);gl.clear(gl.COLOR_BUFFER_BIT);gl.activeTexture(gl.TEXTURE0);gl.bindTexture(gl.TEXTURE_2D,target0);gl.activeTexture(gl.TEXTURE1);gl.bindTexture(gl.TEXTURE_2D,target1);gl.activeTexture(gl.TEXTURE2);gl.bindTexture(gl.TEXTURE_2D,target2);gl.activeTexture(gl.TEXTURE3);gl.bindTexture(gl.TEXTURE_2D,depthTex);gl.bindBuffer(gl.ARRAY_BUFFER,quadBuf);gl.vertexAttribPointer(programLight.position,2,gl.FLOAT,false,0,0);gl.uniform1i(programLight.target0,0);gl.uniform1i(programLight.target1,1);gl.uniform1i(programLight.target2,2);gl.uniform1i(programLight.depthBuffer,3);gl.uniformMatrix4fv(programLight.viewMatrix,false,scene.view);gl.enableVertexAttribArray(programLight.position);gl.uniform3fv(programLight.lightPos,scene.lightPos);gl.drawArrays(gl.TRIANGLES,0,6)};programLight.deactivate=function(){gl.disableVertexAttribArray(programLight.position);gl.disable(gl.BLEND)};module.exports={render:function(scene){programPass.activate(scene);programPass.deactivate();programLight.activate(scene);programLight.deactivate()}}},{"./Context":"/Volumes/Storage/andrea/web/thesis/src/Context.js","./generators/BuildingSHG.js":"/Volumes/Storage/andrea/web/thesis/src/generators/BuildingSHG.js","./lib/util.js":"/Volumes/Storage/andrea/web/thesis/src/lib/util.js","gl-matrix":"/Volumes/Storage/andrea/web/thesis/src/node_modules/gl-matrix/dist/gl-matrix.js"}],"/Volumes/Storage/andrea/web/thesis/src/generators/Block.js":[function(require,module,exports){var PRNG=require("./PRNG"),Geom=require("./../lib/Geom"),ShapeGrammar=require("./../lib/ShapeGrammar");var lerp=function(a,b,t){return(1-t)*a+t*b};var subdivideStrip=function(block,strip,rng){var points=[],quads=[],angles=[],i1,i2,i3,b1,b2,dx,dy,i,j,m,n,p,len,lots=[];for(i=0,n=block.length;i<n;i++){i1=(i+1)%n;i2=(i+2)%n;i3=(i-1+n)%n;b1=Geom.lineIntersection(block[i],block[i1],strip[i3],strip[i]);b2=Geom.lineIntersection(block[i],block[i1],strip[i1],strip[i2]);dx=b1.x-b2.x;dy=b1.y-b2.y;len=Math.sqrt(dx*dx+dy*dy);ang=Math.atan2(dy,dx);m=~~(rng.random()*3+2);quads.push(m);angles.push(ang);for(j=0;j<m;j++){var jm=j/(m-1);px1=lerp(b1.x,b2.x,jm);py1=lerp(b1.y,b2.y,jm);px2=lerp(strip[i].x,strip[i1].x,jm);py2=lerp(strip[i].y,strip[i1].y,jm);points.push({x:lerp(b1.x,b2.x,jm),y:lerp(b1.y,b2.y,jm)},{x:lerp(strip[i].x,strip[i1].x,jm),y:lerp(strip[i].y,strip[i1].y,jm)})}}points.push(points[0]);for(i=0,n=block.length;i<n;i++){p=[];for(j=0;j<quads[i];j++){p.push(points.shift());p.push(points.shift())}p.push(block[(i+1)%n]);p.push(points[0]||block[0]);for(var k=0,m=p.length;k<m-2;k+=2){lots.push(new Building([p[k],p[(k+1)%m],p[(k+3)%m],p[(k+2)%m]],rng.random()+.5,angles[i]))}}return lots};var Building=function(poly,height,angle){this.poly=poly;this.height=height;this.angle=angle};var Block=function(poly,seed){var rng=new PRNG(seed);this.poly=poly;this.block=Geom.insetPolygon(this.poly,.05);this.lots=subdivideStrip(Geom.insetPolygon(this.block,.1),Geom.insetPolygon(this.block,.4),rng);var cd=poly.reduce(function(o,i){o.cx+=i.x;o.cy+=i.y;if(o.xm>i.x)o.xm=i.x;if(o.xM<i.x)o.xM=i.x;if(o.ym>i.y)o.ym=i.y;if(o.yM<i.y)o.yM=i.y;return o},{xm:Number.POSITIVE_INFINITY,ym:Number.POSITIVE_INFINITY,xM:Number.NEGATIVE_INFINITY,yM:Number.NEGATIVE_INFINITY,cx:0,cy:0});this.x=cd.cx/poly.length;this.y=cd.cy/poly.length;this.w=Math.max(Math.abs(cd.xM-cd.xm),Math.abs(cd.yM-cd.ym))};module.exports=Block},{"./../lib/Geom":"/Volumes/Storage/andrea/web/thesis/src/lib/Geom.js","./../lib/ShapeGrammar":"/Volumes/Storage/andrea/web/thesis/src/lib/ShapeGrammar.js","./PRNG":"/Volumes/Storage/andrea/web/thesis/src/generators/PRNG.js"}],"/Volumes/Storage/andrea/web/thesis/src/generators/BuildingSHG.js":[function(require,module,exports){var ShapeGrammar=require("./../lib/ShapeGrammar"),SHAPE=require("../lib/SHAPE.js"),earcut=require("earcut"),Geom=require("./../lib/Geom"),PRNG=require("./PRNG");var shg=new ShapeGrammar,litWindowsRNG=new PRNG(31337),buildingSidesRNG=new PRNG(31338),buildingLayoutRNG=new PRNG(31339),rng=new PRNG(31337);shg.define("Building",null,function(){var ret=[],curHeight=0;for(var i=0,I=this.floorsLayout.length;i<I;i++){var fli=this.floorsLayout[i],floor={sym:fli.type,height:fli.height,params:fli,points:this.points.map(function(i){return{x:i.x,y:i.y+curHeight,z:i.z}})};curHeight+=fli.height;ret.push(floor)}return ret});shg.define("FL_GndFloor",null,function(){var p2=Math.PI*2,p4=2*p2,fixTH=function(th){return(th+p4)%p2};return function(){var facades=SHAPE.extrudeAll(this.points,this.height,"Facade",[0,1,0]),th=this.params.frontSide;switch(this.params.tiles){case"OneDoor":var doorf=0,minAD=Number.POSITIVE_INFINITY;for(var i=0,I=facades.length;i<I;i++){var fi=facades[i],x0=fi.points[0].x,z0=fi.points[0].z,x1=fi.points[3].x,z1=fi.points[3].z,ad=Math.abs(Math.atan2(z1-z0,x1-x0)-th);fi.type="Windows";if(ad<minAD){minAD=ad;doorf=i}}facades[doorf].type="OneDoor";break}return facades}}());shg.define("FL_Floor",null,function(){var facades=SHAPE.extrudeAll(this.points,this.height,"Facade",[0,1,0]);for(var i=0,I=facades.length;i<I;i++){facades[i].type="Windows";facades[i].windows=this.params.windows}return facades});shg.define("FL_Ledge",null,function(){var extrPoints=[],h=this.height;for(var i=0,I=this.points.length;i<I;i++){var p0=this.points[i],p1=this.points[(i+1)%I],angle=Math.atan2(p1.z-p0.z,p1.x-p0.x),anglep=angle-Math.PI/2,cos=Math.cos(angle)+Math.cos(anglep),sin=Math.sin(angle)+Math.sin(anglep);extrPoints.push({x:p0.x-this.params.width*cos,y:p0.y,z:p0.z-this.params.width*sin})}var facades=SHAPE.extrudeAll(extrPoints,this.height,"Quad",[0,1,0]);facades.forEach(function(i){var dx=i.points[3].x-i.points[0].x,dy=i.points[1].y-i.points[0].y,dz=i.points[3].z-i.points[0].z;var t=h/shg.UVSCALE,s=t*Math.sqrt(dx*dx+dz*dz)/dy;i.uvs=[{s:0,t:t},{s:0,t:0},{s:s,t:0},{s:s,t:t}];i.texID=6});facades.push({sym:"Poly",texID:6,points:extrPoints});facades.push({sym:"Poly",texID:6,points:extrPoints.map(function(i){return{x:i.x,y:i.y+h,z:i.z}})});return facades});shg.define("FL_Rooftop",null,function(){var extrPoints=[],h=this.height;for(var i=0,I=this.points.length;i<I;i++){var p0=this.points[i],p1=this.points[(i+1)%I],angle=Math.atan2(p1.z-p0.z,p1.x-p0.x),anglep=angle-Math.PI/2,cos=Math.cos(angle)+Math.cos(anglep),sin=Math.sin(angle)+Math.sin(anglep);extrPoints.push({x:p0.x+this.params.width*cos,y:p0.y,z:p0.z+this.params.width*sin})}var facadesOut=SHAPE.extrudeAll(this.points,this.height,"Quad",[0,1,0]),facadesIn=SHAPE.extrudeAll(extrPoints,this.height,"Quad",[0,1,0]);while(facadesOut.length)facadesIn.push(facadesOut.shift());facadesIn.forEach(function(i){var dx=i.points[3].x-i.points[0].x,dy=i.points[1].y-i.points[0].y,dz=i.points[3].z-i.points[0].z;var t=h/shg.UVSCALE,s=t*Math.sqrt(dx*dx+dz*dz)/dy;i.uvs=[{s:0,t:t},{s:0,t:0},{s:s,t:0},{s:s,t:t}];i.texID=6});facadesIn.push({sym:"Poly",points:extrPoints,texID:3});for(var i=0,I=extrPoints.length;i<I;i++){var ii=(i+1)%I,p0=this.points[i],p1=extrPoints[i],p2=extrPoints[ii],p3=this.points[ii];var poly={sym:"Poly",points:[p0,p1,p2,p0,p2,p3].map(function(i){return{x:i.x,y:i.y+h,z:i.z}}),texID:6};facadesIn.push(poly)}return facadesIn});shg.define("Facade",function(){return this.type==="OneDoor"},function(){var dx=this.points[3].x-this.points[0].x,dy=this.points[1].y-this.points[0].y,dz=this.points[3].z-this.points[0].z,t=dy/shg.UVSCALE,s=t*Math.sqrt(dx*dx+dz*dz)/dy;this.uvs=[{s:0,t:t},{s:0,t:0},{s:s,t:0},{s:s,t:t}];var quads=SHAPE.fit("x",this,"Window",1);quads[~~(quads.length/2)].sym="Door";for(var i=0,I=quads.length;i<I;i++)quads[i].normal=this.normal;return quads});shg.define("Facade",null,function(){var dx=this.points[3].x-this.points[0].x,dy=this.points[1].y-this.points[0].y,dz=this.points[3].z-this.points[0].z,t=dy/shg.UVSCALE,s=t*Math.sqrt(dx*dx+dz*dz)/dy;this.uvs=[{s:0,t:t},{s:0,t:0},{s:s,t:0},{s:s,t:t}];var quads=SHAPE.fit("x",this,"Window",1);for(var i=0,I=quads.length;i<I;i++)quads[i].normal=this.normal;return quads});shg.define("Window",null,function(){var hsp=SHAPE.split(this,[.3,.4,.3],[1],"Quad"),vsp=SHAPE.split(hsp[1],[1],[.15,.7,.15],"Quad"),windowPane=vsp[1];var wpuvs=windowPane.uvs;windowPane.uvs=null;windowPane.texID=litWindowsRNG.random()>.3?4:5;hsp[0].texID=hsp[2].texID=vsp[0].texID=vsp[2].texID=6;var ret=[hsp[0],hsp[2],vsp[0],vsp[2]];var norm=Geom.triToNormal([windowPane.points[0].x,windowPane.points[0].y,windowPane.points[0].z,windowPane.points[1].x,windowPane.points[1].y,windowPane.points[1].z,windowPane.points[2].x,windowPane.points[2].y,windowPane.points[2].z]);var borders=SHAPE.extrudeAll(windowPane.points,-.005,"Quad",norm);var nX=norm[0],nY=norm[1],nZ=norm[2];nX*=.005;nY*=.005;nZ*=.005;for(var i=0,I=windowPane.points.length;i<I;i++){var p=windowPane.points[i];p.x-=nX;p.y-=nY;p.z-=nZ}for(var i=0,I=borders.length;i<I;i++){borders[i].texID=3;ret.push(borders[i])}ret.push(windowPane);return ret});shg.define("Door",null,function(){var hsp=SHAPE.split(this,[.15,.7,.15],[1],"Quad"),vsp=SHAPE.split(hsp[1],[1],[.7,.3],"Quad"),windowPane=vsp[0];var wpuvs=windowPane.uvs;windowPane.uvs=null;windowPane.texID=litWindowsRNG.random()>.3?4:5;hsp[0].texID=hsp[2].texID=vsp[1].texID=6;var ret=[hsp[0],hsp[2],vsp[1]];var norm=Geom.triToNormal([windowPane.points[0].x,windowPane.points[0].y,windowPane.points[0].z,windowPane.points[1].x,windowPane.points[1].y,windowPane.points[1].z,windowPane.points[2].x,windowPane.points[2].y,windowPane.points[2].z]);var borders=SHAPE.extrudeAll(windowPane.points,-.005,"Quad",norm);var nX=norm[0],nY=norm[1],nZ=norm[2];nX*=.005;nY*=.005;nZ*=.005;for(var i=0,I=windowPane.points.length;i<I;i++){var p=windowPane.points[i];p.x-=nX;p.y-=nY;p.z-=nZ}for(var i=0,I=borders.length;i<I;i++){borders[i].texID=3;ret.push(borders[i])}ret.push(windowPane);return ret});shg.define("Quad",null,function(){var defaultUVS=[{s:0,t:1},{s:0,t:0},{s:1,t:0},{s:1,t:1}];return function(){var vertices,normals=[],uvs,normal,texID,u0,u1,u2,u3,p0,p1,p2,p3,ps=this.points;p0=ps[0],p1=ps[1],p2=ps[2],p3=ps[3];vertices=[p0.x,p0.y,p0.z,p1.x,p1.y,p1.z,p2.x,p2.y,p2.z,p0.x,p0.y,p0.z,p2.x,p2.y,p2.z,p3.x,p3.y,p3.z];normal=this.normal||Geom.triToNormal(vertices);for(var i=0;i<6;i++)normals.push(normal[0],normal[1],normal[2]);uvs=this.uvs||defaultUVS;u0=uvs[0],u1=uvs[1],u2=uvs[2],u3=uvs[3];texID=this.texID||0;uvs=[u0.s,u0.t,texID,u1.s,u1.t,texID,u2.s,u2.t,texID,u0.s,u0.t,texID,u2.s,u2.t,texID,u3.s,u3.t,texID];return{sym:ShapeGrammar.TERMINAL,vertices:vertices,normals:normals,uvs:uvs}}}());shg.define("Poly",null,function(){var rings=this.points.map(function(i){return[i.x,i.z]}),y=this.points[0].y;var triverts=earcut([rings]),vertices=triverts.reduce(function(o,i){o.push(i[0],y,i[1]);return o},[]),normal=this.normal||Geom.triToNormal(vertices),normals=[],uvs=[];var minX,minZ,maxX,maxZ,dx,dz,p;minX=minZ=Number.POSITIVE_INFINITY;maxX=maxZ=Number.NEGATIVE_INFINITY;for(var i=0,I=this.points.length;i<I;i++){p=this.points[i];if(minX>p.x)minX=p.x;if(maxX<p.x)maxX=p.x;if(minZ>p.z)minZ=p.z;if(maxZ<p.z)maxZ=p.z}dx=maxX-minX;dz=maxZ-minZ;for(var i=0,I=vertices.length;i<I;i+=3){var x=vertices[i],z=vertices[i+2];uvs.push((x-minX)/dx,(z-minZ)/dz,this.texID);normals.push(normal[0],normal[1],normal[2])}return{sym:ShapeGrammar.TERMINAL,vertices:vertices,normals:normals,uvs:uvs}});var availColors=[[.88,.88,.88],[.66,.66,.66],[1,.97,.83],[.68,.53,.46]];shg.UVSCALE=.1;module.exports={shg:shg,create:function(lot){var dx=lot.width/2,dy=lot.depth/2,x0=lot.x-dx,x1=lot.x+dx,y0=lot.y-dy,y1=lot.y+dy,ratio=Math.max(dx/dy,dy/dx);var pts=[];if(ratio<1.3&&buildingSidesRNG.random()<.5){for(var i=0;i<8;i++)pts.push({x:lot.x+dx*Math.cos(-i*Math.PI/4),y:0,z:lot.y+dy*Math.sin(-i*Math.PI/4)})}else{pts.push({x:x0,y:0,z:y0},{x:x0,y:0,z:y1},{x:x1,y:0,z:y1},{x:x1,y:0,z:y0})}var floorLayout=[],flId=~~(buildingLayoutRNG.random()*2);switch(flId){case 0:floorLayout.push({type:"FL_GndFloor",height:.1,tiles:"OneDoor",frontSide:lot.angle},{type:"FL_Ledge",height:.025,width:.003125});for(var i=0,I=4+~~(rng.random()*10);i<I;i++)floorLayout.push({type:"FL_Floor",height:.1,windows:"Double"});floorLayout.push({type:"FL_Ledge",height:.025,width:.003125},{type:"FL_Floor",height:.15,windows:"Single"},{type:"FL_Rooftop",height:.025,width:.00625});break;case 1:floorLayout.push({type:"FL_GndFloor",height:.1,tiles:"OneDoor",frontSide:lot.angle});for(var i=0,I=4+~~(rng.random()*10);i<I;i++)floorLayout.push({type:"FL_Floor",height:.1,windows:"Double"});floorLayout.push({type:"FL_Floor",height:.15,windows:"Single"},{type:"FL_Rooftop",height:.025,width:.00625});break}var axiom={sym:"Building",floorsLayout:floorLayout,points:pts};var color=availColors[~~(rng.random()*availColors.length)];var ret=shg.run(axiom);return{geom:ret,color:color}},getGeom:function(){return context}}},{"../lib/SHAPE.js":"/Volumes/Storage/andrea/web/thesis/src/lib/SHAPE.js","./../lib/Geom":"/Volumes/Storage/andrea/web/thesis/src/lib/Geom.js","./../lib/ShapeGrammar":"/Volumes/Storage/andrea/web/thesis/src/lib/ShapeGrammar.js","./PRNG":"/Volumes/Storage/andrea/web/thesis/src/generators/PRNG.js",earcut:"/Volumes/Storage/andrea/web/thesis/src/node_modules/earcut/src/earcut.js"}],"/Volumes/Storage/andrea/web/thesis/src/generators/City.js":[function(require,module,exports){var PRNG=new(require("./PRNG")),Geom=require("./../lib/Geom"),Roads=require("./Roads.js"),Block=require("./Block.js"),ShapeGrammar=require("../lib/ShapeGrammar.js");var traverse=function(){var pi2=Math.PI*2;return function(edgeA,edgeB,roads,face){
var edgeDir=Math.atan2(-edgeB.y+edgeA.y,edgeB.x-edgeA.x),nextDir,nextVtx,iol,rightmost={th:Number.POSITIVE_INFINITY,vertex:null};if(!("traversed"in edgeA))edgeA.traversed=[];if(!("traversed"in edgeB))edgeB.traversed=[];edgeA.traversed.push(edgeB);for(var i=0;i<edgeB.conns.length;i++){nextVtx=edgeB.conns[i];if(nextVtx===edgeA||edgeB.traversed.indexOf(nextVtx)!==-1||face&&nextVtx!==face[0]&&face.indexOf(nextVtx)!==-1)continue;nextDir=Math.atan2(-nextVtx.y+edgeB.y,nextVtx.x-edgeB.x)-edgeDir;if(nextDir>Math.PI)nextDir-=pi2;else if(nextDir<-Math.PI)nextDir+=pi2;if(nextDir<rightmost.th){rightmost.th=nextDir;rightmost.vertex=edgeB.conns[i]}}if(rightmost.vertex===null)return null;if(face)face.push(edgeB);if(face&&rightmost.vertex===face[0]){iol=Geom.isOverlapping(face,roads);if(iol)return null;edgeB.traversed.push(face[0]);return face}face=traverse(edgeB,rightmost.vertex,roads,face||[edgeA,edgeB]);if(face===null){edgeB.traversed.splice(edgeB.traversed.indexOf(rightmost.vertex),1)}return face||null}}();var City=function(seed){PRNG.seed(seed);var polys=[];this.roads=Roads();this.blocks=[];for(var i=0;i<this.roads.length;i++){for(var j=0;j<this.roads[i].conns.length;j++){if(!("traversed"in this.roads[i]))this.roads[i].traversed=[];var poly=traverse(this.roads[i],this.roads[i].conns[j],this.roads);if(poly===null||Geom.isPolyIn(poly,polys))continue;polys.push(poly);this.blocks.push(new Block(poly,PRNG.random()*65536))}}this.roads.forEach(function(r){r.traversed=[]});var roadQuads=[];this.roads.forEach(function(r){r.conns.forEach(function(r1){if(r1.traversed.indexOf(r)!==-1)return;roadQuads.push([r,r1]);r.traversed.push(r1);r1.traversed.push(r)})});this.roadQuads=roadQuads};module.exports=City},{"../lib/ShapeGrammar.js":"/Volumes/Storage/andrea/web/thesis/src/lib/ShapeGrammar.js","./../lib/Geom":"/Volumes/Storage/andrea/web/thesis/src/lib/Geom.js","./Block.js":"/Volumes/Storage/andrea/web/thesis/src/generators/Block.js","./PRNG":"/Volumes/Storage/andrea/web/thesis/src/generators/PRNG.js","./Roads.js":"/Volumes/Storage/andrea/web/thesis/src/generators/Roads.js"}],"/Volumes/Storage/andrea/web/thesis/src/generators/PRNG.js":[function(require,module,exports){var MersenneTwister=require("mersennetwister");var PRNG=function(seed){if(seed!==undefined)this.seed(seed);else this.mt=new MersenneTwister};PRNG.prototype.seed=function(seed){this.mt=new MersenneTwister(seed)};PRNG.prototype.random=function(){return this.mt.random()};module.exports=PRNG},{mersennetwister:"/Volumes/Storage/andrea/web/thesis/src/node_modules/mersennetwister/src/MersenneTwister.js"}],"/Volumes/Storage/andrea/web/thesis/src/generators/Roads.js":[function(require,module,exports){var PRNG=require("./PRNG");var side=8,q=0,amp=2;module.exports=function(seed){var g=[],rng=new PRNG(seed);for(var y=0;y<side;y++)for(var x=0;x<side;x++){var p=g[y*side+x]={x:amp*x+q*rng.random(),y:amp*y+q*rng.random(),conns:[]};if(x>0){p.conns.push(g[y*side+x-1]);g[y*side+x-1].conns.push(p)}if(y>0){p.conns.push(g[(y-1)*side+x]);g[(y-1)*side+x].conns.push(p)}}return g}},{"./PRNG":"/Volumes/Storage/andrea/web/thesis/src/generators/PRNG.js"}],"/Volumes/Storage/andrea/web/thesis/src/lib/Geom.js":[function(require,module,exports){var glMatrix=require("gl-matrix"),vec3=glMatrix.vec3;var Geom={pnpoly:function(poly,x,y){var n=poly.length,i,j,c=false,a,b;for(i=0,j=n-1;i<n;j=i++){a=poly[i];b=poly[j];if(a.y>y!==b.y>y&&x<(b.x-a.x)*(y-a.y)/(b.y-a.y)+a.x)c=!c}return c},isOverlapping:function(poly,vertices){for(var i=vertices.length-1;i--;){if(Geom.pnpoly(poly,vertices[i].x,vertices[i].y)&&poly.indexOf(vertices[i])===-1)return true}return false},isPolyIn:function(poly,polys){for(var i=polys.length-1;i>0;i--)if(Geom.isEqualPoly(poly,polys[i]))return true;return false},isEqualPoly:function(a,b){if(a.length!==b.length)return false;for(var i=a.length-1;i--;)if(b.indexOf(a[i])===-1)return false;return true},insetPolygon:function(poly,dist){var a,b,c,out=[];b=poly[poly.length-1];for(var i=0;i<poly.length-1;i++){a=b;b=poly[i];c=poly[i+1];out.push(Geom.insetCorner(a,b,c,dist))}out.push(Geom.insetCorner(b,c,poly[0],dist));return out},insetCorner:function(a,b,c,dist){var dx1=b.x-a.x,dy1=a.y-b.y,dx2=c.x-b.x,dy2=b.y-c.y,dist1=Math.sqrt(dx1*dx1+dy1*dy1),dist2=Math.sqrt(dx2*dx2+dy2*dy2),insX1,insX2,insY1,insY2,insp,b1={x:b.x,y:b.y},b2={x:b.x,y:b.y};if(dist1==0||dist2==0)return null;insX1=dy1/dist1*dist;insY1=dx1/dist1*dist;insX2=dy2/dist2*dist;insY2=dx2/dist2*dist;b1.x+=insX1;b1.y+=insY1;b2.x+=insX2;b2.y+=insY2;if(b1.x===b2.x&&b1.y===b2.y)return b1;return Geom.lineIntersection({x:a.x+insX1,y:a.y+insY1},b1,b2,{x:c.x+insX2,y:c.y+insY2})},lineIntersection:function(A1,A2,B1,B2){var dist,cos_,sin_,nx,p,a1={x:A1.x,y:A1.y},a2={x:A2.x,y:A2.y},b1={x:B1.x,y:B1.y},b2={x:B2.x,y:B2.y};a2.x-=a1.x;b1.x-=a1.x;b2.x-=a1.x;a2.y-=a1.y;b1.y-=a1.y;b2.y-=a1.y;dist=Math.sqrt(a2.x*a2.x+a2.y*a2.y);cos_=a2.x/dist;sin_=a2.y/dist;nx=b1.x*cos_+b1.y*sin_;b1.y=-b1.x*sin_+b1.y*cos_;b1.x=nx;nx=b2.x*cos_+b2.y*sin_;b2.y=-b2.x*sin_+b2.y*cos_;b2.x=nx;if(b1.y==b2.y)return null;p=b2.x+(b1.x-b2.x)*b2.y/(b2.y-b1.y);return{x:a1.x+p*cos_,y:a1.y+p*sin_}},triToNormal:function(points){var a1=points[0]-points[3],a2=points[1]-points[4],a3=points[2]-points[5],b1=points[6]-points[3],b2=points[7]-points[4],b3=points[8]-points[5];var nX=a2*b3-a3*b2,nY=a1*b3-a3*b1,nZ=a1*b2-a2*b1,rlen=1/Math.sqrt(nX*nX+nY*nY+nZ*nZ);nX*=rlen;nY*=rlen;nZ*=rlen;return[nX,nY,nZ]}};module.exports=Geom},{"gl-matrix":"/Volumes/Storage/andrea/web/thesis/src/node_modules/gl-matrix/dist/gl-matrix.js"}],"/Volumes/Storage/andrea/web/thesis/src/lib/Loader.js":[function(require,module,exports){var Context=require("./../Context");var dict={};var log=document.createElement("ul");log.style.position="absolute";log.style.top="7rem";log.style.left="1rem";log.style.color="#444";log.style.font='10px "Ubuntu Mono", monospace';log.style.lineHeight="1.5em";log.style.listStyleType="none";Context.canvas.parentNode.appendChild(log);module.exports={progress:function(id,percent){if(!(id in dict)){var li=document.createElement("li");log.appendChild(li);dict[id]={fns:[],li:li,value:0}}dict[id].value=percent;if(percent>=1){dict[id].fns.forEach(function(i){i()})}},subscribe:function(id,fn){if(!(id in dict)){var li=document.createElement("li");log.appendChild(li);dict[id]={fns:[],li:li,value:0}}dict[id].fns.push(fn)},render:function(){var str="",li;for(i in dict){var pct=parseInt(dict[i].value*100),sp=""+pct;while(sp.length<4)sp="_"+sp;sp=sp.replace(/_/g,"&nbsp;");dict[i].li.innerHTML="&nbsp;"+i+": "+sp+"%&nbsp;\n";var a="linear-gradient(90deg, #0f0, #0f0 "+pct+"%, #0b0 "+pct+"%)";dict[i].li.style.backgroundImage=a}}}},{"./../Context":"/Volumes/Storage/andrea/web/thesis/src/Context.js"}],"/Volumes/Storage/andrea/web/thesis/src/lib/Mesh.js":[function(require,module,exports){var glMatrix=require("gl-matrix"),Context=require("./../Context"),gl=Context.gl;var Mesh=function(vertices,normals,uvs,extra){this.vBuf=gl.createBuffer();this.nBuf=gl.createBuffer();this.uBuf=gl.createBuffer();this.eBuf=gl.createBuffer();this.count=vertices.length/3;gl.bindBuffer(gl.ARRAY_BUFFER,this.vBuf);gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(vertices),gl.STATIC_DRAW);gl.bindBuffer(gl.ARRAY_BUFFER,this.nBuf);gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(normals),gl.STATIC_DRAW);gl.bindBuffer(gl.ARRAY_BUFFER,this.uBuf);gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(uvs),gl.STATIC_DRAW);gl.bindBuffer(gl.ARRAY_BUFFER,this.eBuf);gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(extra),gl.STATIC_DRAW);gl.bindBuffer(gl.ARRAY_BUFFER,null)};module.exports=Mesh},{"./../Context":"/Volumes/Storage/andrea/web/thesis/src/Context.js","gl-matrix":"/Volumes/Storage/andrea/web/thesis/src/node_modules/gl-matrix/dist/gl-matrix.js"}],"/Volumes/Storage/andrea/web/thesis/src/lib/QuadTree.js":[function(require,module,exports){var QuadTree=function(x,y,w,limit){this.nw=this.sw=this.ne=this.se=null;this.x=x;this.y=y;this.w=w;this.limit=limit;this.points=[]};QuadTree.prototype.contains=function(el){return Math.abs(el.x-this.x)<this.w&&Math.abs(el.y-this.y)<this.w};QuadTree.prototype.insert=function(el){if(!this.contains(el))return false;if(this.points.length<this.limit){this.points.push(el);return true}if(this.nw===null)this.subdivide();return this.nw.insert(el)||this.ne.insert(el)||this.sw.insert(el)||this.se.insert(el)};QuadTree.prototype.subdivide=function(){var x=this.x,y=this.y,w=this.w/2;this.nw=new QuadTree(x-w,y-w,w,this.limit);this.sw=new QuadTree(x-w,y+w,w,this.limit);this.ne=new QuadTree(x+w,y-w,w,this.limit);this.se=new QuadTree(x+w,y+w,w,this.limit)};QuadTree.prototype.intersect=function(x,y,w){return Math.abs(this.x-x)<this.w+w&&Math.abs(this.y-y)<this.w+w};QuadTree.prototype.query=function(x,y,w){var pts=[],cpts=[],tp=this.points;if(!this.intersect(x,y,w)){return pts}for(var i=0,I=tp.length;i<I;i++){if(pointInRange(tp[i],x,y,w))pts.push(tp[i])}if(this.nw===null)return pts;cpts=this.nw.query(x,y,w);for(var i=0,I=cpts.length;i<I;i++)pts.push(cpts[i]);cpts=this.ne.query(x,y,w);for(var i=0,I=cpts.length;i<I;i++)pts.push(cpts[i]);cpts=this.sw.query(x,y,w);for(var i=0,I=cpts.length;i<I;i++)pts.push(cpts[i]);cpts=this.se.query(x,y,w);for(var i=0,I=cpts.length;i<I;i++)pts.push(cpts[i]);return pts};var pointInRange=function(el,x,y,w){return Math.abs(el.x-x)<w&&Math.abs(el.y-y)<w};module.exports=QuadTree},{}],"/Volumes/Storage/andrea/web/thesis/src/lib/SHAPE.js":[function(require,module,exports){var SHAPE={extrude:function(symbol,a,b,len,norm){var nX=0,nY=len,nZ=0;if(norm!==undefined){nX=norm[0]*len;nY=norm[1]*len;nZ=norm[2]*len}return{sym:symbol,points:[{x:a.x,y:a.y,z:a.z},{x:a.x+nX,y:a.y+nY,z:a.z+nZ},{x:b.x+nX,y:b.y+nY,z:b.z+nZ},{x:b.x,y:b.y,z:b.z}]}},extrudeAll:function(path,len,symbols,norm){var out=[];for(var i=0,n=path.length;i<n;++i){var cur=path[i],next=path[(i+1)%n];out.push(SHAPE.extrude(symbols instanceof Array?symbols[i]:symbols,cur,next,len,norm))}return out},split:function(quad,xSplits,ySplits,symbols){var out=[],symI=0,sioa=symbols instanceof Array,qp=quad.points,qu=quad.uvs,p0=qp[0],p1=qp[1],p2=qp[2],p3=qp[3],x0=p0.x,x1=p1.x,x2=p2.x,x3=p3.x,y0=p0.y,y1=p1.y,y2=p2.y,y3=p3.y,z0=p0.z,z1=p1.z,z2=p2.z,z3=p3.z,ds=1,dt=1,ms=0,mt=0;if(qu instanceof Array)ds=qu[3].s-qu[0].s,dt=qu[1].t-qu[0].t,ms=qu[0].s,mt=qu[1].t;var accY=0;for(var y=0,Y=ySplits.length;y<Y;++y){var accX=0,accYY=accY+ySplits[y];for(var x=0,X=xSplits.length;x<X;++x){var accXX=accX+xSplits[x],xa=SHAPE.lerp(x0,x3,accX),xb=SHAPE.lerp(x0,x3,accXX),ya=SHAPE.lerp(y0,y1,accY),yb=SHAPE.lerp(y0,y1,accYY),za=SHAPE.lerp(z0,z3,accX),zb=SHAPE.lerp(z0,z3,accXX);out.push({sym:sioa?symbols[symI++]:symbols,points:[{x:xa,y:ya,z:za},{x:xa,y:yb,z:za},{x:xb,y:yb,z:zb},{x:xb,y:ya,z:zb}],uvs:[{s:ms+ds*accX,t:mt+dt*accY},{s:ms+ds*accX,t:mt+dt*accYY},{s:ms+ds*accXX,t:mt+dt*accYY},{s:ms+ds*accXX,t:mt+dt*accY}]});accX=accXX}accY=accYY}return out},splitXZ:function(quad,xSplits,zSplits,symbols){var out=[],symI=0,qp=quad.points,p0=qp[0],p1=qp[1],p2=qp[2],p3=qp[3],x0=p0.x,x1=p1.x,x2=p2.x,x3=p3.x,y0=p0.y,y1=p1.y,y2=p2.y,y3=p3.y,z0=p0.z,z1=p1.z,z2=p2.z,z3=p3.z;var accZ=0;for(var z=0,Z=zSplits.length;z<Z;++z){var accX=0;for(var x=0,X=xSplits.length;x<X;++x){var xa=SHAPE.lerp(x0,x3,accX),xb=SHAPE.lerp(x0,x3,accX+xSplits[x]),ya=SHAPE.lerp(y0,y1,accX),yb=SHAPE.lerp(y0,y1,accX+xSplits[x]),za=SHAPE.lerp(z0,z1,accZ),zb=SHAPE.lerp(z0,z1,accZ+zSplits[z]);out.push({sym:symbols instanceof Array?symbols[symI++]:symbols,points:[{x:xa,y:ya,z:za},{x:xa,y:ya,z:zb},{x:xb,y:yb,z:zb},{x:xb,y:yb,z:za}]});accX+=xSplits[x]}accZ+=zSplits[z]}return out},splitZX:function(quad,xSplits,zSplits,symbols){var out=[],symI=0,qp=quad.points,p0=qp[0],p1=qp[1],p2=qp[2],p3=qp[3],x0=p0.x,x1=p1.x,x2=p2.x,x3=p3.x,y0=p0.y,y1=p1.y,y2=p2.y,y3=p3.y,z0=p0.z,z1=p1.z,z2=p2.z,z3=p3.z;var accZ=0;for(var z=0,Z=zSplits.length;z<Z;++z){var accX=0;for(var x=0,X=xSplits.length;x<X;++x){var xa=SHAPE.lerp(x0,x1,accX),xb=SHAPE.lerp(x0,x1,accX+xSplits[x]),ya=SHAPE.lerp(y0,y1,accX),yb=SHAPE.lerp(y0,y1,accX+xSplits[x]),za=SHAPE.lerp(z0,z3,accZ),zb=SHAPE.lerp(z0,z3,accZ+zSplits[z]);out.push({sym:symbols instanceof Array?symbols[symI++]:symbols,points:[{x:xa,y:ya,z:za},{x:xa,y:ya,z:zb},{x:xb,y:yb,z:zb},{x:xb,y:yb,z:za}]});accX+=xSplits[x]}accZ+=zSplits[z]}return out},fit:function(axis,quad,symbol,ratio){ratio=ratio||1;var qp=quad.points,p0=qp[0],p1=qp[1],p2=qp[2],p3=qp[3],x0=p0.x,x1=p1.x,x2=p2.x,x3=p3.x,y0=p0.y,y1=p1.y,y2=p2.y,y3=p3.y,z0=p0.z,z1=p1.z,z2=p2.z,z3=p3.z,dx=x3-x0,dy=y1-y0,dz=z3-z0,dzdy=z1-z0;if(axis==="x"){var h=dy,w=ratio*h,wAvail=Math.sqrt(dx*dx+dz*dz),count=Math.round(wAvail/w),splits=[];w=wAvail/count;count=Math.max(1,Math.abs(count));for(var i=0;i<count;i++)splits.push(1/count);return SHAPE.split(quad,splits,[1],symbol)}else if(axis==="y"){var w=x3-x0,h=w/ratio,hAvail=Math.sqrt(dy*dy+dzdy*dzdy),count=Math.round(hAvail/h),splits=[];h=hAvail/count;for(var i=0;i<count;i++)splits.push(1/count);return SHAPE.split(quad,splits,[1],symbol)}},lerp:function(a,b,t){return a*(1-t)+b*t}};module.exports=SHAPE},{}],"/Volumes/Storage/andrea/web/thesis/src/lib/ShapeGrammar.js":[function(require,module,exports){var Geom=require("./Geom"),SHAPE=require("./SHAPE.js"),glMatrix=require("gl-matrix"),earcut=require("earcut"),vec3=glMatrix.vec3,mat4=glMatrix.mat4;var _=function(){this.rules=[]};_.prototype.define=function(lhs,cond,rhs){this.rules.push({lhs:lhs,cond:cond,rhs:rhs})};_.prototype.run=function(state){var output=[],rules=this.rules,nonterminals=0;state=state instanceof Array?state:[state];while(state.length){var lhs=state.shift();if(lhs.sym===_.TERMINAL){output.push(lhs)}else for(var i=0,I=rules.length;i<I;i++){var rule=rules[i];if(lhs.sym===rule.lhs&&(rule.cond===null||rule.cond.call(lhs))){var ret=rule.rhs.call(lhs);ret=ret instanceof Array?ret:[ret];for(var j=0,J=ret.length;j<J;j++){output.push(ret[j]);++nonterminals}break}}}return nonterminals>0?this.run(output):output};_.TERMINAL="TERMINAL";module.exports=_},{"./Geom":"/Volumes/Storage/andrea/web/thesis/src/lib/Geom.js","./SHAPE.js":"/Volumes/Storage/andrea/web/thesis/src/lib/SHAPE.js",earcut:"/Volumes/Storage/andrea/web/thesis/src/node_modules/earcut/src/earcut.js","gl-matrix":"/Volumes/Storage/andrea/web/thesis/src/node_modules/gl-matrix/dist/gl-matrix.js"}],"/Volumes/Storage/andrea/web/thesis/src/lib/util.js":[function(require,module,exports){module.exports={hsl2rgb:function(h,s,l){var r,g,b,m,c,x;if(!isFinite(h))h=0;if(!isFinite(s))s=0;if(!isFinite(l))l=0;h/=60;if(h<0)h=6- -h%6;h%=6;s=Math.max(0,Math.min(1,s/100));l=Math.max(0,Math.min(1,l/100));c=(1-Math.abs(2*l-1))*s;x=c*(1-Math.abs(h%2-1));if(h<1){r=c;g=x;b=0}else if(h<2){r=x;g=c;b=0}else if(h<3){r=0;g=c;b=x}else if(h<4){r=0;g=x;b=c}else if(h<5){r=x;g=0;b=c}else{r=c;g=0;b=x}m=l-c/2;r=Math.round((r+m)*255);g=Math.round((g+m)*255);b=Math.round((b+m)*255);return{r:r,g:g,b:b}}}},{}],"/Volumes/Storage/andrea/web/thesis/src/main.js":[function(require,module,exports){var glMatrix=require("gl-matrix"),Context=require("./Context"),canvas=Context.canvas,gl=Context.gl,Renderer=require("./Renderer.js"),Loader=require("./lib/Loader"),City=require("./generators/City.js"),Stats=require("stats-js"),mainScene=require("./scenes/MainScene.js");var stats=new Stats;stats.setMode(0);stats.domElement.style.position="absolute";stats.domElement.style.right="1rem";stats.domElement.style.top="1rem";canvas.parentNode.appendChild(stats.domElement);var loadingStatus=0;var t0=NaN;Loader.subscribe("Blocks",function(){console.log("Loading complete");loadingStatus=1;t0=NaN;sceneLoop()});function loadingLoop(){if(loadingStatus===0)requestAnimationFrame(loadingLoop);Loader.render()}function sceneLoop(ts){if(isNaN(sceneLoop.t0))sceneLoop.t0=ts;stats.begin();Renderer.render(mainScene);mainScene.update(ts-sceneLoop.t0);stats.end();requestAnimationFrame(sceneLoop)}gl.viewport(0,0,Context.w,Context.h);loadingLoop()},{"./Context":"/Volumes/Storage/andrea/web/thesis/src/Context.js","./Renderer.js":"/Volumes/Storage/andrea/web/thesis/src/Renderer.js","./generators/City.js":"/Volumes/Storage/andrea/web/thesis/src/generators/City.js","./lib/Loader":"/Volumes/Storage/andrea/web/thesis/src/lib/Loader.js","./scenes/MainScene.js":"/Volumes/Storage/andrea/web/thesis/src/scenes/MainScene.js","gl-matrix":"/Volumes/Storage/andrea/web/thesis/src/node_modules/gl-matrix/dist/gl-matrix.js","stats-js":"/Volumes/Storage/andrea/web/thesis/src/node_modules/stats-js/build/stats.min.js"}],"/Volumes/Storage/andrea/web/thesis/src/node_modules/earcut/src/earcut.js":[function(require,module,exports){"use strict";module.exports=earcut;function earcut(points,returnIndices){var outerNode=filterPoints(linkedList(points[0],true)),triangles=returnIndices?{vertices:[],indices:[]}:[];if(!outerNode)return triangles;var node,minX,minY,maxX,maxY,x,y,size,i,threshold=80;for(i=0;threshold>=0&&i<points.length;i++)threshold-=points[i].length;if(threshold<0){node=outerNode.next;minX=maxX=node.p[0];minY=maxY=node.p[1];do{x=node.p[0];y=node.p[1];if(x<minX)minX=x;if(y<minY)minY=y;if(x>maxX)maxX=x;if(y>maxY)maxY=y;node=node.next}while(node!==outerNode);size=Math.max(maxX-minX,maxY-minY)}if(points.length>1)outerNode=eliminateHoles(points,outerNode);earcutLinked(outerNode,triangles,minX,minY,size);return triangles}function linkedList(points,clockwise){var sum=0,len=points.length,i,j,p1,p2,last;for(i=0,j=len-1;i<len;j=i++){p1=points[i];p2=points[j];sum+=(p2[0]-p1[0])*(p1[1]+p2[1])}if(clockwise===sum>0){for(i=0;i<len;i++)last=insertNode(points[i],last)}else{for(i=len-1;i>=0;i--)last=insertNode(points[i],last)}return last}function filterPoints(start,end){if(!end)end=start;var node=start,again;do{again=false;if(equals(node.p,node.next.p)||orient(node.prev.p,node.p,node.next.p)===0){node.prev.next=node.next;node.next.prev=node.prev;if(node.prevZ)node.prevZ.nextZ=node.nextZ;if(node.nextZ)node.nextZ.prevZ=node.prevZ;node=end=node.prev;if(node===node.next)return null;again=true}else{node=node.next}}while(again||node!==end);return end}function earcutLinked(ear,triangles,minX,minY,size,pass){if(!ear)return;var indexed=triangles.vertices!==undefined;if(!pass&&minX!==undefined)indexCurve(ear,minX,minY,size);var stop=ear,prev,next;while(ear.prev!==ear.next){prev=ear.prev;next=ear.next;if(isEar(ear,minX,minY,size)){if(indexed){addIndexedVertex(triangles,prev);addIndexedVertex(triangles,ear);addIndexedVertex(triangles,next)}else{triangles.push(prev.p);triangles.push(ear.p);triangles.push(next.p)}next.prev=prev;prev.next=next;if(ear.prevZ)ear.prevZ.nextZ=ear.nextZ;if(ear.nextZ)ear.nextZ.prevZ=ear.prevZ;ear=next.next;stop=next.next;continue}ear=next;if(ear===stop){if(!pass){earcutLinked(filterPoints(ear),triangles,minX,minY,size,1)}else if(pass===1){ear=cureLocalIntersections(ear,triangles);earcutLinked(ear,triangles,minX,minY,size,2)}else if(pass===2){splitEarcut(ear,triangles,minX,minY,size)}break}}}function addIndexedVertex(triangles,node){if(node.source)node=node.source;var i=node.index;if(i===null){var dim=node.p.length;var vertices=triangles.vertices;node.index=i=vertices.length/dim;for(var d=0;d<dim;d++)vertices.push(node.p[d])}triangles.indices.push(i)}function isEar(ear,minX,minY,size){var a=ear.prev.p,b=ear.p,c=ear.next.p,ax=a[0],bx=b[0],cx=c[0],ay=a[1],by=b[1],cy=c[1],abd=ax*by-ay*bx,acd=ax*cy-ay*cx,cbd=cx*by-cy*bx,A=abd-acd-cbd;if(A<=0)return false;var cay=cy-ay,acx=ax-cx,aby=ay-by,bax=bx-ax,p,px,py,s,t,k,node;if(minX!==undefined){var minTX=ax<bx?ax<cx?ax:cx:bx<cx?bx:cx,minTY=ay<by?ay<cy?ay:cy:by<cy?by:cy,maxTX=ax>bx?ax>cx?ax:cx:bx>cx?bx:cx,maxTY=ay>by?ay>cy?ay:cy:by>cy?by:cy,minZ=zOrder(minTX,minTY,minX,minY,size),maxZ=zOrder(maxTX,maxTY,minX,minY,size);node=ear.nextZ;while(node&&node.z<=maxZ){p=node.p;node=node.nextZ;if(p===a||p===c)continue;px=p[0];py=p[1];s=cay*px+acx*py-acd;if(s>=0){t=aby*px+bax*py+abd;if(t>=0){k=A-s-t;if(k>=0&&(s&&t||s&&k||t&&k))return false}}}node=ear.prevZ;while(node&&node.z>=minZ){p=node.p;node=node.prevZ;if(p===a||p===c)continue;px=p[0];py=p[1];s=cay*px+acx*py-acd;if(s>=0){t=aby*px+bax*py+abd;if(t>=0){k=A-s-t;if(k>=0&&(s&&t||s&&k||t&&k))return false}}}}else{node=ear.next.next;while(node!==ear.prev){p=node.p;node=node.next;px=p[0];py=p[1];s=cay*px+acx*py-acd;if(s>=0){t=aby*px+bax*py+abd;if(t>=0){k=A-s-t;if(k>=0&&(s&&t||s&&k||t&&k))return false}}}}return true}function cureLocalIntersections(start,triangles){var indexed=!!triangles.vertices;var node=start;do{var a=node.prev,b=node.next.next;if(a.p!==b.p&&intersects(a.p,node.p,node.next.p,b.p)&&locallyInside(a,b)&&locallyInside(b,a)){if(indexed){addIndexedVertex(triangles,a);addIndexedVertex(triangles,node);addIndexedVertex(triangles,b)}else{triangles.push(a.p);triangles.push(node.p);triangles.push(b.p)}a.next=b;b.prev=a;var az=node.prevZ,bz=node.nextZ&&node.nextZ.nextZ;if(az)az.nextZ=bz;if(bz)bz.prevZ=az;node=start=b}node=node.next}while(node!==start);return node}function splitEarcut(start,triangles,minX,minY,size){var a=start;do{var b=a.next.next;while(b!==a.prev){if(a.p!==b.p&&isValidDiagonal(a,b)){var c=splitPolygon(a,b);a=filterPoints(a,a.next);c=filterPoints(c,c.next);earcutLinked(a,triangles,minX,minY,size);earcutLinked(c,triangles,minX,minY,size);return}b=b.next}a=a.next}while(a!==start)}function eliminateHoles(points,outerNode){var len=points.length;var queue=[];for(var i=1;i<len;i++){var list=filterPoints(linkedList(points[i],false));if(list)queue.push(getLeftmost(list))}queue.sort(compareX);for(i=0;i<queue.length;i++){eliminateHole(queue[i],outerNode);outerNode=filterPoints(outerNode,outerNode.next)}return outerNode}function eliminateHole(holeNode,outerNode){outerNode=findHoleBridge(holeNode,outerNode);if(outerNode){var b=splitPolygon(outerNode,holeNode);filterPoints(b,b.next)}}function findHoleBridge(holeNode,outerNode){var node=outerNode,p=holeNode.p,px=p[0],py=p[1],qMax=-Infinity,mNode,a,b;do{a=node.p;b=node.next.p;if(py<=a[1]&&py>=b[1]){var qx=a[0]+(py-a[1])*(b[0]-a[0])/(b[1]-a[1]);if(qx<=px&&qx>qMax){qMax=qx;mNode=a[0]<b[0]?node:node.next}}node=node.next}while(node!==outerNode);if(!mNode)return null;var bx=mNode.p[0],by=mNode.p[1],pbd=px*by-py*bx,pcd=px*py-py*qMax,cpy=py-py,pcx=px-qMax,pby=py-by,bpx=bx-px,A=pbd-pcd-(qMax*by-py*bx),sign=A<=0?-1:1,stop=mNode,tanMin=Infinity,mx,my,amx,s,t,tan;node=mNode.next;while(node!==stop){mx=node.p[0];my=node.p[1];amx=px-mx;if(amx>=0&&mx>=bx){s=(cpy*mx+pcx*my-pcd)*sign;if(s>=0){t=(pby*mx+bpx*my+pbd)*sign;if(t>=0&&A*sign-s-t>=0){tan=Math.abs(py-my)/amx;if(tan<tanMin&&locallyInside(node,holeNode)){mNode=node;tanMin=tan}}}}node=node.next}return mNode}function indexCurve(start,minX,minY,size){var node=start;do{if(node.z===null)node.z=zOrder(node.p[0],node.p[1],minX,minY,size);node.prevZ=node.prev;node.nextZ=node.next;node=node.next}while(node!==start);node.prevZ.nextZ=null;node.prevZ=null;sortLinked(node)}function sortLinked(list){var i,p,q,e,tail,numMerges,pSize,qSize,inSize=1;while(true){p=list;list=null;tail=null;numMerges=0;while(p){numMerges++;q=p;pSize=0;for(i=0;i<inSize;i++){pSize++;q=q.nextZ;if(!q)break}qSize=inSize;while(pSize>0||qSize>0&&q){if(pSize===0){e=q;q=q.nextZ;qSize--}else if(qSize===0||!q){e=p;p=p.nextZ;pSize--}else if(p.z<=q.z){e=p;p=p.nextZ;pSize--}else{e=q;q=q.nextZ;qSize--}if(tail)tail.nextZ=e;else list=e;e.prevZ=tail;tail=e}p=q}tail.nextZ=null;if(numMerges<=1)return list;inSize*=2}}function zOrder(x,y,minX,minY,size){x=1e3*(x-minX)/size;x=(x|x<<8)&16711935;x=(x|x<<4)&252645135;x=(x|x<<2)&858993459;x=(x|x<<1)&1431655765;y=1e3*(y-minY)/size;y=(y|y<<8)&16711935;y=(y|y<<4)&252645135;y=(y|y<<2)&858993459;y=(y|y<<1)&1431655765;return x|y<<1}function getLeftmost(start){var node=start,leftmost=start;do{if(node.p[0]<leftmost.p[0])leftmost=node;node=node.next}while(node!==start);return leftmost}function isValidDiagonal(a,b){return!intersectsPolygon(a,a.p,b.p)&&locallyInside(a,b)&&locallyInside(b,a)&&middleInside(a,a.p,b.p)}function orient(p,q,r){var o=(q[1]-p[1])*(r[0]-q[0])-(q[0]-p[0])*(r[1]-q[1]);return o>0?1:o<0?-1:0}function equals(p1,p2){return p1[0]===p2[0]&&p1[1]===p2[1]}function intersects(p1,q1,p2,q2){return orient(p1,q1,p2)!==orient(p1,q1,q2)&&orient(p2,q2,p1)!==orient(p2,q2,q1)}function intersectsPolygon(start,a,b){var node=start;do{var p1=node.p,p2=node.next.p;if(p1!==a&&p2!==a&&p1!==b&&p2!==b&&intersects(p1,p2,a,b))return true;node=node.next}while(node!==start);return false}function locallyInside(a,b){return orient(a.prev.p,a.p,a.next.p)===-1?orient(a.p,b.p,a.next.p)!==-1&&orient(a.p,a.prev.p,b.p)!==-1:orient(a.p,b.p,a.prev.p)===-1||orient(a.p,a.next.p,b.p)===-1}function middleInside(start,a,b){var node=start,inside=false,px=(a[0]+b[0])/2,py=(a[1]+b[1])/2;do{var p1=node.p,p2=node.next.p;if(p1[1]>py!==p2[1]>py&&px<(p2[0]-p1[0])*(py-p1[1])/(p2[1]-p1[1])+p1[0])inside=!inside;node=node.next}while(node!==start);return inside}function compareX(a,b){return a.p[0]-b.p[0]}function splitPolygon(a,b){var a2=new Node(a.p),b2=new Node(b.p),an=a.next,bp=b.prev;a2.source=a;b2.source=b;a.next=b;b.prev=a;a2.next=an;an.prev=a2;b2.next=a2;a2.prev=b2;bp.next=b2;b2.prev=bp;return b2}function insertNode(point,last){var node=new Node(point);if(!last){node.prev=node;node.next=node}else{node.next=last.next;node.prev=last;last.next.prev=node;last.next=node}return node}function Node(p){this.p=p;this.prev=null;this.next=null;this.z=null;this.prevZ=null;this.nextZ=null;this.source=null;this.index=null}},{}],"/Volumes/Storage/andrea/web/thesis/src/node_modules/gl-matrix/dist/gl-matrix.js":[function(require,module,exports){(function(_global){"use strict";var shim={};if(typeof exports==="undefined"){if(typeof define=="function"&&typeof define.amd=="object"&&define.amd){shim.exports={};define(function(){return shim.exports})}else{shim.exports=typeof window!=="undefined"?window:_global}}else{shim.exports=exports}(function(exports){if(!GLMAT_EPSILON){var GLMAT_EPSILON=1e-6}if(!GLMAT_ARRAY_TYPE){var GLMAT_ARRAY_TYPE=typeof Float32Array!=="undefined"?Float32Array:Array}if(!GLMAT_RANDOM){var GLMAT_RANDOM=Math.random}var glMatrix={};glMatrix.setMatrixArrayType=function(type){GLMAT_ARRAY_TYPE=type};if(typeof exports!=="undefined"){exports.glMatrix=glMatrix}var degree=Math.PI/180;glMatrix.toRadian=function(a){return a*degree};var vec2={};vec2.create=function(){var out=new GLMAT_ARRAY_TYPE(2);out[0]=0;out[1]=0;return out};vec2.clone=function(a){var out=new GLMAT_ARRAY_TYPE(2);out[0]=a[0];out[1]=a[1];return out};vec2.fromValues=function(x,y){var out=new GLMAT_ARRAY_TYPE(2);out[0]=x;out[1]=y;return out};vec2.copy=function(out,a){out[0]=a[0];out[1]=a[1];return out};vec2.set=function(out,x,y){out[0]=x;out[1]=y;return out};vec2.add=function(out,a,b){out[0]=a[0]+b[0];out[1]=a[1]+b[1];return out};vec2.subtract=function(out,a,b){out[0]=a[0]-b[0];out[1]=a[1]-b[1];return out};vec2.sub=vec2.subtract;vec2.multiply=function(out,a,b){out[0]=a[0]*b[0];out[1]=a[1]*b[1];return out};vec2.mul=vec2.multiply;vec2.divide=function(out,a,b){out[0]=a[0]/b[0];out[1]=a[1]/b[1];return out};vec2.div=vec2.divide;vec2.min=function(out,a,b){out[0]=Math.min(a[0],b[0]);out[1]=Math.min(a[1],b[1]);return out};vec2.max=function(out,a,b){out[0]=Math.max(a[0],b[0]);out[1]=Math.max(a[1],b[1]);return out};vec2.scale=function(out,a,b){out[0]=a[0]*b;out[1]=a[1]*b;return out};vec2.scaleAndAdd=function(out,a,b,scale){out[0]=a[0]+b[0]*scale;out[1]=a[1]+b[1]*scale;return out};vec2.distance=function(a,b){var x=b[0]-a[0],y=b[1]-a[1];return Math.sqrt(x*x+y*y)};vec2.dist=vec2.distance;vec2.squaredDistance=function(a,b){var x=b[0]-a[0],y=b[1]-a[1];return x*x+y*y};vec2.sqrDist=vec2.squaredDistance;vec2.length=function(a){var x=a[0],y=a[1];return Math.sqrt(x*x+y*y)};vec2.len=vec2.length;vec2.squaredLength=function(a){var x=a[0],y=a[1];return x*x+y*y};vec2.sqrLen=vec2.squaredLength;vec2.negate=function(out,a){out[0]=-a[0];out[1]=-a[1];return out};vec2.normalize=function(out,a){var x=a[0],y=a[1];var len=x*x+y*y;if(len>0){len=1/Math.sqrt(len);out[0]=a[0]*len;out[1]=a[1]*len}return out};vec2.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]};vec2.cross=function(out,a,b){var z=a[0]*b[1]-a[1]*b[0];out[0]=out[1]=0;out[2]=z;return out};vec2.lerp=function(out,a,b,t){var ax=a[0],ay=a[1];out[0]=ax+t*(b[0]-ax);out[1]=ay+t*(b[1]-ay);return out};vec2.random=function(out,scale){scale=scale||1;var r=GLMAT_RANDOM()*2*Math.PI;out[0]=Math.cos(r)*scale;out[1]=Math.sin(r)*scale;return out};vec2.transformMat2=function(out,a,m){var x=a[0],y=a[1];out[0]=m[0]*x+m[2]*y;out[1]=m[1]*x+m[3]*y;return out};vec2.transformMat2d=function(out,a,m){var x=a[0],y=a[1];out[0]=m[0]*x+m[2]*y+m[4];out[1]=m[1]*x+m[3]*y+m[5];return out};vec2.transformMat3=function(out,a,m){var x=a[0],y=a[1];out[0]=m[0]*x+m[3]*y+m[6];out[1]=m[1]*x+m[4]*y+m[7];return out};vec2.transformMat4=function(out,a,m){var x=a[0],y=a[1];out[0]=m[0]*x+m[4]*y+m[12];out[1]=m[1]*x+m[5]*y+m[13];return out};vec2.forEach=function(){var vec=vec2.create();return function(a,stride,offset,count,fn,arg){var i,l;if(!stride){stride=2}if(!offset){offset=0}if(count){l=Math.min(count*stride+offset,a.length)}else{l=a.length}for(i=offset;i<l;i+=stride){vec[0]=a[i];vec[1]=a[i+1];fn(vec,vec,arg);a[i]=vec[0];a[i+1]=vec[1]}return a}}();vec2.str=function(a){return"vec2("+a[0]+", "+a[1]+")"};if(typeof exports!=="undefined"){exports.vec2=vec2}var vec3={};vec3.create=function(){var out=new GLMAT_ARRAY_TYPE(3);out[0]=0;out[1]=0;out[2]=0;return out};vec3.clone=function(a){var out=new GLMAT_ARRAY_TYPE(3);out[0]=a[0];out[1]=a[1];out[2]=a[2];return out};vec3.fromValues=function(x,y,z){var out=new GLMAT_ARRAY_TYPE(3);out[0]=x;out[1]=y;out[2]=z;return out};vec3.copy=function(out,a){out[0]=a[0];out[1]=a[1];out[2]=a[2];return out};vec3.set=function(out,x,y,z){out[0]=x;out[1]=y;out[2]=z;return out};vec3.add=function(out,a,b){out[0]=a[0]+b[0];out[1]=a[1]+b[1];out[2]=a[2]+b[2];return out};vec3.subtract=function(out,a,b){out[0]=a[0]-b[0];out[1]=a[1]-b[1];out[2]=a[2]-b[2];return out};vec3.sub=vec3.subtract;vec3.multiply=function(out,a,b){out[0]=a[0]*b[0];out[1]=a[1]*b[1];out[2]=a[2]*b[2];return out};vec3.mul=vec3.multiply;vec3.divide=function(out,a,b){out[0]=a[0]/b[0];out[1]=a[1]/b[1];out[2]=a[2]/b[2];return out};vec3.div=vec3.divide;vec3.min=function(out,a,b){out[0]=Math.min(a[0],b[0]);out[1]=Math.min(a[1],b[1]);out[2]=Math.min(a[2],b[2]);return out};vec3.max=function(out,a,b){out[0]=Math.max(a[0],b[0]);out[1]=Math.max(a[1],b[1]);out[2]=Math.max(a[2],b[2]);return out};vec3.scale=function(out,a,b){out[0]=a[0]*b;out[1]=a[1]*b;out[2]=a[2]*b;return out};vec3.scaleAndAdd=function(out,a,b,scale){out[0]=a[0]+b[0]*scale;out[1]=a[1]+b[1]*scale;out[2]=a[2]+b[2]*scale;return out};vec3.distance=function(a,b){var x=b[0]-a[0],y=b[1]-a[1],z=b[2]-a[2];return Math.sqrt(x*x+y*y+z*z)};vec3.dist=vec3.distance;vec3.squaredDistance=function(a,b){var x=b[0]-a[0],y=b[1]-a[1],z=b[2]-a[2];return x*x+y*y+z*z};vec3.sqrDist=vec3.squaredDistance;vec3.length=function(a){var x=a[0],y=a[1],z=a[2];return Math.sqrt(x*x+y*y+z*z)};vec3.len=vec3.length;vec3.squaredLength=function(a){var x=a[0],y=a[1],z=a[2];return x*x+y*y+z*z};vec3.sqrLen=vec3.squaredLength;vec3.negate=function(out,a){out[0]=-a[0];out[1]=-a[1];out[2]=-a[2];return out};vec3.normalize=function(out,a){var x=a[0],y=a[1],z=a[2];var len=x*x+y*y+z*z;if(len>0){len=1/Math.sqrt(len);out[0]=a[0]*len;out[1]=a[1]*len;out[2]=a[2]*len}return out};vec3.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]};vec3.cross=function(out,a,b){var ax=a[0],ay=a[1],az=a[2],bx=b[0],by=b[1],bz=b[2];out[0]=ay*bz-az*by;out[1]=az*bx-ax*bz;out[2]=ax*by-ay*bx;return out};vec3.lerp=function(out,a,b,t){var ax=a[0],ay=a[1],az=a[2];out[0]=ax+t*(b[0]-ax);out[1]=ay+t*(b[1]-ay);out[2]=az+t*(b[2]-az);return out};vec3.random=function(out,scale){scale=scale||1;var r=GLMAT_RANDOM()*2*Math.PI;var z=GLMAT_RANDOM()*2-1;var zScale=Math.sqrt(1-z*z)*scale;out[0]=Math.cos(r)*zScale;out[1]=Math.sin(r)*zScale;out[2]=z*scale;return out};vec3.transformMat4=function(out,a,m){var x=a[0],y=a[1],z=a[2];out[0]=m[0]*x+m[4]*y+m[8]*z+m[12];out[1]=m[1]*x+m[5]*y+m[9]*z+m[13];out[2]=m[2]*x+m[6]*y+m[10]*z+m[14];return out};vec3.transformMat3=function(out,a,m){var x=a[0],y=a[1],z=a[2];out[0]=x*m[0]+y*m[3]+z*m[6];out[1]=x*m[1]+y*m[4]+z*m[7];

out[2]=x*m[2]+y*m[5]+z*m[8];return out};vec3.transformQuat=function(out,a,q){var x=a[0],y=a[1],z=a[2],qx=q[0],qy=q[1],qz=q[2],qw=q[3],ix=qw*x+qy*z-qz*y,iy=qw*y+qz*x-qx*z,iz=qw*z+qx*y-qy*x,iw=-qx*x-qy*y-qz*z;out[0]=ix*qw+iw*-qx+iy*-qz-iz*-qy;out[1]=iy*qw+iw*-qy+iz*-qx-ix*-qz;out[2]=iz*qw+iw*-qz+ix*-qy-iy*-qx;return out};vec3.rotateX=function(out,a,b,c){var p=[],r=[];p[0]=a[0]-b[0];p[1]=a[1]-b[1];p[2]=a[2]-b[2];r[0]=p[0];r[1]=p[1]*Math.cos(c)-p[2]*Math.sin(c);r[2]=p[1]*Math.sin(c)+p[2]*Math.cos(c);out[0]=r[0]+b[0];out[1]=r[1]+b[1];out[2]=r[2]+b[2];return out};vec3.rotateY=function(out,a,b,c){var p=[],r=[];p[0]=a[0]-b[0];p[1]=a[1]-b[1];p[2]=a[2]-b[2];r[0]=p[2]*Math.sin(c)+p[0]*Math.cos(c);r[1]=p[1];r[2]=p[2]*Math.cos(c)-p[0]*Math.sin(c);out[0]=r[0]+b[0];out[1]=r[1]+b[1];out[2]=r[2]+b[2];return out};vec3.rotateZ=function(out,a,b,c){var p=[],r=[];p[0]=a[0]-b[0];p[1]=a[1]-b[1];p[2]=a[2]-b[2];r[0]=p[0]*Math.cos(c)-p[1]*Math.sin(c);r[1]=p[0]*Math.sin(c)+p[1]*Math.cos(c);r[2]=p[2];out[0]=r[0]+b[0];out[1]=r[1]+b[1];out[2]=r[2]+b[2];return out};vec3.forEach=function(){var vec=vec3.create();return function(a,stride,offset,count,fn,arg){var i,l;if(!stride){stride=3}if(!offset){offset=0}if(count){l=Math.min(count*stride+offset,a.length)}else{l=a.length}for(i=offset;i<l;i+=stride){vec[0]=a[i];vec[1]=a[i+1];vec[2]=a[i+2];fn(vec,vec,arg);a[i]=vec[0];a[i+1]=vec[1];a[i+2]=vec[2]}return a}}();vec3.str=function(a){return"vec3("+a[0]+", "+a[1]+", "+a[2]+")"};if(typeof exports!=="undefined"){exports.vec3=vec3}var vec4={};vec4.create=function(){var out=new GLMAT_ARRAY_TYPE(4);out[0]=0;out[1]=0;out[2]=0;out[3]=0;return out};vec4.clone=function(a){var out=new GLMAT_ARRAY_TYPE(4);out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];return out};vec4.fromValues=function(x,y,z,w){var out=new GLMAT_ARRAY_TYPE(4);out[0]=x;out[1]=y;out[2]=z;out[3]=w;return out};vec4.copy=function(out,a){out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];return out};vec4.set=function(out,x,y,z,w){out[0]=x;out[1]=y;out[2]=z;out[3]=w;return out};vec4.add=function(out,a,b){out[0]=a[0]+b[0];out[1]=a[1]+b[1];out[2]=a[2]+b[2];out[3]=a[3]+b[3];return out};vec4.subtract=function(out,a,b){out[0]=a[0]-b[0];out[1]=a[1]-b[1];out[2]=a[2]-b[2];out[3]=a[3]-b[3];return out};vec4.sub=vec4.subtract;vec4.multiply=function(out,a,b){out[0]=a[0]*b[0];out[1]=a[1]*b[1];out[2]=a[2]*b[2];out[3]=a[3]*b[3];return out};vec4.mul=vec4.multiply;vec4.divide=function(out,a,b){out[0]=a[0]/b[0];out[1]=a[1]/b[1];out[2]=a[2]/b[2];out[3]=a[3]/b[3];return out};vec4.div=vec4.divide;vec4.min=function(out,a,b){out[0]=Math.min(a[0],b[0]);out[1]=Math.min(a[1],b[1]);out[2]=Math.min(a[2],b[2]);out[3]=Math.min(a[3],b[3]);return out};vec4.max=function(out,a,b){out[0]=Math.max(a[0],b[0]);out[1]=Math.max(a[1],b[1]);out[2]=Math.max(a[2],b[2]);out[3]=Math.max(a[3],b[3]);return out};vec4.scale=function(out,a,b){out[0]=a[0]*b;out[1]=a[1]*b;out[2]=a[2]*b;out[3]=a[3]*b;return out};vec4.scaleAndAdd=function(out,a,b,scale){out[0]=a[0]+b[0]*scale;out[1]=a[1]+b[1]*scale;out[2]=a[2]+b[2]*scale;out[3]=a[3]+b[3]*scale;return out};vec4.distance=function(a,b){var x=b[0]-a[0],y=b[1]-a[1],z=b[2]-a[2],w=b[3]-a[3];return Math.sqrt(x*x+y*y+z*z+w*w)};vec4.dist=vec4.distance;vec4.squaredDistance=function(a,b){var x=b[0]-a[0],y=b[1]-a[1],z=b[2]-a[2],w=b[3]-a[3];return x*x+y*y+z*z+w*w};vec4.sqrDist=vec4.squaredDistance;vec4.length=function(a){var x=a[0],y=a[1],z=a[2],w=a[3];return Math.sqrt(x*x+y*y+z*z+w*w)};vec4.len=vec4.length;vec4.squaredLength=function(a){var x=a[0],y=a[1],z=a[2],w=a[3];return x*x+y*y+z*z+w*w};vec4.sqrLen=vec4.squaredLength;vec4.negate=function(out,a){out[0]=-a[0];out[1]=-a[1];out[2]=-a[2];out[3]=-a[3];return out};vec4.normalize=function(out,a){var x=a[0],y=a[1],z=a[2],w=a[3];var len=x*x+y*y+z*z+w*w;if(len>0){len=1/Math.sqrt(len);out[0]=a[0]*len;out[1]=a[1]*len;out[2]=a[2]*len;out[3]=a[3]*len}return out};vec4.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3]*b[3]};vec4.lerp=function(out,a,b,t){var ax=a[0],ay=a[1],az=a[2],aw=a[3];out[0]=ax+t*(b[0]-ax);out[1]=ay+t*(b[1]-ay);out[2]=az+t*(b[2]-az);out[3]=aw+t*(b[3]-aw);return out};vec4.random=function(out,scale){scale=scale||1;out[0]=GLMAT_RANDOM();out[1]=GLMAT_RANDOM();out[2]=GLMAT_RANDOM();out[3]=GLMAT_RANDOM();vec4.normalize(out,out);vec4.scale(out,out,scale);return out};vec4.transformMat4=function(out,a,m){var x=a[0],y=a[1],z=a[2],w=a[3];out[0]=m[0]*x+m[4]*y+m[8]*z+m[12]*w;out[1]=m[1]*x+m[5]*y+m[9]*z+m[13]*w;out[2]=m[2]*x+m[6]*y+m[10]*z+m[14]*w;out[3]=m[3]*x+m[7]*y+m[11]*z+m[15]*w;return out};vec4.transformQuat=function(out,a,q){var x=a[0],y=a[1],z=a[2],qx=q[0],qy=q[1],qz=q[2],qw=q[3],ix=qw*x+qy*z-qz*y,iy=qw*y+qz*x-qx*z,iz=qw*z+qx*y-qy*x,iw=-qx*x-qy*y-qz*z;out[0]=ix*qw+iw*-qx+iy*-qz-iz*-qy;out[1]=iy*qw+iw*-qy+iz*-qx-ix*-qz;out[2]=iz*qw+iw*-qz+ix*-qy-iy*-qx;return out};vec4.forEach=function(){var vec=vec4.create();return function(a,stride,offset,count,fn,arg){var i,l;if(!stride){stride=4}if(!offset){offset=0}if(count){l=Math.min(count*stride+offset,a.length)}else{l=a.length}for(i=offset;i<l;i+=stride){vec[0]=a[i];vec[1]=a[i+1];vec[2]=a[i+2];vec[3]=a[i+3];fn(vec,vec,arg);a[i]=vec[0];a[i+1]=vec[1];a[i+2]=vec[2];a[i+3]=vec[3]}return a}}();vec4.str=function(a){return"vec4("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+")"};if(typeof exports!=="undefined"){exports.vec4=vec4}var mat2={};mat2.create=function(){var out=new GLMAT_ARRAY_TYPE(4);out[0]=1;out[1]=0;out[2]=0;out[3]=1;return out};mat2.clone=function(a){var out=new GLMAT_ARRAY_TYPE(4);out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];return out};mat2.copy=function(out,a){out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];return out};mat2.identity=function(out){out[0]=1;out[1]=0;out[2]=0;out[3]=1;return out};mat2.transpose=function(out,a){if(out===a){var a1=a[1];out[1]=a[2];out[2]=a1}else{out[0]=a[0];out[1]=a[2];out[2]=a[1];out[3]=a[3]}return out};mat2.invert=function(out,a){var a0=a[0],a1=a[1],a2=a[2],a3=a[3],det=a0*a3-a2*a1;if(!det){return null}det=1/det;out[0]=a3*det;out[1]=-a1*det;out[2]=-a2*det;out[3]=a0*det;return out};mat2.adjoint=function(out,a){var a0=a[0];out[0]=a[3];out[1]=-a[1];out[2]=-a[2];out[3]=a0;return out};mat2.determinant=function(a){return a[0]*a[3]-a[2]*a[1]};mat2.multiply=function(out,a,b){var a0=a[0],a1=a[1],a2=a[2],a3=a[3];var b0=b[0],b1=b[1],b2=b[2],b3=b[3];out[0]=a0*b0+a2*b1;out[1]=a1*b0+a3*b1;out[2]=a0*b2+a2*b3;out[3]=a1*b2+a3*b3;return out};mat2.mul=mat2.multiply;mat2.rotate=function(out,a,rad){var a0=a[0],a1=a[1],a2=a[2],a3=a[3],s=Math.sin(rad),c=Math.cos(rad);out[0]=a0*c+a2*s;out[1]=a1*c+a3*s;out[2]=a0*-s+a2*c;out[3]=a1*-s+a3*c;return out};mat2.scale=function(out,a,v){var a0=a[0],a1=a[1],a2=a[2],a3=a[3],v0=v[0],v1=v[1];out[0]=a0*v0;out[1]=a1*v0;out[2]=a2*v1;out[3]=a3*v1;return out};mat2.str=function(a){return"mat2("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+")"};mat2.frob=function(a){return Math.sqrt(Math.pow(a[0],2)+Math.pow(a[1],2)+Math.pow(a[2],2)+Math.pow(a[3],2))};mat2.LDU=function(L,D,U,a){L[2]=a[2]/a[0];U[0]=a[0];U[1]=a[1];U[3]=a[3]-L[2]*U[1];return[L,D,U]};if(typeof exports!=="undefined"){exports.mat2=mat2}var mat2d={};mat2d.create=function(){var out=new GLMAT_ARRAY_TYPE(6);out[0]=1;out[1]=0;out[2]=0;out[3]=1;out[4]=0;out[5]=0;return out};mat2d.clone=function(a){var out=new GLMAT_ARRAY_TYPE(6);out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];out[4]=a[4];out[5]=a[5];return out};mat2d.copy=function(out,a){out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];out[4]=a[4];out[5]=a[5];return out};mat2d.identity=function(out){out[0]=1;out[1]=0;out[2]=0;out[3]=1;out[4]=0;out[5]=0;return out};mat2d.invert=function(out,a){var aa=a[0],ab=a[1],ac=a[2],ad=a[3],atx=a[4],aty=a[5];var det=aa*ad-ab*ac;if(!det){return null}det=1/det;out[0]=ad*det;out[1]=-ab*det;out[2]=-ac*det;out[3]=aa*det;out[4]=(ac*aty-ad*atx)*det;out[5]=(ab*atx-aa*aty)*det;return out};mat2d.determinant=function(a){return a[0]*a[3]-a[1]*a[2]};mat2d.multiply=function(out,a,b){var a0=a[0],a1=a[1],a2=a[2],a3=a[3],a4=a[4],a5=a[5],b0=b[0],b1=b[1],b2=b[2],b3=b[3],b4=b[4],b5=b[5];out[0]=a0*b0+a2*b1;out[1]=a1*b0+a3*b1;out[2]=a0*b2+a2*b3;out[3]=a1*b2+a3*b3;out[4]=a0*b4+a2*b5+a4;out[5]=a1*b4+a3*b5+a5;return out};mat2d.mul=mat2d.multiply;mat2d.rotate=function(out,a,rad){var a0=a[0],a1=a[1],a2=a[2],a3=a[3],a4=a[4],a5=a[5],s=Math.sin(rad),c=Math.cos(rad);out[0]=a0*c+a2*s;out[1]=a1*c+a3*s;out[2]=a0*-s+a2*c;out[3]=a1*-s+a3*c;out[4]=a4;out[5]=a5;return out};mat2d.scale=function(out,a,v){var a0=a[0],a1=a[1],a2=a[2],a3=a[3],a4=a[4],a5=a[5],v0=v[0],v1=v[1];out[0]=a0*v0;out[1]=a1*v0;out[2]=a2*v1;out[3]=a3*v1;out[4]=a4;out[5]=a5;return out};mat2d.translate=function(out,a,v){var a0=a[0],a1=a[1],a2=a[2],a3=a[3],a4=a[4],a5=a[5],v0=v[0],v1=v[1];out[0]=a0;out[1]=a1;out[2]=a2;out[3]=a3;out[4]=a0*v0+a2*v1+a4;out[5]=a1*v0+a3*v1+a5;return out};mat2d.str=function(a){return"mat2d("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+")"};mat2d.frob=function(a){return Math.sqrt(Math.pow(a[0],2)+Math.pow(a[1],2)+Math.pow(a[2],2)+Math.pow(a[3],2)+Math.pow(a[4],2)+Math.pow(a[5],2)+1)};if(typeof exports!=="undefined"){exports.mat2d=mat2d}var mat3={};mat3.create=function(){var out=new GLMAT_ARRAY_TYPE(9);out[0]=1;out[1]=0;out[2]=0;out[3]=0;out[4]=1;out[5]=0;out[6]=0;out[7]=0;out[8]=1;return out};mat3.fromMat4=function(out,a){out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[4];out[4]=a[5];out[5]=a[6];out[6]=a[8];out[7]=a[9];out[8]=a[10];return out};mat3.clone=function(a){var out=new GLMAT_ARRAY_TYPE(9);out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];out[4]=a[4];out[5]=a[5];out[6]=a[6];out[7]=a[7];out[8]=a[8];return out};mat3.copy=function(out,a){out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];out[4]=a[4];out[5]=a[5];out[6]=a[6];out[7]=a[7];out[8]=a[8];return out};mat3.identity=function(out){out[0]=1;out[1]=0;out[2]=0;out[3]=0;out[4]=1;out[5]=0;out[6]=0;out[7]=0;out[8]=1;return out};mat3.transpose=function(out,a){if(out===a){var a01=a[1],a02=a[2],a12=a[5];out[1]=a[3];out[2]=a[6];out[3]=a01;out[5]=a[7];out[6]=a02;out[7]=a12}else{out[0]=a[0];out[1]=a[3];out[2]=a[6];out[3]=a[1];out[4]=a[4];out[5]=a[7];out[6]=a[2];out[7]=a[5];out[8]=a[8]}return out};mat3.invert=function(out,a){var a00=a[0],a01=a[1],a02=a[2],a10=a[3],a11=a[4],a12=a[5],a20=a[6],a21=a[7],a22=a[8],b01=a22*a11-a12*a21,b11=-a22*a10+a12*a20,b21=a21*a10-a11*a20,det=a00*b01+a01*b11+a02*b21;if(!det){return null}det=1/det;out[0]=b01*det;out[1]=(-a22*a01+a02*a21)*det;out[2]=(a12*a01-a02*a11)*det;out[3]=b11*det;out[4]=(a22*a00-a02*a20)*det;out[5]=(-a12*a00+a02*a10)*det;out[6]=b21*det;out[7]=(-a21*a00+a01*a20)*det;out[8]=(a11*a00-a01*a10)*det;return out};mat3.adjoint=function(out,a){var a00=a[0],a01=a[1],a02=a[2],a10=a[3],a11=a[4],a12=a[5],a20=a[6],a21=a[7],a22=a[8];out[0]=a11*a22-a12*a21;out[1]=a02*a21-a01*a22;out[2]=a01*a12-a02*a11;out[3]=a12*a20-a10*a22;out[4]=a00*a22-a02*a20;out[5]=a02*a10-a00*a12;out[6]=a10*a21-a11*a20;out[7]=a01*a20-a00*a21;out[8]=a00*a11-a01*a10;return out};mat3.determinant=function(a){var a00=a[0],a01=a[1],a02=a[2],a10=a[3],a11=a[4],a12=a[5],a20=a[6],a21=a[7],a22=a[8];return a00*(a22*a11-a12*a21)+a01*(-a22*a10+a12*a20)+a02*(a21*a10-a11*a20)};mat3.multiply=function(out,a,b){var a00=a[0],a01=a[1],a02=a[2],a10=a[3],a11=a[4],a12=a[5],a20=a[6],a21=a[7],a22=a[8],b00=b[0],b01=b[1],b02=b[2],b10=b[3],b11=b[4],b12=b[5],b20=b[6],b21=b[7],b22=b[8];out[0]=b00*a00+b01*a10+b02*a20;out[1]=b00*a01+b01*a11+b02*a21;out[2]=b00*a02+b01*a12+b02*a22;out[3]=b10*a00+b11*a10+b12*a20;out[4]=b10*a01+b11*a11+b12*a21;out[5]=b10*a02+b11*a12+b12*a22;out[6]=b20*a00+b21*a10+b22*a20;out[7]=b20*a01+b21*a11+b22*a21;out[8]=b20*a02+b21*a12+b22*a22;return out};mat3.mul=mat3.multiply;mat3.translate=function(out,a,v){var a00=a[0],a01=a[1],a02=a[2],a10=a[3],a11=a[4],a12=a[5],a20=a[6],a21=a[7],a22=a[8],x=v[0],y=v[1];out[0]=a00;out[1]=a01;out[2]=a02;out[3]=a10;out[4]=a11;out[5]=a12;out[6]=x*a00+y*a10+a20;out[7]=x*a01+y*a11+a21;out[8]=x*a02+y*a12+a22;return out};mat3.rotate=function(out,a,rad){var a00=a[0],a01=a[1],a02=a[2],a10=a[3],a11=a[4],a12=a[5],a20=a[6],a21=a[7],a22=a[8],s=Math.sin(rad),c=Math.cos(rad);out[0]=c*a00+s*a10;out[1]=c*a01+s*a11;out[2]=c*a02+s*a12;out[3]=c*a10-s*a00;out[4]=c*a11-s*a01;out[5]=c*a12-s*a02;out[6]=a20;out[7]=a21;out[8]=a22;return out};mat3.scale=function(out,a,v){var x=v[0],y=v[1];out[0]=x*a[0];out[1]=x*a[1];out[2]=x*a[2];out[3]=y*a[3];out[4]=y*a[4];out[5]=y*a[5];out[6]=a[6];out[7]=a[7];out[8]=a[8];return out};mat3.fromMat2d=function(out,a){out[0]=a[0];out[1]=a[1];out[2]=0;out[3]=a[2];out[4]=a[3];out[5]=0;out[6]=a[4];out[7]=a[5];out[8]=1;return out};mat3.fromQuat=function(out,q){var x=q[0],y=q[1],z=q[2],w=q[3],x2=x+x,y2=y+y,z2=z+z,xx=x*x2,yx=y*x2,yy=y*y2,zx=z*x2,zy=z*y2,zz=z*z2,wx=w*x2,wy=w*y2,wz=w*z2;out[0]=1-yy-zz;out[3]=yx-wz;out[6]=zx+wy;out[1]=yx+wz;out[4]=1-xx-zz;out[7]=zy-wx;out[2]=zx-wy;out[5]=zy+wx;out[8]=1-xx-yy;return out};mat3.normalFromMat4=function(out,a){var a00=a[0],a01=a[1],a02=a[2],a03=a[3],a10=a[4],a11=a[5],a12=a[6],a13=a[7],a20=a[8],a21=a[9],a22=a[10],a23=a[11],a30=a[12],a31=a[13],a32=a[14],a33=a[15],b00=a00*a11-a01*a10,b01=a00*a12-a02*a10,b02=a00*a13-a03*a10,b03=a01*a12-a02*a11,b04=a01*a13-a03*a11,b05=a02*a13-a03*a12,b06=a20*a31-a21*a30,b07=a20*a32-a22*a30,b08=a20*a33-a23*a30,b09=a21*a32-a22*a31,b10=a21*a33-a23*a31,b11=a22*a33-a23*a32,det=b00*b11-b01*b10+b02*b09+b03*b08-b04*b07+b05*b06;if(!det){return null}det=1/det;out[0]=(a11*b11-a12*b10+a13*b09)*det;out[1]=(a12*b08-a10*b11-a13*b07)*det;out[2]=(a10*b10-a11*b08+a13*b06)*det;out[3]=(a02*b10-a01*b11-a03*b09)*det;out[4]=(a00*b11-a02*b08+a03*b07)*det;out[5]=(a01*b08-a00*b10-a03*b06)*det;out[6]=(a31*b05-a32*b04+a33*b03)*det;out[7]=(a32*b02-a30*b05-a33*b01)*det;out[8]=(a30*b04-a31*b02+a33*b00)*det;return out};mat3.str=function(a){return"mat3("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+", "+a[6]+", "+a[7]+", "+a[8]+")"};mat3.frob=function(a){return Math.sqrt(Math.pow(a[0],2)+Math.pow(a[1],2)+Math.pow(a[2],2)+Math.pow(a[3],2)+Math.pow(a[4],2)+Math.pow(a[5],2)+Math.pow(a[6],2)+Math.pow(a[7],2)+Math.pow(a[8],2))};if(typeof exports!=="undefined"){exports.mat3=mat3}var mat4={};mat4.create=function(){var out=new GLMAT_ARRAY_TYPE(16);out[0]=1;out[1]=0;out[2]=0;out[3]=0;out[4]=0;out[5]=1;out[6]=0;out[7]=0;out[8]=0;out[9]=0;out[10]=1;out[11]=0;out[12]=0;out[13]=0;out[14]=0;out[15]=1;return out};mat4.clone=function(a){var out=new GLMAT_ARRAY_TYPE(16);out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];out[4]=a[4];out[5]=a[5];out[6]=a[6];out[7]=a[7];out[8]=a[8];out[9]=a[9];out[10]=a[10];out[11]=a[11];out[12]=a[12];out[13]=a[13];out[14]=a[14];out[15]=a[15];return out};mat4.copy=function(out,a){out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];out[4]=a[4];out[5]=a[5];out[6]=a[6];out[7]=a[7];out[8]=a[8];out[9]=a[9];out[10]=a[10];out[11]=a[11];out[12]=a[12];out[13]=a[13];out[14]=a[14];out[15]=a[15];return out};mat4.identity=function(out){out[0]=1;out[1]=0;out[2]=0;out[3]=0;out[4]=0;out[5]=1;out[6]=0;out[7]=0;out[8]=0;out[9]=0;out[10]=1;out[11]=0;out[12]=0;out[13]=0;out[14]=0;out[15]=1;return out};mat4.transpose=function(out,a){if(out===a){var a01=a[1],a02=a[2],a03=a[3],a12=a[6],a13=a[7],a23=a[11];out[1]=a[4];out[2]=a[8];out[3]=a[12];out[4]=a01;out[6]=a[9];out[7]=a[13];out[8]=a02;out[9]=a12;out[11]=a[14];out[12]=a03;out[13]=a13;out[14]=a23}else{out[0]=a[0];out[1]=a[4];out[2]=a[8];out[3]=a[12];out[4]=a[1];out[5]=a[5];out[6]=a[9];out[7]=a[13];out[8]=a[2];out[9]=a[6];out[10]=a[10];out[11]=a[14];out[12]=a[3];out[13]=a[7];out[14]=a[11];out[15]=a[15]}return out};mat4.invert=function(out,a){var a00=a[0],a01=a[1],a02=a[2],a03=a[3],a10=a[4],a11=a[5],a12=a[6],a13=a[7],a20=a[8],a21=a[9],a22=a[10],a23=a[11],a30=a[12],a31=a[13],a32=a[14],a33=a[15],b00=a00*a11-a01*a10,b01=a00*a12-a02*a10,b02=a00*a13-a03*a10,b03=a01*a12-a02*a11,b04=a01*a13-a03*a11,b05=a02*a13-a03*a12,b06=a20*a31-a21*a30,b07=a20*a32-a22*a30,b08=a20*a33-a23*a30,b09=a21*a32-a22*a31,b10=a21*a33-a23*a31,b11=a22*a33-a23*a32,det=b00*b11-b01*b10+b02*b09+b03*b08-b04*b07+b05*b06;if(!det){return null}det=1/det;out[0]=(a11*b11-a12*b10+a13*b09)*det;out[1]=(a02*b10-a01*b11-a03*b09)*det;out[2]=(a31*b05-a32*b04+a33*b03)*det;out[3]=(a22*b04-a21*b05-a23*b03)*det;out[4]=(a12*b08-a10*b11-a13*b07)*det;out[5]=(a00*b11-a02*b08+a03*b07)*det;out[6]=(a32*b02-a30*b05-a33*b01)*det;out[7]=(a20*b05-a22*b02+a23*b01)*det;out[8]=(a10*b10-a11*b08+a13*b06)*det;out[9]=(a01*b08-a00*b10-a03*b06)*det;out[10]=(a30*b04-a31*b02+a33*b00)*det;out[11]=(a21*b02-a20*b04-a23*b00)*det;out[12]=(a11*b07-a10*b09-a12*b06)*det;out[13]=(a00*b09-a01*b07+a02*b06)*det;out[14]=(a31*b01-a30*b03-a32*b00)*det;out[15]=(a20*b03-a21*b01+a22*b00)*det;return out};mat4.adjoint=function(out,a){var a00=a[0],a01=a[1],a02=a[2],a03=a[3],a10=a[4],a11=a[5],a12=a[6],a13=a[7],a20=a[8],a21=a[9],a22=a[10],a23=a[11],a30=a[12],a31=a[13],a32=a[14],a33=a[15];out[0]=a11*(a22*a33-a23*a32)-a21*(a12*a33-a13*a32)+a31*(a12*a23-a13*a22);out[1]=-(a01*(a22*a33-a23*a32)-a21*(a02*a33-a03*a32)+a31*(a02*a23-a03*a22));out[2]=a01*(a12*a33-a13*a32)-a11*(a02*a33-a03*a32)+a31*(a02*a13-a03*a12);out[3]=-(a01*(a12*a23-a13*a22)-a11*(a02*a23-a03*a22)+a21*(a02*a13-a03*a12));out[4]=-(a10*(a22*a33-a23*a32)-a20*(a12*a33-a13*a32)+a30*(a12*a23-a13*a22));out[5]=a00*(a22*a33-a23*a32)-a20*(a02*a33-a03*a32)+a30*(a02*a23-a03*a22);out[6]=-(a00*(a12*a33-a13*a32)-a10*(a02*a33-a03*a32)+a30*(a02*a13-a03*a12));out[7]=a00*(a12*a23-a13*a22)-a10*(a02*a23-a03*a22)+a20*(a02*a13-a03*a12);out[8]=a10*(a21*a33-a23*a31)-a20*(a11*a33-a13*a31)+a30*(a11*a23-a13*a21);out[9]=-(a00*(a21*a33-a23*a31)-a20*(a01*a33-a03*a31)+a30*(a01*a23-a03*a21));out[10]=a00*(a11*a33-a13*a31)-a10*(a01*a33-a03*a31)+a30*(a01*a13-a03*a11);out[11]=-(a00*(a11*a23-a13*a21)-a10*(a01*a23-a03*a21)+a20*(a01*a13-a03*a11));out[12]=-(a10*(a21*a32-a22*a31)-a20*(a11*a32-a12*a31)+a30*(a11*a22-a12*a21));out[13]=a00*(a21*a32-a22*a31)-a20*(a01*a32-a02*a31)+a30*(a01*a22-a02*a21);out[14]=-(a00*(a11*a32-a12*a31)-a10*(a01*a32-a02*a31)+a30*(a01*a12-a02*a11));out[15]=a00*(a11*a22-a12*a21)-a10*(a01*a22-a02*a21)+a20*(a01*a12-a02*a11);return out};mat4.determinant=function(a){var a00=a[0],a01=a[1],a02=a[2],a03=a[3],a10=a[4],a11=a[5],a12=a[6],a13=a[7],a20=a[8],a21=a[9],a22=a[10],a23=a[11],a30=a[12],a31=a[13],a32=a[14],a33=a[15],b00=a00*a11-a01*a10,b01=a00*a12-a02*a10,b02=a00*a13-a03*a10,b03=a01*a12-a02*a11,b04=a01*a13-a03*a11,b05=a02*a13-a03*a12,b06=a20*a31-a21*a30,b07=a20*a32-a22*a30,b08=a20*a33-a23*a30,b09=a21*a32-a22*a31,b10=a21*a33-a23*a31,b11=a22*a33-a23*a32;return b00*b11-b01*b10+b02*b09+b03*b08-b04*b07+b05*b06};mat4.multiply=function(out,a,b){var a00=a[0],a01=a[1],a02=a[2],a03=a[3],a10=a[4],a11=a[5],a12=a[6],a13=a[7],a20=a[8],a21=a[9],a22=a[10],a23=a[11],a30=a[12],a31=a[13],a32=a[14],a33=a[15];var b0=b[0],b1=b[1],b2=b[2],b3=b[3];out[0]=b0*a00+b1*a10+b2*a20+b3*a30;out[1]=b0*a01+b1*a11+b2*a21+b3*a31;out[2]=b0*a02+b1*a12+b2*a22+b3*a32;out[3]=b0*a03+b1*a13+b2*a23+b3*a33;b0=b[4];b1=b[5];b2=b[6];b3=b[7];out[4]=b0*a00+b1*a10+b2*a20+b3*a30;out[5]=b0*a01+b1*a11+b2*a21+b3*a31;out[6]=b0*a02+b1*a12+b2*a22+b3*a32;out[7]=b0*a03+b1*a13+b2*a23+b3*a33;b0=b[8];b1=b[9];b2=b[10];b3=b[11];out[8]=b0*a00+b1*a10+b2*a20+b3*a30;out[9]=b0*a01+b1*a11+b2*a21+b3*a31;out[10]=b0*a02+b1*a12+b2*a22+b3*a32;out[11]=b0*a03+b1*a13+b2*a23+b3*a33;b0=b[12];b1=b[13];b2=b[14];b3=b[15];out[12]=b0*a00+b1*a10+b2*a20+b3*a30;out[13]=b0*a01+b1*a11+b2*a21+b3*a31;out[14]=b0*a02+b1*a12+b2*a22+b3*a32;out[15]=b0*a03+b1*a13+b2*a23+b3*a33;return out};mat4.mul=mat4.multiply;mat4.translate=function(out,a,v){var x=v[0],y=v[1],z=v[2],a00,a01,a02,a03,a10,a11,a12,a13,a20,a21,a22,a23;if(a===out){out[12]=a[0]*x+a[4]*y+a[8]*z+a[12];out[13]=a[1]*x+a[5]*y+a[9]*z+a[13];out[14]=a[2]*x+a[6]*y+a[10]*z+a[14];out[15]=a[3]*x+a[7]*y+a[11]*z+a[15]}else{a00=a[0];a01=a[1];a02=a[2];a03=a[3];a10=a[4];a11=a[5];a12=a[6];a13=a[7];a20=a[8];a21=a[9];a22=a[10];a23=a[11];out[0]=a00;out[1]=a01;out[2]=a02;out[3]=a03;out[4]=a10;out[5]=a11;out[6]=a12;out[7]=a13;out[8]=a20;out[9]=a21;out[10]=a22;out[11]=a23;out[12]=a00*x+a10*y+a20*z+a[12];out[13]=a01*x+a11*y+a21*z+a[13];out[14]=a02*x+a12*y+a22*z+a[14];out[15]=a03*x+a13*y+a23*z+a[15]}return out};mat4.scale=function(out,a,v){var x=v[0],y=v[1],z=v[2];out[0]=a[0]*x;out[1]=a[1]*x;out[2]=a[2]*x;out[3]=a[3]*x;out[4]=a[4]*y;out[5]=a[5]*y;out[6]=a[6]*y;out[7]=a[7]*y;out[8]=a[8]*z;out[9]=a[9]*z;out[10]=a[10]*z;out[11]=a[11]*z;out[12]=a[12];out[13]=a[13];out[14]=a[14];out[15]=a[15];return out};mat4.rotate=function(out,a,rad,axis){var x=axis[0],y=axis[1],z=axis[2],len=Math.sqrt(x*x+y*y+z*z),s,c,t,a00,a01,a02,a03,a10,a11,a12,a13,a20,a21,a22,a23,b00,b01,b02,b10,b11,b12,b20,b21,b22;if(Math.abs(len)<GLMAT_EPSILON){return null}len=1/len;x*=len;y*=len;z*=len;s=Math.sin(rad);c=Math.cos(rad);t=1-c;a00=a[0];a01=a[1];a02=a[2];a03=a[3];a10=a[4];a11=a[5];a12=a[6];a13=a[7];a20=a[8];a21=a[9];a22=a[10];a23=a[11];b00=x*x*t+c;b01=y*x*t+z*s;b02=z*x*t-y*s;b10=x*y*t-z*s;b11=y*y*t+c;b12=z*y*t+x*s;b20=x*z*t+y*s;b21=y*z*t-x*s;b22=z*z*t+c;out[0]=a00*b00+a10*b01+a20*b02;out[1]=a01*b00+a11*b01+a21*b02;out[2]=a02*b00+a12*b01+a22*b02;out[3]=a03*b00+a13*b01+a23*b02;out[4]=a00*b10+a10*b11+a20*b12;out[5]=a01*b10+a11*b11+a21*b12;out[6]=a02*b10+a12*b11+a22*b12;out[7]=a03*b10+a13*b11+a23*b12;out[8]=a00*b20+a10*b21+a20*b22;out[9]=a01*b20+a11*b21+a21*b22;out[10]=a02*b20+a12*b21+a22*b22;out[11]=a03*b20+a13*b21+a23*b22;if(a!==out){out[12]=a[12];out[13]=a[13];out[14]=a[14];out[15]=a[15]}return out};mat4.rotateX=function(out,a,rad){var s=Math.sin(rad),c=Math.cos(rad),a10=a[4],a11=a[5],a12=a[6],a13=a[7],a20=a[8],a21=a[9],a22=a[10],a23=a[11];if(a!==out){out[0]=a[0];out[1]=a[1];out[2]=a[2];out[3]=a[3];out[12]=a[12];out[13]=a[13];out[14]=a[14];out[15]=a[15]}out[4]=a10*c+a20*s;out[5]=a11*c+a21*s;out[6]=a12*c+a22*s;out[7]=a13*c+a23*s;out[8]=a20*c-a10*s;out[9]=a21*c-a11*s;out[10]=a22*c-a12*s;out[11]=a23*c-a13*s;return out};mat4.rotateY=function(out,a,rad){var s=Math.sin(rad),c=Math.cos(rad),a00=a[0],a01=a[1],a02=a[2],a03=a[3],a20=a[8],a21=a[9],a22=a[10],a23=a[11];if(a!==out){out[4]=a[4];out[5]=a[5];out[6]=a[6];out[7]=a[7];out[12]=a[12];out[13]=a[13];out[14]=a[14];out[15]=a[15]}out[0]=a00*c-a20*s;out[1]=a01*c-a21*s;out[2]=a02*c-a22*s;out[3]=a03*c-a23*s;out[8]=a00*s+a20*c;out[9]=a01*s+a21*c;out[10]=a02*s+a22*c;out[11]=a03*s+a23*c;return out};mat4.rotateZ=function(out,a,rad){var s=Math.sin(rad),c=Math.cos(rad),a00=a[0],a01=a[1],a02=a[2],a03=a[3],a10=a[4],a11=a[5],a12=a[6],a13=a[7];if(a!==out){out[8]=a[8];out[9]=a[9];out[10]=a[10];out[11]=a[11];out[12]=a[12];out[13]=a[13];out[14]=a[14];out[15]=a[15]}out[0]=a00*c+a10*s;out[1]=a01*c+a11*s;out[2]=a02*c+a12*s;out[3]=a03*c+a13*s;out[4]=a10*c-a00*s;out[5]=a11*c-a01*s;out[6]=a12*c-a02*s;out[7]=a13*c-a03*s;return out};mat4.fromRotationTranslation=function(out,q,v){var x=q[0],y=q[1],z=q[2],w=q[3],x2=x+x,y2=y+y,z2=z+z,xx=x*x2,xy=x*y2,xz=x*z2,yy=y*y2,yz=y*z2,zz=z*z2,wx=w*x2,wy=w*y2,wz=w*z2;out[0]=1-(yy+zz);out[1]=xy+wz;out[2]=xz-wy;out[3]=0;out[4]=xy-wz;out[5]=1-(xx+zz);out[6]=yz+wx;out[7]=0;out[8]=xz+wy;out[9]=yz-wx;out[10]=1-(xx+yy);out[11]=0;out[12]=v[0];out[13]=v[1];out[14]=v[2];out[15]=1;return out};mat4.fromQuat=function(out,q){var x=q[0],y=q[1],z=q[2],w=q[3],x2=x+x,y2=y+y,z2=z+z,xx=x*x2,yx=y*x2,yy=y*y2,zx=z*x2,zy=z*y2,zz=z*z2,wx=w*x2,wy=w*y2,wz=w*z2;out[0]=1-yy-zz;out[1]=yx+wz;out[2]=zx-wy;out[3]=0;out[4]=yx-wz;out[5]=1-xx-zz;out[6]=zy+wx;out[7]=0;out[8]=zx+wy;out[9]=zy-wx;out[10]=1-xx-yy;out[11]=0;out[12]=0;out[13]=0;out[14]=0;out[15]=1;return out};mat4.frustum=function(out,left,right,bottom,top,near,far){var rl=1/(right-left),tb=1/(top-bottom),nf=1/(near-far);out[0]=near*2*rl;out[1]=0;out[2]=0;out[3]=0;out[4]=0;out[5]=near*2*tb;out[6]=0;out[7]=0;out[8]=(right+left)*rl;out[9]=(top+bottom)*tb;out[10]=(far+near)*nf;out[11]=-1;out[12]=0;out[13]=0;out[14]=far*near*2*nf;out[15]=0;return out};mat4.perspective=function(out,fovy,aspect,near,far){var f=1/Math.tan(fovy/2),nf=1/(near-far);out[0]=f/aspect;out[1]=0;out[2]=0;out[3]=0;out[4]=0;out[5]=f;out[6]=0;out[7]=0;out[8]=0;out[9]=0;out[10]=(far+near)*nf;out[11]=-1;out[12]=0;out[13]=0;out[14]=2*far*near*nf;out[15]=0;return out};mat4.ortho=function(out,left,right,bottom,top,near,far){var lr=1/(left-right),bt=1/(bottom-top),nf=1/(near-far);out[0]=-2*lr;out[1]=0;out[2]=0;out[3]=0;out[4]=0;out[5]=-2*bt;out[6]=0;out[7]=0;out[8]=0;out[9]=0;out[10]=2*nf;out[11]=0;out[12]=(left+right)*lr;out[13]=(top+bottom)*bt;out[14]=(far+near)*nf;out[15]=1;return out};mat4.lookAt=function(out,eye,center,up){var x0,x1,x2,y0,y1,y2,z0,z1,z2,len,eyex=eye[0],eyey=eye[1],eyez=eye[2],upx=up[0],upy=up[1],upz=up[2],centerx=center[0],centery=center[1],centerz=center[2];if(Math.abs(eyex-centerx)<GLMAT_EPSILON&&Math.abs(eyey-centery)<GLMAT_EPSILON&&Math.abs(eyez-centerz)<GLMAT_EPSILON){return mat4.identity(out)}z0=eyex-centerx;z1=eyey-centery;z2=eyez-centerz;len=1/Math.sqrt(z0*z0+z1*z1+z2*z2);z0*=len;z1*=len;z2*=len;x0=upy*z2-upz*z1;x1=upz*z0-upx*z2;x2=upx*z1-upy*z0;len=Math.sqrt(x0*x0+x1*x1+x2*x2);if(!len){x0=0;x1=0;x2=0}else{len=1/len;x0*=len;x1*=len;x2*=len}y0=z1*x2-z2*x1;y1=z2*x0-z0*x2;y2=z0*x1-z1*x0;len=Math.sqrt(y0*y0+y1*y1+y2*y2);if(!len){y0=0;y1=0;y2=0}else{len=1/len;y0*=len;y1*=len;y2*=len}out[0]=x0;out[1]=y0;out[2]=z0;out[3]=0;out[4]=x1;out[5]=y1;out[6]=z1;out[7]=0;out[8]=x2;out[9]=y2;out[10]=z2;out[11]=0;out[12]=-(x0*eyex+x1*eyey+x2*eyez);out[13]=-(y0*eyex+y1*eyey+y2*eyez);out[14]=-(z0*eyex+z1*eyey+z2*eyez);out[15]=1;return out};mat4.str=function(a){return"mat4("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+", "+a[6]+", "+a[7]+", "+a[8]+", "+a[9]+", "+a[10]+", "+a[11]+", "+a[12]+", "+a[13]+", "+a[14]+", "+a[15]+")"};mat4.frob=function(a){return Math.sqrt(Math.pow(a[0],2)+Math.pow(a[1],2)+Math.pow(a[2],2)+Math.pow(a[3],2)+Math.pow(a[4],2)+Math.pow(a[5],2)+Math.pow(a[6],2)+Math.pow(a[6],2)+Math.pow(a[7],2)+Math.pow(a[8],2)+Math.pow(a[9],2)+Math.pow(a[10],2)+Math.pow(a[11],2)+Math.pow(a[12],2)+Math.pow(a[13],2)+Math.pow(a[14],2)+Math.pow(a[15],2))};if(typeof exports!=="undefined"){exports.mat4=mat4}var quat={};quat.create=function(){var out=new GLMAT_ARRAY_TYPE(4);out[0]=0;out[1]=0;out[2]=0;out[3]=1;return out};quat.rotationTo=function(){var tmpvec3=vec3.create();var xUnitVec3=vec3.fromValues(1,0,0);var yUnitVec3=vec3.fromValues(0,1,0);return function(out,a,b){var dot=vec3.dot(a,b);if(dot<-.999999){vec3.cross(tmpvec3,xUnitVec3,a);if(vec3.length(tmpvec3)<1e-6)vec3.cross(tmpvec3,yUnitVec3,a);vec3.normalize(tmpvec3,tmpvec3);quat.setAxisAngle(out,tmpvec3,Math.PI);return out}else if(dot>.999999){out[0]=0;out[1]=0;out[2]=0;out[3]=1;return out}else{vec3.cross(tmpvec3,a,b);out[0]=tmpvec3[0];out[1]=tmpvec3[1];out[2]=tmpvec3[2];out[3]=1+dot;return quat.normalize(out,out)}}}();quat.setAxes=function(){var matr=mat3.create();return function(out,view,right,up){matr[0]=right[0];matr[3]=right[1];matr[6]=right[2];matr[1]=up[0];matr[4]=up[1];matr[7]=up[2];matr[2]=-view[0];matr[5]=-view[1];matr[8]=-view[2];return quat.normalize(out,quat.fromMat3(out,matr))}}();quat.clone=vec4.clone;quat.fromValues=vec4.fromValues;quat.copy=vec4.copy;quat.set=vec4.set;quat.identity=function(out){out[0]=0;out[1]=0;out[2]=0;out[3]=1;return out};quat.setAxisAngle=function(out,axis,rad){rad=rad*.5;var s=Math.sin(rad);out[0]=s*axis[0];out[1]=s*axis[1];out[2]=s*axis[2];out[3]=Math.cos(rad);return out};quat.add=vec4.add;quat.multiply=function(out,a,b){var ax=a[0],ay=a[1],az=a[2],aw=a[3],bx=b[0],by=b[1],bz=b[2],bw=b[3];out[0]=ax*bw+aw*bx+ay*bz-az*by;out[1]=ay*bw+aw*by+az*bx-ax*bz;out[2]=az*bw+aw*bz+ax*by-ay*bx;out[3]=aw*bw-ax*bx-ay*by-az*bz;return out};quat.mul=quat.multiply;quat.scale=vec4.scale;quat.rotateX=function(out,a,rad){rad*=.5;var ax=a[0],ay=a[1],az=a[2],aw=a[3],bx=Math.sin(rad),bw=Math.cos(rad);out[0]=ax*bw+aw*bx;out[1]=ay*bw+az*bx;out[2]=az*bw-ay*bx;out[3]=aw*bw-ax*bx;return out};quat.rotateY=function(out,a,rad){rad*=.5;var ax=a[0],ay=a[1],az=a[2],aw=a[3],by=Math.sin(rad),bw=Math.cos(rad);out[0]=ax*bw-az*by;out[1]=ay*bw+aw*by;out[2]=az*bw+ax*by;out[3]=aw*bw-ay*by;return out};quat.rotateZ=function(out,a,rad){rad*=.5;var ax=a[0],ay=a[1],az=a[2],aw=a[3],bz=Math.sin(rad),bw=Math.cos(rad);out[0]=ax*bw+ay*bz;out[1]=ay*bw-ax*bz;out[2]=az*bw+aw*bz;out[3]=aw*bw-az*bz;return out};quat.calculateW=function(out,a){var x=a[0],y=a[1],z=a[2];out[0]=x;out[1]=y;out[2]=z;out[3]=-Math.sqrt(Math.abs(1-x*x-y*y-z*z));return out};quat.dot=vec4.dot;quat.lerp=vec4.lerp;quat.slerp=function(out,a,b,t){var ax=a[0],ay=a[1],az=a[2],aw=a[3],bx=b[0],by=b[1],bz=b[2],bw=b[3];var omega,cosom,sinom,scale0,scale1;cosom=ax*bx+ay*by+az*bz+aw*bw;if(cosom<0){cosom=-cosom;bx=-bx;by=-by;bz=-bz;bw=-bw}if(1-cosom>1e-6){omega=Math.acos(cosom);sinom=Math.sin(omega);scale0=Math.sin((1-t)*omega)/sinom;scale1=Math.sin(t*omega)/sinom}else{scale0=1-t;scale1=t}out[0]=scale0*ax+scale1*bx;out[1]=scale0*ay+scale1*by;out[2]=scale0*az+scale1*bz;out[3]=scale0*aw+scale1*bw;return out};quat.invert=function(out,a){var a0=a[0],a1=a[1],a2=a[2],a3=a[3],dot=a0*a0+a1*a1+a2*a2+a3*a3,invDot=dot?1/dot:0;out[0]=-a0*invDot;out[1]=-a1*invDot;out[2]=-a2*invDot;out[3]=a3*invDot;return out};quat.conjugate=function(out,a){out[0]=-a[0];out[1]=-a[1];out[2]=-a[2];out[3]=a[3];return out};quat.length=vec4.length;quat.len=quat.length;quat.squaredLength=vec4.squaredLength;quat.sqrLen=quat.squaredLength;quat.normalize=vec4.normalize;quat.fromMat3=function(out,m){var fTrace=m[0]+m[4]+m[8];var fRoot;if(fTrace>0){fRoot=Math.sqrt(fTrace+1);out[3]=.5*fRoot;fRoot=.5/fRoot;out[0]=(m[7]-m[5])*fRoot;out[1]=(m[2]-m[6])*fRoot;out[2]=(m[3]-m[1])*fRoot}else{var i=0;if(m[4]>m[0])i=1;if(m[8]>m[i*3+i])i=2;var j=(i+1)%3;var k=(i+2)%3;fRoot=Math.sqrt(m[i*3+i]-m[j*3+j]-m[k*3+k]+1);out[i]=.5*fRoot;fRoot=.5/fRoot;out[3]=(m[k*3+j]-m[j*3+k])*fRoot;out[j]=(m[j*3+i]+m[i*3+j])*fRoot;out[k]=(m[k*3+i]+m[i*3+k])*fRoot}return out};quat.str=function(a){return"quat("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+")"};if(typeof exports!=="undefined"){exports.quat=quat}})(shim.exports)})(this)},{}],"/Volumes/Storage/andrea/web/thesis/src/node_modules/mersennetwister/src/MersenneTwister.js":[function(require,module,exports){(function(root,factory){"use strict";if(typeof exports==="object"){module.exports=factory()}else if(typeof define==="function"&&define.amd){define(factory)}else{root.MersenneTwister=factory()}})(this,function(){"use strict";var MAX_INT=4294967296,N=624,M=397,UPPER_MASK=2147483648,LOWER_MASK=2147483647,MATRIX_A=2567483615;var MersenneTwister=function(seed){if(typeof seed==="undefined"){seed=(new Date).getTime()}this.mt=new Array(N);this.mti=N+1;this.seed(seed)};MersenneTwister.prototype.seed=function(seed){var s;this.mt[0]=seed>>>0;for(this.mti=1;this.mti<N;this.mti++){s=this.mt[this.mti-1]^this.mt[this.mti-1]>>>30;this.mt[this.mti]=(((s&4294901760)>>>16)*1812433253<<16)+(s&65535)*1812433253+this.mti;this.mt[this.mti]>>>=0}};MersenneTwister.prototype.seedArray=function(vector){var i=1,j=0,k=N>vector.length?N:vector.length,s;this.seed(19650218);for(;k>0;k--){s=this.mt[i-1]^this.mt[i-1]>>>30;this.mt[i]=(this.mt[i]^(((s&4294901760)>>>16)*1664525<<16)+(s&65535)*1664525)+vector[j]+j;this.mt[i]>>>=0;i++;j++;if(i>=N){this.mt[0]=this.mt[N-1];i=1}if(j>=vector.length){j=0}}for(k=N-1;k;k--){s=this.mt[i-1]^this.mt[i-1]>>>30;this.mt[i]=(this.mt[i]^(((s&4294901760)>>>16)*1566083941<<16)+(s&65535)*1566083941)-i;this.mt[i]>>>=0;i++;if(i>=N){this.mt[0]=this.mt[N-1];i=1}}this.mt[0]=2147483648};MersenneTwister.prototype.int=function(){var y,kk,mag01=new Array(0,MATRIX_A);if(this.mti>=N){if(this.mti===N+1){this.seed(5489)}for(kk=0;kk<N-M;kk++){y=this.mt[kk]&UPPER_MASK|this.mt[kk+1]&LOWER_MASK;this.mt[kk]=this.mt[kk+M]^y>>>1^mag01[y&1]}for(;kk<N-1;kk++){y=this.mt[kk]&UPPER_MASK|this.mt[kk+1]&LOWER_MASK;this.mt[kk]=this.mt[kk+(M-N)]^y>>>1^mag01[y&1]}y=this.mt[N-1]&UPPER_MASK|this.mt[0]&LOWER_MASK;this.mt[N-1]=this.mt[M-1]^y>>>1^mag01[y&1];this.mti=0}y=this.mt[this.mti++];y^=y>>>11;y^=y<<7&2636928640;y^=y<<15&4022730752;y^=y>>>18;return y>>>0};MersenneTwister.prototype.int31=function(){return this.int()>>>1};MersenneTwister.prototype.real=function(){return this.int()*(1/(MAX_INT-1))};MersenneTwister.prototype.realx=function(){return(this.int()+.5)*(1/MAX_INT)};MersenneTwister.prototype.rnd=function(){return this.int()*(1/MAX_INT)};MersenneTwister.prototype.random=MersenneTwister.prototype.rnd;

MersenneTwister.prototype.rndHiRes=function(){var a=this.int()>>>5,b=this.int()>>>6;return(a*67108864+b)*(1/9007199254740992)};var instance=new MersenneTwister;MersenneTwister.random=function(){return instance.rnd()};return MersenneTwister})},{}],"/Volumes/Storage/andrea/web/thesis/src/node_modules/stats-js/build/stats.min.js":[function(require,module,exports){var Stats=function(){var l=Date.now(),m=l,g=0,n=Infinity,o=0,h=0,p=Infinity,q=0,r=0,s=0,f=document.createElement("div");f.id="stats";f.addEventListener("mousedown",function(b){b.preventDefault();t(++s%2)},!1);f.style.cssText="width:80px;opacity:0.9;cursor:pointer";var a=document.createElement("div");a.id="fps";a.style.cssText="padding:0 0 3px 3px;text-align:left;background-color:#002";f.appendChild(a);var i=document.createElement("div");i.id="fpsText";i.style.cssText="color:#0ff;font-family:Helvetica,Arial,sans-serif;font-size:9px;font-weight:bold;line-height:15px";i.innerHTML="FPS";a.appendChild(i);var c=document.createElement("div");c.id="fpsGraph";c.style.cssText="position:relative;width:74px;height:30px;background-color:#0ff";for(a.appendChild(c);74>c.children.length;){var j=document.createElement("span");j.style.cssText="width:1px;height:30px;float:left;background-color:#113";c.appendChild(j)}var d=document.createElement("div");d.id="ms";d.style.cssText="padding:0 0 3px 3px;text-align:left;background-color:#020;display:none";f.appendChild(d);var k=document.createElement("div");k.id="msText";k.style.cssText="color:#0f0;font-family:Helvetica,Arial,sans-serif;font-size:9px;font-weight:bold;line-height:15px";k.innerHTML="MS";d.appendChild(k);var e=document.createElement("div");e.id="msGraph";e.style.cssText="position:relative;width:74px;height:30px;background-color:#0f0";for(d.appendChild(e);74>e.children.length;)j=document.createElement("span"),j.style.cssText="width:1px;height:30px;float:left;background-color:#131",e.appendChild(j);var t=function(b){s=b;switch(s){case 0:a.style.display="block";d.style.display="none";break;case 1:a.style.display="none",d.style.display="block"}};return{REVISION:12,domElement:f,setMode:t,begin:function(){l=Date.now()},end:function(){var b=Date.now();g=b-l;n=Math.min(n,g);o=Math.max(o,g);k.textContent=g+" MS ("+n+"-"+o+")";var a=Math.min(30,30-30*(g/200));e.appendChild(e.firstChild).style.height=a+"px";r++;b>m+1e3&&(h=Math.round(1e3*r/(b-m)),p=Math.min(p,h),q=Math.max(q,h),i.textContent=h+" FPS ("+p+"-"+q+")",a=Math.min(30,30-30*(h/100)),c.appendChild(c.firstChild).style.height=a+"px",m=b,r=0);return b},update:function(){l=this.end()}}};"object"===typeof module&&(module.exports=Stats)},{}],"/Volumes/Storage/andrea/web/thesis/src/scenes/MainScene.js":[function(require,module,exports){var glMatrix=require("gl-matrix"),Context=require("./../Context"),Mesh=require("./../lib/Mesh"),Geom=require("./../lib/Geom"),QuadTree=require("./../lib/QuadTree"),Loader=require("./../lib/Loader"),vec3=glMatrix.vec3,mat4=glMatrix.mat4,gl=Context.gl,BuildingSHG=require("../generators/BuildingSHG.js"),City=require("../generators/City.js");var computeBlockMesh=function(block,availColors){var vertices=[],normals=[],uvs=[],extra=[],lights=[],count=0;for(var j=0,n=block.lots.length;j<n;j++){var lot,h,angle,cx,cy,xm,xM,ym,yM;lot=block.lots[j];h=lot.height,angle=lot.angle,lot=lot.poly;cx=cy=0;xm=ym=Number.POSITIVE_INFINITY;xM=yM=Number.NEGATIVE_INFINITY;for(var k=0,K=lot.length;k<K;k++){var cur=lot[k];cx+=cur.x;cy+=cur.y;xm=Math.min(xm,cur.x);xM=Math.max(xM,cur.x);ym=Math.min(ym,cur.y);yM=Math.max(yM,cur.y)}cx/=lot.length;cy/=lot.length;var bldg=BuildingSHG.create({x:cx,y:cy,width:Math.abs(xM-xm)*.9,depth:Math.abs(yM-ym)*.9,angle:angle}),bldgGeom=bldg.geom,color=bldg.color;for(var l=0,L=bldgGeom.length;l<L;l++){var bg=bldgGeom[l];if(bg.sym==="LIGHT")lights.push(bg.lightPos);else for(var k=0,K=bg.vertices.length;k<K;k++){vertices.push(bg.vertices[k]);normals.push(bg.normals[k]);uvs.push(bg.uvs[k]);extra.push(color[k%3])}bldgGeom[l]=null}}return{mesh:new Mesh(vertices,normals,uvs,extra),lights:lights,x:block.x,y:block.y,w:block.w}};var city=new City(0),geom={quadtree:null,quadtreeLights:null,fixedMeshes:[]};var log=document.createElement("pre");log.style.background="white";log.style.color="black";log.style.position="absolute";log.style.right="1rem";log.style.top="7rem";Context.canvas.parentElement.appendChild(log);(function(){var vertices=[],normals=[],uvs=[],extra=[],count=0,block,blockq,lot,h,col,mI=0,meshes=[],blocks=[],lights=[],qtree,qtreeL;var blocksProgress=0,blocksCount=city.blocks.length;while(city.blocks.length){block=city.blocks.shift();setTimeout(function(){var m=computeBlockMesh(this);blocks.push(m);blocksProgress++;Loader.progress("Blocks",blocksProgress/blocksCount)}.bind(block),0)}Loader.subscribe("Blocks",function(geom,blocks){return function(){var xm,ym,xM,yM;xm=ym=Number.POSITIVE_INFINITY;xM=yM=Number.NEGATIVE_INFINITY;blocks.forEach(function(i){xm=Math.min(xm,i.x-i.w);xM=Math.max(xM,i.x+i.w);ym=Math.min(ym,i.y-i.w);yM=Math.max(yM,i.y+i.w)});var qx=Math.abs(xM-xm)/2,qy=Math.abs(yM-ym)/2;qtree=new QuadTree(qx,qy,Math.max(qx,qy),4);qtreeL=new QuadTree(qx,qy,Math.max(qx,qy),8);blocks.forEach(function(i){qtree.insert(i)});geom.quadtree=qtree;geom.quadtreeLights=qtreeL;console.log(geom.quadtreeLights.query(6,6,.25).length)}}(geom,blocks));vertices.push.apply(vertices,[-20,-.001,-20,-20,-.001,20,20,-.001,20,-20,-.001,-20,20,-.001,20,20,-.001,-20]);normals.push.apply(normals,[0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0]);uvs.push.apply(uvs,[0,0,3,0,40,3,40,40,3,0,0,3,40,40,3,40,0,3]);extra.push.apply(extra,[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]);var roadQuads=city.roadQuads.reduce(function(){var N,U;N=[0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0];U=[0,0,2,0,1,2,1,1,2,0,0,2,1,1,2,1,0,2];return function(out,i){var aa=i[0],bb=i[1],slope=Math.atan2(bb.y-aa.y,bb.x-aa.x)+Math.PI/2,dx=Math.abs(.09*Math.cos(slope)),dy=Math.abs(.09*Math.sin(slope)),a={x:aa.x+dy,y:aa.y+dx},b={x:bb.x-dy,y:bb.y-dx},len=Math.sqrt(Math.pow(b.y-a.y,2)+Math.pow(b.x-a.x,2));var vertices=[a.x-dx,0,a.y-dy,b.x-dx,0,b.y-dy,b.x+dx,0,b.y+dy,a.x-dx,0,a.y-dy,b.x+dx,0,b.y+dy,a.x+dx,0,a.y+dy],uvs=U.map(function(i,idx){switch(idx%3){case 0:return i;break;case 1:return i*len;break;default:return i}return i});for(var k=0,K=vertices.length;k<K;k++){out.vertices.push(vertices[k]);out.normals.push(N[k]);out.uvs.push(uvs[k]);out.extra.push(0)}return out}}(),{vertices:[],normals:[],uvs:[],extra:[]});for(var k=0,K=roadQuads.vertices.length;k<K;k++){vertices.push(roadQuads.vertices[k]);normals.push(roadQuads.normals[k]);uvs.push(roadQuads.uvs[k]);extra.push(roadQuads.extra[k])}geom.fixedMeshes=[new Mesh(vertices,normals,uvs,extra)]})();var scene={meshes:[],lights:[],lightPos:vec3.create(),view:mat4.create(),model:mat4.create(),count:0};console.log(geom);var t=0,pushFn=function(o,i){o.push(i);return o},x=6,y=.05,z=6,alpha=0,beta=0,dx=0,dz=0;var tlerp=function(start,end,ts){return(ts-start)/(end-start)};var lerp=function(a,b,t){return a*(1-t)+b*t};var polyEasing=function(x){return x*x*x*(x*(6*x-15)+10)};var calcPositions=function(ts){log.textContent=parseInt(ts);if(ts<5e3){var t=polyEasing(tlerp(0,5e3,ts));y=lerp(20,.05,t)}if(ts>=4e3&&ts<5e3){var t=polyEasing(tlerp(4e3,5e3,ts));alpha=lerp(Math.PI/2,0,t);beta=lerp(0,Math.PI,t)}if(ts>=4e3&&ts<2e4){var t=polyEasing(tlerp(4e3,2e4,ts));x=lerp(6,10,t)}if(ts>=5e3&&ts<19500){var t=polyEasing(tlerp(5e3,2e4,ts));beta=lerp(Math.PI,Math.PI*3/2,t)}if(ts>=19500&&ts<20500){var t=polyEasing(tlerp(19500,20500,ts));alpha=lerp(0,-Math.PI/2,t)}if(ts>=2e4&&ts<22500){var t=polyEasing(tlerp(2e4,22500,ts));beta=lerp(Math.PI*3/2,Math.PI,t);y=lerp(.05,1.05,t);z=lerp(6,0,t)}if(ts>=20500&&ts<22500){var t=polyEasing(tlerp(20500,22500,ts));alpha=lerp(-Math.PI/2,0,t)}if(ts>=22500&&ts<3e4){var t=polyEasing(tlerp(22500,3e4,ts));z=lerp(0,14,t)}if(ts>=3e4){var t=tlerp(3e4,4e4,ts);z=0;alpha=Math.PI/8;x=lerp(12,0,t)}};scene.update=function(timestamp){x+=(Math.cos(beta)*dx-Math.sin(beta)*dz)*Math.cos(alpha);y+=Math.sin(alpha)*dz;z+=(Math.sin(beta)*dx+Math.cos(beta)*dz)*Math.cos(alpha);log.textContent=[x,y,z].map(function(i){return i.toFixed(2)}).join(", ")+" "+(Math.PI/alpha).toFixed(2)+" "+(Math.PI/beta).toFixed(2);vec3.set(scene.lightPos,6,.05,6);mat4.identity(scene.view);mat4.rotateX(scene.view,scene.view,alpha);mat4.rotateY(scene.view,scene.view,beta);mat4.translate(scene.view,scene.view,[-x,-y,-z]);scene.meshes=geom.fixedMeshes.reduce(pushFn,[]);scene.meshes=geom.quadtree.query(x,z,4).map(function(i){return i.mesh}).reduce(pushFn,scene.meshes);scene.lights=geom.quadtreeLights.query(x,z,.5).map(function(i){return[i.l.x,i.l.y,i.l.z]});t+=.001};document.body.addEventListener("keydown",function(evt){switch(evt.which){case 87:dz=-.008;break;case 83:dz=.008;break;case 65:dx=-.008;break;case 68:dx=.008;break}});document.body.addEventListener("keyup",function(evt){switch(evt.which){case 87:dz=0;break;case 83:dz=0;break;case 65:dx=0;break;case 68:dx=0;break}});Context.canvas.addEventListener("mousedown",function(evt){var onMove,onUp,x0=evt.clientX,y0=evt.clientY;onMove=function(evt){var dx=evt.clientX-x0,dy=evt.clientY-y0;alpha+=dy*.005;beta+=dx*.005;x0=evt.clientX;y0=evt.clientY;log.textContent=[x,y,z].map(function(i){return i.toFixed(2)}).join(", ")+" "+(Math.PI/alpha).toFixed(2)+" "+(Math.PI/beta).toFixed(2)};onUp=function(evt){Context.canvas.removeEventListener("mousemove",onMove);Context.canvas.removeEventListener("mouseup",onUp)};Context.canvas.addEventListener("mousemove",onMove);Context.canvas.addEventListener("mouseup",onUp)});module.exports=scene},{"../generators/BuildingSHG.js":"/Volumes/Storage/andrea/web/thesis/src/generators/BuildingSHG.js","../generators/City.js":"/Volumes/Storage/andrea/web/thesis/src/generators/City.js","./../Context":"/Volumes/Storage/andrea/web/thesis/src/Context.js","./../lib/Geom":"/Volumes/Storage/andrea/web/thesis/src/lib/Geom.js","./../lib/Loader":"/Volumes/Storage/andrea/web/thesis/src/lib/Loader.js","./../lib/Mesh":"/Volumes/Storage/andrea/web/thesis/src/lib/Mesh.js","./../lib/QuadTree":"/Volumes/Storage/andrea/web/thesis/src/lib/QuadTree.js","gl-matrix":"/Volumes/Storage/andrea/web/thesis/src/node_modules/gl-matrix/dist/gl-matrix.js"}]},{},["/Volumes/Storage/andrea/web/thesis/src/main.js"]);