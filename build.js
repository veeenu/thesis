!function t(e,n,r){function i(a,s){if(!n[a]){if(!e[a]){var u="function"==typeof require&&require;if(!s&&u)return u(a,!0);if(o)return o(a,!0);var h=new Error("Cannot find module '"+a+"'");throw h.code="MODULE_NOT_FOUND",h}var l=n[a]={exports:{}};e[a][0].call(l.exports,function(t){var n=e[a][1][t];return i(n?n:t)},l,l.exports,t,e,n,r)}return n[a].exports}for(var o="function"==typeof require&&require,a=0;a<r.length;a++)i(r[a]);return i}({1:[function(t,e,n){var r=document.getElementById("thesis-canvas"),i=r.getContext("webgl"),o=r.getBoundingClientRect(),a=o.width,s=o.height;r.width=a,r.height=s,r.style.background="black",e.exports={canvas:r,gl:i,w:a,h:s,aspectRatio:a/s}},{}],2:[function(t,e,n){var r,i,o,a,s,u,h,l=(t("./lib/util.js"),t("./lib/glMatrixSubset")),c=(l.vec3,l.mat3),x=l.mat4,p=t("./Context"),f=p.gl,m=(t("./generators/BuildingSHG.js"),f.createProgram()),v=f.createProgram(),d=f.createProgram(),y=f.createProgram(),g=f.createShader(f.VERTEX_SHADER),z=f.createShader(f.FRAGMENT_SHADER),b=f.createShader(f.VERTEX_SHADER),E=f.createShader(f.FRAGMENT_SHADER),T=f.createShader(f.VERTEX_SHADER),M=f.createShader(f.FRAGMENT_SHADER),A=f.createShader(f.VERTEX_SHADER),w=f.createShader(f.FRAGMENT_SHADER);r="uniform mat4 projection, viewmodel;\nuniform mat3 normalM;\n\nattribute vec3 vertex, normal, uv, extra;\n\nvarying vec4 vPosition, clipPosition;\nvarying vec3 texUV, vNormal, vExtra;\n\nvoid main() {\n  \n  vec4 viewPos = viewmodel * vec4(vertex, 1.);\n  clipPosition = projection * viewPos;\n  gl_Position = clipPosition;\n\n  vPosition = viewPos;\n  vNormal = normalM * normal;\n  vExtra = extra;\n  texUV = uv;\n\n}\n\n",o="#extension GL_OES_standard_derivatives : require\n\nprecision highp float;\n\nuniform sampler2D mainScene, roomScene;\n\nvarying vec4 vPosition, clipPosition;\nvarying vec3 texUV, vNormal, vExtra;\n\n////////////////////////////////////////////////////////////////////////////////\n// https://github.com/ashima/webgl-noise/blob/master/src/noise2D.glsl         //\n////////////////////////////////////////////////////////////////////////////////\n\nvec3 mod289(vec3 x) { return x - floor(x * (1.0 / 289.0)) * 289.0; }\nvec2 mod289(vec2 x) { return x - floor(x * (1.0 / 289.0)) * 289.0; }\nvec3 permute(vec3 x) { return mod289(((x*34.0)+1.0)*x); }\nfloat snoise(vec2 v) {\n  const vec4 C = vec4(0.211324865405187,  // (3.0-sqrt(3.0))/6.0\n                      0.366025403784439,  // 0.5*(sqrt(3.0)-1.0)\n                     -0.577350269189626,  // -1.0 + 2.0 * C.x\n                      0.024390243902439); // 1.0 / 41.0\n  vec2 i  = floor(v + dot(v, C.yy) );\n  vec2 x0 = v -   i + dot(i, C.xx);\n  vec2 i1;\n  i1 = (x0.x > x0.y) ? vec2(1.0, 0.0) : vec2(0.0, 1.0);\n  vec4 x12 = x0.xyxy + C.xxzz;\n  x12.xy -= i1;\n  i = mod289(i);\n  vec3 p = permute( permute( i.y + vec3(0.0, i1.y, 1.0 ))\n		+ i.x + vec3(0.0, i1.x, 1.0 ));\n  vec3 m = max(0.5 - vec3(dot(x0,x0), dot(x12.xy,x12.xy), dot(x12.zw,x12.zw)), 0.0);\n  m = m*m ;\n  m = m*m ;\n  vec3 x = 2.0 * fract(p * C.www) - 1.0;\n  vec3 h = abs(x) - 0.5;\n  vec3 ox = floor(x + 0.5);\n  vec3 a0 = x - ox;\n  m *= 1.79284291400159 - 0.85373472095314 * ( a0*a0 + h*h );\n  vec3 g;\n  g.x  = a0.x  * x0.x  + h.x  * x0.y;\n  g.yz = a0.yz * x12.xz + h.yz * x12.yw;\n  return 130.0 * dot(m, g);\n}\n\n////////////////////////////////////////////////////////////////////////////////\n// Procedural textures\n////////////////////////////////////////////////////////////////////////////////\n\nvec3 bumpMap(vec3 fvert, vec3 fnorm, float bump) {\n\n  vec3 ddx = normalize(dFdx(fvert)),\n       ddy = normalize(dFdy(fvert)),\n       bU = dFdx(bump) * cross(fnorm, ddy),\n       bV = dFdy(bump) * cross(ddx, fnorm),\n       bD = fnorm + (bU + bV);\n\n  return normalize(bD);\n}\n\nstruct TTextureInfo {\n  vec3 color;\n  vec3 normal;\n};\n\n#define textureBrickI(x, p, notp) ((floor(x)*(p))+max(fract(x)-(notp), 0.0))\nTTextureInfo textureBrick(vec3 fvert, vec3 fnorm, float fdepth, vec2 uv, vec3 brickColor) {\n\n  const float bW  = .0625,\n              bH  = .03125,\n              mS  = 1. / 256.,\n              mWf = mS * .5 / bW,\n              mHf = mS * .5 / bH;\n  const vec3 mortarColor = vec3(.68, .68, .71);\n\n  float u = uv.s / bW,\n        v = uv.t / bH,\n        brU = floor(u),\n        brV = floor(v);\n\n  if(mod(v * .5, 1.) > .5)\n    u += .5;\n  brU = floor(u);\n\n  float noisev = 1. +\n                 snoise(uv * 256.) * .125;\n  float brickDamp = 1. + .125 * sin(1.57 * (brU + 1.)) * sin(2. * (brV + 1.));\n\n  vec2 uuv = vec2(u, v),\n       fw = 2. * vec2(fwidth(uuv.x), fwidth(uuv.y)),\n       mortarPct = vec2(mWf, mHf),\n       brickPct = vec2(1., 1.) - mortarPct,\n       ub = (textureBrickI(uuv + fw, brickPct, mortarPct) -\n             textureBrickI(uuv, brickPct, mortarPct)) / fw;\n\n  vec3 color = mix(mortarColor, brickColor * brickDamp, ub.x * ub.y);\n\n  // Adaptive box blur filter. Not perfect but quick and somewhat acceptable\n  vec2 ubSample, ubKernel = 4. * fwidth(ub), noiseKernel = fwidth(uv);\n  float bump = 0., invd = 1. / 11.;\n\n  for(int x = -1; x <= 1; x++) {\n    for(int y = -1; y <= 1; y++) {\n      ubSample = ub + vec2(float(x), float(y)) * ubKernel;\n      bump += .1111111 * ubSample.x * ubSample.y;\n    }\n  }\n\n  bump *= 1.75;\n\n  // Frequency clamping\n  bump -= 8. * (1. - smoothstep(0., .00125, max(noiseKernel.x, noiseKernel.y))) * noisev;\n\n  return TTextureInfo(\n    color,\n    bumpMap(fvert, fnorm, bump)\n  );\n}\n\n/******************************************************************************\\\n * Window texture\n\\******************************************************************************/\n\nTTextureInfo textureWindow(vec3 fvert, vec3 fnorm, float fdepth, vec2 uv, vec3 windowColor) {\n\n  const vec2 patternPct   = vec2(1., 1.),\n             patternStart = vec2(0., 0.), //(1. - patternPct) * .25,\n             patternEnd   = patternStart + patternPct,\n             framePct     = vec2(1. / 32., 1. / 32.),\n             frameStart   = patternStart + framePct,\n             frameEnd     = patternEnd   - framePct;\n  //const vec3 windowColor  = vec3(.8, .94, .99),\n  const vec3 frameColor   = vec3(.5, .5, .5);\n\n  vec2 fk   = fwidth(uv) * 2.,\n       uuv  = mod(uv, .5 - 1. / 64.),\n       patF = (smoothstep(frameEnd, frameEnd + fk, uuv) - smoothstep(frameStart, frameStart + fk, uuv));\n  float noisep = 1. + \n                snoise(-uv * .5) * .25;\n  float noisev = 1. + \n                 snoise(uv * 16.) * .0625 +\n                 abs(snoise(uv * 512.)) * .0625;\n\n  float bump = patF.x * patF.y;\n\n  return TTextureInfo(\n    mix(frameColor, windowColor * noisep, patF.x * patF.y),\n    bumpMap(fvert, fnorm, bump)\n  );\n}\n\n/******************************************************************************\\\n * Road texture\n\\******************************************************************************/\n\nvec3 textureRoad(vec2 uuv) {\n  const float padding = 1. / 32.,\n              tapeW   = 1. / 32.,\n              tapeL0  = padding,\n              tapeL1  = padding + tapeW,\n              tapeR1  = 1. - tapeL0,\n              tapeR0  = 1. - tapeL1,\n              tapeC0  = .5 - tapeW * .5,\n              tapeC1  = .5 + tapeW * .5,\n              vertDiv = 4.;\n  const vec3 asphaltColor = vec3(.2, .2, .2),\n             stripColor = vec3(.8, .8, .8);\n\n  vec2 uv = uuv + vec2(0, .5), fk = fwidth(uv);\n  float csSpacing = mod(.25 + uv.t * vertDiv, 1.),\n        q = \n    (\n      smoothstep(tapeL0, tapeL0 + fk.x, uv.s) - \n      smoothstep(tapeL1, tapeL1 + fk.x, uv.s)\n    ) +\n    (\n      smoothstep(tapeR0, tapeR0 + fk.x, uv.s) - \n      smoothstep(tapeR1, tapeR1 + fk.x, uv.s)\n    ) +\n    (\n      smoothstep(tapeC0, tapeC0 + fk.x, uv.s) - \n      smoothstep(tapeC1, tapeC1 + fk.x, uv.s)\n    ) * \n    (\n      smoothstep(.5 - fk.y, .5 + fk.y, csSpacing) *\n      (1. - smoothstep(1. - 2. * fk.y, 1., csSpacing))\n    )\n    ;\n\n  float noiseA = 1. +\n                 abs(snoise(uv * 16.))  * .0625 +\n                 abs(snoise(uv * 32.))  * .0625 +\n                 abs(snoise(uv * 128.)) * .125,\n        noiseS = 1. + \n                 abs(snoise(uv * 128.)) * .125;\n\n  return mix(asphaltColor * noiseA, stripColor * noiseS, q);\n}\n\nvec3 textureAsphalt(vec2 uuv) {\n  const vec3 asphaltColor = vec3(.2, .2, .2);\n\n  vec2 uv = uuv + vec2(0, .5);\n  float noiseA = 1. +\n                 abs(snoise(uv * 16.))  * .0625 +\n                 abs(snoise(uv * 32.))  * .0625 +\n                 abs(snoise(uv * 128.)) * .125;\n  return asphaltColor * 2.5 * noiseA;\n}\n\nvec3 textureWood(vec3 str) {\n  const vec3 color0 = vec3(.64, .48, .11),\n             color1 = vec3(.49, .34, .08);\n\n  float noise = \n    .5 * snoise(str.xz * .125) * snoise(str.xy * .125) +\n    .25 * (snoise(str.xz * .25) * snoise(str.xy * .25)) +\n    .125 * (snoise(str.xz * .5) * snoise(str.xy * .5)) +\n    .0625 * (snoise(str.xz) * snoise(str.xy));\n\n  return mix(color0, color1, mod(length(str.xz) + noise, 1.));\n}\n\n////////////////////////////////////////////////////////////////////////////////\n\nfloat packColor(vec3 v) {\n  const float u = 255. / 256.;\n\n  return fract(v.x * u) + floor(v.y * u * 255.) + floor(v.z * u * 255.) * 255.;\n}\n\nvec2 packNormal(in vec3 normal)\n{\n    const float SCALE = 1.7777;\n    float scalar1 = (normal.z + 1.0) * (SCALE * 2.0);\n    return normal.xy / scalar1 + 0.5;\n}\n\nvoid main() {\n\n  TTextureInfo ti;\n  vec3 color, normal;\n\n  float depth = clipPosition.z / clipPosition.w;\n\n  normal = normalize(faceforward(vNormal, gl_FragCoord.xyz, vNormal));\n\n  if(texUV.z > 7.1) {\n    color = texture2D(mainScene, texUV.xy).rgb;\n  }\n  else if(texUV.z > 6.1) {\n    color = textureWood(8. * (vExtra - .5));\n  }\n  else if(texUV.z > 5.1) {\n    ti = textureBrick(vPosition.xyz, vNormal, gl_FragCoord.z, mod(texUV.xy, 1.), vExtra);\n    color = ti.color;\n    normal = ti.normal;\n  }\n  else if(texUV.z > 4.1) {\n    ti = textureWindow(vPosition.xyz, vNormal, gl_FragCoord.z, mod(texUV.yx, 1.), vec3(1., 1., .7));\n    color = ti.color;\n    normal = ti.normal;\n  }\n  else if(texUV.z > 3.1) {\n    ti = textureWindow(vPosition.xyz, vNormal, gl_FragCoord.z, mod(texUV.yx, 1.), vec3(.3, .3, .3));\n    color = ti.color;\n    normal = ti.normal;\n  }\n  else if(texUV.z > 2.1)\n    color = textureAsphalt(mod(texUV.yx, 1.));\n  else if(texUV.z > 1.1)\n    color = textureRoad(mod(texUV.xy, 1.));\n  else\n    color = textureAsphalt(mod(texUV.yx, 1.));\n\n  color = clamp(.2 * color, 0., 1.);\n\n  gl_FragColor = vec4(packNormal(normalize(normal)), packColor(color), depth);\n}\n",i="uniform mat4 viewMatrix;\n\nattribute vec3 lightPos;\nattribute vec2 position;\nvarying vec2 sscoord, coord;\n\nvarying vec3 lPos;\n\nvoid main() {\n  gl_Position = vec4(position, 0., 1.);\n  coord = .5 + .5 * position;\n  sscoord = position;\n  lPos = (viewMatrix * vec4(lightPos, 1.)).xyz;\n}\n",a="#extension GL_OES_standard_derivatives : enable\nprecision highp float;\n\nuniform sampler2D target0;\nuniform mat4 inverseProjection, viewMatrix;\nuniform vec4 lightParameters;\n\nvarying vec2 sscoord, coord;\nvarying vec3 lPos;\n\nvec3 unpackColor(float d) {\n  vec3 ret;\n\n  ret.x = fract(d);\n  float zi = floor(d / 255.);\n  ret.z = fract(zi / 255.);\n  ret.y = fract( floor( d - ( zi * 255. ) ) / 255.);\n\n  return ret;\n}\n\nvec3 unpackNormal(in vec2 enc)\n{\n	const float SCALE = 1.7777;\n	vec2 nn = enc * (2.0 * SCALE) - SCALE;\n	float g = 2.0 / (dot(nn.xy, nn.xy) + 1.0);\n	vec3 normal;\n	normal.xy = g * nn.xy;\n	normal.z = g - 1.0;\n	return normal;\n}\n\n////////////////////////////////////////////////////////////////////////////////\n// Main\n////////////////////////////////////////////////////////////////////////////////\n\nvoid main() {\n\n  vec4 t0 = texture2D(target0, coord);\n  /*if(length(t0.xy) == 0.)\n    discard;*/\n\n  float depth = t0.w;\n\n  vec4 vertexFromDepth = inverseProjection * vec4(sscoord, depth, 1.);\n  vec3 vertex = vertexFromDepth.xyz / vertexFromDepth.w;\n  vec3 lightDir = lPos - vertex;\n\n  float dist = length(lightDir);\n  //if(dist > 2.)\n  //  discard;\n\n  vec3 normal = -normalize(unpackNormal(t0.xy)),\n       color  = unpackColor(t0.z);\n\n  float lambert = max(dot(faceforward(-normal, lightDir, normal), normalize(lightDir)), 0.),\n        att = lightParameters.x * min(1.,\n                1. /\n                (\n                  lightParameters.y + \n                  lightParameters.z * dist + \n                  lightParameters.w * dist * dist\n                )\n              );\n\n  gl_FragColor = vec4(lambert * att * color, 1.);\n  //gl_FragColor = vec4(color, 1.);\n\n}\n",vsrcSSAO="uniform mat4 viewMatrix;\n\nattribute vec2 position;\nvarying vec2 coord;\n\nvoid main() {\n  gl_Position = vec4(position, 0., 1.);\n  coord = .5 + .5 * position;\n}\n",s="#extension GL_OES_standard_derivatives : enable\nprecision highp float;\n\nuniform sampler2D target0, lightBuffer;\n\nvarying vec2 coord;\n\n#define DL 2.399963229728653\n#define EULER 2.718281828459045\n\nvec2 vrand( const vec2 coord ) {\n \n  vec2 noise;\n \n  float nx = dot ( coord, vec2( 12.9898, 78.233 ) );\n  float ny = dot ( coord, vec2( 12.9898, 78.233 ) * 2.0 );\n \n  noise = clamp( fract ( 43758.5453 * sin( vec2( nx, ny ) ) ), 0.0, 1.0 );\n \n  return ( noise * 2.0  - 1.0 ) * .0003;\n \n}\n\nfloat readDepth(const vec2 coord) {\n  return (96. * .001) / (1000.001 - texture2D(target0, coord).w * 999.999);\n}\n\nfloat cmpDepth(const float d1, const float d2, inout int far) {\n\n  float ga = 2., diff = (d1 - d2) * 100.;\n\n  if(diff < .4)\n    ga = .3;\n  else\n    far = 1;\n\n  float dd = diff - .4,\n        gauss = pow(EULER, -2. * dd * dd / (ga * ga));\n  \n  return gauss;\n}\n\nfloat calcAO(float depth, vec2 uv, float dw, float dh) {\n  float dd = 5. - depth * 5.;\n\n  vec2 vv = vec2(dw, dh),\n       coord1 = uv + dd * vv,\n       coord2 = uv - dd * vv;\n\n  int far = 0;\n  float tmp1 = 0., tmp2 = 0.;\n  \n  tmp1 = cmpDepth(depth, readDepth(coord1), far);\n  if(far > 0) {\n    tmp2 = cmpDepth(readDepth(coord2), depth, far);\n    tmp1 += (1. - tmp1) * tmp2;\n  }\n\n  return tmp1;\n}\n\nvoid main() {\n\n  vec3 color = texture2D(lightBuffer, coord).rgb;\n  float occlusion = 0., \n        vdepth = readDepth(coord),\n        tt = clamp(vdepth, .5, 1.);\n  vec2 noisev = vrand(coord);\n\n  float w = (1. / 1280.) / tt + (noisev.x * (1. - noisev.x)),\n        h = (1. / 800.)  / tt + (noisev.y * (1. - noisev.y)),\n        dz = 1. / 16.,\n        z = 1. - dz * .5,\n        l = 0.;\n  for(int i = 0; i < 16; i++) {\n    float r = sqrt(1. - z),\n          pw = cos(l) * r,\n          ph = sin(l) * r;\n    occlusion += calcAO(vdepth, coord, pw * w, ph * h);\n    z -= dz;\n    l += DL;\n  }\n\n  occlusion *= dz;\n\n  color = mix(color, vec3(0.), occlusion);\n  //color = pow(color, vec3(1. / 2.2));\n\n  gl_FragColor = vec4(color, 1.);\n\n  //gl_FragColor = vec4(lambert * att * 2.5 * color, 1.);\n}\n\n",u="attribute vec2 position;\nvarying vec2 coord;\n\nvoid main() {\n  gl_Position = vec4(position, 0., 1.);\n  coord = .5 + .5 * position;\n}\n",h="precision highp float;\n\nuniform sampler2D tex;\nvarying vec2 coord;\n\nvoid main() {\n\n  vec3 color = texture2D(tex, coord).rgb;\n\n  gl_FragColor = vec4(color, 1.);\n\n}\n\n",f.clearColor(0,0,0,0),f.depthFunc(f.LESS),f.blendFunc(f.ONE,f.ONE);var R,F;R=f.getExtension("OES_standard_derivatives"),F=f.getExtension("OES_texture_float"),f.shaderSource(g,r),f.shaderSource(z,o),f.compileShader(g),f.compileShader(z),f.attachShader(m,g),f.attachShader(m,z),f.linkProgram(m),f.shaderSource(T,vsrcSSAO),f.shaderSource(M,s),f.compileShader(T),f.compileShader(M),f.attachShader(d,T),f.attachShader(d,M),f.linkProgram(d),f.shaderSource(b,i),f.shaderSource(E,a),f.compileShader(b),f.compileShader(E),f.attachShader(v,b),f.attachShader(v,E),f.linkProgram(v),f.shaderSource(A,u),f.shaderSource(w,h),f.compileShader(A),f.compileShader(w),f.attachShader(y,A),f.attachShader(y,w),f.linkProgram(y);var I=document.createElement("pre");I.textContent=["VP:",f.getShaderInfoLog(g),"\nFP:",f.getShaderInfoLog(z),"\nLP:",f.getProgramInfoLog(m),"\nVL:",f.getShaderInfoLog(b),"\nFL:",f.getShaderInfoLog(E),"\nLL:",f.getProgramInfoLog(v),"\nVS:",f.getShaderInfoLog(T),"\nFS:",f.getShaderInfoLog(M),"\nLS:",f.getProgramInfoLog(d),"\nVT:",f.getShaderInfoLog(A),"\nFT:",f.getShaderInfoLog(w),"\nLT:",f.getProgramInfoLog(y),"\nExt:",null!==R?"OES_standard derivatives":"",null!==F?"OES_texture_float":""].join(" "),document.body.appendChild(I);var S=f.createTexture(),_=f.createTexture(),P=f.createRenderbuffer(),N=f.createFramebuffer(),D=f.createFramebuffer(),C=f.createFramebuffer();f.bindRenderbuffer(f.RENDERBUFFER,P),f.renderbufferStorage(f.RENDERBUFFER,f.DEPTH_COMPONENT16,p.w,p.h),f.bindTexture(f.TEXTURE_2D,S),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MAG_FILTER,f.NEAREST),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MIN_FILTER,f.NEAREST),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,f.CLAMP_TO_EDGE),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,f.CLAMP_TO_EDGE),f.texImage2D(f.TEXTURE_2D,0,f.RGBA,p.w,p.h,0,f.RGBA,f.FLOAT,null),f.bindTexture(f.TEXTURE_2D,_),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MAG_FILTER,f.NEAREST),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MIN_FILTER,f.NEAREST),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,f.CLAMP_TO_EDGE),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,f.CLAMP_TO_EDGE),f.texImage2D(f.TEXTURE_2D,0,f.RGBA,p.w,p.h,0,f.RGBA,f.UNSIGNED_BYTE,null),f.bindTexture(f.TEXTURE_2D,null),f.bindFramebuffer(f.FRAMEBUFFER,N),f.framebufferRenderbuffer(f.FRAMEBUFFER,f.DEPTH_ATTACHMENT,f.RENDERBUFFER,P),f.framebufferTexture2D(f.FRAMEBUFFER,f.COLOR_ATTACHMENT0,f.TEXTURE_2D,S,0),f.bindFramebuffer(f.FRAMEBUFFER,D),f.framebufferTexture2D(f.FRAMEBUFFER,f.COLOR_ATTACHMENT0,f.TEXTURE_2D,_,0),f.bindFramebuffer(f.FRAMEBUFFER,null);for(var L=f.createBuffer(),B=f.createBuffer(),U=new Float32Array(9216),G=[],X=x.create(),k=x.create(),O=0;512>O;O++)G.push(1,-1,-1,-1,-1,1,1,-1,-1,1,1,1);f.bindBuffer(f.ARRAY_BUFFER,L),f.bufferData(f.ARRAY_BUFFER,new Float32Array(G),f.STATIC_DRAW),f.bindBuffer(f.ARRAY_BUFFER,B),f.bufferData(f.ARRAY_BUFFER,U,f.STREAM_DRAW),f.bindBuffer(f.ARRAY_BUFFER,null),x.perspective(X,Math.PI/2,p.aspectRatio,.001,1e3),x.invert(k,X),["vertex","normal","uv","extra"].forEach(function(t){m[t]=f.getAttribLocation(m,t)}),["projection","viewmodel","normalM","mainScene","roomScene"].forEach(function(t){m[t]=f.getUniformLocation(m,t)}),["position","lightPos"].forEach(function(t){v[t]=f.getAttribLocation(v,t)}),["target0","lightParameters","inverseProjection","viewMatrix"].forEach(function(t){v[t]=f.getUniformLocation(v,t)}),["position"].forEach(function(t){y[t]=f.getAttribLocation(y,t)}),["tex"].forEach(function(t){y[t]=f.getUniformLocation(y,t)}),["position"].forEach(function(t){d[t]=f.getAttribLocation(d,t)}),["target0","lightBuffer"].forEach(function(t){d[t]=f.getUniformLocation(d,t)}),m.activate=function(t){f.useProgram(m),f.bindFramebuffer(f.FRAMEBUFFER,N),f.enable(f.DEPTH_TEST),f.clear(f.COLOR_BUFFER_BIT|f.DEPTH_BUFFER_BIT);var e=x.create(),n=c.create();x.mul(e,t.view,t.model),c.normalFromMat4(n,e),f.activeTexture(f.TEXTURE0),f.bindTexture(f.TEXTURE_2D,m.textures.mainScene),f.activeTexture(f.TEXTURE1),f.bindTexture(f.TEXTURE_2D,m.textures.roomScene),f.uniform1i(m.mainScene,0),f.uniform1i(m.roomScene,1),f.uniformMatrix4fv(m.projection,!1,X),f.uniformMatrix4fv(m.viewmodel,!1,e),f.uniformMatrix3fv(m.normalM,!1,n),f.enableVertexAttribArray(m.vertex),f.enableVertexAttribArray(m.normal),f.enableVertexAttribArray(m.uv),f.enableVertexAttribArray(m.extra),t.meshes.forEach(function(t){f.bindBuffer(f.ARRAY_BUFFER,t.vBuf),f.vertexAttribPointer(m.vertex,3,f.FLOAT,!1,0,0),f.bindBuffer(f.ARRAY_BUFFER,t.nBuf),f.vertexAttribPointer(m.normal,3,f.FLOAT,!1,0,0),f.bindBuffer(f.ARRAY_BUFFER,t.uBuf),f.vertexAttribPointer(m.uv,3,f.FLOAT,!1,0,0),f.bindBuffer(f.ARRAY_BUFFER,t.eBuf),f.vertexAttribPointer(m.extra,3,f.FLOAT,!1,0,0),f.drawArrays(f.TRIANGLES,0,t.count)})},m.deactivate=function(){f.bindFramebuffer(f.FRAMEBUFFER,null),f.disableVertexAttribArray(m.vertex),f.disableVertexAttribArray(m.normal),f.disableVertexAttribArray(m.uv),f.disableVertexAttribArray(m.extra),f.disable(f.DEPTH_TEST)},v.activate=function(t){f.useProgram(v),f.bindFramebuffer(f.FRAMEBUFFER,D),f.enable(f.BLEND),f.clear(f.COLOR_BUFFER_BIT),f.activeTexture(f.TEXTURE0),f.bindTexture(f.TEXTURE_2D,S),f.uniform1i(v.target0,0),f.uniform4fv(v.lightParameters,t.lightParameters),f.uniformMatrix4fv(v.viewMatrix,!1,t.view),f.uniformMatrix4fv(v.inverseProjection,!1,k),f.bindBuffer(f.ARRAY_BUFFER,L),f.vertexAttribPointer(v.position,2,f.FLOAT,!1,0,0),f.bindBuffer(f.ARRAY_BUFFER,B),f.vertexAttribPointer(v.lightPos,3,f.FLOAT,!1,0,0);var e=Math.min(t.lights.length,U.length),n=U.subarray(0,e);n.set(t.lights),f.bufferSubData(f.ARRAY_BUFFER,0,n),f.enableVertexAttribArray(v.position),f.enableVertexAttribArray(v.lightPos),f.drawArrays(f.TRIANGLES,0,e/3),f.enableVertexAttribArray(v.lightPosition)},v.deactivate=function(){f.bindFramebuffer(f.FRAMEBUFFER,null),f.disableVertexAttribArray(v.position),f.disableVertexAttribArray(v.lightPos),f.disable(f.BLEND)},d.activate=function(t){f.useProgram(d),f.bindFramebuffer(f.FRAMEBUFFER,C),f.framebufferTexture2D(f.FRAMEBUFFER,f.COLOR_ATTACHMENT0,f.TEXTURE_2D,t.texture,0),f.clear(f.COLOR_BUFFER_BIT),f.activeTexture(f.TEXTURE0),f.bindTexture(f.TEXTURE_2D,S),f.activeTexture(f.TEXTURE1),f.bindTexture(f.TEXTURE_2D,_),f.uniform1i(d.target0,0),f.uniform1i(d.lightBuffer,1),f.bindBuffer(f.ARRAY_BUFFER,L),f.vertexAttribPointer(d.position,2,f.FLOAT,!1,0,0),f.enableVertexAttribArray(d.position),f.drawArrays(f.TRIANGLES,0,6)},d.deactivate=function(){f.disableVertexAttribArray(d.position),f.bindFramebuffer(f.FRAMEBUFFER,null)},y.activate=function(t){f.useProgram(y),f.clear(f.COLOR_BUFFER_BIT),f.activeTexture(f.TEXTURE0),f.bindTexture(f.TEXTURE_2D,t),f.uniform1i(y.tex,0),f.bindBuffer(f.ARRAY_BUFFER,L),f.vertexAttribPointer(y.position,2,f.FLOAT,!1,0,0),f.enableVertexAttribArray(y.position),f.drawArrays(f.TRIANGLES,0,6)},e.exports={init:function(t,e){m.textures={mainScene:t.texture,roomScene:e.texture}},render:function(t){m.activate(t),m.deactivate(),v.activate(t),v.deactivate(),d.activate(t),d.deactivate(),y.activate(t.texture)}}},{"./Context":1,"./generators/BuildingSHG.js":5,"./lib/glMatrixSubset":17,"./lib/util.js":18}],3:[function(t,e,n){var r=t("./../lib/ShapeGrammar"),i=t("../lib/SHAPE.js"),o=t("./../lib/Geom"),a=(t("./PRNG"),new r),s=new r;a.define("Balcony",null,function(){var t=this.points,e={sym:"BalconyFloor",points:[{x:t[0].x,y:t[0].y,z:t[0].z},{x:t[1].x,y:t[1].y,z:t[1].z},{x:t[2].x,y:t[2].y,z:t[2].z},{x:t[3].x,y:t[3].y,z:t[3].z}],extrudeBorders:this.floorHeight},n={sym:"BalconyFloor",points:[{x:t[0].x,y:t[0].y+this.floorHeight,z:t[0].z},{x:t[1].x,y:t[1].y+this.floorHeight,z:t[1].z},{x:t[2].x,y:t[2].y+this.floorHeight,z:t[2].z},{x:t[3].x,y:t[3].y+this.floorHeight,z:t[3].z}]},r=i.extrudeAll(e.points,this.floorHeight,"TQuad"),o=i.extrudeAll(n.points,this.fenceHeight,"Fence");return o.pop(),r.push.apply(r,o),r.push(e,n),r}),a.define("BalconyFloor",null,function(){var t=i.splitXZ(this,[.8,.15,.05],[.05,.45,.5],"TQuad"),e=t.splice(4,1).shift().points;if("extrudeBorders"in this){var n=i.extrudeAll([{x:e[0].x,y:e[0].y,z:e[0].z},{x:e[1].x,y:e[1].y,z:e[1].z},{x:e[2].x,y:e[2].y,z:e[2].z},{x:e[3].x,y:e[3].y,z:e[3].z}],this.extrudeBorders,"TQuad");t.push.apply(t,n)}return t}),a.define("Fence",null,function(){var t=i.fit("x",this,"StickBase",.25),e=this.points[0],n=this.points[1],r=(this.points[2],this.points[3]),o=r.x-e.x,a=(n.y-e.y,r.z-e.z),s=Math.atan2(a,o)-Math.PI/2,u=(Math.sqrt(o*o+a*a),.05*Math.cos(s)),h=.05*Math.sin(s),l={sym:"TQuad",points:[{x:e.x,y:n.y,z:e.z},{x:e.x+u,y:n.y,z:e.z+h},{x:r.x+u,y:n.y,z:r.z+h},{x:r.x,y:n.y,z:r.z}]},c={sym:"TQuad",points:[{x:e.x,y:n.y+.05,z:e.z},{x:e.x+u,y:n.y+.05,z:e.z+h},{x:r.x+u,y:n.y+.05,z:r.z+h},{x:r.x,y:n.y+.05,z:r.z}]};t.push(l),t.push(c);var x=l.points;return t.push.apply(t,i.extrudeAll([{x:x[0].x,y:x[0].y,z:x[0].z},{x:x[1].x,y:x[1].y,z:x[1].z},{x:x[2].x,y:x[2].y,z:x[2].z},{x:x[3].x,y:x[3].y,z:x[3].z}],.05,"TQuad")),t}),a.define("StickBase",null,function(){var t=i.split(this,[.45,.1,.45],[1],null),e=t[1],n=e.points,r=n[3].x-n[0].x,o=n[1].y-n[0].y,a=n[3].z-n[0].z,s=Math.atan2(a,r)-Math.PI/2,u=Math.sqrt(r*r+a*a),h=Math.abs(o),l=Math.cos(s)*u,c=Math.sin(s)*u;return{sym:"Stick",points:[{x:n[0].x,y:n[0].y,z:n[0].z},{x:n[0].x+l,y:n[0].y,z:n[0].z+c},{x:n[3].x+l,y:n[0].y,z:n[3].z+c},{x:n[3].x,y:n[0].y,z:n[3].z}],stickHeight:h}}),a.define("Stick",null,function(){var t=this.points;return i.extrudeAll([{x:t[0].x,y:t[0].y,z:t[0].z},{x:t[1].x,y:t[1].y,z:t[1].z},{x:t[2].x,y:t[2].y,z:t[2].z},{x:t[3].x,y:t[3].y,z:t[3].z}],this.stickHeight,"TQuad")}),a.define("TQuad",null,function(){var t,e=[],n=[],i=[];this.uvs=this.uvs||[{s:0,t:1},{s:0,t:0},{s:1,t:0},{s:1,t:1}];var a=this.points[0],s=this.points[1],u=this.points[2],h=this.points[3];e=[a.x,a.y,a.z,s.x,s.y,s.z,u.x,u.y,u.z,a.x,a.y,a.z,u.x,u.y,u.z,h.x,h.y,h.z],i=[0,1,2,0,2,3].reduce(function(t,e){return t.push(this.uvs[e].s,this.uvs[e].t,this.texID||0),t}.bind(this),[]),t=o.triToNormal(e);for(var l=0;6>l;l++)n.push.apply(n,t);return{sym:r.TERMINAL,vertices:e,normals:n,uvs:i}}),s.define("Staircase",null,function(){for(var t=this.stairHeight+this.stairSpace,e=this.height/t,n=this.width/e,r=[],i=0;e>=i;i++)r.push({sym:"Stair",x:this.x+n*i,y:this.y+t*i,z:this.z,height:this.stairHeight,width:n,depth:this.stairDepth});return r.push({sym:"TQuad",points:[{x:this.x-n/2,y:this.y,z:this.z-this.stairDepth/2},{x:this.x-n/2+this.width,y:this.y+this.height,z:this.z-this.stairDepth/2},{x:this.x+n/2+this.width,y:this.y+this.height,z:this.z-this.stairDepth/2},{x:this.x+n/2,y:this.y,z:this.z-this.stairDepth/2}]},{sym:"TQuad",points:[{x:this.x-n/2,y:this.y,z:this.z+this.stairDepth/2},{x:this.x-n/2+this.width,y:this.y+this.height,z:this.z+this.stairDepth/2},{x:this.x+n/2+this.width,y:this.y+this.height,z:this.z+this.stairDepth/2},{x:this.x+n/2,y:this.y,z:this.z+this.stairDepth/2}]}),r}),s.define("Stair",null,function(){var t=this.width/2,e=this.height/2,n=this.depth/2,r=[{sym:"TQuad",points:[{x:this.x-t,y:this.y-e,z:this.z-n},{x:this.x-t,y:this.y-e,z:this.z+n},{x:this.x+t,y:this.y-e,z:this.z+n},{x:this.x+t,y:this.y-e,z:this.z-n}]},{sym:"TQuad",points:[{x:this.x-t,y:this.y+e,z:this.z-n},{x:this.x-t,y:this.y+e,z:this.z+n},{x:this.x+t,y:this.y+e,z:this.z+n},{x:this.x+t,y:this.y+e,z:this.z-n}]}];return r.push.apply(r,i.extrudeAll(r[0].points,this.height,"TQuad")),r}),s.define("TQuad",null,function(){var t,e=[],n=[],i=[];this.uvs=this.uvs||[{s:0,t:1},{s:0,t:0},{s:1,t:0},{s:1,t:1}];var a=this.points[0],s=this.points[1],u=this.points[2],h=this.points[3];e=[a.x,a.y,a.z,s.x,s.y,s.z,u.x,u.y,u.z,a.x,a.y,a.z,u.x,u.y,u.z,h.x,h.y,h.z],i=[0,1,2,0,2,3].reduce(function(t,e){return t.push(this.uvs[e].s,this.uvs[e].t,this.texID||0),t}.bind(this),[]),t=o.triToNormal(e);for(var l=0;6>l;l++)n.push.apply(n,t);return{sym:r.TERMINAL,vertices:e,normals:n,uvs:i}});var u,h;u=a.run({sym:"Balcony",points:[{x:-.5,y:0,z:0},{x:-.5,y:0,z:1},{x:.5,y:0,z:1},{x:.5,y:0,z:0}],floorHeight:.025,fenceHeight:.4}).reduce(function(t,e){for(var n=0,r=e.vertices.length;r>n;n++)t.vertices.push(e.vertices[n]),t.normals.push(e.normals[n]),t.uvs.push(e.uvs[n]);return t},{vertices:[],normals:[],uvs:[]}),h=s.run({sym:"Staircase",x:-0.2375,y:.0125,z:.35,height:1,width:.7,stairDepth:.2,stairHeight:.025,stairSpace:.0625}).reduce(function(t,e){for(var n=0,r=e.vertices.length;r>n;n++)t.vertices.push(e.vertices[n]),t.normals.push(e.normals[n]),t.uvs.push(e.uvs[n]);return t},{vertices:u.vertices.slice(),normals:u.normals.slice(),uvs:u.uvs.slice()});var l=function(t){var e=t.vertices,n=t.normals,r=t.uvs;return function(t){for(var i=t.angle,o=Math.cos(i),a=Math.sin(i),s=t.x1-t.x0,u=t.z1-t.z0,h=t.x0+s/2,l=t.z0+u/2,c=t.y,x=t.width,p=t.height,f=t.depth,m=e.length,v=new Float32Array(m),d=new Float32Array(m),y=new Float32Array(r),g=0;m>g;g+=3){var z=e[g]*x,b=e[g+1]*p+c,E=e[g+2]*f;v[g]=z*o+E*a+h,v[g+1]=b,v[g+2]=-z*a+E*o+l,z=n[g],b=n[g+1],E=n[g+2],z=z*o+E*a+h,E=-z*a+E*o+l,d[g]=z,d[g+1]=b,d[g+2]=E}return{vertices:v,normals:d,uvs:y}}};e.exports={createBalcony:l(u),createBalconyWithStairs:l(h)}},{"../lib/SHAPE.js":15,"./../lib/Geom":11,"./../lib/ShapeGrammar":16,"./PRNG":8}],4:[function(t,e,n){var r=t("./PRNG"),i=t("./../lib/Geom"),o=(t("./../lib/ShapeGrammar"),function(t,e,n){return(1-n)*t+n*e}),a=function(t,e,n){var r,a,u,h,l,c,x,p,f,m,v,d,y,g=[],z=[],b=[],E=[];for(p=0,v=t.length;v>p;p++)for(r=(p+1)%v,a=(p+2)%v,u=(p-1+v)%v,h=i.lineIntersection(t[p],t[r],e[u],e[p]),l=i.lineIntersection(t[p],t[r],e[r],e[a]),c=h.x-l.x,x=h.y-l.y,y=Math.sqrt(c*c+x*x),ang=Math.atan2(x,c),m=2,z.push(m),b.push(ang),f=0;m>f;f++){var T=f/(m-1);px1=o(h.x,l.x,T),py1=o(h.y,l.y,T),px2=o(e[p].x,e[r].x,T),py2=o(e[p].y,e[r].y,T),g.push({x:o(h.x,l.x,T),y:o(h.y,l.y,T)},{x:o(e[p].x,e[r].x,T),y:o(e[p].y,e[r].y,T)})}for(g.push(g[0]),p=0,v=t.length;v>p;p++){for(d=[],f=0;f<z[p];f++)d.push(g.shift()),d.push(g.shift());d.push(t[(p+1)%v]),d.push(g[0]||t[0]);for(var M=0,m=d.length;m-2>M;M+=2)E.push(new s([d[M],d[(M+1)%m],d[(M+3)%m],d[(M+2)%m]],n.random()+.5,b[p]))}return E},s=function(t,e,n){this.poly=t,this.height=e,this.angle=n},u=function(t,e){var n=new r(e);this.poly=t,this.block=i.insetPolygon(this.poly,.05),this.lots=a(i.insetPolygon(this.block,.1),i.insetPolygon(this.block,.6),n);var o=t.reduce(function(t,e){return t.cx+=e.x,t.cy+=e.y,t.xm>e.x&&(t.xm=e.x),t.xM<e.x&&(t.xM=e.x),t.ym>e.y&&(t.ym=e.y),t.yM<e.y&&(t.yM=e.y),t},{xm:Number.POSITIVE_INFINITY,ym:Number.POSITIVE_INFINITY,xM:Number.NEGATIVE_INFINITY,yM:Number.NEGATIVE_INFINITY,cx:0,cy:0});this.x=o.cx/t.length,this.y=o.cy/t.length,this.w=Math.max(Math.abs(o.xM-o.xm),Math.abs(o.yM-o.ym))};e.exports=u},{"./../lib/Geom":11,"./../lib/ShapeGrammar":16,"./PRNG":8}],5:[function(t,e,n){var r=t("./../lib/ShapeGrammar"),i=t("../lib/SHAPE.js"),o=t("earcut"),a=t("./../lib/Geom"),s=t("./PRNG"),u=t("./BalconySHG.js"),h=new r,l=new s(31337),c=new s(31338),x=new s(31339),p=new s(31337);h.define("Building",null,function(){for(var t=[],e=0,n=0,r=this.floorsLayout.length;r>n;n++){var i=this.floorsLayout[n],o={sym:i.type,height:i.height,params:i,points:this.points.map(function(t){return{x:t.x,y:t.y+e,z:t.z}}),facadeLayout:this.facadeLayout};"frontFacade"in this&&(o.frontFacade=this.frontFacade),"hasBalcony"in this&&(o.hasBalcony=this.hasBalcony),e+=i.height,t.push(o)}return t}),h.define("FL_GndFloor",null,function(){2*Math.PI;return function(){var t=i.extrudeAll(this.points,this.height,"Facade",[0,1,0]);this.params.frontSide;switch(this.params.tiles){case"OneDoor":for(var e=0,n=t.length;n>e;e++)t[e].type=this.facadeLayout[e]||"Windows";t[this.frontFacade].type="OneDoor"}return t}}()),h.define("FL_Floor",null,function(){for(var t=i.extrudeAll(this.points,this.height,"Facade",[0,1,0]),e=0,n=t.length;n>e;e++)t[e].type=this.facadeLayout[e]||"Windows",t[e].windows=this.params.windows;return"hasBalcony"in this&&(t[this.frontFacade].hasBalcony=this.hasBalcony),t}),h.define("FL_Ledge",null,function(){for(var t=[],e=this.height,n=this.points[0].y,r=0,o=this.points.length;o>r;r++){var s=this.points[r],u=this.points[(r+1)%o],l=Math.atan2(u.z-s.z,u.x-s.x),c=l-Math.PI/2;Math.cos(l)+Math.cos(c),Math.sin(l)+Math.sin(c)}t=a.insetPolygon(this.points.map(function(t){return{x:t.x,y:t.z}}),this.params.width).map(function(t){return{x:t.x,y:n,z:t.y}});var x=i.extrudeAll(t,this.height,"Quad",[0,1,0]);return x.forEach(function(t){var n=t.points[3].x-t.points[0].x,r=t.points[1].y-t.points[0].y,i=t.points[3].z-t.points[0].z,o=e/h.UVSCALE,a=o*Math.sqrt(n*n+i*i)/r;t.uvs=[{s:0,t:o},{s:0,t:0},{s:a,t:0},{s:a,t:o}],t.texID=6}),x.push({sym:"Poly",texID:6,points:t}),x.push({sym:"Poly",texID:6,points:t.map(function(t){return{x:t.x,y:t.y+e,z:t.z}})}),x}),h.define("FL_Rooftop",null,function(){for(var t=[],e=this.height,n=this.points[0].y,r=0,o=this.points.length;o>r;r++){var s=this.points[r],u=this.points[(r+1)%o],l=Math.atan2(u.z-s.z,u.x-s.x),c=l-Math.PI/2;
Math.cos(l)+Math.cos(c),Math.sin(l)+Math.sin(c)}t=a.insetPolygon(this.points.map(function(t){return{x:t.x,y:t.z}}),-this.params.width).map(function(t){return{x:t.x,y:n,z:t.y}});for(var x=i.extrudeAll(this.points,this.height,"Quad",[0,1,0]),p=i.extrudeAll(t,this.height,"Quad",[0,1,0]);x.length;)p.push(x.shift());p.forEach(function(t){var n=t.points[3].x-t.points[0].x,r=t.points[1].y-t.points[0].y,i=t.points[3].z-t.points[0].z,o=e/h.UVSCALE,a=o*Math.sqrt(n*n+i*i)/r;t.uvs=[{s:0,t:o},{s:0,t:0},{s:a,t:0},{s:a,t:o}],t.texID=6}),p.push({sym:"Poly",points:t,texID:3});for(var r=0,o=t.length;o>r;r++){var f=(r+1)%o,s=this.points[r],u=t[r],m=t[f],v=this.points[f],d={sym:"Poly",points:[s,u,m,s,m,v].map(function(t){return{x:t.x,y:t.y+e,z:t.z}}),texID:6};p.push(d)}return p}),h.define("Facade",function(){return"OneDoor"===this.type},function(){var t=this.points[3].x-this.points[0].x,e=this.points[1].y-this.points[0].y,n=this.points[3].z-this.points[0].z,r=e/h.UVSCALE,o=r*Math.sqrt(t*t+n*n)/e;this.uvs=[{s:0,t:r},{s:0,t:0},{s:o,t:0},{s:o,t:r}];var a=i.fit("x",this,"Window",1);a[~~(a.length/2)].sym="Door";for(var s=0,u=a.length;u>s;s++)a[s].normal=this.normal;return a}),h.define("Facade",null,function(){var t=this.points[3].x-this.points[0].x,e=this.points[1].y-this.points[0].y,n=this.points[3].z-this.points[0].z,o=Math.sqrt(t*t+n*n),a=e/h.UVSCALE,s=a*o/e,l=null,c=this.normal;this.uvs=[{s:0,t:a},{s:0,t:0},{s:s,t:0},{s:s,t:a}];var x=i.fit("x",this,"Window",1).map(function(t){return t.normal=c,t});if("Window"===this.type);else if("function"==typeof this.type)for(var p=0,f=x.length;f>p;p++)this.type(p)||(x[p].sym="Quad",x[p].texID=6);if(this.hasBalcony){var m=(x.length%2===0?2:3)/x.length,v={x0:this.points[0].x,z0:this.points[0].z,x1:this.points[3].x,z1:this.points[3].z,y:this.points[0].y,height:e,width:.9*o*m,depth:.4*o*m,angle:Math.atan2(-n,t)};l=u.createBalconyWithStairs(v),l.sym=r.TERMINAL}for(var p=0,f=x.length;f>p;p++)x[p].normal=this.normal;return null!==l&&x.push(l),x}),h.define("Window",null,function(){var t=i.split(this,[.3,.4,.3],[1],"Quad"),e=i.split(t[1],[1],[.15,.7,.15],"Quad"),n=e[1],r=l.random()>.8;n.uvs;n.uvs=null,n.texID=r?5:4,t[0].texID=t[2].texID=e[0].texID=e[2].texID=6;var o=[t[0],t[2],e[0],e[2]],s=this.normal||a.triToNormal([n.points[0].x,n.points[0].y,n.points[0].z,n.points[1].x,n.points[1].y,n.points[1].z,n.points[2].x,n.points[2].y,n.points[2].z]),u=i.extrudeAll(n.points,-.005,"Quad",s),h=s[0],c=s[1],x=s[2];h*=.005,c*=.005,x*=.005;for(var p=0,f=n.points.length;f>p;p++){var m=n.points[p];m.x-=h,m.y-=c,m.z-=x}for(var p=0,f=u.length;f>p;p++)u[p].texID=3,o.push(u[p]);return o.push(n),o}),h.define("Door",null,function(){var t=i.split(this,[.15,.7,.15],[1],"Quad"),e=i.split(t[1],[1],[.7,.3],"Quad"),n=e[0];n.uvs;n.uvs=null,n.texID=l.random()>.3?4:5,t[0].texID=t[2].texID=e[1].texID=6;var r=[t[0],t[2],e[1]],o=a.triToNormal([n.points[0].x,n.points[0].y,n.points[0].z,n.points[1].x,n.points[1].y,n.points[1].z,n.points[2].x,n.points[2].y,n.points[2].z]),s=i.extrudeAll(n.points,-.005,"Quad",o),u=o[0],h=o[1],c=o[2];u*=.005,h*=.005,c*=.005;for(var x=0,p=n.points.length;p>x;x++){var f=n.points[x];f.x-=u,f.y-=h,f.z-=c}for(var x=0,p=s.length;p>x;x++)s[x].texID=3,r.push(s[x]);return r.push(n),r}),h.define("Quad",null,function(){var t=[{s:0,t:1},{s:0,t:0},{s:1,t:0},{s:1,t:1}];return function(){var e,n,i,o,s,u,h,l,c,x,p,f,m=[],v=this.points;c=v[0],x=v[1],p=v[2],f=v[3],e=[c.x,c.y,c.z,x.x,x.y,x.z,p.x,p.y,p.z,c.x,c.y,c.z,p.x,p.y,p.z,f.x,f.y,f.z],i=this.normal||a.triToNormal(e);for(var d=0;6>d;d++)m.push(i[0],i[1],i[2]);return n=this.uvs||t,s=n[0],u=n[1],h=n[2],l=n[3],o=this.texID||0,n=[s.s,s.t,o,u.s,u.t,o,h.s,h.t,o,s.s,s.t,o,h.s,h.t,o,l.s,l.t,o],{sym:r.TERMINAL,vertices:e,normals:m,uvs:n}}}()),h.define("Poly",null,function(){var t,e,n,i,s,u,h,l=this.points.map(function(t){return[t.x,t.z]}),c=this.points[0].y,x=o([l]),p=x.reduce(function(t,e){return t.push(e[0],c,e[1]),t},[]),f=this.normal||a.triToNormal(p),m=[],v=[];t=e=Number.POSITIVE_INFINITY,n=i=Number.NEGATIVE_INFINITY;for(var d=0,y=this.points.length;y>d;d++)h=this.points[d],t>h.x&&(t=h.x),n<h.x&&(n=h.x),e>h.z&&(e=h.z),i<h.z&&(i=h.z);s=n-t,u=i-e;for(var d=0,y=p.length;y>d;d+=3){var g=p[d],z=p[d+2];v.push((g-t)/s,(z-e)/u,this.texID),m.push(f[0],f[1],f[2])}return{sym:r.TERMINAL,vertices:p,normals:m,uvs:v}});var f=[[.9,.65,.48],[.75,.73,.69],[.82,.67,.42],[.6,.39,.33]];h.UVSCALE=.1,e.exports={shg:h,create:function(t){var e=t.width/2,n=t.depth/2,r=t.x-e,i=t.x+e,o=t.y-n,a=t.y+n,s=Math.max(e/n,n/e),u=null,l=!1,m=[];if(1.3>s&&c.random()<.3)for(var v=0;8>v;v++){var d=-t.angle-v*Math.PI/4;m.push({x:t.x+e*Math.cos(d),y:0,z:t.y+n*Math.sin(d)}),u=0}else if(s>1.1&&c.random()<.8){l=!0;var y=2/2.7;e>n?t.angle<.1?(m.push({x:r,y:0,z:o},{x:r,y:0,z:a},{x:r+e*y,y:0,z:a},{x:r+e*y,y:0,z:a-n*y},{x:i-e*y,y:0,z:a-n*y},{x:i-e*y,y:0,z:a},{x:i,y:0,z:a},{x:i,y:0,z:o}),u=3):(m.push({x:r,y:0,z:o},{x:r,y:0,z:a},{x:i,y:0,z:a},{x:i,y:0,z:o},{x:i-e*y,y:0,z:o},{x:i-e*y,y:0,z:o+n*y},{x:r+e*y,y:0,z:o+n*y},{x:r+e*y,y:0,z:o}),u=5):t.angle>0?(m.push({x:r,y:0,z:o},{x:r,y:0,z:o+n*y},{x:r+e*y,y:0,z:o+n*y},{x:r+e*y,y:0,z:a-n*y},{x:r,y:0,z:a-n*y},{x:r,y:0,z:a},{x:i,y:0,z:a},{x:i,y:0,z:o}),u=2):(m.push({x:r,y:0,z:o},{x:r,y:0,z:a},{x:i,y:0,z:a},{x:i,y:0,z:a-n*y},{x:i-e*y,y:0,z:a-n*y},{x:i-e*y,y:0,z:o+n*y},{x:i,y:0,z:o+n*y},{x:i,y:0,z:o}),u=4)}else m.push({x:r,y:0,z:o},{x:r,y:0,z:a},{x:i,y:0,z:a},{x:i,y:0,z:o}),u=e>n?t.angle<.1?1:3:t.angle<0?2:0;var g=[],z=~~(2*x.random()),b=[];switch(z){case 0:g.push({type:"FL_GndFloor",height:.05,tiles:"OneDoor",frontSide:t.angle},{type:"FL_Ledge",height:.00625,width:.00625});for(var v=0,E=4+~~(20*p.random());E>v;v++)g.push({type:"FL_Floor",height:.05,windows:"Double"});g.push({type:"FL_Ledge",height:.00625,width:.00625},{type:"FL_Floor",height:.0625,windows:"Single"},{type:"FL_Rooftop",height:.00625,width:.00625});break;case 1:g.push({type:"FL_GndFloor",height:.05,tiles:"OneDoor",frontSide:t.angle});for(var v=0,E=4+~~(10*p.random());E>v;v++)g.push({type:"FL_Floor",height:.05,windows:"Double"});g.push({type:"FL_Floor",height:.05,windows:"Single"},{type:"FL_Rooftop",height:.00625,width:.00625})}for(var v=0,E=m.length;E>v;v++){var T=~~(3*p.random());switch(T){case 0:b[v]="Windows";break;case 1:b[v]=function(t){return!(t%3===0)};break;case 2:b[v]=function(t){return t%2===0}}}var M={sym:"Building",floorsLayout:g,facadeLayout:b,points:m};null!==u&&(M.frontFacade=u),l&&(M.hasBalcony=!0);var A=f[~~(p.random()*f.length)],w=h.run(M);return{geom:w,color:A}},getGeom:function(){return context}}},{"../lib/SHAPE.js":15,"./../lib/Geom":11,"./../lib/ShapeGrammar":16,"./BalconySHG.js":3,"./PRNG":8,earcut:20}],6:[function(t,e,n){var r=new(t("./PRNG")),i=t("./../lib/Geom"),o=t("./Roads.js"),a=t("./Block.js"),s=(t("../lib/ShapeGrammar.js"),function(){var t=2*Math.PI;return function(e,n,r,o){var a,u,h,l=Math.atan2(-n.y+e.y,n.x-e.x),c={th:Number.POSITIVE_INFINITY,vertex:null};"traversed"in e||(e.traversed=[]),"traversed"in n||(n.traversed=[]),e.traversed.push(n);for(var x=0;x<n.conns.length;x++)u=n.conns[x],u===e||-1!==n.traversed.indexOf(u)||o&&u!==o[0]&&-1!==o.indexOf(u)||(a=Math.atan2(-u.y+n.y,u.x-n.x)-l,a>Math.PI?a-=t:a<-Math.PI&&(a+=t),a<c.th&&(c.th=a,c.vertex=n.conns[x]));return null===c.vertex?null:(o&&o.push(n),o&&c.vertex===o[0]?(h=i.isOverlapping(o,r))?null:(n.traversed.push(o[0]),o):(o=s(n,c.vertex,r,o||[e,n]),null===o&&n.traversed.splice(n.traversed.indexOf(c.vertex),1),o||null))}}()),u=function(t){r.seed(t);var e=[];this.roads=o(),this.blocks=[];for(var n=0;n<this.roads.length;n++)for(var u=0;u<this.roads[n].conns.length;u++){"traversed"in this.roads[n]||(this.roads[n].traversed=[]);var h=s(this.roads[n],this.roads[n].conns[u],this.roads);null===h||i.isPolyIn(h,e)||(e.push(h),this.blocks.push(new a(h,65536*r.random())))}this.roads.forEach(function(t){t.traversed=[]});var l=[];this.roads.forEach(function(t){t.conns.forEach(function(e){-1===e.traversed.indexOf(t)&&(l.push([t,e]),t.traversed.push(e),e.traversed.push(t))})}),this.roadQuads=l};e.exports=u},{"../lib/ShapeGrammar.js":16,"./../lib/Geom":11,"./Block.js":4,"./PRNG":8,"./Roads.js":9}],7:[function(t,e,n){var r=t("./../lib/ShapeGrammar"),i=t("../lib/SHAPE.js"),o=(t("earcut"),t("./../lib/Geom")),a=(t("./PRNG"),new r),s=function(t){return function(e,n){return e=e.concat(i.extrudeAll(n,t,"Quad",[0,-1,0])),e.push({sym:"Quad",points:n}),e.push({sym:"Quad",points:n.map(function(e){return{x:e.x,y:e.y-t,z:e.z}})}),e}},u=function(t){var e=t.vertices.reduce(function(t,e,n){var r=n%3;switch(r){case 0:t.mX=Math.min(t.mX,e),t.MX=Math.max(t.MX,e);break;case 1:t.mY=Math.min(t.mY,e),t.MY=Math.max(t.MY,e);break;case 2:t.mZ=Math.min(t.mZ,e),t.MZ=Math.max(t.MZ,e)}return t},{mX:Number.POSITIVE_INFINITY,MX:Number.NEGATIVE_INFINITY,mY:Number.POSITIVE_INFINITY,MY:Number.NEGATIVE_INFINITY,mZ:Number.POSITIVE_INFINITY,MZ:Number.NEGATIVE_INFINITY});e.lX=e.MX-e.mX,e.lY=e.MY-e.mY,e.lZ=e.MZ-e.mZ;for(var n=t.extra,r=t.vertices,i=0,o=t.vertices.length;o>i;i+=3)n[i]=(r[i]-e.mX)/e.lX,n[i+1]=(r[i+1]-e.mY)/e.lY,n[i+2]=(r[i+2]-e.mZ)/e.lZ;return t};a.define("Chair",null,function(){var t=this.woodThk,e=this.width,n=this.height,r=2*t-.5,i=-r,o=this.cy,a=e/2,u=n/2,h=2*t,l=[{x:r,z:r},{x:r,z:i},{x:i,z:i},{x:i,z:r}].map(function(n){return[{x:e*n.x-t,y:o,z:e*n.z-t},{x:e*n.x-t,y:o,z:e*n.z+t},{x:e*n.x+t,y:o,z:e*n.z+t},{x:e*n.x+t,y:o,z:e*n.z-t}]}),c=[];return c=l.reduce(s(u),c),c=s(-h).call(null,c,[{x:-a,y:o,z:a},{x:-a,y:o,z:-a},{x:a,y:o,z:-a},{x:a,y:o,z:a}]),c=s(-u).call(null,c,[{x:-a,y:h+o,z:-a+h},{x:-a,y:h+o,z:-a},{x:a,y:h+o,z:-a},{x:a,y:h+o,z:-a+h}]).map(function(t){return t.texID=7,t})}),a.define("Table",null,function(){var t=this.woodThk,e=this.width,n=this.height,r=2*t-.5,i=-r,o=this.cy,a=e/2,u=2*t,h=[{x:r,z:r},{x:r,z:i},{x:i,z:i},{x:i,z:r}].map(function(n){return[{x:e*n.x-t,y:o,z:e*n.z-t},{x:e*n.x-t,y:o,z:e*n.z+t},{x:e*n.x+t,y:o,z:e*n.z+t},{x:e*n.x+t,y:o,z:e*n.z-t}]}),l=[];return l=h.reduce(s(n),l),l=s(-u).call(null,l,[{x:-a,y:o,z:a},{x:-a,y:o,z:-a},{x:a,y:o,z:-a},{x:a,y:o,z:a}]).map(function(t){return t.texID=7,t})}),a.define("Lamp",null,function(){for(var t=this.rings,e=this.sectors,n=null,r=[],i=[],o=0;t>o;o++){for(var a=0;e>a;a++){var s=Math.sin(.5*Math.PI*(o+1)/t)*this.radius;r.push({x:Math.cos(2*Math.PI*a/e)*s,z:Math.sin(2*Math.PI*a/e)*s,y:-o/t*this.height})}if(null!==n)for(var a=0;e>a;a++){var u=r[a],h=n[a],l=n[(a+1)%e],c=r[(a+1)%e];i.push({sym:"Quad",texID:7,points:[{x:u.x,y:u.y,z:u.z},{x:h.x,y:h.y,z:h.z},{x:l.x,y:l.y,z:l.z},{x:c.x,y:c.y,z:c.z}]})}n=r,r=[]}return i}),a.define("Quad",null,function(){var t=[{s:0,t:1},{s:0,t:0},{s:1,t:0},{s:1,t:1}];return function(){var e,n,i,a,s,u,h,l,c,x,p,f,m=[],v=this.points;c=v[0],x=v[1],p=v[2],f=v[3],e=[c.x,c.y,c.z,x.x,x.y,x.z,p.x,p.y,p.z,c.x,c.y,c.z,p.x,p.y,p.z,f.x,f.y,f.z],i=this.normal||o.triToNormal(e);for(var d=0;6>d;d++)m.push(i[0],i[1],i[2]);return n=this.uvs||t,s=n[0],u=n[1],h=n[2],l=n[3],a=this.texID||0,n=[s.s,s.t,a,u.s,u.t,a,h.s,h.t,a,s.s,s.t,a,h.s,h.t,a,l.s,l.t,a],{sym:r.TERMINAL,vertices:e,normals:m,uvs:n}}}());var h=a.run({sym:"Table",cy:.4,width:.75,height:.4,woodThk:.025}).reduce(function(t,e){for(var n=0,r=e.vertices.length;r>n;n++)t.vertices.push(e.vertices[n]),t.normals.push(e.normals[n]),t.uvs.push(e.uvs[n]);return t},{vertices:[],normals:[],uvs:[],extra:[]}),l=a.run({sym:"Chair",cy:-.5,width:.5,height:1,woodThk:.03125}).reduce(function(t,e){for(var n=0,r=e.vertices.length;r>n;n++)t.vertices.push(e.vertices[n]),t.normals.push(e.normals[n]),t.uvs.push(e.uvs[n]);return t},{vertices:[],normals:[],uvs:[],extra:[]}),c=a.run({sym:"Lamp",rings:8,sectors:16,radius:.125,height:.25}).reduce(function(t,e){for(var n=0,r=e.vertices.length;r>n;n++)t.vertices.push(e.vertices[n]),t.normals.push(e.normals[n]),t.uvs.push(e.uvs[n]);return t},{vertices:[],normals:[],uvs:[],extra:[]});c=u(c),l=u(l),h=u(h);var x=function(t){return function(e,n,r){return{vertices:t.vertices.map(function(t,i){switch(i%3){case 0:return t+e;case 1:return t+n;case 2:return t+r}}),normals:t.normals,uvs:t.uvs,extra:t.extra}}};e.exports={lamp:x(c),table:x(h),chair:x(l)}},{"../lib/SHAPE.js":15,"./../lib/Geom":11,"./../lib/ShapeGrammar":16,"./PRNG":8,earcut:20}],8:[function(t,e,n){var r=t("mersennetwister"),i=function(t){void 0!==t?this.seed(t):this.mt=new r};i.prototype.seed=function(t){this.mt=new r(t)},i.prototype.random=function(){return this.mt.random()},e.exports=i},{mersennetwister:21}],9:[function(t,e,n){var r=t("./PRNG"),i=3,o=0,a=2;e.exports=function(t){for(var e=[],n=new r(t),s=0;i>s;s++)for(var u=0;i>u;u++){var h=e[s*i+u]={x:a*u+o*n.random(),y:a*s+o*n.random(),conns:[]};u>0&&(h.conns.push(e[s*i+u-1]),e[s*i+u-1].conns.push(h)),s>0&&(h.conns.push(e[(s-1)*i+u]),e[(s-1)*i+u].conns.push(h))}return e}},{"./PRNG":8}],10:[function(t,e,n){var r=t("./../lib/ShapeGrammar"),i=t("../lib/SHAPE.js"),o=(t("earcut"),t("./../lib/Geom")),a=t("./PRNG"),s=t("./FurnitureSHG.js"),u=new r,h=new a(12345);u.define("Apartment",null,function(){var t=i.extrudeAll(this.points,u.floorHeight,"Quad",[0,1,0]);return t.push({sym:"Room",points:this.points}),t}),u.define("Room",function(){var t=i.bounds(this);return t.width>t.depth&&(t.width>u.minWidth&&h.random()<u.density||t.width>u.maxWidth)},function(){var t=i.splitXZ(this,[u.ratio,1-u.ratio],[1],"Room");return t}),u.define("Room",function(){var t=i.bounds(this);return t.width<=t.depth&&(t.depth>u.minWidth&&h.random()<u.density||t.width>u.maxWidth)},function(){var t=i.splitXZ(this,[1],[u.ratio,1-u.ratio],"Room");return t}),u.define("Room",null,function(t){for(var e=this.points,n=[],r=i.inset(this.points,.05),o=i.bounds(this),n=[],a=0,s=e.length;s>a;a++){var h,l,c=r[a],x=r[(a+1)%s],p=x.x-c.x,f=x.z-c.z,m=Math.atan2(f,p),v=m+Math.PI/2,d=Math.sin(m),y=Math.cos(m),g=Math.sin(v),z=Math.cos(v);h={x:c.x+.3*y,y:c.y,z:c.z+.3*d},l={x:x.x-.3*y,y:x.y,z:x.z-.3*d},n.push({sym:"Wall",points:[e[a],e[(a+1)%s]],p0:h,p1:l,boundaries:[{x:h.x-.1*z,z:h.z-.1*g},{x:h.x+.1*z,z:h.z+.1*g},{x:l.x+.1*z,z:l.z+.1*g},{x:l.x-.1*z,z:l.z-.1*g}].reduce(function(t,e){return{maxX:Math.max(t.maxX,e.x),maxZ:Math.max(t.maxZ,e.z),minX:Math.min(t.minX,e.x),minZ:Math.min(t.minZ,e.z)}},{maxX:Number.NEGATIVE_INFINITY,maxZ:Number.NEGATIVE_INFINITY,minX:Number.POSITIVE_INFINITY,minZ:Number.POSITIVE_INFINITY}),length:Math.sqrt(p*p+f*f),angle:m})}n.push({sym:"Quad",points:this.points}),n.push({sym:"Quad",points:this.points.map(function(t){return{x:t.x,y:t.y+u.floorHeight,z:t.z}})});var b=1/e.length,E={sym:"GraphNode",isTerminal:!0,neighbors:[],roomCentroid:this.points.reduce(function(t,e){return t.x+=b*e.x,t.y+=b*e.y,t.z+=b*e.z,t},{x:0,y:0,z:0})};return n.forEach(function(t){"Wall"===t.sym&&(t.room=E)}),n.push(E),n.push({sym:"Quad",texID:8,points:[{x:E.roomCentroid.x-.25,y:E.roomCentroid.y+.5,z:E.roomCentroid.z-.25},{x:E.roomCentroid.x-.25,y:E.roomCentroid.y+1,z:E.roomCentroid.z-.25},{x:E.roomCentroid.x+.25,y:E.roomCentroid.y+1,z:E.roomCentroid.z-.25},{x:E.roomCentroid.x+.25,y:E.roomCentroid.y+.5,z:E.roomCentroid.z-.25}]}),n.push({sym:"Quad",texID:8,points:[{x:E.roomCentroid.x-.25,y:E.roomCentroid.y+.5,z:E.roomCentroid.z+.25},{x:E.roomCentroid.x-.25,y:E.roomCentroid.y+1,z:E.roomCentroid.z+.25},{x:E.roomCentroid.x+.25,y:E.roomCentroid.y+1,z:E.roomCentroid.z+.25},{x:E.roomCentroid.x+.25,y:E.roomCentroid.y+.5,z:E.roomCentroid.z+.25}]}),n.push({sym:"Quad",texID:8,points:[{x:E.roomCentroid.x-.25,y:E.roomCentroid.y+.5,z:E.roomCentroid.z-.25},{x:E.roomCentroid.x-.25,y:E.roomCentroid.y+1,z:E.roomCentroid.z-.25},{x:E.roomCentroid.x-.25,y:E.roomCentroid.y+1,z:E.roomCentroid.z+.25},{x:E.roomCentroid.x-.25,y:E.roomCentroid.y+.5,z:E.roomCentroid.z+.25}]}),n.push({sym:"Quad",texID:8,points:[{x:E.roomCentroid.x+.25,y:E.roomCentroid.y+.5,z:E.roomCentroid.z-.25},{x:E.roomCentroid.x+.25,y:E.roomCentroid.y+1,z:E.roomCentroid.z-.25},{x:E.roomCentroid.x+.25,y:E.roomCentroid.y+1,z:E.roomCentroid.z+.25},{x:E.roomCentroid.x+.25,y:E.roomCentroid.y+.5,z:E.roomCentroid.z+.25}]}),n.push({sym:"Lamp",isTerminal:!0,point:{x:E.roomCentroid.x,y:this.points[0].y+u.floorHeight,z:E.roomCentroid.z}}),console.log(o.width*o.depth),o.width*o.depth>10&&n.push({sym:"Table",isTerminal:!0,point:{x:E.roomCentroid.x+.7*o.width*(Math.random()-.5),y:this.points[0].y,z:E.roomCentroid.z+.7*o.depth*(Math.random()-.5)}}),n}),u.define("Wall",function(t){return!t.reduce(function(t,e){return t||"Room"===e.sym},!1)},function(t){var e=this.boundaries.maxX,n=this.boundaries.maxZ,r=this.boundaries.minX,i=this.boundaries.minZ,o=this,a=this.length,s=t.reduce(function(t,s){if(t.occluded||s===o||"Wall"!==s.sym)return t;var u=s.boundaries;return s.length>=a&&!(e<u.minX||u.maxX<r||n<u.minZ||u.maxZ<i)&&(t.occluded=!0,t.by=s.room),t},{occluded:!1,by:null});return s.occluded?(this.occluded=!0,{sym:"OccludedWall",points:this.points,angle:this.angle,connects:[this.room,s.by],length:this.length}):[]}),u.define("Wall",null,function(){return this}),u.define("OccludedWall",null,function(){var t,e,n,r=this.angle+Math.PI/2,o=Math.sin(r)*u.wallDepth/2,a=Math.cos(r)*u.wallDepth/2,s=this.points[0],h=this.points[1],l={x:s.x+a,y:s.y,z:s.z+o},c={x:h.x+a,y:h.y,z:h.z+o},x={x:s.x-a,y:s.y,z:s.z-o},p={x:h.x-a,y:h.y,z:h.z-o},f=i.extrude("OccludedWall",l,c,u.floorHeight,[0,1,0]),m=i.extrude("OccludedWall",x,p,u.floorHeight,[0,1,0]),v=.5/this.length,d=(1-v)/2,y=i.split(f,[d,v,d],[1],"Quad"),g=i.split(y[1],[1],[.7,.3],"Quad"),z=i.split(m,[d,v,d],[1],"Quad"),b=i.split(z[1],[1],[.7,.3],"Quad"),E=g[0],T=b[0],M=(1-v/8)/2,A=M+v/8,w={x:i.lerp(s.x,h.x,M),y:i.lerp(s.y,h.y,M),z:i.lerp(s.z,h.z,M)},R={x:i.lerp(s.x,h.x,A),y:i.lerp(s.y,h.y,A),z:i.lerp(s.z,h.z,A)};return t={sym:"Door",angle:r,point:{x:.5*(s.x+h.x),y:.5*(s.y+h.y),z:.5*(s.z+h.z)}},e={sym:"GraphArc",isTerminal:!0,a:this.connects[0],b:this.connects[1],c:t},n={sym:"GraphArc",isTerminal:!0,a:this.connects[1],b:this.connects[0],c:t},this.connects[0].neighbors.push({r:this.connects[1],via:t}),this.connects[1].neighbors.push({r:this.connects[0],via:t}),[y[0],y[2],g[1],z[0],z[2],b[1],{sym:"Quad",points:[T.points[1],T.points[0],E.points[0],E.points[1]]},{sym:"Quad",points:[T.points[3],T.points[2],E.points[2],E.points[3]]},{sym:"Quad",points:[T.points[2],T.points[1],E.points[1],E.points[2]]},t,{sym:"WallSegment",points:[s,w]},{sym:"WallSegment",points:[R,h]},e,n]}),u.define("Quad",null,function(){var t=[{s:0,t:1},{s:0,t:0},{s:1,t:0},{s:1,t:1}];return function(){var e,n,r,i,a,s,u,h,l,c,x,p,f=[],m=this.points;l=m[0],c=m[1],x=m[2],p=m[3],e=[l.x,l.y,l.z,c.x,c.y,c.z,x.x,x.y,x.z,l.x,l.y,l.z,x.x,x.y,x.z,p.x,p.y,p.z],r=this.normal||o.triToNormal(e);for(var v=0;6>v;v++)f.push(r[0],r[1],r[2]);return n=this.uvs||t,a=n[0],s=n[1],u=n[2],h=n[3],i=this.texID||3,n=[a.s,a.t,i,s.s,s.t,i,u.s,u.t,i,a.s,a.t,i,u.s,u.t,i,h.s,h.t,i],{sym:"Quad",isTerminal:!0,vertices:e,normals:f,uvs:n}}}()),u.define("Door",null,function(){return{sym:"Door",isTerminal:!0,point:this.point,angle:this.angle}}),u.define("WallSegment",null,function(){return{sym:"Wall",isTerminal:!0,p0:this.points[0],p1:this.points[1]}}),u.minWidth=4,u.maxWidth=7,u.density=.8,u.ratio=.61,u.floorHeight=1.5,u.wallDepth=.2,e.exports={shg:u,create:function(t){var e=u.run({sym:"Apartment",points:t}).reduce(function(t,e){switch(e.sym){case"Quad":for(var n=0,r=e.vertices.length;r>n;n++)t.vertices.push(e.vertices[n]),t.normals.push(e.normals[n]),t.uvs.push(e.uvs[n]);break;case"Lamp":for(var i=s.lamp(e.point.x,e.point.y,e.point.z),n=0,r=i.vertices.length;r>n;n++)t.lamp.vertices.push(i.vertices[n]),t.lamp.normals.push(i.normals[n]),t.lamp.uvs.push(i.uvs[n]),t.lamp.extra.push(i.extra[n]);break;case"Table":for(var o=s.table(e.point.x,e.point.y,e.point.z),n=0,r=o.vertices.length;r>n;n++)t.table.vertices.push(o.vertices[n]),t.table.normals.push(o.normals[n]),t.table.uvs.push(o.uvs[n]),t.table.extra.push(o.extra[n]);break;case"Chair":for(var a=s.chair(e.point.x,e.point.y,e.point.z),n=0,r=a.vertices.length;r>n;n++)t.chair.vertices.push(a.vertices[n]),t.chair.normals.push(a.normals[n]),t.chair.uvs.push(a.uvs[n]),t.chair.extra.push(a.extra[n]);break;case"Wall":t.walls.push(e);break;case"Door":t.doors.push(e);break;case"GraphNode":t.rooms.push(e),t.nodes.push(e);break;case"GraphArc":t.arcs.push(e)}return t},{vertices:[],normals:[],uvs:[],walls:[],rooms:[],nodes:[],arcs:[],doors:[],lamp:{vertices:[],normals:[],uvs:[],extra:[]},table:{vertices:[],normals:[],uvs:[],extra:[]},chair:{vertices:[],normals:[],uvs:[],extra:[]}});console.log(e);var n=t.reduce(function(t,e){return t.minX=Math.min(e.x,t.minX),t.minZ=Math.min(e.z,t.minZ),t.maxX=Math.max(e.x,t.maxX),t.maxZ=Math.max(e.z,t.maxZ),t},{minX:Number.POSITIVE_INFINITY,maxX:Number.NEGATIVE_INFINITY,minZ:Number.POSITIVE_INFINITY,maxZ:Number.NEGATIVE_INFINITY});return n.lenX=n.maxX-n.minX,n.lenZ=n.maxZ-n.minZ,e.lines=e.walls.reduce(function(t,e){return t.push((e.p0.x-n.minX)/n.lenX,(e.p0.z-n.minZ)/n.lenZ,(e.p1.x-n.minX)/n.lenX,(e.p1.z-n.minZ)/n.lenZ),t},[]),e.roomsWorld=e.rooms.map(function(t){return t.roomCentroid}),e.rooms=e.rooms.reduce(function(t,e){return t.push({x:(e.roomCentroid.x-n.minX)/n.lenX,y:(e.roomCentroid.y-n.minY)/n.lenY,z:(e.roomCentroid.z-n.minZ)/n.lenZ}),t},[]),e.width=n.lenX,e.height=n.lenZ,e.bbox=n,e}}},{"../lib/SHAPE.js":15,"./../lib/Geom":11,"./../lib/ShapeGrammar":16,"./FurnitureSHG.js":7,"./PRNG":8,earcut:20}],11:[function(t,e,n){var r=t("./glMatrixSubset"),i=(r.vec3,{pnpoly:function(t,e,n){var r,i,o,a,s=t.length,u=!1;for(r=0,i=s-1;s>r;i=r++)o=t[r],a=t[i],o.y>n!=a.y>n&&e<(a.x-o.x)*(n-o.y)/(a.y-o.y)+o.x&&(u=!u);return u},isOverlapping:function(t,e){for(var n=e.length-1;n--;)if(i.pnpoly(t,e[n].x,e[n].y)&&-1===t.indexOf(e[n]))return!0;return!1},isPolyIn:function(t,e){for(var n=e.length-1;n>0;n--)if(i.isEqualPoly(t,e[n]))return!0;return!1},isEqualPoly:function(t,e){if(t.length!==e.length)return!1;for(var n=t.length-1;n--;)if(-1===e.indexOf(t[n]))return!1;return!0},insetPolygon:function(t,e){var n,r,o,a=[];r=t[t.length-1];for(var s=0;s<t.length-1;s++)n=r,r=t[s],o=t[s+1],a.push(i.insetCorner(n,r,o,e));return a.push(i.insetCorner(r,o,t[0],e)),a},insetCorner:function(t,e,n,r){var o,a,s,u,h=e.x-t.x,l=t.y-e.y,c=n.x-e.x,x=e.y-n.y,p=Math.sqrt(h*h+l*l),f=Math.sqrt(c*c+x*x),m={x:e.x,y:e.y},v={x:e.x,y:e.y};return 0==p||0==f?null:(o=l/p*r,s=h/p*r,a=x/f*r,u=c/f*r,m.x+=o,m.y+=s,v.x+=a,v.y+=u,m.x===v.x&&m.y===v.y?m:i.lineIntersection({x:t.x+o,y:t.y+s},m,v,{x:n.x+a,y:n.y+u}))},lineIntersection:function(t,e,n,r){var i,o,a,s,u,h={x:t.x,y:t.y},l={x:e.x,y:e.y},c={x:n.x,y:n.y},x={x:r.x,y:r.y};return l.x-=h.x,c.x-=h.x,x.x-=h.x,l.y-=h.y,c.y-=h.y,x.y-=h.y,i=Math.sqrt(l.x*l.x+l.y*l.y),o=l.x/i,a=l.y/i,s=c.x*o+c.y*a,c.y=-c.x*a+c.y*o,c.x=s,s=x.x*o+x.y*a,x.y=-x.x*a+x.y*o,x.x=s,c.y==x.y?null:(u=x.x+(c.x-x.x)*x.y/(x.y-c.y),{x:h.x+u*o,y:h.y+u*a})},triToNormal:function(t){var e=t[0]-t[3],n=t[1]-t[4],r=t[2]-t[5],i=t[6]-t[3],o=t[7]-t[4],a=t[8]-t[5],s=n*a-r*o,u=e*a-r*i,h=e*o-n*i,l=1/Math.sqrt(s*s+u*u+h*h);return s*=l,u*=l,h*=l,[s,u,h]}});e.exports=i},{"./glMatrixSubset":17}],12:[function(t,e,n){var r=t("./../Context"),o={},a=document.createElement("ul");a.style.position="absolute",a.style.top="7rem",a.style.left="1rem",a.style.color="#444",a.style.font='10px "Ubuntu Mono", monospace',a.style.lineHeight="1.5em",a.style.listStyleType="none",r.canvas.parentNode.appendChild(a),e.exports={progress:function(t,e){if(!(t in o)){var n=document.createElement("li");a.appendChild(n),o[t]={fns:[],li:n,value:0}}o[t].value=e,e>=1&&o[t].fns.forEach(function(t){t()})},subscribe:function(t,e){if(!(t in o)){var n=document.createElement("li");a.appendChild(n),o[t]={fns:[],li:n,value:0}}o[t].fns.push(e)},render:function(){for(i in o){for(var t=parseInt(100*o[i].value),e=""+t;e.length<4;)e="_"+e;e=e.replace(/_/g,"&nbsp;"),o[i].li.innerHTML="&nbsp;"+i+": "+e+"%&nbsp;\n";var n="linear-gradient(90deg, #0f0, #0f0 "+t+"%, #0b0 "+t+"%)";o[i].li.style.backgroundImage=n}}}},{"./../Context":1}],13:[function(t,e,n){var r=(t("./glMatrixSubset"),t("./../Context")),i=r.gl,o=function(t,e,n,r){this.vBuf=i.createBuffer(),this.nBuf=i.createBuffer(),this.uBuf=i.createBuffer(),this.eBuf=i.createBuffer(),this.count=t.length/3,i.bindBuffer(i.ARRAY_BUFFER,this.vBuf),i.bufferData(i.ARRAY_BUFFER,new Float32Array(t),i.STATIC_DRAW),i.bindBuffer(i.ARRAY_BUFFER,this.nBuf),i.bufferData(i.ARRAY_BUFFER,new Float32Array(e),i.STATIC_DRAW),i.bindBuffer(i.ARRAY_BUFFER,this.uBuf),i.bufferData(i.ARRAY_BUFFER,new Float32Array(n),i.STATIC_DRAW),i.bindBuffer(i.ARRAY_BUFFER,this.eBuf),i.bufferData(i.ARRAY_BUFFER,new Float32Array(r),i.STATIC_DRAW),i.bindBuffer(i.ARRAY_BUFFER,null)};e.exports=o},{"./../Context":1,"./glMatrixSubset":17}],14:[function(t,e,n){var r=function(t,e,n,r){this.nw=this.sw=this.ne=this.se=null,this.x=t,this.y=e,this.w=Math.abs(n),this.limit=r,this.points=[]};r.prototype.contains=function(t){return Math.abs(t.x-this.x)<this.w&&Math.abs(t.y-this.y)<this.w},r.prototype.insert=function(t){return this.contains(t)?this.points.length<this.limit?(this.points.push(t),!0):(null===this.nw&&this.subdivide(),this.nw.insert(t)||this.ne.insert(t)||this.sw.insert(t)||this.se.insert(t)):!1},r.prototype.subdivide=function(){var t=this.x,e=this.y,n=this.w/2;this.nw=new r(t-n,e-n,n,this.limit),this.sw=new r(t-n,e+n,n,this.limit),this.ne=new r(t+n,e-n,n,this.limit),this.se=new r(t+n,e+n,n,this.limit)},r.prototype.intersect=function(t,e,n){return Math.abs(this.x-t)<this.w+n&&Math.abs(this.y-e)<this.w+n},r.prototype.query=function(t,e,n){var r=[],o=[],a=this.points;if(!this.intersect(t,e,n))return r;for(var s=0,u=a.length;u>s;s++)i(a[s],t,e,n)&&r.push(a[s]);if(null===this.nw)return r;o=this.nw.query(t,e,n);for(var s=0,u=o.length;u>s;s++)r.push(o[s]);o=this.ne.query(t,e,n);for(var s=0,u=o.length;u>s;s++)r.push(o[s]);o=this.sw.query(t,e,n);for(var s=0,u=o.length;u>s;s++)r.push(o[s]);o=this.se.query(t,e,n);for(var s=0,u=o.length;u>s;s++)r.push(o[s]);return r};var i=function(t,e,n,r){return Math.abs(t.x-e)<r&&Math.abs(t.y-n)<r};e.exports=r},{}],15:[function(t,e,n){var r=t("./Geom"),i={extrude:function(t,e,n,r,i){var o=0,a=r,s=0;return void 0!==i&&(o=i[0]*r,a=i[1]*r,s=i[2]*r),{sym:t,points:[{x:e.x,y:e.y,z:e.z},{x:e.x+o,y:e.y+a,z:e.z+s},{x:n.x+o,y:n.y+a,z:n.z+s},{x:n.x,y:n.y,z:n.z}]}},extrudeAll:function(t,e,n,r){for(var o=[],a=0,s=t.length;s>a;++a){var u=t[a],h=t[(a+1)%s];o.push(i.extrude(n instanceof Array?n[a]:n,u,h,e,r))}return o},split:function(t,e,n,r){var o=[],a=0,s=r instanceof Array,u=t.points,h=t.uvs,l=u[0],c=u[1],x=u[2],p=u[3],f=l.x,m=(c.x,x.x,p.x),v=l.y,d=c.y,y=(x.y,p.y,l.z),g=(c.z,x.z,p.z),z=1,b=1,E=0,T=0;h instanceof Array&&(z=h[3].s-h[0].s,b=h[1].t-h[0].t,E=h[0].s,T=h[1].t);for(var M=0,A=0,w=n.length;w>A;++A){for(var R=0,F=M+n[A],I=0,S=e.length;S>I;++I){var _=R+e[I],P=i.lerp(f,m,R),N=i.lerp(f,m,_),D=i.lerp(v,d,M),C=i.lerp(v,d,F),L=i.lerp(y,g,R),B=i.lerp(y,g,_);o.push({sym:s?r[a++]:r,points:[{x:P,y:D,z:L},{x:P,y:C,z:L},{x:N,y:C,z:B},{x:N,y:D,z:B}],uvs:[{s:E+z*R,t:T+b*M},{s:E+z*R,t:T+b*F},{s:E+z*_,t:T+b*F},{s:E+z*_,t:T+b*M}]}),R=_}M=F}return o},splitXZ:function(t,e,n,r){for(var o=[],a=0,s=t.points,u=s[0],h=s[1],l=s[2],c=s[3],x=u.x,p=(h.x,l.x,c.x),f=u.y,m=h.y,v=(l.y,c.y,u.z),d=h.z,y=(l.z,c.z,0),g=0,z=n.length;z>g;++g){for(var b=0,E=0,T=e.length;T>E;++E){var M=i.lerp(x,p,b),A=i.lerp(x,p,b+e[E]),w=i.lerp(f,m,b),R=i.lerp(f,m,b+e[E]),F=i.lerp(v,d,y),I=i.lerp(v,d,y+n[g]);o.push({sym:r instanceof Array?r[a++]:r,points:[{x:M,y:w,z:F},{x:M,y:w,z:I},{x:A,y:R,z:I},{x:A,y:R,z:F}]}),b+=e[E]}y+=n[g]}return o},splitZX:function(t,e,n,r){for(var o=[],a=0,s=t.points,u=s[0],h=s[1],l=s[2],c=s[3],x=u.x,p=h.x,f=(l.x,c.x,u.y),m=h.y,v=(l.y,c.y,u.z),d=(h.z,l.z,c.z),y=0,g=0,z=n.length;z>g;++g){for(var b=0,E=0,T=e.length;T>E;++E){var M=i.lerp(x,p,b),A=i.lerp(x,p,b+e[E]),w=i.lerp(f,m,b),R=i.lerp(f,m,b+e[E]),F=i.lerp(v,d,y),I=i.lerp(v,d,y+n[g]);o.push({sym:r instanceof Array?r[a++]:r,points:[{x:M,y:w,z:F},{x:M,y:w,z:I},{x:A,y:R,z:I},{x:A,y:R,z:F}]}),b+=e[E]}y+=n[g]}return o},fit:function(t,e,n,r){r=r||1;var o=e.points,a=o[0],s=o[1],u=o[2],h=o[3],l=a.x,c=(s.x,u.x,h.x),x=a.y,p=s.y,f=(u.y,h.y,a.z),m=s.z,v=(u.z,h.z),d=c-l,y=p-x,g=v-f,z=m-f;if("x"===t){var b=y,E=r*b,T=Math.sqrt(d*d+g*g),M=Math.round(T/E),A=[];E=T/M,M=Math.max(1,Math.abs(M));for(var w=0;M>w;w++)A.push(1/M);return i.split(e,A,[1],n)}if("y"===t){var E=c-l,b=E/r,R=Math.sqrt(y*y+z*z),M=Math.round(R/b),A=[];b=R/M;for(var w=0;M>w;w++)A.push(1/M);return i.split(e,A,[1],n)}},bounds:function(t){var e,n,r,i,o=t.points;e=n=Number.POSITIVE_INFINITY,r=i=Number.NEGATIVE_INFINITY;for(var a=0,s=o.length;s>a;a++){var u=o[a];e=Math.min(u.x,e),n=Math.min(u.z,n),r=Math.max(u.x,r),i=Math.max(u.z,i)}return{width:r-e,depth:i-n}},inset:function(t,e){return r.insetPolygon(t.map(function(t){return{x:t.x,y:t.z}}),-e).map(function(e){return{x:e.x,y:t[0].y,z:e.y}})},lerp:function(t,e,n){return t*(1-n)+e*n}};e.exports=i},{"./Geom":11}],16:[function(t,e,n){var r=(t("./Geom"),t("./SHAPE.js"),t("./glMatrixSubset")),i=(t("earcut"),r.vec3,r.mat4,function(){this.rules=[]});i.prototype.define=function(t,e,n){this.rules.push({lhs:t,cond:e,rhs:n})},i.prototype.run=function(t){var e=[],n=this.rules,r=0;t=t instanceof Array?t:[t];for(var o=0,a=t.length;a>o;o++){var s=t[o];if(s.sym===i.TERMINAL||s.isTerminal)e.push(s);else for(var u=0,h=n.length;h>u;u++){var l=n[u];if(s.sym===l.lhs&&(null===l.cond||l.cond.call(s,t))){var c=l.rhs.call(s,t);c=c instanceof Array?c:[c];for(var x=0,p=c.length;p>x;x++)e.push(c[x]),++r;break}}}return r>0?this.run(e):e},i.TERMINAL="TERMINAL",e.exports=i},{"./Geom":11,"./SHAPE.js":15,"./glMatrixSubset":17,earcut:20}],17:[function(t,e,n){var r=Float32Array,i={};i.create=function(){var t=new r(16);return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},i.clone=function(t){var e=new r(16);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},i.copy=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},i.identity=function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},i.transpose=function(t,e){if(t===e){var n=e[1],r=e[2],i=e[3],o=e[6],a=e[7],s=e[11];t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=n,t[6]=e[9],t[7]=e[13],t[8]=r,t[9]=o,t[11]=e[14],t[12]=i,t[13]=a,t[14]=s}else t[0]=e[0],t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=e[1],t[5]=e[5],t[6]=e[9],t[7]=e[13],t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=e[14],t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15];return t},i.invert=function(t,e){var n=e[0],r=e[1],i=e[2],o=e[3],a=e[4],s=e[5],u=e[6],h=e[7],l=e[8],c=e[9],x=e[10],p=e[11],f=e[12],m=e[13],v=e[14],d=e[15],y=n*s-r*a,g=n*u-i*a,z=n*h-o*a,b=r*u-i*s,E=r*h-o*s,T=i*h-o*u,M=l*m-c*f,A=l*v-x*f,w=l*d-p*f,R=c*v-x*m,F=c*d-p*m,I=x*d-p*v,S=y*I-g*F+z*R+b*w-E*A+T*M;return S?(S=1/S,t[0]=(s*I-u*F+h*R)*S,t[1]=(i*F-r*I-o*R)*S,t[2]=(m*T-v*E+d*b)*S,t[3]=(x*E-c*T-p*b)*S,t[4]=(u*w-a*I-h*A)*S,t[5]=(n*I-i*w+o*A)*S,t[6]=(v*z-f*T-d*g)*S,t[7]=(l*T-x*z+p*g)*S,t[8]=(a*F-s*w+h*M)*S,t[9]=(r*w-n*F-o*M)*S,t[10]=(f*E-m*z+d*y)*S,t[11]=(c*z-l*E-p*y)*S,t[12]=(s*A-a*R-u*M)*S,t[13]=(n*R-r*A+i*M)*S,t[14]=(m*g-f*b-v*y)*S,t[15]=(l*b-c*g+x*y)*S,t):null},i.adjoint=function(t,e){var n=e[0],r=e[1],i=e[2],o=e[3],a=e[4],s=e[5],u=e[6],h=e[7],l=e[8],c=e[9],x=e[10],p=e[11],f=e[12],m=e[13],v=e[14],d=e[15];return t[0]=s*(x*d-p*v)-c*(u*d-h*v)+m*(u*p-h*x),t[1]=-(r*(x*d-p*v)-c*(i*d-o*v)+m*(i*p-o*x)),t[2]=r*(u*d-h*v)-s*(i*d-o*v)+m*(i*h-o*u),t[3]=-(r*(u*p-h*x)-s*(i*p-o*x)+c*(i*h-o*u)),t[4]=-(a*(x*d-p*v)-l*(u*d-h*v)+f*(u*p-h*x)),t[5]=n*(x*d-p*v)-l*(i*d-o*v)+f*(i*p-o*x),t[6]=-(n*(u*d-h*v)-a*(i*d-o*v)+f*(i*h-o*u)),t[7]=n*(u*p-h*x)-a*(i*p-o*x)+l*(i*h-o*u),t[8]=a*(c*d-p*m)-l*(s*d-h*m)+f*(s*p-h*c),t[9]=-(n*(c*d-p*m)-l*(r*d-o*m)+f*(r*p-o*c)),t[10]=n*(s*d-h*m)-a*(r*d-o*m)+f*(r*h-o*s),t[11]=-(n*(s*p-h*c)-a*(r*p-o*c)+l*(r*h-o*s)),t[12]=-(a*(c*v-x*m)-l*(s*v-u*m)+f*(s*x-u*c)),t[13]=n*(c*v-x*m)-l*(r*v-i*m)+f*(r*x-i*c),t[14]=-(n*(s*v-u*m)-a*(r*v-i*m)+f*(r*u-i*s)),t[15]=n*(s*x-u*c)-a*(r*x-i*c)+l*(r*u-i*s),
t},i.determinant=function(t){var e=t[0],n=t[1],r=t[2],i=t[3],o=t[4],a=t[5],s=t[6],u=t[7],h=t[8],l=t[9],c=t[10],x=t[11],p=t[12],f=t[13],m=t[14],v=t[15],d=e*a-n*o,y=e*s-r*o,g=e*u-i*o,z=n*s-r*a,b=n*u-i*a,E=r*u-i*s,T=h*f-l*p,M=h*m-c*p,A=h*v-x*p,w=l*m-c*f,R=l*v-x*f,F=c*v-x*m;return d*F-y*R+g*w+z*A-b*M+E*T},i.multiply=function(t,e,n){var r=e[0],i=e[1],o=e[2],a=e[3],s=e[4],u=e[5],h=e[6],l=e[7],c=e[8],x=e[9],p=e[10],f=e[11],m=e[12],v=e[13],d=e[14],y=e[15],g=n[0],z=n[1],b=n[2],E=n[3];return t[0]=g*r+z*s+b*c+E*m,t[1]=g*i+z*u+b*x+E*v,t[2]=g*o+z*h+b*p+E*d,t[3]=g*a+z*l+b*f+E*y,g=n[4],z=n[5],b=n[6],E=n[7],t[4]=g*r+z*s+b*c+E*m,t[5]=g*i+z*u+b*x+E*v,t[6]=g*o+z*h+b*p+E*d,t[7]=g*a+z*l+b*f+E*y,g=n[8],z=n[9],b=n[10],E=n[11],t[8]=g*r+z*s+b*c+E*m,t[9]=g*i+z*u+b*x+E*v,t[10]=g*o+z*h+b*p+E*d,t[11]=g*a+z*l+b*f+E*y,g=n[12],z=n[13],b=n[14],E=n[15],t[12]=g*r+z*s+b*c+E*m,t[13]=g*i+z*u+b*x+E*v,t[14]=g*o+z*h+b*p+E*d,t[15]=g*a+z*l+b*f+E*y,t},i.mul=i.multiply,i.translate=function(t,e,n){var r,i,o,a,s,u,h,l,c,x,p,f,m=n[0],v=n[1],d=n[2];return e===t?(t[12]=e[0]*m+e[4]*v+e[8]*d+e[12],t[13]=e[1]*m+e[5]*v+e[9]*d+e[13],t[14]=e[2]*m+e[6]*v+e[10]*d+e[14],t[15]=e[3]*m+e[7]*v+e[11]*d+e[15]):(r=e[0],i=e[1],o=e[2],a=e[3],s=e[4],u=e[5],h=e[6],l=e[7],c=e[8],x=e[9],p=e[10],f=e[11],t[0]=r,t[1]=i,t[2]=o,t[3]=a,t[4]=s,t[5]=u,t[6]=h,t[7]=l,t[8]=c,t[9]=x,t[10]=p,t[11]=f,t[12]=r*m+s*v+c*d+e[12],t[13]=i*m+u*v+x*d+e[13],t[14]=o*m+h*v+p*d+e[14],t[15]=a*m+l*v+f*d+e[15]),t},i.scale=function(t,e,n){var r=n[0],i=n[1],o=n[2];return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t[3]=e[3]*r,t[4]=e[4]*i,t[5]=e[5]*i,t[6]=e[6]*i,t[7]=e[7]*i,t[8]=e[8]*o,t[9]=e[9]*o,t[10]=e[10]*o,t[11]=e[11]*o,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},i.rotate=function(t,e,n,r){var i,o,a,s,u,h,l,c,x,p,f,m,v,d,y,g,z,b,E,T,M,A,w,R,F=r[0],I=r[1],S=r[2],_=Math.sqrt(F*F+I*I+S*S);return Math.abs(_)<GLMAT_EPSILON?null:(_=1/_,F*=_,I*=_,S*=_,i=Math.sin(n),o=Math.cos(n),a=1-o,s=e[0],u=e[1],h=e[2],l=e[3],c=e[4],x=e[5],p=e[6],f=e[7],m=e[8],v=e[9],d=e[10],y=e[11],g=F*F*a+o,z=I*F*a+S*i,b=S*F*a-I*i,E=F*I*a-S*i,T=I*I*a+o,M=S*I*a+F*i,A=F*S*a+I*i,w=I*S*a-F*i,R=S*S*a+o,t[0]=s*g+c*z+m*b,t[1]=u*g+x*z+v*b,t[2]=h*g+p*z+d*b,t[3]=l*g+f*z+y*b,t[4]=s*E+c*T+m*M,t[5]=u*E+x*T+v*M,t[6]=h*E+p*T+d*M,t[7]=l*E+f*T+y*M,t[8]=s*A+c*w+m*R,t[9]=u*A+x*w+v*R,t[10]=h*A+p*w+d*R,t[11]=l*A+f*w+y*R,e!==t&&(t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t)},i.rotateX=function(t,e,n){var r=Math.sin(n),i=Math.cos(n),o=e[4],a=e[5],s=e[6],u=e[7],h=e[8],l=e[9],c=e[10],x=e[11];return e!==t&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[4]=o*i+h*r,t[5]=a*i+l*r,t[6]=s*i+c*r,t[7]=u*i+x*r,t[8]=h*i-o*r,t[9]=l*i-a*r,t[10]=c*i-s*r,t[11]=x*i-u*r,t},i.rotateY=function(t,e,n){var r=Math.sin(n),i=Math.cos(n),o=e[0],a=e[1],s=e[2],u=e[3],h=e[8],l=e[9],c=e[10],x=e[11];return e!==t&&(t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=o*i-h*r,t[1]=a*i-l*r,t[2]=s*i-c*r,t[3]=u*i-x*r,t[8]=o*r+h*i,t[9]=a*r+l*i,t[10]=s*r+c*i,t[11]=u*r+x*i,t},i.rotateZ=function(t,e,n){var r=Math.sin(n),i=Math.cos(n),o=e[0],a=e[1],s=e[2],u=e[3],h=e[4],l=e[5],c=e[6],x=e[7];return e!==t&&(t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=o*i+h*r,t[1]=a*i+l*r,t[2]=s*i+c*r,t[3]=u*i+x*r,t[4]=h*i-o*r,t[5]=l*i-a*r,t[6]=c*i-s*r,t[7]=x*i-u*r,t},i.fromRotationTranslation=function(t,e,n){var r=e[0],i=e[1],o=e[2],a=e[3],s=r+r,u=i+i,h=o+o,l=r*s,c=r*u,x=r*h,p=i*u,f=i*h,m=o*h,v=a*s,d=a*u,y=a*h;return t[0]=1-(p+m),t[1]=c+y,t[2]=x-d,t[3]=0,t[4]=c-y,t[5]=1-(l+m),t[6]=f+v,t[7]=0,t[8]=x+d,t[9]=f-v,t[10]=1-(l+p),t[11]=0,t[12]=n[0],t[13]=n[1],t[14]=n[2],t[15]=1,t},i.fromQuat=function(t,e){var n=e[0],r=e[1],i=e[2],o=e[3],a=n+n,s=r+r,u=i+i,h=n*a,l=r*a,c=r*s,x=i*a,p=i*s,f=i*u,m=o*a,v=o*s,d=o*u;return t[0]=1-c-f,t[1]=l+d,t[2]=x-v,t[3]=0,t[4]=l-d,t[5]=1-h-f,t[6]=p+m,t[7]=0,t[8]=x+v,t[9]=p-m,t[10]=1-h-c,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},i.frustum=function(t,e,n,r,i,o,a){var s=1/(n-e),u=1/(i-r),h=1/(o-a);return t[0]=2*o*s,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=2*o*u,t[6]=0,t[7]=0,t[8]=(n+e)*s,t[9]=(i+r)*u,t[10]=(a+o)*h,t[11]=-1,t[12]=0,t[13]=0,t[14]=a*o*2*h,t[15]=0,t},i.perspective=function(t,e,n,r,i){var o=1/Math.tan(e/2),a=1/(r-i);return t[0]=o/n,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=o,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=(i+r)*a,t[11]=-1,t[12]=0,t[13]=0,t[14]=2*i*r*a,t[15]=0,t},i.ortho=function(t,e,n,r,i,o,a){var s=1/(e-n),u=1/(r-i),h=1/(o-a);return t[0]=-2*s,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*u,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*h,t[11]=0,t[12]=(e+n)*s,t[13]=(i+r)*u,t[14]=(a+o)*h,t[15]=1,t},i.lookAt=function(t,e,n,r){var o,a,s,u,h,l,c,x,p,f,m=e[0],v=e[1],d=e[2],y=r[0],g=r[1],z=r[2],b=n[0],E=n[1],T=n[2];return Math.abs(m-b)<GLMAT_EPSILON&&Math.abs(v-E)<GLMAT_EPSILON&&Math.abs(d-T)<GLMAT_EPSILON?i.identity(t):(c=m-b,x=v-E,p=d-T,f=1/Math.sqrt(c*c+x*x+p*p),c*=f,x*=f,p*=f,o=g*p-z*x,a=z*c-y*p,s=y*x-g*c,f=Math.sqrt(o*o+a*a+s*s),f?(f=1/f,o*=f,a*=f,s*=f):(o=0,a=0,s=0),u=x*s-p*a,h=p*o-c*s,l=c*a-x*o,f=Math.sqrt(u*u+h*h+l*l),f?(f=1/f,u*=f,h*=f,l*=f):(u=0,h=0,l=0),t[0]=o,t[1]=u,t[2]=c,t[3]=0,t[4]=a,t[5]=h,t[6]=x,t[7]=0,t[8]=s,t[9]=l,t[10]=p,t[11]=0,t[12]=-(o*m+a*v+s*d),t[13]=-(u*m+h*v+l*d),t[14]=-(c*m+x*v+p*d),t[15]=1,t)},i.str=function(t){return"mat4("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+", "+t[9]+", "+t[10]+", "+t[11]+", "+t[12]+", "+t[13]+", "+t[14]+", "+t[15]+")"},i.frob=function(t){return Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2)+Math.pow(t[2],2)+Math.pow(t[3],2)+Math.pow(t[4],2)+Math.pow(t[5],2)+Math.pow(t[6],2)+Math.pow(t[6],2)+Math.pow(t[7],2)+Math.pow(t[8],2)+Math.pow(t[9],2)+Math.pow(t[10],2)+Math.pow(t[11],2)+Math.pow(t[12],2)+Math.pow(t[13],2)+Math.pow(t[14],2)+Math.pow(t[15],2))},"undefined"!=typeof n&&(n.mat4=i);var o={};o.create=function(){var t=new r(3);return t[0]=0,t[1]=0,t[2]=0,t},o.clone=function(t){var e=new r(3);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e},o.fromValues=function(t,e,n){var i=new r(3);return i[0]=t,i[1]=e,i[2]=n,i},o.copy=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t},o.set=function(t,e,n,r){return t[0]=e,t[1]=n,t[2]=r,t},o.add=function(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t},o.subtract=function(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t},o.sub=o.subtract,o.multiply=function(t,e,n){return t[0]=e[0]*n[0],t[1]=e[1]*n[1],t[2]=e[2]*n[2],t},o.mul=o.multiply,o.divide=function(t,e,n){return t[0]=e[0]/n[0],t[1]=e[1]/n[1],t[2]=e[2]/n[2],t},o.div=o.divide,o.min=function(t,e,n){return t[0]=Math.min(e[0],n[0]),t[1]=Math.min(e[1],n[1]),t[2]=Math.min(e[2],n[2]),t},o.max=function(t,e,n){return t[0]=Math.max(e[0],n[0]),t[1]=Math.max(e[1],n[1]),t[2]=Math.max(e[2],n[2]),t},o.scale=function(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t},o.scaleAndAdd=function(t,e,n,r){return t[0]=e[0]+n[0]*r,t[1]=e[1]+n[1]*r,t[2]=e[2]+n[2]*r,t},o.distance=function(t,e){var n=e[0]-t[0],r=e[1]-t[1],i=e[2]-t[2];return Math.sqrt(n*n+r*r+i*i)},o.dist=o.distance,o.squaredDistance=function(t,e){var n=e[0]-t[0],r=e[1]-t[1],i=e[2]-t[2];return n*n+r*r+i*i},o.sqrDist=o.squaredDistance,o.length=function(t){var e=t[0],n=t[1],r=t[2];return Math.sqrt(e*e+n*n+r*r)},o.len=o.length,o.squaredLength=function(t){var e=t[0],n=t[1],r=t[2];return e*e+n*n+r*r},o.sqrLen=o.squaredLength,o.negate=function(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t},o.normalize=function(t,e){var n=e[0],r=e[1],i=e[2],o=n*n+r*r+i*i;return o>0&&(o=1/Math.sqrt(o),t[0]=e[0]*o,t[1]=e[1]*o,t[2]=e[2]*o),t},o.dot=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]},o.cross=function(t,e,n){var r=e[0],i=e[1],o=e[2],a=n[0],s=n[1],u=n[2];return t[0]=i*u-o*s,t[1]=o*a-r*u,t[2]=r*s-i*a,t},o.lerp=function(t,e,n,r){var i=e[0],o=e[1],a=e[2];return t[0]=i+r*(n[0]-i),t[1]=o+r*(n[1]-o),t[2]=a+r*(n[2]-a),t},o.random=function(t,e){e=e||1;var n=2*GLMAT_RANDOM()*Math.PI,r=2*GLMAT_RANDOM()-1,i=Math.sqrt(1-r*r)*e;return t[0]=Math.cos(n)*i,t[1]=Math.sin(n)*i,t[2]=r*e,t},o.transformMat4=function(t,e,n){var r=e[0],i=e[1],o=e[2];return t[0]=n[0]*r+n[4]*i+n[8]*o+n[12],t[1]=n[1]*r+n[5]*i+n[9]*o+n[13],t[2]=n[2]*r+n[6]*i+n[10]*o+n[14],t},o.transformMat3=function(t,e,n){var r=e[0],i=e[1],o=e[2];return t[0]=r*n[0]+i*n[3]+o*n[6],t[1]=r*n[1]+i*n[4]+o*n[7],t[2]=r*n[2]+i*n[5]+o*n[8],t},o.transformQuat=function(t,e,n){var r=e[0],i=e[1],o=e[2],a=n[0],s=n[1],u=n[2],h=n[3],l=h*r+s*o-u*i,c=h*i+u*r-a*o,x=h*o+a*i-s*r,p=-a*r-s*i-u*o;return t[0]=l*h+p*-a+c*-u-x*-s,t[1]=c*h+p*-s+x*-a-l*-u,t[2]=x*h+p*-u+l*-s-c*-a,t},o.rotateX=function(t,e,n,r){var i=[],o=[];return i[0]=e[0]-n[0],i[1]=e[1]-n[1],i[2]=e[2]-n[2],o[0]=i[0],o[1]=i[1]*Math.cos(r)-i[2]*Math.sin(r),o[2]=i[1]*Math.sin(r)+i[2]*Math.cos(r),t[0]=o[0]+n[0],t[1]=o[1]+n[1],t[2]=o[2]+n[2],t},o.rotateY=function(t,e,n,r){var i=[],o=[];return i[0]=e[0]-n[0],i[1]=e[1]-n[1],i[2]=e[2]-n[2],o[0]=i[2]*Math.sin(r)+i[0]*Math.cos(r),o[1]=i[1],o[2]=i[2]*Math.cos(r)-i[0]*Math.sin(r),t[0]=o[0]+n[0],t[1]=o[1]+n[1],t[2]=o[2]+n[2],t},o.rotateZ=function(t,e,n,r){var i=[],o=[];return i[0]=e[0]-n[0],i[1]=e[1]-n[1],i[2]=e[2]-n[2],o[0]=i[0]*Math.cos(r)-i[1]*Math.sin(r),o[1]=i[0]*Math.sin(r)+i[1]*Math.cos(r),o[2]=i[2],t[0]=o[0]+n[0],t[1]=o[1]+n[1],t[2]=o[2]+n[2],t},o.forEach=function(){var t=o.create();return function(e,n,r,i,o,a){var s,u;for(n||(n=3),r||(r=0),u=i?Math.min(i*n+r,e.length):e.length,s=r;u>s;s+=n)t[0]=e[s],t[1]=e[s+1],t[2]=e[s+2],o(t,t,a),e[s]=t[0],e[s+1]=t[1],e[s+2]=t[2];return e}}(),o.str=function(t){return"vec3("+t[0]+", "+t[1]+", "+t[2]+")"},"undefined"!=typeof n&&(n.vec3=o);var a={};a.create=function(){var t=new r(9);return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t},a.fromMat4=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[4],t[4]=e[5],t[5]=e[6],t[6]=e[8],t[7]=e[9],t[8]=e[10],t},a.clone=function(t){var e=new r(9);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e},a.copy=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t},a.identity=function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t},a.transpose=function(t,e){if(t===e){var n=e[1],r=e[2],i=e[5];t[1]=e[3],t[2]=e[6],t[3]=n,t[5]=e[7],t[6]=r,t[7]=i}else t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8];return t},a.invert=function(t,e){var n=e[0],r=e[1],i=e[2],o=e[3],a=e[4],s=e[5],u=e[6],h=e[7],l=e[8],c=l*a-s*h,x=-l*o+s*u,p=h*o-a*u,f=n*c+r*x+i*p;return f?(f=1/f,t[0]=c*f,t[1]=(-l*r+i*h)*f,t[2]=(s*r-i*a)*f,t[3]=x*f,t[4]=(l*n-i*u)*f,t[5]=(-s*n+i*o)*f,t[6]=p*f,t[7]=(-h*n+r*u)*f,t[8]=(a*n-r*o)*f,t):null},a.adjoint=function(t,e){var n=e[0],r=e[1],i=e[2],o=e[3],a=e[4],s=e[5],u=e[6],h=e[7],l=e[8];return t[0]=a*l-s*h,t[1]=i*h-r*l,t[2]=r*s-i*a,t[3]=s*u-o*l,t[4]=n*l-i*u,t[5]=i*o-n*s,t[6]=o*h-a*u,t[7]=r*u-n*h,t[8]=n*a-r*o,t},a.determinant=function(t){var e=t[0],n=t[1],r=t[2],i=t[3],o=t[4],a=t[5],s=t[6],u=t[7],h=t[8];return e*(h*o-a*u)+n*(-h*i+a*s)+r*(u*i-o*s)},a.multiply=function(t,e,n){var r=e[0],i=e[1],o=e[2],a=e[3],s=e[4],u=e[5],h=e[6],l=e[7],c=e[8],x=n[0],p=n[1],f=n[2],m=n[3],v=n[4],d=n[5],y=n[6],g=n[7],z=n[8];return t[0]=x*r+p*a+f*h,t[1]=x*i+p*s+f*l,t[2]=x*o+p*u+f*c,t[3]=m*r+v*a+d*h,t[4]=m*i+v*s+d*l,t[5]=m*o+v*u+d*c,t[6]=y*r+g*a+z*h,t[7]=y*i+g*s+z*l,t[8]=y*o+g*u+z*c,t},a.mul=a.multiply,a.translate=function(t,e,n){var r=e[0],i=e[1],o=e[2],a=e[3],s=e[4],u=e[5],h=e[6],l=e[7],c=e[8],x=n[0],p=n[1];return t[0]=r,t[1]=i,t[2]=o,t[3]=a,t[4]=s,t[5]=u,t[6]=x*r+p*a+h,t[7]=x*i+p*s+l,t[8]=x*o+p*u+c,t},a.rotate=function(t,e,n){var r=e[0],i=e[1],o=e[2],a=e[3],s=e[4],u=e[5],h=e[6],l=e[7],c=e[8],x=Math.sin(n),p=Math.cos(n);return t[0]=p*r+x*a,t[1]=p*i+x*s,t[2]=p*o+x*u,t[3]=p*a-x*r,t[4]=p*s-x*i,t[5]=p*u-x*o,t[6]=h,t[7]=l,t[8]=c,t},a.scale=function(t,e,n){var r=n[0],i=n[1];return t[0]=r*e[0],t[1]=r*e[1],t[2]=r*e[2],t[3]=i*e[3],t[4]=i*e[4],t[5]=i*e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t},a.fromMat2d=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=0,t[3]=e[2],t[4]=e[3],t[5]=0,t[6]=e[4],t[7]=e[5],t[8]=1,t},a.fromQuat=function(t,e){var n=e[0],r=e[1],i=e[2],o=e[3],a=n+n,s=r+r,u=i+i,h=n*a,l=r*a,c=r*s,x=i*a,p=i*s,f=i*u,m=o*a,v=o*s,d=o*u;return t[0]=1-c-f,t[3]=l-d,t[6]=x+v,t[1]=l+d,t[4]=1-h-f,t[7]=p-m,t[2]=x-v,t[5]=p+m,t[8]=1-h-c,t},a.normalFromMat4=function(t,e){var n=e[0],r=e[1],i=e[2],o=e[3],a=e[4],s=e[5],u=e[6],h=e[7],l=e[8],c=e[9],x=e[10],p=e[11],f=e[12],m=e[13],v=e[14],d=e[15],y=n*s-r*a,g=n*u-i*a,z=n*h-o*a,b=r*u-i*s,E=r*h-o*s,T=i*h-o*u,M=l*m-c*f,A=l*v-x*f,w=l*d-p*f,R=c*v-x*m,F=c*d-p*m,I=x*d-p*v,S=y*I-g*F+z*R+b*w-E*A+T*M;return S?(S=1/S,t[0]=(s*I-u*F+h*R)*S,t[1]=(u*w-a*I-h*A)*S,t[2]=(a*F-s*w+h*M)*S,t[3]=(i*F-r*I-o*R)*S,t[4]=(n*I-i*w+o*A)*S,t[5]=(r*w-n*F-o*M)*S,t[6]=(m*T-v*E+d*b)*S,t[7]=(v*z-f*T-d*g)*S,t[8]=(f*E-m*z+d*y)*S,t):null},a.str=function(t){return"mat3("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+")"},a.frob=function(t){return Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2)+Math.pow(t[2],2)+Math.pow(t[3],2)+Math.pow(t[4],2)+Math.pow(t[5],2)+Math.pow(t[6],2)+Math.pow(t[7],2)+Math.pow(t[8],2))},"undefined"!=typeof n&&(n.mat3=a),e.exports={mat4:i,mat3:a,vec3:o}},{}],18:[function(t,e,n){e.exports={hsl2rgb:function(t,e,n){var r,i,o,a,s,u;return isFinite(t)||(t=0),isFinite(e)||(e=0),isFinite(n)||(n=0),t/=60,0>t&&(t=6- -t%6),t%=6,e=Math.max(0,Math.min(1,e/100)),n=Math.max(0,Math.min(1,n/100)),s=(1-Math.abs(2*n-1))*e,u=s*(1-Math.abs(t%2-1)),1>t?(r=s,i=u,o=0):2>t?(r=u,i=s,o=0):3>t?(r=0,i=s,o=u):4>t?(r=0,i=u,o=s):5>t?(r=u,i=0,o=s):(r=s,i=0,o=u),a=n-s/2,r=Math.round(255*(r+a)),i=Math.round(255*(i+a)),o=Math.round(255*(o+a)),{r:r,g:i,b:o}}}},{}],19:[function(t,e,n){e.exports=function(t,e,n,r){e="number"==typeof e?e:.5,n=n?n:25;var i,o,a,s,u,h,l,c=1,x=t.length,p=0,f=(x-2)*n+2+(r?2*n:0),m=new Float32Array(f),v=new Float32Array(4*(n+2)),d=4;for(i=t.slice(0),r?(i.unshift(t[x-1]),i.unshift(t[x-2]),i.push(t[0],t[1])):(i.unshift(t[1]),i.unshift(t[0]),i.push(t[x-2],t[x-1])),v[0]=1;n>c;c++)o=c/n,a=o*o,s=a*o,u=2*s,h=3*a,v[d++]=u-h+1,v[d++]=h-u,v[d++]=s-2*a+o,v[d++]=s-a;return v[++d]=1,l=function(t,r,i){var o,a,s,u,h,l,c,x,f,v,d,y,g,z,b=2;for(b;i>b;b+=2)for(a=t[b],s=t[b+1],u=t[b+2],h=t[b+3],l=(u-t[b-2])*e,c=(h-t[b-1])*e,x=(t[b+4]-a)*e,f=(t[b+5]-s)*e,o=0;n>o;o++)v=o<<2,d=r[v],y=r[v+1],g=r[v+2],z=r[v+3],m[p++]=d*a+y*u+g*l+z*x,m[p++]=d*s+y*h+g*c+z*f},l(i,v,x),r&&(i=[],i.push(t[x-4],t[x-3],t[x-2],t[x-1]),i.push(t[0],t[1],t[2],t[3]),l(i,v,4)),x=r?0:t.length-2,m[p++]=t[x],m[p]=t[x+1],m}},{}],20:[function(t,e,n){"use strict";function r(t,e){var n=o(i(t[0],!0)),r=e?{vertices:[],indices:[]}:[];if(!n)return r;var s,u,h,l,x,p,f,m,v,d=80;for(v=0;d>=0&&v<t.length;v++)d-=t[v].length;if(0>d){s=n.next,u=l=s.p[0],h=x=s.p[1];do p=s.p[0],f=s.p[1],u>p&&(u=p),h>f&&(h=f),p>l&&(l=p),f>x&&(x=f),s=s.next;while(s!==n);m=Math.max(l-u,x-h)}return t.length>1&&(n=c(t,n)),a(n,r,u,h,m),r}function i(t,e){var n,r,i,o,a,s=0,u=t.length;for(n=0,r=u-1;u>n;r=n++)i=t[n],o=t[r],s+=(o[0]-i[0])*(i[1]+o[1]);if(e===s>0)for(n=0;u>n;n++)a=R(t[n],a);else for(n=u-1;n>=0;n--)a=R(t[n],a);return a}function o(t,e){e||(e=t);var n,r=t;do if(n=!1,z(r.p,r.next.p)||0===g(r.prev.p,r.p,r.next.p)){if(r.prev.next=r.next,r.next.prev=r.prev,r.prevZ&&(r.prevZ.nextZ=r.nextZ),r.nextZ&&(r.nextZ.prevZ=r.prevZ),r=e=r.prev,r===r.next)return null;n=!0}else r=r.next;while(n||r!==e);return e}function a(t,e,n,r,i,c){if(t){var x=void 0!==e.vertices;c||void 0===n||f(t,n,r,i);for(var p,m,v=t;t.prev!==t.next;)if(p=t.prev,m=t.next,u(t,n,r,i))x?(s(e,p),s(e,t),s(e,m)):(e.push(p.p),e.push(t.p),e.push(m.p)),m.prev=p,p.next=m,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ),t=m.next,v=m.next;else if(t=m,t===v){c?1===c?(t=h(t,e),a(t,e,n,r,i,2)):2===c&&l(t,e,n,r,i):a(o(t),e,n,r,i,1);break}}}function s(t,e){e.source&&(e=e.source);var n=e.index;if(null===n){var r=e.p.length,i=t.vertices;e.index=n=i.length/r;for(var o=0;r>o;o++)i.push(e.p[o])}t.indices.push(n)}function u(t,e,n,r){var i=t.prev.p,o=t.p,a=t.next.p,s=i[0],u=o[0],h=a[0],l=i[1],c=o[1],x=a[1],p=s*c-l*u,f=s*x-l*h,m=h*c-x*u,d=p-f-m;if(0>=d)return!1;var y,g,z,b,E,T,M,A=x-l,w=s-h,R=l-c,F=u-s;if(void 0!==e){var I=u>s?h>s?s:h:h>u?u:h,S=c>l?x>l?l:x:x>c?c:x,_=s>u?s>h?s:h:u>h?u:h,P=l>c?l>x?l:x:c>x?c:x,N=v(I,S,e,n,r),D=v(_,P,e,n,r);for(M=t.nextZ;M&&M.z<=D;)if(y=M.p,M=M.nextZ,y!==i&&y!==a&&(g=y[0],z=y[1],b=A*g+w*z-f,b>=0&&(E=R*g+F*z+p,E>=0&&(T=d-b-E,T>=0&&(b&&E||b&&T||E&&T)))))return!1;for(M=t.prevZ;M&&M.z>=N;)if(y=M.p,M=M.prevZ,y!==i&&y!==a&&(g=y[0],z=y[1],b=A*g+w*z-f,b>=0&&(E=R*g+F*z+p,E>=0&&(T=d-b-E,T>=0&&(b&&E||b&&T||E&&T)))))return!1}else for(M=t.next.next;M!==t.prev;)if(y=M.p,M=M.next,g=y[0],z=y[1],b=A*g+w*z-f,b>=0&&(E=R*g+F*z+p,E>=0&&(T=d-b-E,T>=0&&(b&&E||b&&T||E&&T))))return!1;return!0}function h(t,e){var n=!!e.vertices,r=t;do{var i=r.prev,o=r.next.next;if(i.p!==o.p&&b(i.p,r.p,r.next.p,o.p)&&T(i,o)&&T(o,i)){n?(s(e,i),s(e,r),s(e,o)):(e.push(i.p),e.push(r.p),e.push(o.p)),i.next=o,o.prev=i;var a=r.prevZ,u=r.nextZ&&r.nextZ.nextZ;a&&(a.nextZ=u),u&&(u.prevZ=a),r=t=o}r=r.next}while(r!==t);return r}function l(t,e,n,r,i){var s=t;do{for(var u=s.next.next;u!==s.prev;){if(s.p!==u.p&&y(s,u)){var h=w(s,u);return s=o(s,s.next),h=o(h,h.next),a(s,e,n,r,i),void a(h,e,n,r,i)}u=u.next}s=s.next}while(s!==t)}function c(t,e){for(var n=t.length,r=[],a=1;n>a;a++){var s=o(i(t[a],!1));s&&r.push(d(s))}for(r.sort(A),a=0;a<r.length;a++)x(r[a],e),e=o(e,e.next);return e}function x(t,e){if(e=p(t,e)){var n=w(e,t);o(n,n.next)}}function p(t,e){var n,r,i,o=e,a=t.p,s=a[0],u=a[1],h=-(1/0);do{if(r=o.p,i=o.next.p,u<=r[1]&&u>=i[1]){var l=r[0]+(u-r[1])*(i[0]-r[0])/(i[1]-r[1]);s>=l&&l>h&&(h=l,n=r[0]<i[0]?o:o.next)}o=o.next}while(o!==e);if(!n)return null;var c,x,p,f,m,v,d=n.p[0],y=n.p[1],g=s*y-u*d,z=s*u-u*h,b=u-u,E=s-h,M=u-y,A=d-s,w=g-z-(h*y-u*d),R=0>=w?-1:1,F=n,I=1/0;for(o=n.next;o!==F;)c=o.p[0],x=o.p[1],p=s-c,p>=0&&c>=d&&(f=(b*c+E*x-z)*R,f>=0&&(m=(M*c+A*x+g)*R,m>=0&&w*R-f-m>=0&&(v=Math.abs(u-x)/p,I>v&&T(o,t)&&(n=o,I=v)))),o=o.next;return n}function f(t,e,n,r){var i=t;do null===i.z&&(i.z=v(i.p[0],i.p[1],e,n,r)),i.prevZ=i.prev,i.nextZ=i.next,i=i.next;while(i!==t);i.prevZ.nextZ=null,i.prevZ=null,m(i)}function m(t){for(var e,n,r,i,o,a,s,u,h=1;;){for(n=t,t=null,o=null,a=0;n;){for(a++,r=n,s=0,e=0;h>e&&(s++,r=r.nextZ,r);e++);for(u=h;s>0||u>0&&r;)0===s?(i=r,r=r.nextZ,u--):0!==u&&r?n.z<=r.z?(i=n,n=n.nextZ,s--):(i=r,r=r.nextZ,u--):(i=n,n=n.nextZ,s--),o?o.nextZ=i:t=i,i.prevZ=o,o=i;n=r}if(o.nextZ=null,1>=a)return t;h*=2}}function v(t,e,n,r,i){return t=1e3*(t-n)/i,t=16711935&(t|t<<8),t=252645135&(t|t<<4),t=858993459&(t|t<<2),t=1431655765&(t|t<<1),e=1e3*(e-r)/i,e=16711935&(e|e<<8),e=252645135&(e|e<<4),e=858993459&(e|e<<2),e=1431655765&(e|e<<1),t|e<<1}function d(t){var e=t,n=t;do e.p[0]<n.p[0]&&(n=e),e=e.next;while(e!==t);return n}function y(t,e){return!E(t,t.p,e.p)&&T(t,e)&&T(e,t)&&M(t,t.p,e.p)}function g(t,e,n){var r=(e[1]-t[1])*(n[0]-e[0])-(e[0]-t[0])*(n[1]-e[1]);return r>0?1:0>r?-1:0}function z(t,e){return t[0]===e[0]&&t[1]===e[1]}function b(t,e,n,r){return g(t,e,n)!==g(t,e,r)&&g(n,r,t)!==g(n,r,e)}function E(t,e,n){var r=t;do{var i=r.p,o=r.next.p;if(i!==e&&o!==e&&i!==n&&o!==n&&b(i,o,e,n))return!0;r=r.next}while(r!==t);return!1}function T(t,e){return-1===g(t.prev.p,t.p,t.next.p)?-1!==g(t.p,e.p,t.next.p)&&-1!==g(t.p,t.prev.p,e.p):-1===g(t.p,e.p,t.prev.p)||-1===g(t.p,t.next.p,e.p)}function M(t,e,n){var r=t,i=!1,o=(e[0]+n[0])/2,a=(e[1]+n[1])/2;do{var s=r.p,u=r.next.p;s[1]>a!=u[1]>a&&o<(u[0]-s[0])*(a-s[1])/(u[1]-s[1])+s[0]&&(i=!i),r=r.next}while(r!==t);return i}function A(t,e){return t.p[0]-e.p[0]}function w(t,e){var n=new F(t.p),r=new F(e.p),i=t.next,o=e.prev;return n.source=t,r.source=e,t.next=e,e.prev=t,n.next=i,i.prev=n,r.next=n,n.prev=r,o.next=r,r.prev=o,r}function R(t,e){var n=new F(t);return e?(n.next=e.next,n.prev=e,e.next.prev=n,e.next=n):(n.prev=n,n.next=n),n}function F(t){this.p=t,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.source=null,this.index=null}e.exports=r},{}],21:[function(t,e,n){!function(t,r){"use strict";"object"==typeof n?e.exports=r():"function"==typeof define&&define.amd?define(r):t.MersenneTwister=r()}(this,function(){"use strict";var t=4294967296,e=624,n=397,r=2147483648,i=2147483647,o=2567483615,a=function(t){"undefined"==typeof t&&(t=(new Date).getTime()),this.mt=new Array(e),this.mti=e+1,this.seed(t)};a.prototype.seed=function(t){var n;for(this.mt[0]=t>>>0,this.mti=1;this.mti<e;this.mti++)n=this.mt[this.mti-1]^this.mt[this.mti-1]>>>30,this.mt[this.mti]=(1812433253*((4294901760&n)>>>16)<<16)+1812433253*(65535&n)+this.mti,this.mt[this.mti]>>>=0},a.prototype.seedArray=function(t){var n,r=1,i=0,o=e>t.length?e:t.length;for(this.seed(19650218);o>0;o--)n=this.mt[r-1]^this.mt[r-1]>>>30,this.mt[r]=(this.mt[r]^(1664525*((4294901760&n)>>>16)<<16)+1664525*(65535&n))+t[i]+i,this.mt[r]>>>=0,r++,i++,r>=e&&(this.mt[0]=this.mt[e-1],r=1),i>=t.length&&(i=0);for(o=e-1;o;o--)n=this.mt[r-1]^this.mt[r-1]>>>30,this.mt[r]=(this.mt[r]^(1566083941*((4294901760&n)>>>16)<<16)+1566083941*(65535&n))-r,this.mt[r]>>>=0,r++,r>=e&&(this.mt[0]=this.mt[e-1],r=1);this.mt[0]=2147483648},a.prototype.int=function(){var t,a,s=new Array(0,o);if(this.mti>=e){for(this.mti===e+1&&this.seed(5489),a=0;e-n>a;a++)t=this.mt[a]&r|this.mt[a+1]&i,this.mt[a]=this.mt[a+n]^t>>>1^s[1&t];for(;e-1>a;a++)t=this.mt[a]&r|this.mt[a+1]&i,this.mt[a]=this.mt[a+(n-e)]^t>>>1^s[1&t];t=this.mt[e-1]&r|this.mt[0]&i,this.mt[e-1]=this.mt[n-1]^t>>>1^s[1&t],this.mti=0}return t=this.mt[this.mti++],t^=t>>>11,t^=t<<7&2636928640,t^=t<<15&4022730752,t^=t>>>18,t>>>0},a.prototype.int31=function(){return this.int()>>>1},a.prototype.real=function(){return this.int()*(1/(t-1))},a.prototype.realx=function(){return(this.int()+.5)*(1/t)},a.prototype.rnd=function(){return this.int()*(1/t)},a.prototype.random=a.prototype.rnd,a.prototype.rndHiRes=function(){var t=this.int()>>>5,e=this.int()>>>6;return(67108864*t+e)*(1/9007199254740992)};var s=new a;return a.random=function(){return s.rnd()},a})},{}],22:[function(t,e,n){var r=function(){var t=Date.now(),e=t,n=0,r=1/0,i=0,o=0,a=1/0,s=0,u=0,h=0,l=document.createElement("div");l.id="stats",l.addEventListener("mousedown",function(t){t.preventDefault(),y(++h%2)},!1),l.style.cssText="width:80px;opacity:0.9;cursor:pointer";var c=document.createElement("div");c.id="fps",c.style.cssText="padding:0 0 3px 3px;text-align:left;background-color:#002",l.appendChild(c);var x=document.createElement("div");x.id="fpsText",x.style.cssText="color:#0ff;font-family:Helvetica,Arial,sans-serif;font-size:9px;font-weight:bold;line-height:15px",x.innerHTML="FPS",c.appendChild(x);var p=document.createElement("div");for(p.id="fpsGraph",p.style.cssText="position:relative;width:74px;height:30px;background-color:#0ff",c.appendChild(p);74>p.children.length;){var f=document.createElement("span");f.style.cssText="width:1px;height:30px;float:left;background-color:#113",p.appendChild(f)}var m=document.createElement("div");m.id="ms",m.style.cssText="padding:0 0 3px 3px;text-align:left;background-color:#020;display:none",l.appendChild(m);var v=document.createElement("div");v.id="msText",v.style.cssText="color:#0f0;font-family:Helvetica,Arial,sans-serif;font-size:9px;font-weight:bold;line-height:15px",v.innerHTML="MS",m.appendChild(v);var d=document.createElement("div");for(d.id="msGraph",d.style.cssText="position:relative;width:74px;height:30px;background-color:#0f0",m.appendChild(d);74>d.children.length;)f=document.createElement("span"),f.style.cssText="width:1px;height:30px;float:left;background-color:#131",d.appendChild(f);var y=function(t){switch(h=t){case 0:c.style.display="block",m.style.display="none";break;case 1:c.style.display="none",m.style.display="block"}};return{REVISION:12,domElement:l,setMode:y,begin:function(){t=Date.now()},end:function(){var h=Date.now();n=h-t,r=Math.min(r,n),i=Math.max(i,n),v.textContent=n+" MS ("+r+"-"+i+")";var l=Math.min(30,30-30*(n/200));return d.appendChild(d.firstChild).style.height=l+"px",u++,h>e+1e3&&(o=Math.round(1e3*u/(h-e)),a=Math.min(a,o),s=Math.max(s,o),x.textContent=o+" FPS ("+a+"-"+s+")",l=Math.min(30,30-30*(o/100)),p.appendChild(p.firstChild).style.height=l+"px",e=h,u=0),h},update:function(){t=this.end()}}};"object"==typeof e&&(e.exports=r)},{}],23:[function(t,e,n){var r=t("./../lib/glMatrixSubset"),i=t("./../Context"),o=t("./../lib/Mesh"),a=(t("./../lib/Geom"),t("./../lib/QuadTree")),s=t("./../lib/Loader"),u=(r.vec3,r.mat4),h=i.gl,l=t("../generators/BuildingSHG.js"),c=t("../generators/City.js"),x=function(t,e,n){return t*(1-n)+e*n},p=function(t,e){for(var n=[],r=[],i=[],a=[],s=[],u=0,h=t.lots.length;h>u;u++){var c,x,p,f,m,v,d,y,g;c=t.lots[u],x=c.height,p=c.angle,c=c.poly,f=m=0,v=y=Number.POSITIVE_INFINITY,d=g=Number.NEGATIVE_INFINITY;for(var z=0,b=c.length;b>z;z++){var E=c[z];f+=E.x,m+=E.y,v=Math.min(v,E.x),d=Math.max(d,E.x),y=Math.min(y,E.y),g=Math.max(g,E.y)}f/=c.length,m/=c.length;for(var T=l.create({x:f,y:m,width:.9*Math.abs(d-v),depth:.9*Math.abs(g-y),angle:p}),M=T.geom,A=T.color,w=0,R=M.length;R>w;w++){var F=M[w];if("light"in F)s.push(F.light);else for(var z=0,b=F.vertices.length;b>z;z++)n.push(F.vertices[z]),r.push(F.normals[z]),i.push(F.uvs[z]),a.push(A[z%3]);M[w]=null}}return{mesh:new o(n,r,i,a),lights:s,x:t.x,y:t.y,w:t.w}},f=new c(0),m={quadtree:null,quadtreeLights:null,fixedMeshes:[]},v=document.createElement("pre");v.style.background="white",v.style.color="black",v.style.position="absolute",v.style.right="1rem",v.style.top="7rem",i.canvas.parentElement.appendChild(v),function(){var t,e,n=[],r=[],i=[],u=[],h=[],l=[],c=0,v=f.blocks.length;for(function(){var t=[];f.roads.forEach(function(e){l.push({x:e.x,y:.25,z:e.y}),e.conns.forEach(function(n){-1===t.indexOf(n)&&l.push({x:x(e.x,n.x,.5),y:.25,z:x(e.y,n.y,.5)})}),t.push(e)})}();f.blocks.length;)t=f.blocks.shift(),setTimeout(function(){var t=p(this);h.push(t),c++,s.progress("Blocks",c/v)}.bind(t),0);s.subscribe("Blocks",function(t,n){return function(){var r,i,o,s;r=i=Number.POSITIVE_INFINITY,o=s=Number.NEGATIVE_INFINITY,n.forEach(function(t){r=Math.min(r,t.x-t.w),o=Math.max(o,t.x+t.w),i=Math.min(i,t.y-t.w),s=Math.max(s,t.y+t.w)});var u=Math.abs(o-r)/2,h=Math.abs(s-i)/2;e=new a(u,h,Math.max(u,h),4),n.forEach(function(t){e.insert(t)}),console.log(n),t.quadtree=e,t.allLights=l}}(m,h)),n.push.apply(n,[-20,-.001,-20,-20,-.001,20,20,-.001,20,-20,-.001,-20,20,-.001,20,20,-.001,-20]),r.push.apply(r,[0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0]),i.push.apply(i,[0,0,3,0,40,3,40,40,3,0,0,3,40,40,3,40,0,3]),u.push.apply(u,[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]);for(var d=f.roadQuads.reduce(function(){var t,e;return t=[0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0],e=[0,0,2,0,1,2,1,1,2,0,0,2,1,1,2,1,0,2],function(n,r){for(var i=r[0],o=r[1],a=Math.atan2(o.y-i.y,o.x-i.x)+Math.PI/2,s=Math.abs(.09*Math.cos(a)),u=Math.abs(.09*Math.sin(a)),h={x:i.x+u,y:i.y+s},l={x:o.x-u,y:o.y-s},c=Math.sqrt(Math.pow(l.y-h.y,2)+Math.pow(l.x-h.x,2)),x=[h.x-s,0,h.y-u,l.x-s,0,l.y-u,l.x+s,0,l.y+u,h.x-s,0,h.y-u,l.x+s,0,l.y+u,h.x+s,0,h.y+u],p=e.map(function(t,e){switch(e%3){case 0:return t;case 1:return t*c;default:return t}return t}),f=0,m=x.length;m>f;f++)n.vertices.push(x[f]),n.normals.push(t[f]),n.uvs.push(p[f]),n.extra.push(0);return n}}(),{vertices:[],normals:[],uvs:[],extra:[]}),y=0,g=d.vertices.length;g>y;y++)n.push(d.vertices[y]),r.push(d.normals[y]),i.push(d.uvs[y]),u.push(d.extra[y]);m.fixedMeshes=[new o(n,r,i,u)]}();var d={meshes:[],lights:[],lightParameters:[16,0,8,64],view:u.create(),model:u.create(),count:0,texture:h.createTexture()};h.bindTexture(h.TEXTURE_2D,d.texture),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MAG_FILTER,h.NEAREST),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MIN_FILTER,h.NEAREST),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_S,h.CLAMP_TO_EDGE),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_T,h.CLAMP_TO_EDGE),h.texImage2D(h.TEXTURE_2D,0,h.RGBA,i.w,i.h,0,h.RGBA,h.UNSIGNED_BYTE,null),h.bindTexture(h.TEXTURE_2D,null);var y=0,g=function(t,e){return t.push(e),t},z=2,b=.19,E=1.8,T=0,M=0,A=0,w=0;d.update=function(t){z+=(Math.cos(M)*A-Math.sin(M)*w)*Math.cos(T),b+=Math.sin(T)*w,E+=(Math.sin(M)*A+Math.cos(M)*w)*Math.cos(T),v.textContent=[z,b,E].map(function(t){return t.toFixed(2)}).join(", ")+" "+(Math.PI/T).toFixed(2)+" "+(Math.PI/M).toFixed(2),u.identity(d.view),u.rotateX(d.view,d.view,T),u.rotateY(d.view,d.view,M),u.translate(d.view,d.view,[-z,-b,-E]);var e;e=m.quadtree.query(z,E,4),d.meshes=m.fixedMeshes.reduce(g,[]),d.meshes=e.map(function(t){return t.mesh}).reduce(g,d.meshes),d.lights=m.allLights.reduce(function(t,e){for(var n=0;6>n;n++)t.push(e.x,e.y,e.z);return t},[]),v.textContent+="\nVertices: "+d.meshes.reduce(function(t,e){return t+e.count},0),y+=.001,v.textContent+="\nLights: "+d.lights.length/18},document.body.addEventListener("keydown",function(t){switch(t.which){case 87:w=-.008;break;case 83:w=.008;break;case 65:A=-.008;break;case 68:A=.008}}),document.body.addEventListener("keyup",function(t){switch(t.which){case 87:w=0;break;case 83:w=0;break;case 65:A=0;break;case 68:A=0}}),i.canvas.addEventListener("mousedown",function(t){var e,n,r=t.clientX,o=t.clientY;e=function(t){var e=t.clientX-r,n=t.clientY-o;T+=.005*n,M+=.005*e,r=t.clientX,o=t.clientY,v.textContent=[z,b,E].map(function(t){return t.toFixed(2)}).join(", ")+" "+(Math.PI/T).toFixed(2)+" "+(Math.PI/M).toFixed(2)},n=function(t){i.canvas.removeEventListener("mousemove",e),i.canvas.removeEventListener("mouseup",n)},i.canvas.addEventListener("mousemove",e),i.canvas.addEventListener("mouseup",n)}),e.exports=d},{"../generators/BuildingSHG.js":5,"../generators/City.js":6,"./../Context":1,"./../lib/Geom":11,"./../lib/Loader":12,"./../lib/Mesh":13,"./../lib/QuadTree":14,"./../lib/glMatrixSubset":17}],24:[function(t,e,n){var r,i,o=t("./../lib/glMatrixSubset"),a=t("./../Context"),s=t("./../lib/Mesh"),u=(t("./../lib/Geom"),t("cardinal-spline"),t("./../lib/QuadTree"),t("./../lib/Loader"),o.vec3),h=o.mat4,l=a.gl,c=t("../generators/RoomSHG.js"),x={meshes:[],lights:[],lightParameters:[6,0,2,.1],view:h.create(),model:h.create(),count:0,texture:l.createTexture()};l.bindTexture(l.TEXTURE_2D,x.texture),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MAG_FILTER,l.NEAREST),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MIN_FILTER,l.NEAREST),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_WRAP_S,l.CLAMP_TO_EDGE),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_WRAP_T,l.CLAMP_TO_EDGE),l.texImage2D(l.TEXTURE_2D,0,l.RGBA,a.w,a.h,0,l.RGBA,l.UNSIGNED_BYTE,null),l.bindTexture(l.TEXTURE_2D,null);var p=function(t,e){var n=t.vertices,r=t.normals,i=t.uvs,o=[];return e=e.reduce(function(t,e){return void 0!==e.door&&t.push(e.door.point),t.push(e.room.roomCentroid),t},[]),o=n.map(function(t,e){return.4}),{room:t,mesh:new s(n,r,i,o),lampMesh:new s(new Float32Array(t.lamp.vertices),new Float32Array(t.lamp.normals),new Float32Array(t.lamp.uvs),new Float32Array(t.lamp.extra)),tableMesh:new s(new Float32Array(t.table.vertices),new Float32Array(t.table.normals),new Float32Array(t.table.uvs),new Float32Array(t.table.extra)),lights:t.roomsWorld.map(function(t){return{x:t.x,y:t.y+.75,z:t.z}}),path:e}},f=function(t,e,n){var r,i,o=[t],a=[],s=[],u=[];for(a[n.indexOf(t)]=null;o.length>0&&(r=o.shift(),r!==e);)r.neighbors.forEach(function(t){var e=n.indexOf(t.r);void 0===a[e]&&(o.push(t.r),a[e]=r,s[e]=t.via)});for(r=e;null!==r;)i=n.indexOf(r),void 0!==s[i]&&u.unshift({room:r,door:s[i]}),r=a[i];return u};i=c.create([{x:-4,y:0,z:-8},{x:-4,y:0,z:8},{x:4,y:0,z:8},{x:4,y:0,z:-8}]);for(var m=[],v=0,d=i.nodes.length;d>v;v++)m=m.concat(f(i.nodes[v],i.nodes[(v+1)%d],i.nodes));r=p(i,m);r.room.bbox;x.meshes=[r.mesh,r.lampMesh,r.tableMesh],x.lights=r.lights.reduce(function(t,e){for(var n=0;6>n;n++)t.push(e.x,e.y,e.z);return t},[]);var y=function(t,e){for(var n=[],r=0,i=t.length;i>r;r++)for(var o=t[r],a=t[(r+1)%i],s=t[(r+2)%i],u=a.x-o.x,h=a.z-o.z,l=Math.sqrt(u*u+h*h),c=(Math.atan2(-a.z+o.z,a.x-o.x)+3*Math.PI/2)%(2*Math.PI),x=(Math.atan2(-s.z+a.z,s.x-a.x)+3*Math.PI/2)%(2*Math.PI),p=0,f=0,m=~~(l/e);m>f;f++)p=f/m,n.push({x:o.x*(1-p)+a.x*p,y:o.y*(1-p)+a.y*p,z:o.z*(1-p)+a.z*p,th:c*(1-p)+x*p});return console.log(n),function(t){
var e=t,r=n.length,i=e*r,o=~~i,a=i-o,s=n[o],u=n[(o+1)%r];return{x:s.x*(1-a)+u.x*a,y:s.y*(1-a)+u.y*a,z:s.z*(1-a)+u.z*a,th:s.th*(1-a)+u.th*a}}}(r.path,.025);h.translate(x.view,x.view,[0,0,-8]),h.rotateX(x.view,x.view,Math.PI/2),x.update=function(t){var e=y(t%6e4/6e4),n=e.x,r=e.z,i=e.th,o=u.fromValues(-.0625,.25,.0625),a=u.fromValues(0,.25,-.25),s=u.fromValues(.0625,.25,.0625),l=h.create();h.translate(l,l,[n,0,r]),h.scale(l,l,[2,1,2]),h.rotateY(l,l,i),u.transformMat4(o,o,l),u.transformMat4(a,a,l),u.transformMat4(s,s,l),h.identity(x.view),h.rotateY(x.view,x.view,-i),h.translate(x.view,x.view,[-n,-.75,-r])},e.exports=x},{"../generators/RoomSHG.js":10,"./../Context":1,"./../lib/Geom":11,"./../lib/Loader":12,"./../lib/Mesh":13,"./../lib/QuadTree":14,"./../lib/glMatrixSubset":17,"cardinal-spline":19}],25:[function(t,e,n){function r(){0===f&&requestAnimationFrame(r),h.render()}function i(t){isNaN(i.t0)&&(i.t0=t),p.begin(),u.render(c),c.update(t-i.t0),u.render(x),x.update(t-i.t0),p.end(),window.STAHP!==!0&&requestAnimationFrame(i)}var o=(t("./lib/glMatrixSubset"),t("./Context")),a=o.canvas,s=o.gl,u=t("./Renderer.js"),h=t("./lib/Loader"),l=(t("./generators/City.js"),t("stats-js")),c=t("./scenes/MainScene.js"),x=t("./scenes/RoomScene.js"),p=new l;p.setMode(0),p.domElement.style.position="absolute",p.domElement.style.right="1rem",p.domElement.style.top="1rem",a.parentNode.appendChild(p.domElement);var f=0,m=NaN;h.subscribe("Blocks",function(){console.log("Loading complete"),f=1,m=NaN,u.init(c,x),i()}),s.viewport(0,0,o.w,o.h),r()},{"./Context":1,"./Renderer.js":2,"./generators/City.js":6,"./lib/Loader":12,"./lib/glMatrixSubset":17,"./scenes/MainScene.js":23,"./scenes/RoomScene.js":24,"stats-js":22}]},{},[25]);