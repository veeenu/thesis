!function t(e,n,r){function i(a,s){if(!n[a]){if(!e[a]){var u="function"==typeof require&&require;if(!s&&u)return u(a,!0);if(o)return o(a,!0);var h=new Error("Cannot find module '"+a+"'");throw h.code="MODULE_NOT_FOUND",h}var l=n[a]={exports:{}};e[a][0].call(l.exports,function(t){var n=e[a][1][t];return i(n?n:t)},l,l.exports,t,e,n,r)}return n[a].exports}for(var o="function"==typeof require&&require,a=0;a<r.length;a++)i(r[a]);return i}({1:[function(t,e,n){var r=document.getElementById("thesis-canvas"),i=r.getContext("webgl"),o=r.getBoundingClientRect(),a=o.width,s=o.height;r.width=a,r.height=s,r.style.background="black",e.exports={canvas:r,gl:i,w:a,h:s,aspectRatio:a/s}},{}],2:[function(t,e,n){var r,i,o,a,s,u,h,l=t("./lib/glMatrixSubset"),c=l.mat3,p=l.mat4,x=t("./Context"),f=x.gl,d=f.createProgram(),v=f.createProgram(),m=f.createProgram(),y=f.createProgram(),g=f.createShader(f.VERTEX_SHADER),z=f.createShader(f.FRAGMENT_SHADER),E=f.createShader(f.VERTEX_SHADER),b=f.createShader(f.FRAGMENT_SHADER),T=f.createShader(f.VERTEX_SHADER),M=f.createShader(f.FRAGMENT_SHADER),w=f.createShader(f.VERTEX_SHADER),R=f.createShader(f.FRAGMENT_SHADER);r="uniform mat4 projection, viewmodel;\nuniform mat3 normalM;\n\nattribute vec3 vertex, normal, uv, extra;\n\nvarying vec4 vPosition, clipPosition;\nvarying vec3 texUV, vExtra;\n\nvoid main() {\n  \n  vec4 viewPos = viewmodel * vec4(vertex, 1.);\n  clipPosition = projection * viewPos;\n  gl_Position = clipPosition;\n\n  vPosition = viewPos;\n  vExtra = extra;\n  texUV = uv;\n\n}\n\n",o="#extension GL_OES_standard_derivatives : require\n\nprecision highp float;\n\nuniform sampler2D mainScene, roomScene;\n\nvarying vec4 vPosition, clipPosition;\nvarying vec3 texUV, vExtra;\n\n////////////////////////////////////////////////////////////////////////////////\n// https://github.com/ashima/webgl-noise/blob/master/src/noise2D.glsl         //\n////////////////////////////////////////////////////////////////////////////////\n\nvec3 mod289(vec3 x) { return x - floor(x * (1.0 / 289.0)) * 289.0; }\nvec2 mod289(vec2 x) { return x - floor(x * (1.0 / 289.0)) * 289.0; }\nvec3 permute(vec3 x) { return mod289(((x*34.0)+1.0)*x); }\nfloat snoise(vec2 v) {\n  const vec4 C = vec4(0.211324865405187,  // (3.0-sqrt(3.0))/6.0\n                      0.366025403784439,  // 0.5*(sqrt(3.0)-1.0)\n                     -0.577350269189626,  // -1.0 + 2.0 * C.x\n                      0.024390243902439); // 1.0 / 41.0\n  vec2 i  = floor(v + dot(v, C.yy) );\n  vec2 x0 = v -   i + dot(i, C.xx);\n  vec2 i1;\n  i1 = (x0.x > x0.y) ? vec2(1.0, 0.0) : vec2(0.0, 1.0);\n  vec4 x12 = x0.xyxy + C.xxzz;\n  x12.xy -= i1;\n  i = mod289(i);\n  vec3 p = permute( permute( i.y + vec3(0.0, i1.y, 1.0 ))\n		+ i.x + vec3(0.0, i1.x, 1.0 ));\n  vec3 m = max(0.5 - vec3(dot(x0,x0), dot(x12.xy,x12.xy), dot(x12.zw,x12.zw)), 0.0);\n  m = m*m ;\n  m = m*m ;\n  vec3 x = 2.0 * fract(p * C.www) - 1.0;\n  vec3 h = abs(x) - 0.5;\n  vec3 ox = floor(x + 0.5);\n  vec3 a0 = x - ox;\n  m *= 1.79284291400159 - 0.85373472095314 * ( a0*a0 + h*h );\n  vec3 g;\n  g.x  = a0.x  * x0.x  + h.x  * x0.y;\n  g.yz = a0.yz * x12.xz + h.yz * x12.yw;\n  return 130.0 * dot(m, g);\n}\n\n////////////////////////////////////////////////////////////////////////////////\n// Procedural textures\n////////////////////////////////////////////////////////////////////////////////\n\nvec3 bumpMap(vec3 fvert, vec3 fnorm, float bump) {\n\n  vec3 ddx = normalize(dFdx(fvert)),\n       ddy = normalize(dFdy(fvert)),\n       bU = dFdx(bump) * cross(fnorm, ddy),\n       bV = dFdy(bump) * cross(ddx, fnorm),\n       bD = fnorm + (bU + bV);\n\n  return normalize(bD);\n}\n\nstruct TTextureInfo {\n  vec3 color;\n  vec3 normal;\n};\n\n#define textureBrickI(x, p, notp) ((floor(x)*(p))+max(fract(x)-(notp), 0.0))\nTTextureInfo textureBrick(vec3 fvert, vec3 fnorm, float fdepth, vec2 uv, vec3 brickColor) {\n\n  const float bW  = .0625,\n              bH  = .03125,\n              mS  = 1. / 256.,\n              mWf = mS * .5 / bW,\n              mHf = mS * .5 / bH;\n  const vec3 mortarColor = vec3(.68, .68, .71);\n\n  float u = uv.s / bW,\n        v = uv.t / bH,\n        brU = floor(u),\n        brV = floor(v);\n\n  if(mod(v * .5, 1.) > .5)\n    u += .5;\n  brU = floor(u);\n\n  float noisev = 1. +\n                 snoise(uv * 256.) * .125;\n  float brickDamp = 1. + .125 * sin(1.57 * (brU + 1.)) * sin(2. * (brV + 1.));\n\n  vec2 uuv = vec2(u, v),\n       fw = 2. * vec2(fwidth(uuv.x), fwidth(uuv.y)),\n       mortarPct = vec2(mWf, mHf),\n       brickPct = vec2(1., 1.) - mortarPct,\n       ub = (textureBrickI(uuv + fw, brickPct, mortarPct) -\n             textureBrickI(uuv, brickPct, mortarPct)) / fw;\n\n  vec3 color = mix(mortarColor, brickColor * brickDamp, ub.x * ub.y);\n\n  // Adaptive box blur filter. Not perfect but quick and somewhat acceptable\n  vec2 ubSample, ubKernel = 4. * fwidth(ub), noiseKernel = fwidth(uv);\n  float bump = 0., invd = 1. / 11.;\n\n  for(int x = -1; x <= 1; x++) {\n    for(int y = -1; y <= 1; y++) {\n      ubSample = ub + vec2(float(x), float(y)) * ubKernel;\n      bump += .1111111 * ubSample.x * ubSample.y;\n    }\n  }\n\n  bump *= 1.75;\n\n  // Frequency clamping\n  bump -= 8. * (1. - smoothstep(0., .00125, max(noiseKernel.x, noiseKernel.y))) * noisev;\n\n  return TTextureInfo(\n    color,\n    bumpMap(fvert, fnorm, bump)\n  );\n}\n\n/******************************************************************************\\\n * Window texture\n\\******************************************************************************/\n\nTTextureInfo textureWindow(vec3 fvert, vec3 fnorm, float fdepth, vec2 uv, vec3 windowColor) {\n\n  const vec2 patternPct   = vec2(1., 1.),\n             patternStart = vec2(0., 0.), //(1. - patternPct) * .25,\n             patternEnd   = patternStart + patternPct,\n             framePct     = vec2(1. / 32., 1. / 32.),\n             frameStart   = patternStart + framePct,\n             frameEnd     = patternEnd   - framePct;\n  //const vec3 windowColor  = vec3(.8, .94, .99),\n  const vec3 frameColor   = vec3(.5, .5, .5);\n\n  vec2 fk   = fwidth(uv) * 2.,\n       uuv  = mod(uv, .5 - 1. / 64.),\n       patF = (smoothstep(frameEnd, frameEnd + fk, uuv) - smoothstep(frameStart, frameStart + fk, uuv));\n  float noisep = 1. + \n                snoise(-uv * .5) * .25;\n  float noisev = 1. + \n                 snoise(uv * 16.) * .0625 +\n                 abs(snoise(uv * 512.)) * .0625;\n\n  float bump = patF.x * patF.y;\n\n  return TTextureInfo(\n    mix(frameColor, windowColor * noisep, patF.x * patF.y),\n    bumpMap(fvert, fnorm, bump)\n  );\n}\n\n/******************************************************************************\\\n * Road texture\n\\******************************************************************************/\n\nvec3 textureRoad(vec2 uuv) {\n  const float padding = 1. / 32.,\n              tapeW   = 1. / 32.,\n              tapeL0  = padding,\n              tapeL1  = padding + tapeW,\n              tapeR1  = 1. - tapeL0,\n              tapeR0  = 1. - tapeL1,\n              tapeC0  = .5 - tapeW * .5,\n              tapeC1  = .5 + tapeW * .5,\n              vertDiv = 4.;\n  const vec3 asphaltColor = vec3(.2, .2, .2),\n             stripColor = vec3(.8, .8, .8);\n\n  vec2 uv = uuv + vec2(0, .5), fk = fwidth(uv);\n  float csSpacing = mod(.25 + uv.t * vertDiv, 1.),\n        q = \n    (\n      smoothstep(tapeL0, tapeL0 + fk.x, uv.s) - \n      smoothstep(tapeL1, tapeL1 + fk.x, uv.s)\n    ) +\n    (\n      smoothstep(tapeR0, tapeR0 + fk.x, uv.s) - \n      smoothstep(tapeR1, tapeR1 + fk.x, uv.s)\n    ) +\n    (\n      smoothstep(tapeC0, tapeC0 + fk.x, uv.s) - \n      smoothstep(tapeC1, tapeC1 + fk.x, uv.s)\n    ) * \n    (\n      smoothstep(.5 - fk.y, .5 + fk.y, csSpacing) *\n      (1. - smoothstep(1. - 2. * fk.y, 1., csSpacing))\n    )\n    ;\n\n  float noiseA = 1. +\n                 abs(snoise(uv * 16.))  * .0625 +\n                 abs(snoise(uv * 32.))  * .0625 +\n                 abs(snoise(uv * 128.)) * .125,\n        noiseS = 1. + \n                 abs(snoise(uv * 128.)) * .125;\n\n  return mix(asphaltColor * noiseA, stripColor * noiseS, q);\n}\n\nvec3 textureAsphalt(vec2 uuv) {\n  const vec3 asphaltColor = vec3(.2, .2, .2);\n\n  vec2 uv = uuv + vec2(0, .5);\n  float noiseA = 1. +\n                 abs(snoise(uv * 16.))  * .0625 +\n                 abs(snoise(uv * 32.))  * .0625 +\n                 abs(snoise(uv * 128.)) * .125;\n  return asphaltColor * 2.5 * noiseA;\n}\n\nvec3 textureWood(vec3 str) {\n  const vec3 color0 = vec3(.64, .48, .11),\n             color1 = vec3(.49, .34, .08);\n\n  float noise = \n    .5 * snoise(str.xz * .125) * snoise(str.xy * .125) +\n    .25 * (snoise(str.xz * .25) * snoise(str.xy * .25)) +\n    .125 * (snoise(str.xz * .5) * snoise(str.xy * .5)) +\n    .0625 * (snoise(str.xz) * snoise(str.xy));\n\n  return mix(color0, color1, mod(length(str.xz) + noise, 1.));\n}\n\n////////////////////////////////////////////////////////////////////////////////\n\nfloat packColor(vec3 v) {\n  const float u = 255. / 256.;\n\n  return fract(v.x * u) + floor(v.y * u * 255.) + floor(v.z * u * 255.) * 255.;\n}\n\nvec2 packNormal(in vec3 normal)\n{\n    const float SCALE = 1.7777;\n    float scalar1 = (normal.z + 1.0) * (SCALE * 2.0);\n    return normal.xy / scalar1 + 0.5;\n}\n\nvoid main() {\n\n  TTextureInfo ti;\n  vec3 color, normal;\n\n  float depth = clipPosition.z / clipPosition.w;\n\n  //normal = normalize(faceforward(vNormal, gl_FragCoord.xyz, vNormal));\n  //normal = normalize(vNormal);\n  normal = cross(dFdx(vPosition.xyz), dFdy(vPosition.xyz));\n\n  if(texUV.z > 7.1) {\n    color = texture2D(mainScene, texUV.xy).rgb;\n  }\n  else if(texUV.z > 6.1) {\n    color = textureWood(8. * (vExtra - .5));\n  }\n  else if(texUV.z > 5.1) {\n    ti = textureBrick(vPosition.xyz, normal, gl_FragCoord.z, mod(texUV.xy, 1.), vExtra);\n    color = ti.color;\n    normal = ti.normal;\n  }\n  else if(texUV.z > 4.1) {\n    ti = textureWindow(vPosition.xyz, normal, gl_FragCoord.z, mod(texUV.yx, 1.), vec3(1., 1., .7));\n    color = ti.color;\n    normal = ti.normal;\n  }\n  else if(texUV.z > 3.1) {\n    ti = textureWindow(vPosition.xyz, normal, gl_FragCoord.z, mod(texUV.yx, 1.), vec3(.3, .3, .3));\n    color = ti.color;\n    normal = ti.normal;\n  }\n  else if(texUV.z > 2.1)\n    color = textureAsphalt(mod(texUV.yx, 1.));\n  else if(texUV.z > 1.1)\n    color = textureRoad(mod(texUV.xy, 1.));\n  else\n    color = textureAsphalt(mod(texUV.yx, 1.));\n\n  color = clamp(.2 * color, 0., 1.);\n\n  gl_FragColor = vec4(packNormal(normalize(normal)), packColor(color), depth);\n}\n",i="uniform mat4 viewMatrix;\n\nattribute vec3 lightPos;\nattribute vec2 position;\nvarying vec2 sscoord, coord;\n\nvarying vec3 lPos;\n\nvoid main() {\n  gl_Position = vec4(position, 0., 1.);\n  coord = .5 + .5 * position;\n  sscoord = position;\n  lPos = (viewMatrix * vec4(lightPos, 1.)).xyz;\n}\n",a="#extension GL_OES_standard_derivatives : enable\nprecision highp float;\n\nuniform sampler2D target0;\nuniform mat4 inverseProjection, viewMatrix;\nuniform vec4 lightParameters;\n\nvarying vec2 sscoord, coord;\nvarying vec3 lPos;\n\nvec3 unpackColor(float d) {\n  vec3 ret;\n\n  ret.x = fract(d);\n  float zi = floor(d / 255.);\n  ret.z = fract(zi / 255.);\n  ret.y = fract( floor( d - ( zi * 255. ) ) / 255.);\n\n  return ret;\n}\n\nvec3 unpackNormal(in vec2 enc)\n{\n	const float SCALE = 1.7777;\n	vec2 nn = enc * (2.0 * SCALE) - SCALE;\n	float g = 2.0 / (dot(nn.xy, nn.xy) + 1.0);\n	vec3 normal;\n	normal.xy = g * nn.xy;\n	normal.z = g - 1.0;\n	return normal;\n}\n\n////////////////////////////////////////////////////////////////////////////////\n// Main\n////////////////////////////////////////////////////////////////////////////////\n\nvoid main() {\n\n  vec4 t0 = texture2D(target0, coord);\n  /*if(length(t0.xy) == 0.)\n    discard;*/\n\n  float depth = t0.w;\n\n  vec4 vertexFromDepth = inverseProjection * vec4(sscoord, depth, 1.);\n  vec3 vertex = vertexFromDepth.xyz / vertexFromDepth.w;\n  vec3 lightDir = lPos - vertex;\n\n  float dist = length(lightDir);\n  //if(dist > 2.)\n  //  discard;\n\n  vec3 normal = normalize(unpackNormal(t0.xy)),\n       color  = unpackColor(t0.z);\n\n  float lambert = max(dot(normal, normalize(lightDir)), 0.),\n        specular = step(0., lambert) * pow(dot(normal, normalize(lightDir - vertex)), 64.),\n        att = lightParameters.x * min(1.,\n                1. /\n                (\n                  lightParameters.y + \n                  lightParameters.z * dist + \n                  lightParameters.w * dist * dist\n                )\n              );\n\n  gl_FragColor = vec4((lambert) * att * color, 1.);\n  //gl_FragColor = vec4(color, 1.);\n\n}\n",vsrcSSAO="uniform mat4 viewMatrix;\n\nattribute vec2 position;\nvarying vec2 coord;\n\nvoid main() {\n  gl_Position = vec4(position, 0., 1.);\n  coord = .5 + .5 * position;\n}\n",s="#extension GL_OES_standard_derivatives : enable\nprecision highp float;\n\nuniform sampler2D target0, lightBuffer;\n\nvarying vec2 coord;\n\n#define DL 2.399963229728653\n#define EULER 2.718281828459045\n\nvec2 vrand( const vec2 coord ) {\n \n  vec2 noise;\n \n  float nx = dot ( coord, vec2( 12.9898, 78.233 ) );\n  float ny = dot ( coord, vec2( 12.9898, 78.233 ) * 2.0 );\n \n  noise = clamp( fract ( 43758.5453 * sin( vec2( nx, ny ) ) ), 0.0, 1.0 );\n \n  return ( noise * 2.0  - 1.0 ) * .0003;\n \n}\n\nfloat readDepth(const vec2 coord) {\n  return (96. * .001) / (1000.001 - texture2D(target0, coord).w * 999.999);\n}\n\nfloat cmpDepth(const float d1, const float d2, inout int far) {\n\n  float ga = 2., diff = (d1 - d2) * 100.;\n\n  if(diff < .4)\n    ga = .3;\n  else\n    far = 1;\n\n  float dd = diff - .4,\n        gauss = pow(EULER, -2. * dd * dd / (ga * ga));\n  \n  return gauss;\n}\n\nfloat calcAO(float depth, vec2 uv, float dw, float dh) {\n  float dd = 5. - depth * 5.;\n\n  vec2 vv = vec2(dw, dh),\n       coord1 = uv + dd * vv,\n       coord2 = uv - dd * vv;\n\n  int far = 0;\n  float tmp1 = 0., tmp2 = 0.;\n  \n  tmp1 = cmpDepth(depth, readDepth(coord1), far);\n  if(far > 0) {\n    tmp2 = cmpDepth(readDepth(coord2), depth, far);\n    tmp1 += (1. - tmp1) * tmp2;\n  }\n\n  return tmp1;\n}\n\nvoid main() {\n\n  vec3 color = texture2D(lightBuffer, coord).rgb;\n  float occlusion = 0., \n        vdepth = readDepth(coord),\n        tt = clamp(vdepth, .5, 1.);\n  vec2 noisev = vrand(coord);\n\n  float w = (1. / 1280.) / tt + (noisev.x * (1. - noisev.x)),\n        h = (1. / 800.)  / tt + (noisev.y * (1. - noisev.y)),\n        dz = 1. / 16.,\n        z = 1. - dz * .5,\n        l = 0.;\n  for(int i = 0; i < 16; i++) {\n    float r = sqrt(1. - z),\n          pw = cos(l) * r,\n          ph = sin(l) * r;\n    occlusion += calcAO(vdepth, coord, pw * w, ph * h);\n    z -= dz;\n    l += DL;\n  }\n\n  occlusion *= dz;\n\n  color = mix(color, vec3(0.), occlusion);\n  //color = pow(color, vec3(1. / 2.2));\n\n  gl_FragColor = vec4(color, 1.);\n  //occlusion = 1. - occlusion;\n  //gl_FragColor = vec4(occlusion, occlusion, occlusion, 1.);\n\n  //gl_FragColor = vec4(lambert * att * 2.5 * color, 1.);\n}\n\n",u="attribute vec2 position;\nvarying vec2 coord;\n\nvoid main() {\n  gl_Position = vec4(position, 0., 1.);\n  coord = .5 + .5 * position;\n}\n",h="precision highp float;\n\nuniform sampler2D tex;\nuniform float fade;\nvarying vec2 coord;\n\nvoid main() {\n\n  vec3 color = mix(vec3(0.), texture2D(tex, coord).rgb, fade);\n\n  gl_FragColor = vec4(color, 1.);\n\n}\n\n",f.clearColor(0,0,0,0),f.depthFunc(f.LESS),f.blendFunc(f.ONE,f.ONE);var A,I;A=f.getExtension("OES_standard_derivatives"),I=f.getExtension("OES_texture_float"),f.shaderSource(g,r),f.shaderSource(z,o),f.compileShader(g),f.compileShader(z),f.attachShader(d,g),f.attachShader(d,z),f.linkProgram(d),f.shaderSource(T,vsrcSSAO),f.shaderSource(M,s),f.compileShader(T),f.compileShader(M),f.attachShader(m,T),f.attachShader(m,M),f.linkProgram(m),f.shaderSource(E,i),f.shaderSource(b,a),f.compileShader(E),f.compileShader(b),f.attachShader(v,E),f.attachShader(v,b),f.linkProgram(v),f.shaderSource(w,u),f.shaderSource(R,h),f.compileShader(w),f.compileShader(R),f.attachShader(y,w),f.attachShader(y,R),f.linkProgram(y),console.log("VP:",f.getShaderInfoLog(g),"\nFP:",f.getShaderInfoLog(z),"\nLP:",f.getProgramInfoLog(d),"\nVL:",f.getShaderInfoLog(E),"\nFL:",f.getShaderInfoLog(b),"\nLL:",f.getProgramInfoLog(v),"\nVS:",f.getShaderInfoLog(T),"\nFS:",f.getShaderInfoLog(M),"\nLS:",f.getProgramInfoLog(m),"\nVT:",f.getShaderInfoLog(w),"\nFT:",f.getShaderInfoLog(R),"\nLT:",f.getProgramInfoLog(y),"\nExt:",null!==A?"OES_standard derivatives":"",null!==I?"OES_texture_float":"");var F=f.createTexture(),_=f.createTexture(),S=f.createRenderbuffer(),P=f.createFramebuffer(),N=f.createFramebuffer(),D=f.createFramebuffer();f.bindRenderbuffer(f.RENDERBUFFER,S),f.renderbufferStorage(f.RENDERBUFFER,f.DEPTH_COMPONENT16,x.w,x.h),f.bindTexture(f.TEXTURE_2D,F),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MAG_FILTER,f.NEAREST),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MIN_FILTER,f.NEAREST),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,f.CLAMP_TO_EDGE),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,f.CLAMP_TO_EDGE),f.texImage2D(f.TEXTURE_2D,0,f.RGBA,x.w,x.h,0,f.RGBA,f.FLOAT,null),f.bindTexture(f.TEXTURE_2D,_),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MAG_FILTER,f.NEAREST),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MIN_FILTER,f.NEAREST),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,f.CLAMP_TO_EDGE),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,f.CLAMP_TO_EDGE),f.texImage2D(f.TEXTURE_2D,0,f.RGBA,x.w,x.h,0,f.RGBA,f.UNSIGNED_BYTE,null),f.bindTexture(f.TEXTURE_2D,null),f.bindFramebuffer(f.FRAMEBUFFER,P),f.framebufferRenderbuffer(f.FRAMEBUFFER,f.DEPTH_ATTACHMENT,f.RENDERBUFFER,S),f.framebufferTexture2D(f.FRAMEBUFFER,f.COLOR_ATTACHMENT0,f.TEXTURE_2D,F,0),f.bindFramebuffer(f.FRAMEBUFFER,N),f.framebufferTexture2D(f.FRAMEBUFFER,f.COLOR_ATTACHMENT0,f.TEXTURE_2D,_,0),f.bindFramebuffer(f.FRAMEBUFFER,null);for(var L=f.createBuffer(),C=f.createBuffer(),B=new Float32Array(9216),U=[],X=p.create(),k=p.create(),G=0;512>G;G++)U.push(1,-1,-1,-1,-1,1,1,-1,-1,1,1,1);f.bindBuffer(f.ARRAY_BUFFER,L),f.bufferData(f.ARRAY_BUFFER,new Float32Array(U),f.STATIC_DRAW),f.bindBuffer(f.ARRAY_BUFFER,C),f.bufferData(f.ARRAY_BUFFER,B,f.STREAM_DRAW),f.bindBuffer(f.ARRAY_BUFFER,null),p.perspective(X,Math.PI/2,x.aspectRatio,.001,1e3),p.invert(k,X),[d,v,m,y].forEach(function(t){for(var e=0,n=f.getProgramParameter(t,f.ACTIVE_ATTRIBUTES);n>e;e++){var r=f.getActiveAttrib(t,e).name;t[r]=f.getAttribLocation(t,r)}for(var e=0,n=f.getProgramParameter(t,f.ACTIVE_UNIFORMS);n>e;e++){var r=f.getActiveUniform(t,e).name;t[r]=f.getUniformLocation(t,r)}}),d.activate=function(t){f.useProgram(d),f.bindFramebuffer(f.FRAMEBUFFER,P),f.enable(f.DEPTH_TEST),f.clear(f.COLOR_BUFFER_BIT|f.DEPTH_BUFFER_BIT);var e=p.create(),n=c.create();p.mul(e,t.view,t.model),c.normalFromMat4(n,e),f.activeTexture(f.TEXTURE0),f.bindTexture(f.TEXTURE_2D,d.textures.mainScene),f.activeTexture(f.TEXTURE1),f.bindTexture(f.TEXTURE_2D,d.textures.roomScene),f.uniform1i(d.mainScene,0),f.uniform1i(d.roomScene,1),f.uniformMatrix4fv(d.projection,!1,X),f.uniformMatrix4fv(d.viewmodel,!1,e),f.uniformMatrix3fv(d.normalM,!1,n),f.enableVertexAttribArray(d.vertex),f.enableVertexAttribArray(d.normal),f.enableVertexAttribArray(d.uv),f.enableVertexAttribArray(d.extra),t.meshes.forEach(function(t){f.bindBuffer(f.ARRAY_BUFFER,t.vBuf),f.vertexAttribPointer(d.vertex,3,f.FLOAT,!1,0,0),f.bindBuffer(f.ARRAY_BUFFER,t.uBuf),f.vertexAttribPointer(d.uv,3,f.FLOAT,!1,0,0),f.bindBuffer(f.ARRAY_BUFFER,t.eBuf),f.vertexAttribPointer(d.extra,3,f.FLOAT,!1,0,0),f.drawArrays(f.TRIANGLES,0,t.count)})},d.deactivate=function(){f.bindFramebuffer(f.FRAMEBUFFER,null),f.disableVertexAttribArray(d.vertex),f.disableVertexAttribArray(d.normal),f.disableVertexAttribArray(d.uv),f.disableVertexAttribArray(d.extra),f.disable(f.DEPTH_TEST)};v.activate=function(t){f.useProgram(v),f.bindFramebuffer(f.FRAMEBUFFER,N),f.enable(f.BLEND),f.clear(f.COLOR_BUFFER_BIT),f.activeTexture(f.TEXTURE0),f.bindTexture(f.TEXTURE_2D,F),f.uniform1i(v.target0,0),f.uniform4fv(v.lightParameters,t.lightParameters),f.uniformMatrix4fv(v.viewMatrix,!1,t.view),f.uniformMatrix4fv(v.inverseProjection,!1,k),f.bindBuffer(f.ARRAY_BUFFER,L),f.vertexAttribPointer(v.position,2,f.FLOAT,!1,0,0),f.bindBuffer(f.ARRAY_BUFFER,t.lightBuf),f.vertexAttribPointer(v.lightPos,3,f.FLOAT,!1,0,0),f.enableVertexAttribArray(v.position),f.enableVertexAttribArray(v.lightPos),f.drawArrays(f.TRIANGLES,0,t.lights.length/3)},v.deactivate=function(){f.bindFramebuffer(f.FRAMEBUFFER,null),f.disableVertexAttribArray(v.position),f.disableVertexAttribArray(v.lightPos),f.disable(f.BLEND)},m.activate=function(t){f.useProgram(m),f.bindFramebuffer(f.FRAMEBUFFER,D),f.framebufferTexture2D(f.FRAMEBUFFER,f.COLOR_ATTACHMENT0,f.TEXTURE_2D,t.texture,0),f.clear(f.COLOR_BUFFER_BIT),f.activeTexture(f.TEXTURE0),f.bindTexture(f.TEXTURE_2D,F),f.activeTexture(f.TEXTURE1),f.bindTexture(f.TEXTURE_2D,_),f.uniform1i(m.target0,0),f.uniform1i(m.lightBuffer,1),f.bindBuffer(f.ARRAY_BUFFER,L),f.vertexAttribPointer(m.position,2,f.FLOAT,!1,0,0),f.enableVertexAttribArray(m.position),f.drawArrays(f.TRIANGLES,0,6)},m.deactivate=function(){f.disableVertexAttribArray(m.position),f.bindFramebuffer(f.FRAMEBUFFER,null)},y.activate=function(t){f.useProgram(y),f.clear(f.COLOR_BUFFER_BIT),f.activeTexture(f.TEXTURE0),f.bindTexture(f.TEXTURE_2D,t.texture),f.uniform1i(y.tex,0),f.uniform1f(y.fade,"fade"in t?t.fade:1),f.bindBuffer(f.ARRAY_BUFFER,L),f.vertexAttribPointer(y.position,2,f.FLOAT,!1,0,0),f.enableVertexAttribArray(y.position),f.drawArrays(f.TRIANGLES,0,6)},e.exports={init:function(t,e){d.textures={mainScene:t.texture,roomScene:e.texture}},render:function(t,e){d.activate(t),d.deactivate(),v.activate(t),v.deactivate(),m.activate(t),m.deactivate(),e===!0&&y.activate(t)}}},{"./Context":1,"./lib/glMatrixSubset":18}],3:[function(t,e,n){var r=t("./../lib/ShapeGrammar"),i=t("../lib/SHAPE.js"),o=t("./../lib/Geom"),a=new r,s=new r;a.define("Balcony",null,function(){var t=this.points,e={sym:"BalconyFloor",points:[{x:t[0].x,y:t[0].y,z:t[0].z},{x:t[1].x,y:t[1].y,z:t[1].z},{x:t[2].x,y:t[2].y,z:t[2].z},{x:t[3].x,y:t[3].y,z:t[3].z}],extrudeBorders:this.floorHeight},n={sym:"BalconyFloor",points:[{x:t[0].x,y:t[0].y+this.floorHeight,z:t[0].z},{x:t[1].x,y:t[1].y+this.floorHeight,z:t[1].z},{x:t[2].x,y:t[2].y+this.floorHeight,z:t[2].z},{x:t[3].x,y:t[3].y+this.floorHeight,z:t[3].z}]},r=i.extrudeAll(e.points,this.floorHeight,"TQuad"),o=i.extrudeAll(n.points,this.fenceHeight,"Fence");return o.pop(),r.push.apply(r,o),r.push(e,n),r}),a.define("BalconyFloor",null,function(){var t=i.splitXZ(this,[.8,.15,.05],[.05,.45,.5],"TQuad"),e=t.splice(4,1).shift().points;if("extrudeBorders"in this){var n=i.extrudeAll([{x:e[0].x,y:e[0].y,z:e[0].z},{x:e[1].x,y:e[1].y,z:e[1].z},{x:e[2].x,y:e[2].y,z:e[2].z},{x:e[3].x,y:e[3].y,z:e[3].z}],this.extrudeBorders,"TQuad");t.push.apply(t,n)}return t}),a.define("Fence",null,function(){var t=i.fit("x",this,"StickBase",.25),e=this.points[0],n=this.points[1],r=this.points[3],o=r.x-e.x,a=r.z-e.z,s=Math.atan2(a,o)-Math.PI/2,u=.05*Math.cos(s),h=.05*Math.sin(s),l={sym:"TQuad",points:[{x:e.x,y:n.y,z:e.z},{x:e.x+u,y:n.y,z:e.z+h},{x:r.x+u,y:n.y,z:r.z+h},{x:r.x,y:n.y,z:r.z}]},c={sym:"TQuad",points:[{x:e.x,y:n.y+.05,z:e.z},{x:e.x+u,y:n.y+.05,z:e.z+h},{x:r.x+u,y:n.y+.05,z:r.z+h},{x:r.x,y:n.y+.05,z:r.z}]};t.push(l),t.push(c);var p=l.points;return t.push.apply(t,i.extrudeAll([{x:p[0].x,y:p[0].y,z:p[0].z},{x:p[1].x,y:p[1].y,z:p[1].z},{x:p[2].x,y:p[2].y,z:p[2].z},{x:p[3].x,y:p[3].y,z:p[3].z}],.05,"TQuad")),t}),a.define("StickBase",null,function(){var t=i.split(this,[.45,.1,.45],[1],null),e=t[1],n=e.points,r=n[3].x-n[0].x,o=n[1].y-n[0].y,a=n[3].z-n[0].z,s=Math.atan2(a,r)-Math.PI/2,u=Math.sqrt(r*r+a*a),h=Math.abs(o),l=Math.cos(s)*u,c=Math.sin(s)*u;return{sym:"Stick",points:[{x:n[0].x,y:n[0].y,z:n[0].z},{x:n[0].x+l,y:n[0].y,z:n[0].z+c},{x:n[3].x+l,y:n[0].y,z:n[3].z+c},{x:n[3].x,y:n[0].y,z:n[3].z}],stickHeight:h}}),a.define("Stick",null,function(){var t=this.points;return i.extrudeAll([{x:t[0].x,y:t[0].y,z:t[0].z},{x:t[1].x,y:t[1].y,z:t[1].z},{x:t[2].x,y:t[2].y,z:t[2].z},{x:t[3].x,y:t[3].y,z:t[3].z}],this.stickHeight,"TQuad")}),a.define("TQuad",null,function(){var t,e=[],n=[],i=[];this.uvs=this.uvs||[{s:0,t:1},{s:0,t:0},{s:1,t:0},{s:1,t:1}];var a=this.points[0],s=this.points[1],u=this.points[2],h=this.points[3];e=[a.x,a.y,a.z,s.x,s.y,s.z,u.x,u.y,u.z,a.x,a.y,a.z,u.x,u.y,u.z,h.x,h.y,h.z],i=[0,1,2,0,2,3].reduce(function(t,e){return t.push(this.uvs[e].s,this.uvs[e].t,this.texID||0),t}.bind(this),[]),t=o.triToNormal(e);for(var l=0;6>l;l++)n.push.apply(n,t);return{sym:r.TERMINAL,vertices:e,normals:n,uvs:i}}),s.define("Staircase",null,function(){for(var t=this.stairHeight+this.stairSpace,e=this.height/t,n=this.width/e,r=[],i=0;e>=i;i++)r.push({sym:"Stair",x:this.x+n*i,y:this.y+t*i,z:this.z,height:this.stairHeight,width:n,depth:this.stairDepth});return r.push({sym:"TQuad",points:[{x:this.x-n/2,y:this.y,z:this.z-this.stairDepth/2},{x:this.x-n/2+this.width,y:this.y+this.height,z:this.z-this.stairDepth/2},{x:this.x+n/2+this.width,y:this.y+this.height,z:this.z-this.stairDepth/2},{x:this.x+n/2,y:this.y,z:this.z-this.stairDepth/2}]},{sym:"TQuad",points:[{x:this.x-n/2,y:this.y,z:this.z+this.stairDepth/2},{x:this.x-n/2+this.width,y:this.y+this.height,z:this.z+this.stairDepth/2},{x:this.x+n/2+this.width,y:this.y+this.height,z:this.z+this.stairDepth/2},{x:this.x+n/2,y:this.y,z:this.z+this.stairDepth/2}]}),r}),s.define("Stair",null,function(){var t=this.width/2,e=this.height/2,n=this.depth/2,r=[{sym:"TQuad",points:[{x:this.x-t,y:this.y-e,z:this.z-n},{x:this.x-t,y:this.y-e,z:this.z+n},{x:this.x+t,y:this.y-e,z:this.z+n},{x:this.x+t,y:this.y-e,z:this.z-n}]},{sym:"TQuad",points:[{x:this.x-t,y:this.y+e,z:this.z-n},{x:this.x-t,y:this.y+e,z:this.z+n},{x:this.x+t,y:this.y+e,z:this.z+n},{x:this.x+t,y:this.y+e,z:this.z-n}]}];return r.push.apply(r,i.extrudeAll(r[0].points,this.height,"TQuad")),r}),s.define("TQuad",null,function(){var t,e=[],n=[],i=[];this.uvs=this.uvs||[{s:0,t:1},{s:0,t:0},{s:1,t:0},{s:1,t:1}];var a=this.points[0],s=this.points[1],u=this.points[2],h=this.points[3];e=[a.x,a.y,a.z,s.x,s.y,s.z,u.x,u.y,u.z,a.x,a.y,a.z,u.x,u.y,u.z,h.x,h.y,h.z],i=[0,1,2,0,2,3].reduce(function(t,e){return t.push(this.uvs[e].s,this.uvs[e].t,this.texID||0),t}.bind(this),[]),t=o.triToNormal(e);for(var l=0;6>l;l++)n.push.apply(n,t);return{sym:r.TERMINAL,vertices:e,normals:n,uvs:i}});var u,h;u=a.run({sym:"Balcony",points:[{x:-.5,y:0,z:0},{x:-.5,y:0,z:1},{x:.5,y:0,z:1},{x:.5,y:0,z:0}],floorHeight:.025,fenceHeight:.4}).reduce(function(t,e){for(var n=0,r=e.vertices.length;r>n;n++)t.vertices.push(e.vertices[n]),t.normals.push(e.normals[n]),t.uvs.push(e.uvs[n]);return t},{vertices:[],normals:[],uvs:[]}),h=s.run({sym:"Staircase",x:-0.2375,y:.0125,z:.35,height:1,width:.7,stairDepth:.2,stairHeight:.025,stairSpace:.0625}).reduce(function(t,e){for(var n=0,r=e.vertices.length;r>n;n++)t.vertices.push(e.vertices[n]),t.normals.push(e.normals[n]),t.uvs.push(e.uvs[n]);return t},{vertices:u.vertices.slice(),normals:u.normals.slice(),uvs:u.uvs.slice()});var l=function(t){var e=t.vertices,n=t.normals,r=t.uvs;return function(t){for(var i=t.angle,o=Math.cos(i),a=Math.sin(i),s=t.x1-t.x0,u=t.z1-t.z0,h=t.x0+s/2,l=t.z0+u/2,c=t.y,p=t.width,x=t.height,f=t.depth,d=e.length,v=new Float32Array(d),m=new Float32Array(d),y=new Float32Array(r),g=0;d>g;g+=3){var z=e[g]*p,E=e[g+1]*x+c,b=e[g+2]*f;v[g]=z*o+b*a+h,v[g+1]=E,v[g+2]=-z*a+b*o+l,z=n[g],E=n[g+1],b=n[g+2],z=z*o+b*a+h,b=-z*a+b*o+l,m[g]=z,m[g+1]=E,m[g+2]=b}return{vertices:v,normals:m,uvs:y}}};e.exports={createBalcony:l(u),createBalconyWithStairs:l(h)}},{"../lib/SHAPE.js":15,"./../lib/Geom":11,"./../lib/ShapeGrammar":16}],4:[function(t,e,n){var r=t("./PRNG"),i=t("./../lib/Geom"),o=function(t,e,n){return(1-n)*t+n*e},a=function(t,e,n){var r,a,u,h,l,c,p,x,f,d,v,m,y,g=[],z=[],E=[],b=[];for(x=0,v=t.length;v>x;x++)for(r=(x+1)%v,a=(x+2)%v,u=(x-1+v)%v,h=i.lineIntersection(t[x],t[r],e[u],e[x]),l=i.lineIntersection(t[x],t[r],e[r],e[a]),c=h.x-l.x,p=h.y-l.y,y=Math.sqrt(c*c+p*p),ang=Math.atan2(p,c),d=2,z.push(d),E.push(ang),f=0;d>f;f++){var T=f/(d-1);px1=o(h.x,l.x,T),py1=o(h.y,l.y,T),px2=o(e[x].x,e[r].x,T),py2=o(e[x].y,e[r].y,T),g.push({x:o(h.x,l.x,T),y:o(h.y,l.y,T)},{x:o(e[x].x,e[r].x,T),y:o(e[x].y,e[r].y,T)})}for(g.push(g[0]),x=0,v=t.length;v>x;x++){for(m=[],f=0;f<z[x];f++)m.push(g.shift()),m.push(g.shift());m.push(t[(x+1)%v]),m.push(g[0]||t[0]);for(var M=0,d=m.length;d-2>M;M+=2)b.push(new s([m[M],m[(M+1)%d],m[(M+3)%d],m[(M+2)%d]],n.random()+.5,E[x]))}return b},s=function(t,e,n){this.poly=t,this.height=e,this.angle=n},u=function(t,e){var n=new r(e);this.poly=t,this.block=i.insetPolygon(this.poly,.05),this.lots=a(i.insetPolygon(this.block,.1),i.insetPolygon(this.block,.6),n);var o=t.reduce(function(t,e){return t.cx+=e.x,t.cy+=e.y,t.xm>e.x&&(t.xm=e.x),t.xM<e.x&&(t.xM=e.x),t.ym>e.y&&(t.ym=e.y),t.yM<e.y&&(t.yM=e.y),t},{xm:Number.POSITIVE_INFINITY,ym:Number.POSITIVE_INFINITY,xM:Number.NEGATIVE_INFINITY,yM:Number.NEGATIVE_INFINITY,cx:0,cy:0});this.x=o.cx/t.length,this.y=o.cy/t.length,this.w=Math.max(Math.abs(o.xM-o.xm),Math.abs(o.yM-o.ym))};e.exports=u},{"./../lib/Geom":11,"./PRNG":8}],5:[function(t,e,n){var r=t("./../lib/ShapeGrammar"),i=t("../lib/SHAPE.js"),o=t("earcut"),a=t("./../lib/Geom"),s=t("./PRNG"),u=t("./BalconySHG.js"),h=new r,l=new s(31337),c=new s(31338),p=new s(31339),x=new s(31337);h.define("Building",null,function(){for(var t=[],e=0,n=0,r=this.floorsLayout.length;r>n;n++){var i=this.floorsLayout[n],o={sym:i.type,height:i.height,params:i,points:this.points.map(function(t){return{x:t.x,y:t.y+e,z:t.z}}),facadeLayout:this.facadeLayout};"frontFacade"in this&&(o.frontFacade=this.frontFacade),"hasBalcony"in this&&(o.hasBalcony=this.hasBalcony,n>=r-2&&(o.hasBalconyTop=this.hasBalcony)),e+=i.height,t.push(o)}return t}),h.define("FL_GndFloor",null,function(){return function(){var t=i.extrudeAll(this.points,this.height,"Facade",[0,1,0]);switch(this.params.tiles){case"OneDoor":for(var e=0,n=t.length;n>e;e++)t[e].type=this.facadeLayout[e]||"Windows";t[this.frontFacade].type="OneDoor"}return t}}()),h.define("FL_Floor",null,function(){for(var t=i.extrudeAll(this.points,this.height,"Facade",[0,1,0]),e=0,n=t.length;n>e;e++)t[e].type=this.facadeLayout[e]||"Windows",t[e].windows=this.params.windows;return"hasBalcony"in this&&(t[this.frontFacade].hasBalcony=this.hasBalcony),"hasBalconyTop"in this&&(t[this.frontFacade].hasBalconyTop=this.hasBalconyTop),t}),h.define("FL_Ledge",null,function(){var t=[],e=this.height,n=this.points[0].y;t=a.insetPolygon(this.points.map(function(t){return{x:t.x,y:t.z}}),this.params.width).map(function(t){return{x:t.x,y:n,z:t.y}});var r=i.extrudeAll(t,this.height,"Quad",[0,1,0]);return r.forEach(function(t){var n=t.points[3].x-t.points[0].x,r=t.points[1].y-t.points[0].y,i=t.points[3].z-t.points[0].z,o=e/h.UVSCALE,a=o*Math.sqrt(n*n+i*i)/r;t.uvs=[{s:0,t:o},{s:0,t:0},{s:a,t:0},{s:a,t:o}],t.texID=6}),r.push({sym:"Poly",texID:6,points:t}),r.push({sym:"Poly",texID:6,points:t.map(function(t){return{x:t.x,y:t.y+e,z:t.z}})}),r}),h.define("FL_Rooftop",null,function(){var t=[],e=this.height,n=this.points[0].y;t=a.insetPolygon(this.points.map(function(t){return{x:t.x,y:t.z}}),-this.params.width).map(function(t){return{x:t.x,y:n,z:t.y}});for(var r=i.extrudeAll(this.points,this.height,"Quad",[0,1,0]),o=i.extrudeAll(t,this.height,"Quad",[0,1,0]);r.length;)o.push(r.shift());o.forEach(function(t){var n=t.points[3].x-t.points[0].x,r=t.points[1].y-t.points[0].y,i=t.points[3].z-t.points[0].z,o=e/h.UVSCALE,a=o*Math.sqrt(n*n+i*i)/r;t.uvs=[{s:0,t:o},{s:0,t:0},{s:a,t:0},{s:a,t:o}],t.texID=6}),o.push({sym:"Poly",points:t,texID:3});for(var s=0,u=t.length;u>s;s++){var l=(s+1)%u,c=this.points[s],p=t[s],x=t[l],f=this.points[l],d={sym:"Poly",points:[c,p,x,c,x,f].map(function(t){return{x:t.x,y:t.y+e,z:t.z}}),texID:6};o.push(d)}return o}),h.define("Facade",function(){
return"OneDoor"===this.type},function(){var t=this.points[3].x-this.points[0].x,e=this.points[1].y-this.points[0].y,n=this.points[3].z-this.points[0].z,r=e/h.UVSCALE,o=r*Math.sqrt(t*t+n*n)/e;this.uvs=[{s:0,t:r},{s:0,t:0},{s:o,t:0},{s:o,t:r}];var a=i.fit("x",this,"Window",1);return a[~~(a.length/2)].sym="Door",a}),h.define("Facade",null,function(){var t=this.points[3].x-this.points[0].x,e=this.points[1].y-this.points[0].y,n=this.points[3].z-this.points[0].z,o=Math.sqrt(t*t+n*n),a=e/h.UVSCALE,s=a*o/e,l=null;this.normal;this.uvs=[{s:0,t:a},{s:0,t:0},{s:s,t:0},{s:s,t:a}];var c=i.fit("x",this,"Window",1);if("Window"===this.type);else if("function"==typeof this.type)for(var p=0,x=c.length;x>p;p++)this.type(p)||(c[p].sym="Quad",c[p].texID=6);if(this.hasBalcony){var f=(c.length%2===0?2:3)/c.length,d={x0:this.points[0].x,z0:this.points[0].z,x1:this.points[3].x,z1:this.points[3].z,y:this.points[0].y,height:e,width:.9*o*f,depth:.4*o*f,angle:Math.atan2(-n,t)};l=this.hasBalconyTop?u.createBalcony(d):u.createBalconyWithStairs(d),l.sym=r.TERMINAL}return null!==l&&c.push(l),c}),h.define("Window",null,function(){var t=i.split(this,[.3,.4,.3],[1],"Quad"),e=i.split(t[1],[1],[.15,.7,.15],"Quad"),n=e[1],r=l.random()>.8;n.uvs=null,n.texID=r?5:4,t[0].texID=t[2].texID=e[0].texID=e[2].texID=6;var o=[t[0],t[2],e[0],e[2]],s=this.normal||a.triToNormal([n.points[0].x,n.points[0].y,n.points[0].z,n.points[1].x,n.points[1].y,n.points[1].z,n.points[2].x,n.points[2].y,n.points[2].z]),u=i.extrudeAll(n.points,-.0025,"Quad",s),h=s[0],c=s[1],p=s[2];h*=.0025,c*=.0025,p*=.0025;for(var x=0,f=n.points.length;f>x;x++){var d=n.points[x];d.x-=h,d.y-=c,d.z-=p}for(var x=0,f=u.length;f>x;x++)u[x].texID=3,o.push(u[x]);return o.push(n),o}),h.define("Door",null,function(){var t=i.split(this,[.15,.7,.15],[1],"Quad"),e=i.split(t[1],[1],[.7,.3],"Quad"),n=e[0];n.uvs=null,n.texID=l.random()>.3?4:5,t[0].texID=t[2].texID=e[1].texID=6;var r=[t[0],t[2],e[1]],o=a.triToNormal([n.points[0].x,n.points[0].y,n.points[0].z,n.points[1].x,n.points[1].y,n.points[1].z,n.points[2].x,n.points[2].y,n.points[2].z]),s=i.extrudeAll(n.points,-.005,"Quad",o),u=o[0],h=o[1],c=o[2];u*=.005,h*=.005,c*=.005;for(var p=0,x=n.points.length;x>p;p++){var f=n.points[p];f.x-=u,f.y-=h,f.z-=c}for(var p=0,x=s.length;x>p;p++)s[p].texID=3,r.push(s[p]);return r.push(n),r}),h.define("Quad",null,function(){var t=[{s:0,t:1},{s:0,t:0},{s:1,t:0},{s:1,t:1}];return function(){var e,n,i,o,a,s,u,h,l,c,p,x=this.points;return h=x[0],l=x[1],c=x[2],p=x[3],e=[h.x,h.y,h.z,l.x,l.y,l.z,c.x,c.y,c.z,h.x,h.y,h.z,c.x,c.y,c.z,p.x,p.y,p.z],n=this.uvs||t,o=n[0],a=n[1],s=n[2],u=n[3],i=this.texID||0,n=[o.s,o.t,i,a.s,a.t,i,s.s,s.t,i,o.s,o.t,i,s.s,s.t,i,u.s,u.t,i],{sym:r.TERMINAL,vertices:e,uvs:n}}}()),h.define("Poly",null,function(){var t,e,n,i,a,s,u,h=this.points.map(function(t){return[t.x,t.z]}),l=this.points[0].y,c=o([h]),p=c.reduce(function(t,e){return t.push(e[0],l,e[1]),t},[]),x=[];t=e=Number.POSITIVE_INFINITY,n=i=Number.NEGATIVE_INFINITY;for(var f=0,d=this.points.length;d>f;f++)u=this.points[f],t>u.x&&(t=u.x),n<u.x&&(n=u.x),e>u.z&&(e=u.z),i<u.z&&(i=u.z);a=n-t,s=i-e;for(var f=0,d=p.length;d>f;f+=3){var v=p[f],m=p[f+2];x.push((v-t)/a,(m-e)/s,this.texID)}return{sym:r.TERMINAL,vertices:p,uvs:x}});var f=[[.9,.65,.48],[.75,.73,.69],[.82,.67,.42],[.6,.39,.33]];h.UVSCALE=.1,e.exports={shg:h,create:function(t){var e=t.width/2,n=t.depth/2,r=t.x-e,i=t.x+e,o=t.y-n,a=t.y+n,s=Math.max(e/n,n/e),u=1e3*(i+r+a+o),d=null,v=!1;l.seed(u),c.seed(u),p.seed(u);var m=[];if(1.3>s&&c.random()<.3)for(var y=0;8>y;y++){var g=-t.angle-y*Math.PI/4;m.push({x:t.x+e*Math.cos(g),y:0,z:t.y+n*Math.sin(g)}),d=0}else if(s>1.1&&c.random()<.8){v=!0;var z=2/2.7;e>n?t.angle<.1?(m.push({x:r,y:0,z:o},{x:r,y:0,z:a},{x:r+e*z,y:0,z:a},{x:r+e*z,y:0,z:a-n*z},{x:i-e*z,y:0,z:a-n*z},{x:i-e*z,y:0,z:a},{x:i,y:0,z:a},{x:i,y:0,z:o}),d=3):(m.push({x:r,y:0,z:o},{x:r,y:0,z:a},{x:i,y:0,z:a},{x:i,y:0,z:o},{x:i-e*z,y:0,z:o},{x:i-e*z,y:0,z:o+n*z},{x:r+e*z,y:0,z:o+n*z},{x:r+e*z,y:0,z:o}),d=5):t.angle>0?(m.push({x:r,y:0,z:o},{x:r,y:0,z:o+n*z},{x:r+e*z,y:0,z:o+n*z},{x:r+e*z,y:0,z:a-n*z},{x:r,y:0,z:a-n*z},{x:r,y:0,z:a},{x:i,y:0,z:a},{x:i,y:0,z:o}),d=2):(m.push({x:r,y:0,z:o},{x:r,y:0,z:a},{x:i,y:0,z:a},{x:i,y:0,z:a-n*z},{x:i-e*z,y:0,z:a-n*z},{x:i-e*z,y:0,z:o+n*z},{x:i,y:0,z:o+n*z},{x:i,y:0,z:o}),d=4)}else m.push({x:r,y:0,z:o},{x:r,y:0,z:a},{x:i,y:0,z:a},{x:i,y:0,z:o}),d=e>n?t.angle<.1?1:3:t.angle<0?2:0;var E=[],b=~~(2*p.random()),T=[];switch(b){case 0:E.push({type:"FL_GndFloor",height:.05,tiles:"OneDoor",frontSide:t.angle},{type:"FL_Ledge",height:.00625,width:.00625});for(var y=0,M=4+~~(20*x.random());M>y;y++)E.push({type:"FL_Floor",height:.05,windows:"Double"});E.push({type:"FL_Ledge",height:.00625,width:.00625},{type:"FL_Floor",height:.0625,windows:"Single"},{type:"FL_Rooftop",height:.00625,width:.00625});break;case 1:E.push({type:"FL_GndFloor",height:.05,tiles:"OneDoor",frontSide:t.angle});for(var y=0,M=4+~~(10*x.random());M>y;y++)E.push({type:"FL_Floor",height:.05,windows:"Double"});E.push({type:"FL_Floor",height:.05,windows:"Single"},{type:"FL_Rooftop",height:.00625,width:.00625})}for(var y=0,M=m.length;M>y;y++){var w=~~(3*x.random());switch(w){case 0:T[y]="Windows";break;case 1:T[y]=function(t){return!(t%3===0)};break;case 2:T[y]=function(t){return t%2===0}}}var R={sym:"Building",floorsLayout:E,facadeLayout:T,points:m};null!==d&&(R.frontFacade=d),v&&(R.hasBalcony=!0);var A=f[~~(x.random()*f.length)],I=h.run(R);return{geom:I,color:A}},getGeom:function(){return context}}},{"../lib/SHAPE.js":15,"./../lib/Geom":11,"./../lib/ShapeGrammar":16,"./BalconySHG.js":3,"./PRNG":8,earcut:19}],6:[function(t,e,n){var r=new(t("./PRNG")),i=t("./../lib/Geom"),o=t("./Roads.js"),a=t("./Block.js"),s=function(){var t=2*Math.PI;return function(e,n,r,o){var a,u,h,l=Math.atan2(-n.y+e.y,n.x-e.x),c={th:Number.POSITIVE_INFINITY,vertex:null};"traversed"in e||(e.traversed=[]),"traversed"in n||(n.traversed=[]),e.traversed.push(n);for(var p=0;p<n.conns.length;p++)u=n.conns[p],u===e||-1!==n.traversed.indexOf(u)||o&&u!==o[0]&&-1!==o.indexOf(u)||(a=Math.atan2(-u.y+n.y,u.x-n.x)-l,a>Math.PI?a-=t:a<-Math.PI&&(a+=t),a<c.th&&(c.th=a,c.vertex=n.conns[p]));return null===c.vertex?null:(o&&o.push(n),o&&c.vertex===o[0]?(h=i.isOverlapping(o,r))?null:(n.traversed.push(o[0]),o):(o=s(n,c.vertex,r,o||[e,n]),null===o&&n.traversed.splice(n.traversed.indexOf(c.vertex),1),o||null))}}(),u=function(t){r.seed(t);var e=[];this.roads=o(),this.blocks=[];for(var n=0;n<this.roads.length;n++)for(var u=0;u<this.roads[n].conns.length;u++){"traversed"in this.roads[n]||(this.roads[n].traversed=[]);var h=s(this.roads[n],this.roads[n].conns[u],this.roads);null===h||i.isPolyIn(h,e)||(e.push(h),this.blocks.push(new a(h,65536*r.random())))}this.roads.forEach(function(t){t.traversed=[]});var l=[];this.roads.forEach(function(t){t.conns.forEach(function(e){-1===e.traversed.indexOf(t)&&(l.push([t,e]),t.traversed.push(e),e.traversed.push(t))})}),this.roadQuads=l};e.exports=u},{"./../lib/Geom":11,"./Block.js":4,"./PRNG":8,"./Roads.js":9}],7:[function(t,e,n){var r=t("./../lib/ShapeGrammar"),i=t("../lib/SHAPE.js"),o=t("./../lib/Geom"),a=new r,s=function(t){return function(e,n){return e=e.concat(i.extrudeAll(n,t,"Quad",[0,-1,0])),e.push({sym:"Quad",points:n}),e.push({sym:"Quad",points:n.map(function(e){return{x:e.x,y:e.y-t,z:e.z}})}),e}},u=function(t){var e=t.vertices.reduce(function(t,e,n){var r=n%3;switch(r){case 0:t.mX=Math.min(t.mX,e),t.MX=Math.max(t.MX,e);break;case 1:t.mY=Math.min(t.mY,e),t.MY=Math.max(t.MY,e);break;case 2:t.mZ=Math.min(t.mZ,e),t.MZ=Math.max(t.MZ,e)}return t},{mX:Number.POSITIVE_INFINITY,MX:Number.NEGATIVE_INFINITY,mY:Number.POSITIVE_INFINITY,MY:Number.NEGATIVE_INFINITY,mZ:Number.POSITIVE_INFINITY,MZ:Number.NEGATIVE_INFINITY});e.lX=e.MX-e.mX,e.lY=e.MY-e.mY,e.lZ=e.MZ-e.mZ;for(var n=t.extra,r=t.vertices,i=0,o=t.vertices.length;o>i;i+=3)n[i]=(r[i]-e.mX)/e.lX,n[i+1]=(r[i+1]-e.mY)/e.lY,n[i+2]=(r[i+2]-e.mZ)/e.lZ;return t};a.define("Chair",null,function(){var t=this.woodThk,e=this.width,n=this.height,r=2*t-.5,i=-r,o=this.cy,a=e/2,u=n/2,h=2*t,l=[{x:r,z:r},{x:r,z:i},{x:i,z:i},{x:i,z:r}].map(function(n){return[{x:e*n.x-t,y:o,z:e*n.z-t},{x:e*n.x-t,y:o,z:e*n.z+t},{x:e*n.x+t,y:o,z:e*n.z+t},{x:e*n.x+t,y:o,z:e*n.z-t}]}),c=[];return c=l.reduce(s(u),c),c=s(-h).call(null,c,[{x:-a,y:o,z:a},{x:-a,y:o,z:-a},{x:a,y:o,z:-a},{x:a,y:o,z:a}]),c=s(-u).call(null,c,[{x:-a,y:h+o,z:-a+h},{x:-a,y:h+o,z:-a},{x:a,y:h+o,z:-a},{x:a,y:h+o,z:-a+h}]).map(function(t){return t.texID=7,t})}),a.define("Table",null,function(){var t=this.woodThk,e=this.width,n=this.height,r=2*t-.5,i=-r,o=this.cy,a=e/2,u=2*t,h=[{x:r,z:r},{x:r,z:i},{x:i,z:i},{x:i,z:r}].map(function(n){return[{x:e*n.x-t,y:o,z:e*n.z-t},{x:e*n.x-t,y:o,z:e*n.z+t},{x:e*n.x+t,y:o,z:e*n.z+t},{x:e*n.x+t,y:o,z:e*n.z-t}]}),l=[];return l=h.reduce(s(n),l),l=s(-u).call(null,l,[{x:-a,y:o,z:a},{x:-a,y:o,z:-a},{x:a,y:o,z:-a},{x:a,y:o,z:a}]).map(function(t){return t.texID=7,t})}),a.define("Lamp",null,function(){for(var t=this.rings,e=this.sectors,n=null,r=[],i=[],o=0;t>o;o++){for(var a=0;e>a;a++){var s=Math.sin(.5*Math.PI*(o+1)/t)*this.radius;r.push({x:Math.cos(2*Math.PI*a/e)*s,z:Math.sin(2*Math.PI*a/e)*s,y:-o/t*this.height})}if(null!==n)for(var a=0;e>a;a++){var u=r[a],h=n[a],l=n[(a+1)%e],c=r[(a+1)%e];i.push({sym:"Quad",texID:7,points:[{x:u.x,y:u.y,z:u.z},{x:h.x,y:h.y,z:h.z},{x:l.x,y:l.y,z:l.z},{x:c.x,y:c.y,z:c.z}]})}n=r,r=[]}return i}),a.define("Quad",null,function(){var t=[{s:0,t:1},{s:0,t:0},{s:1,t:0},{s:1,t:1}];return function(){var e,n,i,a,s,u,h,l,c,p,x,f,d=[],v=this.points;c=v[0],p=v[1],x=v[2],f=v[3],e=[c.x,c.y,c.z,p.x,p.y,p.z,x.x,x.y,x.z,c.x,c.y,c.z,x.x,x.y,x.z,f.x,f.y,f.z],i=this.normal||o.triToNormal(e);for(var m=0;6>m;m++)d.push(i[0],i[1],i[2]);return n=this.uvs||t,s=n[0],u=n[1],h=n[2],l=n[3],a=this.texID||0,n=[s.s,s.t,a,u.s,u.t,a,h.s,h.t,a,s.s,s.t,a,h.s,h.t,a,l.s,l.t,a],{sym:r.TERMINAL,vertices:e,normals:d,uvs:n}}}());var h=a.run({sym:"Table",cy:.4,width:.75,height:.4,woodThk:.025}).reduce(function(t,e){for(var n=0,r=e.vertices.length;r>n;n++)t.vertices.push(e.vertices[n]),t.normals.push(e.normals[n]),t.uvs.push(e.uvs[n]);return t},{vertices:[],normals:[],uvs:[],extra:[]}),l=a.run({sym:"Chair",cy:-.5,width:.5,height:1,woodThk:.03125}).reduce(function(t,e){for(var n=0,r=e.vertices.length;r>n;n++)t.vertices.push(e.vertices[n]),t.normals.push(e.normals[n]),t.uvs.push(e.uvs[n]);return t},{vertices:[],normals:[],uvs:[],extra:[]}),c=a.run({sym:"Lamp",rings:8,sectors:16,radius:.125,height:.25}).reduce(function(t,e){for(var n=0,r=e.vertices.length;r>n;n++)t.vertices.push(e.vertices[n]),t.normals.push(e.normals[n]),t.uvs.push(e.uvs[n]);return t},{vertices:[],normals:[],uvs:[],extra:[]});c=u(c),l=u(l),h=u(h);var p=function(t){return function(e,n,r){return{vertices:t.vertices.map(function(t,i){switch(i%3){case 0:return t+e;case 1:return t+n;case 2:return t+r}}),normals:t.normals,uvs:t.uvs,extra:t.extra}}};e.exports={lamp:p(c),table:p(h),chair:p(l)}},{"../lib/SHAPE.js":15,"./../lib/Geom":11,"./../lib/ShapeGrammar":16}],8:[function(t,e,n){var r=t("mersennetwister"),i=function(t){void 0!==t?this.seed(t):this.mt=new r};i.prototype.seed=function(t){this.mt=new r(t)},i.prototype.random=function(){return this.mt.random()},e.exports=i},{mersennetwister:20}],9:[function(t,e,n){var r=t("./PRNG"),i=4,o=0,a=2;e.exports=function(t){for(var e=[],n=new r(t),s=0;i>s;s++)for(var u=0;i>u;u++){var h=e[s*i+u]={x:a*u+o*n.random(),y:a*s+o*n.random(),conns:[]};u>0&&(h.conns.push(e[s*i+u-1]),e[s*i+u-1].conns.push(h)),s>0&&(h.conns.push(e[(s-1)*i+u]),e[(s-1)*i+u].conns.push(h))}return e}},{"./PRNG":8}],10:[function(t,e,n){var r=t("./../lib/ShapeGrammar"),i=t("./../Context"),o=t("../lib/SHAPE.js"),a=t("./../lib/Geom"),s=t("./PRNG"),u=t("./FurnitureSHG.js"),h=new r,l=new s(12345);h.define("Apartment",null,function(){var t=o.extrudeAll(this.points.slice().reverse(),h.floorHeight,"Quad",[0,1,0]);return t.push({sym:"Room",points:this.points}),t}),h.define("Room",function(){var t=o.bounds(this);return t.width>t.depth&&(t.width>h.minWidth&&l.random()<h.density||t.width>h.maxWidth)},function(){var t=o.splitXZ(this,[h.ratio,1-h.ratio],[1],"Room");return t}),h.define("Room",function(){var t=o.bounds(this);return t.width<=t.depth&&(t.depth>h.minWidth&&l.random()<h.density||t.width>h.maxWidth)},function(){var t=o.splitXZ(this,[1],[h.ratio,1-h.ratio],"Room");return t}),h.define("Room",null,function(t){for(var e=this.points,n=[],r=o.inset(this.points,.05),i=o.bounds(this),n=[],a=0,s=e.length;s>a;a++){var u,l,c=r[a],p=r[(a+1)%s],x=p.x-c.x,f=p.z-c.z,d=Math.atan2(f,x),v=d+Math.PI/2,m=Math.sin(d),y=Math.cos(d),g=Math.sin(v),z=Math.cos(v);u={x:c.x+.3*y,y:c.y,z:c.z+.3*m},l={x:p.x-.3*y,y:p.y,z:p.z-.3*m},n.push({sym:"Wall",points:[e[a],e[(a+1)%s]],p0:u,p1:l,boundaries:[{x:u.x-.1*z,z:u.z-.1*g},{x:u.x+.1*z,z:u.z+.1*g},{x:l.x+.1*z,z:l.z+.1*g},{x:l.x-.1*z,z:l.z-.1*g}].reduce(function(t,e){return{maxX:Math.max(t.maxX,e.x),maxZ:Math.max(t.maxZ,e.z),minX:Math.min(t.minX,e.x),minZ:Math.min(t.minZ,e.z)}},{maxX:Number.NEGATIVE_INFINITY,maxZ:Number.NEGATIVE_INFINITY,minX:Number.POSITIVE_INFINITY,minZ:Number.POSITIVE_INFINITY}),length:Math.sqrt(x*x+f*f),angle:d})}n.push({sym:"Quad",points:this.points});var E=1/e.length,b={sym:"GraphNode",isTerminal:!0,neighbors:[],width:i.width,depth:i.depth,roomCentroid:this.points.reduce(function(t,e){return t.x+=E*e.x,t.y+=E*e.y,t.z+=E*e.z,t},{x:0,y:0,z:0})};return n.forEach(function(t){"Wall"===t.sym&&(t.room=b)}),n.push({sym:"LastRoomCandidate",node:b,points:e}),n.push({sym:"Lamp",isTerminal:!0,point:{x:b.roomCentroid.x,y:this.points[0].y+h.floorHeight,z:b.roomCentroid.z}}),i.width*i.depth>10&&n.push({sym:"Table",isTerminal:!0,point:{x:b.roomCentroid.x+.7*i.width*(Math.random()-.5),y:this.points[0].y,z:b.roomCentroid.z+.7*i.depth*(Math.random()-.5)}}),n}),h.define("LastRoomCandidate",function(t){return t.filter(function(t){return"Room"===t.sym}).length>0},function(t){return this}),h.define("LastRoomCandidate",function(t){return 0===t.filter(function(t){return"LastRoomCandidate"===t.sym}).indexOf(this)},function(t){return this.node.isFirst=!0,this.node}),h.define("LastRoomCandidate",function(t){return 0===t.filter(function(t){return"LastRoomCandidate"===t.sym}).reverse().indexOf(this)},function(t){return this.node.isLast=!0,[this.node,{sym:"LastRoom",node:this.node}]}),h.define("LastRoomCandidate",null,function(t){return this.node}),h.define("LastRoom",function(t){return t.filter(function(t){return"OccludedWall"===t.sym}).length>0},function(){return this}),h.define("LastRoom",null,function(){var t,e=this.node.neighbors.map(function(t){return t.r.roomCentroid}),n=this.node.roomCentroid,r=.9*this.node.width/2,o=.9*this.node.depth/2;t=[{x:n.x,y:n.y,z:n.z+o,mdd:Number.POSITIVE_INFINITY,th:Math.atan2(o,0)},{x:n.x,y:n.y,z:n.z-o,mdd:Number.POSITIVE_INFINITY,th:Math.atan2(-o,0)},{x:n.x+r,y:n.y,z:n.z,mdd:Number.POSITIVE_INFINITY,th:Math.atan2(0,r)},{x:n.x-r,y:n.y,z:n.z,mdd:Number.POSITIVE_INFINITY,th:Math.atan2(0,-r)}],t.forEach(function(t){e.forEach(function(e){var n=e.x-t.x,r=e.z-t.z;t.mdd=Math.min(t.mdd,n*n+r*r)})});var a=t.sort(function(t,e){return t.mdd>e.mdd?-1:e.mdd>t.mdd?1:0}).shift(),s=.15,u=Math.sin(a.th)*s*i.aspectRatio,h=Math.cos(a.th)*s*i.aspectRatio,l={sym:"Quad",texID:8,points:[{x:a.x+u,y:a.y+.75+s,z:a.z-h},{x:a.x+u,y:a.y+.75-s,z:a.z-h},{x:a.x-u,y:a.y+.75-s,z:a.z+h},{x:a.x-u,y:a.y+.75+s,z:a.z+h}]},c={sym:"GraphFinalNode",isTerminal:!0,roomCentroid:{x:a.x-.519*h,y:a.y,z:a.z-.519*u},neighbors:[this.node],isMonitor:!0,door:{angle:a.th,point:n}};return this.node.neighbors.push({r:c,via:c.door}),[l,c]}),h.define("Wall",function(t){return!t.reduce(function(t,e){return t||"Room"===e.sym},!1)},function(t){for(var e=this.boundaries.maxX,n=this.boundaries.maxZ,r=this.boundaries.minX,i=this.boundaries.minZ,o=this.length,a=!1,s=null,u=0,h=t.length;h>u&&!a;u++){var l=t[u];if(!a&&!l.occluded&&l!==this&&"Wall"===l.sym){var c=l.boundaries;l.length>=o&&!(e<c.minX||c.maxX<r||n<c.minZ||c.maxZ<i)&&(a=!0,s=l.room)}}return a?(this.occluded=!0,{sym:"OccludedWall",points:this.points,angle:this.angle,connects:[this.room,s],length:this.length}):[]}),h.define("Wall",null,function(){return this}),h.define("OccludedWall",null,function(){var t,e=this.points[0],n=this.points[1],r=Math.atan2(e.x-n.x,n.z-e.z),i=Math.sin(r)*h.wallDepth/2,a=Math.cos(r)*h.wallDepth/2,s={x:e.x+a,y:e.y,z:e.z+i},u={x:n.x+a,y:n.y,z:n.z+i},l={x:e.x-a,y:e.y,z:e.z-i},c={x:n.x-a,y:n.y,z:n.z-i},p=o.extrude("OccludedWall",s,u,h.floorHeight,[0,1,0]),x=o.extrude("OccludedWall",c,l,h.floorHeight,[0,1,0]),f=.5/this.length,d=(1-f)/2,v=o.split(p,[d,f,d],[1],"Quad"),m=o.split(v[1],[1],[.7,.3],"Quad"),y=o.split(x,[d,f,d],[1],"Quad"),g=o.split(y[1],[1],[.7,.3],"Quad"),z=m[0],E=g[0],b=(1-f/8)/2,T=b+f/8,M={x:o.lerp(e.x,n.x,b),y:o.lerp(e.y,n.y,b),z:o.lerp(e.z,n.z,b)},w={x:o.lerp(e.x,n.x,T),y:o.lerp(e.y,n.y,T),z:o.lerp(e.z,n.z,T)};return t={sym:"Door",angle:r,point:{x:.5*(e.x+n.x),y:.5*(e.y+n.y),z:.5*(e.z+n.z)}},this.connects[0].neighbors.push({r:this.connects[1],via:t}),this.connects[1].neighbors.push({r:this.connects[0],via:t}),[v[0],v[2],m[1],y[0],y[2],g[1],{sym:"Quad",points:[E.points[0],E.points[1],z.points[2],z.points[3]]},{sym:"Quad",points:[E.points[2],E.points[1],z.points[2],z.points[1]]},{sym:"Quad",points:[E.points[3],E.points[2],z.points[1],z.points[0]]},t,{sym:"WallSegment",points:[e,M]},{sym:"WallSegment",points:[w,n]}]}),h.define("Quad",null,function(){var t=[{s:0,t:1},{s:0,t:0},{s:1,t:0},{s:1,t:1}];return function(){var e,n,r,i,o,s,u,h,l,c,p,x,f=[],d=this.points;l=d[0],c=d[1],p=d[2],x=d[3],e=[l.x,l.y,l.z,c.x,c.y,c.z,p.x,p.y,p.z,l.x,l.y,l.z,p.x,p.y,p.z,x.x,x.y,x.z],r=this.normal||a.triToNormal(e);for(var v=0;6>v;v++)f.push(r[0],r[1],r[2]);return n=this.uvs||t,o=n[0],s=n[1],u=n[2],h=n[3],i=this.texID||3,n=[o.s,o.t,i,s.s,s.t,i,u.s,u.t,i,o.s,o.t,i,u.s,u.t,i,h.s,h.t,i],{sym:"Quad",isTerminal:!0,vertices:e,normals:f,uvs:n}}}()),h.define("Door",null,function(){return{sym:"Door",isTerminal:!0,point:this.point,angle:this.angle}}),h.define("WallSegment",null,function(){return{sym:"WallT",isTerminal:!0,p0:this.points[0],p1:this.points[1]}}),h.minWidth=4,h.maxWidth=7,h.density=.8,h.ratio=.61,h.floorHeight=1.5,h.wallDepth=.2,e.exports={shg:h,create:function(t){var e=h.run({sym:"Apartment",points:t}).reduce(function(t,e){switch(e.sym){case"Quad":for(var n=0,r=e.vertices.length;r>n;n++)t.vertices.push(e.vertices[n]),t.normals.push(e.normals[n]),t.uvs.push(e.uvs[n]);break;case"Lamp":for(var i=u.lamp(e.point.x,e.point.y,e.point.z),n=0,r=i.vertices.length;r>n;n++)t.lamp.vertices.push(i.vertices[n]),t.lamp.normals.push(i.normals[n]),t.lamp.uvs.push(i.uvs[n]),t.lamp.extra.push(i.extra[n]);break;case"Table":for(var o=u.table(e.point.x,e.point.y,e.point.z),n=0,r=o.vertices.length;r>n;n++)t.table.vertices.push(o.vertices[n]),t.table.normals.push(o.normals[n]),t.table.uvs.push(o.uvs[n]),t.table.extra.push(o.extra[n]);break;case"Chair":for(var a=u.chair(e.point.x,e.point.y,e.point.z),n=0,r=a.vertices.length;r>n;n++)t.chair.vertices.push(a.vertices[n]),t.chair.normals.push(a.normals[n]),t.chair.uvs.push(a.uvs[n]),t.chair.extra.push(a.extra[n]);break;case"WallT":t.walls.push(e);break;case"Door":t.doors.push(e);break;case"GraphNode":t.rooms.push(e),t.nodes.push(e);break;case"GraphFinalNode":t.monitor=e}return t},{vertices:[],normals:[],uvs:[],walls:[],rooms:[],nodes:[],arcs:[],doors:[],lamp:{vertices:[],normals:[],uvs:[],extra:[]},table:{vertices:[],normals:[],uvs:[],extra:[]},chair:{vertices:[],normals:[],uvs:[],extra:[]},monitor:null});console.log(e.rooms.map(function(t){return t.roomCentroid}));var n=t.reduce(function(t,e){return t.minX=Math.min(e.x,t.minX),t.minZ=Math.min(e.z,t.minZ),t.maxX=Math.max(e.x,t.maxX),t.maxZ=Math.max(e.z,t.maxZ),t},{minX:Number.POSITIVE_INFINITY,maxX:Number.NEGATIVE_INFINITY,minZ:Number.POSITIVE_INFINITY,maxZ:Number.NEGATIVE_INFINITY});return n.lenX=n.maxX-n.minX,n.lenZ=n.maxZ-n.minZ,e.lines=e.walls.reduce(function(t,e){return t.push((e.p0.x-n.minX)/n.lenX,(e.p0.z-n.minZ)/n.lenZ,(e.p1.x-n.minX)/n.lenX,(e.p1.z-n.minZ)/n.lenZ),t},[]),e.roomsWorld=e.rooms.map(function(t){return t.roomCentroid}),e.rooms=e.rooms.reduce(function(t,e){return t.push({x:(e.roomCentroid.x-n.minX)/n.lenX,y:(e.roomCentroid.y-n.minY)/n.lenY,z:(e.roomCentroid.z-n.minZ)/n.lenZ}),t},[]),e.width=n.lenX,e.height=n.lenZ,e.bbox=n,e}}},{"../lib/SHAPE.js":15,"./../Context":1,"./../lib/Geom":11,"./../lib/ShapeGrammar":16,"./FurnitureSHG.js":7,"./PRNG":8}],11:[function(t,e,n){var r={pnpoly:function(t,e,n){var r,i,o,a,s=t.length,u=!1;for(r=0,i=s-1;s>r;i=r++)o=t[r],a=t[i],o.y>n!=a.y>n&&e<(a.x-o.x)*(n-o.y)/(a.y-o.y)+o.x&&(u=!u);return u},isOverlapping:function(t,e){for(var n=e.length-1;n--;)if(r.pnpoly(t,e[n].x,e[n].y)&&-1===t.indexOf(e[n]))return!0;return!1},isPolyIn:function(t,e){for(var n=e.length-1;n>0;n--)if(r.isEqualPoly(t,e[n]))return!0;return!1},isEqualPoly:function(t,e){if(t.length!==e.length)return!1;for(var n=t.length-1;n--;)if(-1===e.indexOf(t[n]))return!1;return!0},insetPolygon:function(t,e){var n,i,o,a=[];i=t[t.length-1];for(var s=0;s<t.length-1;s++)n=i,i=t[s],o=t[s+1],a.push(r.insetCorner(n,i,o,e));return a.push(r.insetCorner(i,o,t[0],e)),a},insetCorner:function(t,e,n,i){var o,a,s,u,h=e.x-t.x,l=t.y-e.y,c=n.x-e.x,p=e.y-n.y,x=Math.sqrt(h*h+l*l),f=Math.sqrt(c*c+p*p),d={x:e.x,y:e.y},v={x:e.x,y:e.y};return 0==x||0==f?null:(o=l/x*i,s=h/x*i,a=p/f*i,u=c/f*i,d.x+=o,d.y+=s,v.x+=a,v.y+=u,d.x===v.x&&d.y===v.y?d:r.lineIntersection({x:t.x+o,y:t.y+s},d,v,{x:n.x+a,y:n.y+u}))},lineIntersection:function(t,e,n,r){var i,o,a,s,u,h={x:t.x,y:t.y},l={x:e.x,y:e.y},c={x:n.x,y:n.y},p={x:r.x,y:r.y};return l.x-=h.x,c.x-=h.x,p.x-=h.x,l.y-=h.y,c.y-=h.y,p.y-=h.y,i=Math.sqrt(l.x*l.x+l.y*l.y),o=l.x/i,a=l.y/i,s=c.x*o+c.y*a,c.y=-c.x*a+c.y*o,c.x=s,s=p.x*o+p.y*a,p.y=-p.x*a+p.y*o,p.x=s,c.y==p.y?null:(u=p.x+(c.x-p.x)*p.y/(p.y-c.y),{x:h.x+u*o,y:h.y+u*a})},triToNormal:function(t){var e=t[0]-t[3],n=t[1]-t[4],r=t[2]-t[5],i=t[6]-t[3],o=t[7]-t[4],a=t[8]-t[5],s=n*a-r*o,u=e*a-r*i,h=e*o-n*i,l=1/Math.sqrt(s*s+u*u+h*h);return s*=l,u*=l,h*=l,[s,u,h]}};e.exports=r},{}],12:[function(t,e,n){var r=t("./../Context"),i={},o=document.createElement("ul");o.style.position="absolute",o.style.top="7rem",o.style.left="1rem",o.style.color="#444",o.style.font='10px "Ubuntu Mono", monospace',o.style.lineHeight="1.5em",o.style.listStyleType="none",r.canvas.parentNode.appendChild(o),e.exports={progress:function(t,e){if(!(t in i)){var n=document.createElement("li");o.appendChild(n),i[t]={fns:[],li:n,value:0}}i[t].value=e,e>=1&&i[t].fns.forEach(function(t){t()})},subscribe:function(t,e){if(!(t in i)){var n=document.createElement("li");o.appendChild(n),i[t]={fns:[],li:n,value:0}}i[t].fns.push(e)},render:function(){for(var t in i){for(var e=parseInt(100*i[t].value),n=""+e;n.length<4;)n="_"+n;n=n.replace(/_/g,"&nbsp;"),i[t].li.innerHTML="&nbsp;"+t+": "+n+"%&nbsp;\n";var r="linear-gradient(90deg, #0f0, #0f0 "+e+"%, #0b0 "+e+"%)";i[t].li.style.backgroundImage=r}}}},{"./../Context":1}],13:[function(t,e,n){var r=t("./../Context"),i=r.gl,o=function(t,e,n){this.vBuf=i.createBuffer(),this.uBuf=i.createBuffer(),this.eBuf=i.createBuffer(),this.count=t.length/3,i.bindBuffer(i.ARRAY_BUFFER,this.vBuf),i.bufferData(i.ARRAY_BUFFER,new Float32Array(t),i.STATIC_DRAW),i.bindBuffer(i.ARRAY_BUFFER,this.uBuf),i.bufferData(i.ARRAY_BUFFER,new Float32Array(e),i.STATIC_DRAW),i.bindBuffer(i.ARRAY_BUFFER,this.eBuf),i.bufferData(i.ARRAY_BUFFER,new Float32Array(n),i.STATIC_DRAW),i.bindBuffer(i.ARRAY_BUFFER,null)};e.exports=o},{"./../Context":1}],14:[function(t,e,n){var r=function(t,e,n,r){this.nw=this.sw=this.ne=this.se=null,this.x=t,this.y=e,this.w=Math.abs(n),this.limit=r,this.points=[]};r.prototype.contains=function(t){return Math.abs(t.x-this.x)<this.w&&Math.abs(t.y-this.y)<this.w},r.prototype.insert=function(t){return this.contains(t)?this.points.length<this.limit?(this.points.push(t),!0):(null===this.nw&&this.subdivide(),this.nw.insert(t)||this.ne.insert(t)||this.sw.insert(t)||this.se.insert(t)):!1},r.prototype.subdivide=function(){var t=this.x,e=this.y,n=this.w/2;this.nw=new r(t-n,e-n,n,this.limit),this.sw=new r(t-n,e+n,n,this.limit),this.ne=new r(t+n,e-n,n,this.limit),this.se=new r(t+n,e+n,n,this.limit)},r.prototype.intersect=function(t,e,n){return Math.abs(this.x-t)<this.w+n&&Math.abs(this.y-e)<this.w+n},r.prototype.query=function(t,e,n){var r=[],o=[],a=this.points;if(!this.intersect(t,e,n))return r;for(var s=0,u=a.length;u>s;s++)i(a[s],t,e,n)&&r.push(a[s]);if(null===this.nw)return r;o=this.nw.query(t,e,n);for(var s=0,u=o.length;u>s;s++)r.push(o[s]);o=this.ne.query(t,e,n);for(var s=0,u=o.length;u>s;s++)r.push(o[s]);o=this.sw.query(t,e,n);for(var s=0,u=o.length;u>s;s++)r.push(o[s]);o=this.se.query(t,e,n);for(var s=0,u=o.length;u>s;s++)r.push(o[s]);return r};var i=function(t,e,n,r){return Math.abs(t.x-e)<r&&Math.abs(t.y-n)<r};e.exports=r},{}],15:[function(t,e,n){var r=t("./Geom"),i={extrude:function(t,e,n,r,i){var o=0,a=r,s=0;return void 0!==i&&(o=i[0]*r,a=i[1]*r,s=i[2]*r),{sym:t,points:[{x:e.x,y:e.y,z:e.z},{x:e.x+o,y:e.y+a,z:e.z+s},{x:n.x+o,y:n.y+a,z:n.z+s},{x:n.x,y:n.y,z:n.z}]}},extrudeAll:function(t,e,n,r){for(var o=[],a=0,s=t.length;s>a;++a){var u=t[a],h=t[(a+1)%s];o.push(i.extrude(n instanceof Array?n[a]:n,u,h,e,r))}return o},split:function(t,e,n,r){var o=[],a=0,s=r instanceof Array,u=t.points,h=t.uvs,l=u[0],c=u[1],p=u[3],x=l.x,f=p.x,d=l.y,v=c.y,m=l.z,y=p.z,g=1,z=1,E=0,b=0;h instanceof Array&&(g=h[3].s-h[0].s,z=h[1].t-h[0].t,E=h[0].s,b=h[1].t);for(var T=0,M=0,w=n.length;w>M;++M){for(var R=0,A=T+n[M],I=0,F=e.length;F>I;++I){var _=R+e[I],S=i.lerp(x,f,R),P=i.lerp(x,f,_),N=i.lerp(d,v,T),D=i.lerp(d,v,A),L=i.lerp(m,y,R),C=i.lerp(m,y,_);o.push({sym:s?r[a++]:r,points:[{x:S,y:N,z:L},{x:S,y:D,z:L},{x:P,y:D,z:C},{x:P,y:N,z:C}],uvs:[{s:E+g*R,t:b+z*T},{s:E+g*R,t:b+z*A},{s:E+g*_,t:b+z*A},{s:E+g*_,t:b+z*T}]}),R=_}T=A}return o},splitXZ:function(t,e,n,r){for(var o=[],a=0,s=t.points,u=s[0],h=s[1],l=s[3],c=u.x,p=l.x,x=u.y,f=h.y,d=u.z,v=h.z,m=0,y=0,g=n.length;g>y;++y){for(var z=0,E=0,b=e.length;b>E;++E){var T=i.lerp(c,p,z),M=i.lerp(c,p,z+e[E]),w=i.lerp(x,f,z),R=i.lerp(x,f,z+e[E]),A=i.lerp(d,v,m),I=i.lerp(d,v,m+n[y]);o.push({sym:r instanceof Array?r[a++]:r,points:[{x:T,y:w,z:A},{x:T,y:w,z:I},{x:M,y:R,z:I},{x:M,y:R,z:A}]}),z+=e[E]}m+=n[y]}return o},splitZX:function(t,e,n,r){for(var o=[],a=0,s=t.points,u=s[0],h=s[1],l=s[3],c=u.x,p=h.x,x=u.y,f=h.y,d=u.z,v=l.z,m=0,y=0,g=n.length;g>y;++y){for(var z=0,E=0,b=e.length;b>E;++E){var T=i.lerp(c,p,z),M=i.lerp(c,p,z+e[E]),w=i.lerp(x,f,z),R=i.lerp(x,f,z+e[E]),A=i.lerp(d,v,m),I=i.lerp(d,v,m+n[y]);o.push({sym:r instanceof Array?r[a++]:r,points:[{x:T,y:w,z:A},{x:T,y:w,z:I},{x:M,y:R,z:I},{x:M,y:R,z:A}]}),z+=e[E]}m+=n[y]}return o},fit:function(t,e,n,r){r=r||1;var o=e.points,a=o[0],s=o[1],u=o[3],h=a.x,l=u.x,c=a.y,p=s.y,x=a.z,f=s.z,d=u.z,v=l-h,m=p-c,y=d-x,g=f-x;if("x"===t){var z=m,E=r*z,b=Math.sqrt(v*v+y*y),T=Math.round(b/E),M=[];E=b/T,T=Math.max(1,Math.abs(T));for(var w=0;T>w;w++)M.push(1/T);return i.split(e,M,[1],n)}if("y"===t){var E=l-h,z=E/r,R=Math.sqrt(m*m+g*g),T=Math.round(R/z),M=[];z=R/T;for(var w=0;T>w;w++)M.push(1/T);return i.split(e,M,[1],n)}},bounds:function(t){var e,n,r,i,o=t.points;e=n=Number.POSITIVE_INFINITY,r=i=Number.NEGATIVE_INFINITY;for(var a=0,s=o.length;s>a;a++){var u=o[a];e=Math.min(u.x,e),n=Math.min(u.z,n),r=Math.max(u.x,r),i=Math.max(u.z,i)}return{width:r-e,depth:i-n}},inset:function(t,e){return r.insetPolygon(t.map(function(t){return{x:t.x,y:t.z}}),-e).map(function(e){return{x:e.x,y:t[0].y,z:e.y}})},lerp:function(t,e,n){return t*(1-n)+e*n}};e.exports=i},{"./Geom":11}],16:[function(t,e,n){var r=function(){this.rules=[]};r.prototype.define=function(t,e,n){this.rules.push({lhs:t,cond:e,rhs:n})},r.prototype.run=function(t){var e=[],n=this.rules,i=0;t=t instanceof Array?t:[t];for(var o=0,a=t.length;a>o;o++){var s=t[o];if(s.sym===r.TERMINAL||s.isTerminal)e.push(s);else for(var u=0,h=n.length;h>u;u++){var l=n[u];if(s.sym===l.lhs&&(null===l.cond||l.cond.call(s,t))){var c=l.rhs.call(s,t);c=c instanceof Array?c:[c];for(var p=0,x=c.length;x>p;p++)e.push(c[p]),++i;break}}}return i>0?this.run(e):e},r.TERMINAL="TERMINAL",e.exports=r},{}],17:[function(t,e,n){var r={no:function(t){return 0},lin:function(t){return t},in2:function(t){return t*t},out2:function(t){var e=1-t;return 1-e*e},in3:function(t){return t*t*t},out3:function(t){var e=1-t;return 1-e*e*e},h01:function(t){return t*t*(3-2*t)}},i=function(t,e,n,r){var o=n+Math.floor((r-n)/2);return 1>=r-n||e[o].time===t?o:e[o].time<t?i(t,e,o,r):i(t,e,n,o)},o=function(t,e,n){return Math.max(Math.min((n-t)/(e-t),1),0)},a=function(){this.keyframes=[]};a.prototype.at=function(t,e,n){var r=this.keyframes;return r.push({time:t,value:e,easing:n||"linear"}),this.count=r.length,this},a.prototype.update=function(t){var e=i(t,this.keyframes,0,this.count),n=this.keyframes[e],a=this.keyframes[Math.min(e+1,this.count-1)],s=n.value,u=a.value,h=r[a.easing].call(null,o(n.time,a.time,t));return s*(1-h)+u*h};var s=function(){this.properties={}};s.prototype.property=function(t){return t in this.properties||(this.properties[t]=new a),this.properties[t]},s.prototype.update=function(t){var e={};for(var n in this.properties)e[n]=this.properties[n].update(t);return e},e.exports=s},{}],18:[function(t,e,n){var r=Float32Array,i={};i.create=function(){var t=new r(16);return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},i.clone=function(t){var e=new r(16);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},i.copy=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},i.identity=function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},i.transpose=function(t,e){if(t===e){var n=e[1],r=e[2],i=e[3],o=e[6],a=e[7],s=e[11];t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=n,t[6]=e[9],t[7]=e[13],t[8]=r,t[9]=o,t[11]=e[14],t[12]=i,t[13]=a,t[14]=s}else t[0]=e[0],t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=e[1],t[5]=e[5],t[6]=e[9],t[7]=e[13],t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=e[14],t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15];return t},i.invert=function(t,e){var n=e[0],r=e[1],i=e[2],o=e[3],a=e[4],s=e[5],u=e[6],h=e[7],l=e[8],c=e[9],p=e[10],x=e[11],f=e[12],d=e[13],v=e[14],m=e[15],y=n*s-r*a,g=n*u-i*a,z=n*h-o*a,E=r*u-i*s,b=r*h-o*s,T=i*h-o*u,M=l*d-c*f,w=l*v-p*f,R=l*m-x*f,A=c*v-p*d,I=c*m-x*d,F=p*m-x*v,_=y*F-g*I+z*A+E*R-b*w+T*M;return _?(_=1/_,t[0]=(s*F-u*I+h*A)*_,t[1]=(i*I-r*F-o*A)*_,t[2]=(d*T-v*b+m*E)*_,t[3]=(p*b-c*T-x*E)*_,t[4]=(u*R-a*F-h*w)*_,t[5]=(n*F-i*R+o*w)*_,t[6]=(v*z-f*T-m*g)*_,t[7]=(l*T-p*z+x*g)*_,t[8]=(a*I-s*R+h*M)*_,t[9]=(r*R-n*I-o*M)*_,t[10]=(f*b-d*z+m*y)*_,t[11]=(c*z-l*b-x*y)*_,t[12]=(s*w-a*A-u*M)*_,t[13]=(n*A-r*w+i*M)*_,t[14]=(d*g-f*E-v*y)*_,t[15]=(l*E-c*g+p*y)*_,t):null},i.adjoint=function(t,e){var n=e[0],r=e[1],i=e[2],o=e[3],a=e[4],s=e[5],u=e[6],h=e[7],l=e[8],c=e[9],p=e[10],x=e[11],f=e[12],d=e[13],v=e[14],m=e[15];return t[0]=s*(p*m-x*v)-c*(u*m-h*v)+d*(u*x-h*p),t[1]=-(r*(p*m-x*v)-c*(i*m-o*v)+d*(i*x-o*p)),t[2]=r*(u*m-h*v)-s*(i*m-o*v)+d*(i*h-o*u),t[3]=-(r*(u*x-h*p)-s*(i*x-o*p)+c*(i*h-o*u)),t[4]=-(a*(p*m-x*v)-l*(u*m-h*v)+f*(u*x-h*p)),t[5]=n*(p*m-x*v)-l*(i*m-o*v)+f*(i*x-o*p),t[6]=-(n*(u*m-h*v)-a*(i*m-o*v)+f*(i*h-o*u)),t[7]=n*(u*x-h*p)-a*(i*x-o*p)+l*(i*h-o*u),t[8]=a*(c*m-x*d)-l*(s*m-h*d)+f*(s*x-h*c),t[9]=-(n*(c*m-x*d)-l*(r*m-o*d)+f*(r*x-o*c)),t[10]=n*(s*m-h*d)-a*(r*m-o*d)+f*(r*h-o*s),t[11]=-(n*(s*x-h*c)-a*(r*x-o*c)+l*(r*h-o*s)),t[12]=-(a*(c*v-p*d)-l*(s*v-u*d)+f*(s*p-u*c)),t[13]=n*(c*v-p*d)-l*(r*v-i*d)+f*(r*p-i*c),t[14]=-(n*(s*v-u*d)-a*(r*v-i*d)+f*(r*u-i*s)),t[15]=n*(s*p-u*c)-a*(r*p-i*c)+l*(r*u-i*s),t},i.determinant=function(t){var e=t[0],n=t[1],r=t[2],i=t[3],o=t[4],a=t[5],s=t[6],u=t[7],h=t[8],l=t[9],c=t[10],p=t[11],x=t[12],f=t[13],d=t[14],v=t[15],m=e*a-n*o,y=e*s-r*o,g=e*u-i*o,z=n*s-r*a,E=n*u-i*a,b=r*u-i*s,T=h*f-l*x,M=h*d-c*x,w=h*v-p*x,R=l*d-c*f,A=l*v-p*f,I=c*v-p*d;
return m*I-y*A+g*R+z*w-E*M+b*T},i.multiply=function(t,e,n){var r=e[0],i=e[1],o=e[2],a=e[3],s=e[4],u=e[5],h=e[6],l=e[7],c=e[8],p=e[9],x=e[10],f=e[11],d=e[12],v=e[13],m=e[14],y=e[15],g=n[0],z=n[1],E=n[2],b=n[3];return t[0]=g*r+z*s+E*c+b*d,t[1]=g*i+z*u+E*p+b*v,t[2]=g*o+z*h+E*x+b*m,t[3]=g*a+z*l+E*f+b*y,g=n[4],z=n[5],E=n[6],b=n[7],t[4]=g*r+z*s+E*c+b*d,t[5]=g*i+z*u+E*p+b*v,t[6]=g*o+z*h+E*x+b*m,t[7]=g*a+z*l+E*f+b*y,g=n[8],z=n[9],E=n[10],b=n[11],t[8]=g*r+z*s+E*c+b*d,t[9]=g*i+z*u+E*p+b*v,t[10]=g*o+z*h+E*x+b*m,t[11]=g*a+z*l+E*f+b*y,g=n[12],z=n[13],E=n[14],b=n[15],t[12]=g*r+z*s+E*c+b*d,t[13]=g*i+z*u+E*p+b*v,t[14]=g*o+z*h+E*x+b*m,t[15]=g*a+z*l+E*f+b*y,t},i.mul=i.multiply,i.translate=function(t,e,n){var r,i,o,a,s,u,h,l,c,p,x,f,d=n[0],v=n[1],m=n[2];return e===t?(t[12]=e[0]*d+e[4]*v+e[8]*m+e[12],t[13]=e[1]*d+e[5]*v+e[9]*m+e[13],t[14]=e[2]*d+e[6]*v+e[10]*m+e[14],t[15]=e[3]*d+e[7]*v+e[11]*m+e[15]):(r=e[0],i=e[1],o=e[2],a=e[3],s=e[4],u=e[5],h=e[6],l=e[7],c=e[8],p=e[9],x=e[10],f=e[11],t[0]=r,t[1]=i,t[2]=o,t[3]=a,t[4]=s,t[5]=u,t[6]=h,t[7]=l,t[8]=c,t[9]=p,t[10]=x,t[11]=f,t[12]=r*d+s*v+c*m+e[12],t[13]=i*d+u*v+p*m+e[13],t[14]=o*d+h*v+x*m+e[14],t[15]=a*d+l*v+f*m+e[15]),t},i.scale=function(t,e,n){var r=n[0],i=n[1],o=n[2];return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t[3]=e[3]*r,t[4]=e[4]*i,t[5]=e[5]*i,t[6]=e[6]*i,t[7]=e[7]*i,t[8]=e[8]*o,t[9]=e[9]*o,t[10]=e[10]*o,t[11]=e[11]*o,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},i.rotate=function(t,e,n,r){var i,o,a,s,u,h,l,c,p,x,f,d,v,m,y,g,z,E,b,T,M,w,R,A,I=r[0],F=r[1],_=r[2],S=Math.sqrt(I*I+F*F+_*_);return Math.abs(S)<GLMAT_EPSILON?null:(S=1/S,I*=S,F*=S,_*=S,i=Math.sin(n),o=Math.cos(n),a=1-o,s=e[0],u=e[1],h=e[2],l=e[3],c=e[4],p=e[5],x=e[6],f=e[7],d=e[8],v=e[9],m=e[10],y=e[11],g=I*I*a+o,z=F*I*a+_*i,E=_*I*a-F*i,b=I*F*a-_*i,T=F*F*a+o,M=_*F*a+I*i,w=I*_*a+F*i,R=F*_*a-I*i,A=_*_*a+o,t[0]=s*g+c*z+d*E,t[1]=u*g+p*z+v*E,t[2]=h*g+x*z+m*E,t[3]=l*g+f*z+y*E,t[4]=s*b+c*T+d*M,t[5]=u*b+p*T+v*M,t[6]=h*b+x*T+m*M,t[7]=l*b+f*T+y*M,t[8]=s*w+c*R+d*A,t[9]=u*w+p*R+v*A,t[10]=h*w+x*R+m*A,t[11]=l*w+f*R+y*A,e!==t&&(t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t)},i.rotateX=function(t,e,n){var r=Math.sin(n),i=Math.cos(n),o=e[4],a=e[5],s=e[6],u=e[7],h=e[8],l=e[9],c=e[10],p=e[11];return e!==t&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[4]=o*i+h*r,t[5]=a*i+l*r,t[6]=s*i+c*r,t[7]=u*i+p*r,t[8]=h*i-o*r,t[9]=l*i-a*r,t[10]=c*i-s*r,t[11]=p*i-u*r,t},i.rotateY=function(t,e,n){var r=Math.sin(n),i=Math.cos(n),o=e[0],a=e[1],s=e[2],u=e[3],h=e[8],l=e[9],c=e[10],p=e[11];return e!==t&&(t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=o*i-h*r,t[1]=a*i-l*r,t[2]=s*i-c*r,t[3]=u*i-p*r,t[8]=o*r+h*i,t[9]=a*r+l*i,t[10]=s*r+c*i,t[11]=u*r+p*i,t},i.rotateZ=function(t,e,n){var r=Math.sin(n),i=Math.cos(n),o=e[0],a=e[1],s=e[2],u=e[3],h=e[4],l=e[5],c=e[6],p=e[7];return e!==t&&(t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=o*i+h*r,t[1]=a*i+l*r,t[2]=s*i+c*r,t[3]=u*i+p*r,t[4]=h*i-o*r,t[5]=l*i-a*r,t[6]=c*i-s*r,t[7]=p*i-u*r,t},i.fromRotationTranslation=function(t,e,n){var r=e[0],i=e[1],o=e[2],a=e[3],s=r+r,u=i+i,h=o+o,l=r*s,c=r*u,p=r*h,x=i*u,f=i*h,d=o*h,v=a*s,m=a*u,y=a*h;return t[0]=1-(x+d),t[1]=c+y,t[2]=p-m,t[3]=0,t[4]=c-y,t[5]=1-(l+d),t[6]=f+v,t[7]=0,t[8]=p+m,t[9]=f-v,t[10]=1-(l+x),t[11]=0,t[12]=n[0],t[13]=n[1],t[14]=n[2],t[15]=1,t},i.fromQuat=function(t,e){var n=e[0],r=e[1],i=e[2],o=e[3],a=n+n,s=r+r,u=i+i,h=n*a,l=r*a,c=r*s,p=i*a,x=i*s,f=i*u,d=o*a,v=o*s,m=o*u;return t[0]=1-c-f,t[1]=l+m,t[2]=p-v,t[3]=0,t[4]=l-m,t[5]=1-h-f,t[6]=x+d,t[7]=0,t[8]=p+v,t[9]=x-d,t[10]=1-h-c,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},i.frustum=function(t,e,n,r,i,o,a){var s=1/(n-e),u=1/(i-r),h=1/(o-a);return t[0]=2*o*s,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=2*o*u,t[6]=0,t[7]=0,t[8]=(n+e)*s,t[9]=(i+r)*u,t[10]=(a+o)*h,t[11]=-1,t[12]=0,t[13]=0,t[14]=a*o*2*h,t[15]=0,t},i.perspective=function(t,e,n,r,i){var o=1/Math.tan(e/2),a=1/(r-i);return t[0]=o/n,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=o,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=(i+r)*a,t[11]=-1,t[12]=0,t[13]=0,t[14]=2*i*r*a,t[15]=0,t},i.ortho=function(t,e,n,r,i,o,a){var s=1/(e-n),u=1/(r-i),h=1/(o-a);return t[0]=-2*s,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*u,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*h,t[11]=0,t[12]=(e+n)*s,t[13]=(i+r)*u,t[14]=(a+o)*h,t[15]=1,t},i.lookAt=function(t,e,n,r){var o,a,s,u,h,l,c,p,x,f,d=e[0],v=e[1],m=e[2],y=r[0],g=r[1],z=r[2],E=n[0],b=n[1],T=n[2];return Math.abs(d-E)<GLMAT_EPSILON&&Math.abs(v-b)<GLMAT_EPSILON&&Math.abs(m-T)<GLMAT_EPSILON?i.identity(t):(c=d-E,p=v-b,x=m-T,f=1/Math.sqrt(c*c+p*p+x*x),c*=f,p*=f,x*=f,o=g*x-z*p,a=z*c-y*x,s=y*p-g*c,f=Math.sqrt(o*o+a*a+s*s),f?(f=1/f,o*=f,a*=f,s*=f):(o=0,a=0,s=0),u=p*s-x*a,h=x*o-c*s,l=c*a-p*o,f=Math.sqrt(u*u+h*h+l*l),f?(f=1/f,u*=f,h*=f,l*=f):(u=0,h=0,l=0),t[0]=o,t[1]=u,t[2]=c,t[3]=0,t[4]=a,t[5]=h,t[6]=p,t[7]=0,t[8]=s,t[9]=l,t[10]=x,t[11]=0,t[12]=-(o*d+a*v+s*m),t[13]=-(u*d+h*v+l*m),t[14]=-(c*d+p*v+x*m),t[15]=1,t)},i.str=function(t){return"mat4("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+", "+t[9]+", "+t[10]+", "+t[11]+", "+t[12]+", "+t[13]+", "+t[14]+", "+t[15]+")"},i.frob=function(t){return Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2)+Math.pow(t[2],2)+Math.pow(t[3],2)+Math.pow(t[4],2)+Math.pow(t[5],2)+Math.pow(t[6],2)+Math.pow(t[6],2)+Math.pow(t[7],2)+Math.pow(t[8],2)+Math.pow(t[9],2)+Math.pow(t[10],2)+Math.pow(t[11],2)+Math.pow(t[12],2)+Math.pow(t[13],2)+Math.pow(t[14],2)+Math.pow(t[15],2))},"undefined"!=typeof n&&(n.mat4=i);var o={};o.create=function(){var t=new r(3);return t[0]=0,t[1]=0,t[2]=0,t},o.clone=function(t){var e=new r(3);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e},o.fromValues=function(t,e,n){var i=new r(3);return i[0]=t,i[1]=e,i[2]=n,i},o.copy=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t},o.set=function(t,e,n,r){return t[0]=e,t[1]=n,t[2]=r,t},o.add=function(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t},o.subtract=function(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t},o.sub=o.subtract,o.multiply=function(t,e,n){return t[0]=e[0]*n[0],t[1]=e[1]*n[1],t[2]=e[2]*n[2],t},o.mul=o.multiply,o.divide=function(t,e,n){return t[0]=e[0]/n[0],t[1]=e[1]/n[1],t[2]=e[2]/n[2],t},o.div=o.divide,o.min=function(t,e,n){return t[0]=Math.min(e[0],n[0]),t[1]=Math.min(e[1],n[1]),t[2]=Math.min(e[2],n[2]),t},o.max=function(t,e,n){return t[0]=Math.max(e[0],n[0]),t[1]=Math.max(e[1],n[1]),t[2]=Math.max(e[2],n[2]),t},o.scale=function(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t},o.scaleAndAdd=function(t,e,n,r){return t[0]=e[0]+n[0]*r,t[1]=e[1]+n[1]*r,t[2]=e[2]+n[2]*r,t},o.distance=function(t,e){var n=e[0]-t[0],r=e[1]-t[1],i=e[2]-t[2];return Math.sqrt(n*n+r*r+i*i)},o.dist=o.distance,o.squaredDistance=function(t,e){var n=e[0]-t[0],r=e[1]-t[1],i=e[2]-t[2];return n*n+r*r+i*i},o.sqrDist=o.squaredDistance,o.length=function(t){var e=t[0],n=t[1],r=t[2];return Math.sqrt(e*e+n*n+r*r)},o.len=o.length,o.squaredLength=function(t){var e=t[0],n=t[1],r=t[2];return e*e+n*n+r*r},o.sqrLen=o.squaredLength,o.negate=function(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t},o.normalize=function(t,e){var n=e[0],r=e[1],i=e[2],o=n*n+r*r+i*i;return o>0&&(o=1/Math.sqrt(o),t[0]=e[0]*o,t[1]=e[1]*o,t[2]=e[2]*o),t},o.dot=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]},o.cross=function(t,e,n){var r=e[0],i=e[1],o=e[2],a=n[0],s=n[1],u=n[2];return t[0]=i*u-o*s,t[1]=o*a-r*u,t[2]=r*s-i*a,t},o.lerp=function(t,e,n,r){var i=e[0],o=e[1],a=e[2];return t[0]=i+r*(n[0]-i),t[1]=o+r*(n[1]-o),t[2]=a+r*(n[2]-a),t},o.random=function(t,e){e=e||1;var n=2*GLMAT_RANDOM()*Math.PI,r=2*GLMAT_RANDOM()-1,i=Math.sqrt(1-r*r)*e;return t[0]=Math.cos(n)*i,t[1]=Math.sin(n)*i,t[2]=r*e,t},o.transformMat4=function(t,e,n){var r=e[0],i=e[1],o=e[2];return t[0]=n[0]*r+n[4]*i+n[8]*o+n[12],t[1]=n[1]*r+n[5]*i+n[9]*o+n[13],t[2]=n[2]*r+n[6]*i+n[10]*o+n[14],t},o.transformMat3=function(t,e,n){var r=e[0],i=e[1],o=e[2];return t[0]=r*n[0]+i*n[3]+o*n[6],t[1]=r*n[1]+i*n[4]+o*n[7],t[2]=r*n[2]+i*n[5]+o*n[8],t},o.transformQuat=function(t,e,n){var r=e[0],i=e[1],o=e[2],a=n[0],s=n[1],u=n[2],h=n[3],l=h*r+s*o-u*i,c=h*i+u*r-a*o,p=h*o+a*i-s*r,x=-a*r-s*i-u*o;return t[0]=l*h+x*-a+c*-u-p*-s,t[1]=c*h+x*-s+p*-a-l*-u,t[2]=p*h+x*-u+l*-s-c*-a,t},o.rotateX=function(t,e,n,r){var i=[],o=[];return i[0]=e[0]-n[0],i[1]=e[1]-n[1],i[2]=e[2]-n[2],o[0]=i[0],o[1]=i[1]*Math.cos(r)-i[2]*Math.sin(r),o[2]=i[1]*Math.sin(r)+i[2]*Math.cos(r),t[0]=o[0]+n[0],t[1]=o[1]+n[1],t[2]=o[2]+n[2],t},o.rotateY=function(t,e,n,r){var i=[],o=[];return i[0]=e[0]-n[0],i[1]=e[1]-n[1],i[2]=e[2]-n[2],o[0]=i[2]*Math.sin(r)+i[0]*Math.cos(r),o[1]=i[1],o[2]=i[2]*Math.cos(r)-i[0]*Math.sin(r),t[0]=o[0]+n[0],t[1]=o[1]+n[1],t[2]=o[2]+n[2],t},o.rotateZ=function(t,e,n,r){var i=[],o=[];return i[0]=e[0]-n[0],i[1]=e[1]-n[1],i[2]=e[2]-n[2],o[0]=i[0]*Math.cos(r)-i[1]*Math.sin(r),o[1]=i[0]*Math.sin(r)+i[1]*Math.cos(r),o[2]=i[2],t[0]=o[0]+n[0],t[1]=o[1]+n[1],t[2]=o[2]+n[2],t},o.forEach=function(){var t=o.create();return function(e,n,r,i,o,a){var s,u;for(n||(n=3),r||(r=0),u=i?Math.min(i*n+r,e.length):e.length,s=r;u>s;s+=n)t[0]=e[s],t[1]=e[s+1],t[2]=e[s+2],o(t,t,a),e[s]=t[0],e[s+1]=t[1],e[s+2]=t[2];return e}}(),o.str=function(t){return"vec3("+t[0]+", "+t[1]+", "+t[2]+")"},"undefined"!=typeof n&&(n.vec3=o);var a={};a.create=function(){var t=new r(9);return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t},a.fromMat4=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[4],t[4]=e[5],t[5]=e[6],t[6]=e[8],t[7]=e[9],t[8]=e[10],t},a.clone=function(t){var e=new r(9);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e},a.copy=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t},a.identity=function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t},a.transpose=function(t,e){if(t===e){var n=e[1],r=e[2],i=e[5];t[1]=e[3],t[2]=e[6],t[3]=n,t[5]=e[7],t[6]=r,t[7]=i}else t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8];return t},a.invert=function(t,e){var n=e[0],r=e[1],i=e[2],o=e[3],a=e[4],s=e[5],u=e[6],h=e[7],l=e[8],c=l*a-s*h,p=-l*o+s*u,x=h*o-a*u,f=n*c+r*p+i*x;return f?(f=1/f,t[0]=c*f,t[1]=(-l*r+i*h)*f,t[2]=(s*r-i*a)*f,t[3]=p*f,t[4]=(l*n-i*u)*f,t[5]=(-s*n+i*o)*f,t[6]=x*f,t[7]=(-h*n+r*u)*f,t[8]=(a*n-r*o)*f,t):null},a.adjoint=function(t,e){var n=e[0],r=e[1],i=e[2],o=e[3],a=e[4],s=e[5],u=e[6],h=e[7],l=e[8];return t[0]=a*l-s*h,t[1]=i*h-r*l,t[2]=r*s-i*a,t[3]=s*u-o*l,t[4]=n*l-i*u,t[5]=i*o-n*s,t[6]=o*h-a*u,t[7]=r*u-n*h,t[8]=n*a-r*o,t},a.determinant=function(t){var e=t[0],n=t[1],r=t[2],i=t[3],o=t[4],a=t[5],s=t[6],u=t[7],h=t[8];return e*(h*o-a*u)+n*(-h*i+a*s)+r*(u*i-o*s)},a.multiply=function(t,e,n){var r=e[0],i=e[1],o=e[2],a=e[3],s=e[4],u=e[5],h=e[6],l=e[7],c=e[8],p=n[0],x=n[1],f=n[2],d=n[3],v=n[4],m=n[5],y=n[6],g=n[7],z=n[8];return t[0]=p*r+x*a+f*h,t[1]=p*i+x*s+f*l,t[2]=p*o+x*u+f*c,t[3]=d*r+v*a+m*h,t[4]=d*i+v*s+m*l,t[5]=d*o+v*u+m*c,t[6]=y*r+g*a+z*h,t[7]=y*i+g*s+z*l,t[8]=y*o+g*u+z*c,t},a.mul=a.multiply,a.translate=function(t,e,n){var r=e[0],i=e[1],o=e[2],a=e[3],s=e[4],u=e[5],h=e[6],l=e[7],c=e[8],p=n[0],x=n[1];return t[0]=r,t[1]=i,t[2]=o,t[3]=a,t[4]=s,t[5]=u,t[6]=p*r+x*a+h,t[7]=p*i+x*s+l,t[8]=p*o+x*u+c,t},a.rotate=function(t,e,n){var r=e[0],i=e[1],o=e[2],a=e[3],s=e[4],u=e[5],h=e[6],l=e[7],c=e[8],p=Math.sin(n),x=Math.cos(n);return t[0]=x*r+p*a,t[1]=x*i+p*s,t[2]=x*o+p*u,t[3]=x*a-p*r,t[4]=x*s-p*i,t[5]=x*u-p*o,t[6]=h,t[7]=l,t[8]=c,t},a.scale=function(t,e,n){var r=n[0],i=n[1];return t[0]=r*e[0],t[1]=r*e[1],t[2]=r*e[2],t[3]=i*e[3],t[4]=i*e[4],t[5]=i*e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t},a.fromMat2d=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=0,t[3]=e[2],t[4]=e[3],t[5]=0,t[6]=e[4],t[7]=e[5],t[8]=1,t},a.fromQuat=function(t,e){var n=e[0],r=e[1],i=e[2],o=e[3],a=n+n,s=r+r,u=i+i,h=n*a,l=r*a,c=r*s,p=i*a,x=i*s,f=i*u,d=o*a,v=o*s,m=o*u;return t[0]=1-c-f,t[3]=l-m,t[6]=p+v,t[1]=l+m,t[4]=1-h-f,t[7]=x-d,t[2]=p-v,t[5]=x+d,t[8]=1-h-c,t},a.normalFromMat4=function(t,e){var n=e[0],r=e[1],i=e[2],o=e[3],a=e[4],s=e[5],u=e[6],h=e[7],l=e[8],c=e[9],p=e[10],x=e[11],f=e[12],d=e[13],v=e[14],m=e[15],y=n*s-r*a,g=n*u-i*a,z=n*h-o*a,E=r*u-i*s,b=r*h-o*s,T=i*h-o*u,M=l*d-c*f,w=l*v-p*f,R=l*m-x*f,A=c*v-p*d,I=c*m-x*d,F=p*m-x*v,_=y*F-g*I+z*A+E*R-b*w+T*M;return _?(_=1/_,t[0]=(s*F-u*I+h*A)*_,t[1]=(u*R-a*F-h*w)*_,t[2]=(a*I-s*R+h*M)*_,t[3]=(i*I-r*F-o*A)*_,t[4]=(n*F-i*R+o*w)*_,t[5]=(r*R-n*I-o*M)*_,t[6]=(d*T-v*b+m*E)*_,t[7]=(v*z-f*T-m*g)*_,t[8]=(f*b-d*z+m*y)*_,t):null},a.str=function(t){return"mat3("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+")"},a.frob=function(t){return Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2)+Math.pow(t[2],2)+Math.pow(t[3],2)+Math.pow(t[4],2)+Math.pow(t[5],2)+Math.pow(t[6],2)+Math.pow(t[7],2)+Math.pow(t[8],2))},"undefined"!=typeof n&&(n.mat3=a),e.exports={mat4:i,mat3:a,vec3:o}},{}],19:[function(t,e,n){"use strict";function r(t,e){var n=o(i(t[0],!0)),r=e?{vertices:[],indices:[]}:[];if(!n)return r;var s,u,h,l,p,x,f,d,v,m=80;for(v=0;m>=0&&v<t.length;v++)m-=t[v].length;if(0>m){s=n.next,u=l=s.p[0],h=p=s.p[1];do x=s.p[0],f=s.p[1],u>x&&(u=x),h>f&&(h=f),x>l&&(l=x),f>p&&(p=f),s=s.next;while(s!==n);d=Math.max(l-u,p-h)}return t.length>1&&(n=c(t,n)),a(n,r,u,h,d),r}function i(t,e){var n,r,i,o,a,s=0,u=t.length;for(n=0,r=u-1;u>n;r=n++)i=t[n],o=t[r],s+=(o[0]-i[0])*(i[1]+o[1]);if(e===s>0)for(n=0;u>n;n++)a=A(t[n],a);else for(n=u-1;n>=0;n--)a=A(t[n],a);return a}function o(t,e){e||(e=t);var n,r=t;do if(n=!1,z(r.p,r.next.p)||0===g(r.prev.p,r.p,r.next.p)){if(r.prev.next=r.next,r.next.prev=r.prev,r.prevZ&&(r.prevZ.nextZ=r.nextZ),r.nextZ&&(r.nextZ.prevZ=r.prevZ),r=e=r.prev,r===r.next)return null;n=!0}else r=r.next;while(n||r!==e);return e}function a(t,e,n,r,i,c){if(t){var p=void 0!==e.vertices;c||void 0===n||f(t,n,r,i);for(var x,d,v=t;t.prev!==t.next;)if(x=t.prev,d=t.next,u(t,n,r,i))p?(s(e,x),s(e,t),s(e,d)):(e.push(x.p),e.push(t.p),e.push(d.p)),d.prev=x,x.next=d,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ),t=d.next,v=d.next;else if(t=d,t===v){c?1===c?(t=h(t,e),a(t,e,n,r,i,2)):2===c&&l(t,e,n,r,i):a(o(t),e,n,r,i,1);break}}}function s(t,e){e.source&&(e=e.source);var n=e.index;if(null===n){var r=e.p.length,i=t.vertices;e.index=n=i.length/r;for(var o=0;r>o;o++)i.push(e.p[o])}t.indices.push(n)}function u(t,e,n,r){var i=t.prev.p,o=t.p,a=t.next.p,s=i[0],u=o[0],h=a[0],l=i[1],c=o[1],p=a[1],x=s*c-l*u,f=s*p-l*h,d=h*c-p*u,m=x-f-d;if(0>=m)return!1;var y,g,z,E,b,T,M,w=p-l,R=s-h,A=l-c,I=u-s;if(void 0!==e){var F=u>s?h>s?s:h:h>u?u:h,_=c>l?p>l?l:p:p>c?c:p,S=s>u?s>h?s:h:u>h?u:h,P=l>c?l>p?l:p:c>p?c:p,N=v(F,_,e,n,r),D=v(S,P,e,n,r);for(M=t.nextZ;M&&M.z<=D;)if(y=M.p,M=M.nextZ,y!==i&&y!==a&&(g=y[0],z=y[1],E=w*g+R*z-f,E>=0&&(b=A*g+I*z+x,b>=0&&(T=m-E-b,T>=0&&(E&&b||E&&T||b&&T)))))return!1;for(M=t.prevZ;M&&M.z>=N;)if(y=M.p,M=M.prevZ,y!==i&&y!==a&&(g=y[0],z=y[1],E=w*g+R*z-f,E>=0&&(b=A*g+I*z+x,b>=0&&(T=m-E-b,T>=0&&(E&&b||E&&T||b&&T)))))return!1}else for(M=t.next.next;M!==t.prev;)if(y=M.p,M=M.next,g=y[0],z=y[1],E=w*g+R*z-f,E>=0&&(b=A*g+I*z+x,b>=0&&(T=m-E-b,T>=0&&(E&&b||E&&T||b&&T))))return!1;return!0}function h(t,e){var n=!!e.vertices,r=t;do{var i=r.prev,o=r.next.next;if(i.p!==o.p&&E(i.p,r.p,r.next.p,o.p)&&T(i,o)&&T(o,i)){n?(s(e,i),s(e,r),s(e,o)):(e.push(i.p),e.push(r.p),e.push(o.p)),i.next=o,o.prev=i;var a=r.prevZ,u=r.nextZ&&r.nextZ.nextZ;a&&(a.nextZ=u),u&&(u.prevZ=a),r=t=o}r=r.next}while(r!==t);return r}function l(t,e,n,r,i){var s=t;do{for(var u=s.next.next;u!==s.prev;){if(s.p!==u.p&&y(s,u)){var h=R(s,u);return s=o(s,s.next),h=o(h,h.next),a(s,e,n,r,i),void a(h,e,n,r,i)}u=u.next}s=s.next}while(s!==t)}function c(t,e){for(var n=t.length,r=[],a=1;n>a;a++){var s=o(i(t[a],!1));s&&r.push(m(s))}for(r.sort(w),a=0;a<r.length;a++)p(r[a],e),e=o(e,e.next);return e}function p(t,e){if(e=x(t,e)){var n=R(e,t);o(n,n.next)}}function x(t,e){var n,r,i,o=e,a=t.p,s=a[0],u=a[1],h=-(1/0);do{if(r=o.p,i=o.next.p,u<=r[1]&&u>=i[1]){var l=r[0]+(u-r[1])*(i[0]-r[0])/(i[1]-r[1]);s>=l&&l>h&&(h=l,n=r[0]<i[0]?o:o.next)}o=o.next}while(o!==e);if(!n)return null;var c,p,x,f,d,v,m=n.p[0],y=n.p[1],g=s*y-u*m,z=s*u-u*h,E=u-u,b=s-h,M=u-y,w=m-s,R=g-z-(h*y-u*m),A=0>=R?-1:1,I=n,F=1/0;for(o=n.next;o!==I;)c=o.p[0],p=o.p[1],x=s-c,x>=0&&c>=m&&(f=(E*c+b*p-z)*A,f>=0&&(d=(M*c+w*p+g)*A,d>=0&&R*A-f-d>=0&&(v=Math.abs(u-p)/x,F>v&&T(o,t)&&(n=o,F=v)))),o=o.next;return n}function f(t,e,n,r){var i=t;do null===i.z&&(i.z=v(i.p[0],i.p[1],e,n,r)),i.prevZ=i.prev,i.nextZ=i.next,i=i.next;while(i!==t);i.prevZ.nextZ=null,i.prevZ=null,d(i)}function d(t){for(var e,n,r,i,o,a,s,u,h=1;;){for(n=t,t=null,o=null,a=0;n;){for(a++,r=n,s=0,e=0;h>e&&(s++,r=r.nextZ,r);e++);for(u=h;s>0||u>0&&r;)0===s?(i=r,r=r.nextZ,u--):0!==u&&r?n.z<=r.z?(i=n,n=n.nextZ,s--):(i=r,r=r.nextZ,u--):(i=n,n=n.nextZ,s--),o?o.nextZ=i:t=i,i.prevZ=o,o=i;n=r}if(o.nextZ=null,1>=a)return t;h*=2}}function v(t,e,n,r,i){return t=1e3*(t-n)/i,t=16711935&(t|t<<8),t=252645135&(t|t<<4),t=858993459&(t|t<<2),t=1431655765&(t|t<<1),e=1e3*(e-r)/i,e=16711935&(e|e<<8),e=252645135&(e|e<<4),e=858993459&(e|e<<2),e=1431655765&(e|e<<1),t|e<<1}function m(t){var e=t,n=t;do e.p[0]<n.p[0]&&(n=e),e=e.next;while(e!==t);return n}function y(t,e){return!b(t,t.p,e.p)&&T(t,e)&&T(e,t)&&M(t,t.p,e.p)}function g(t,e,n){var r=(e[1]-t[1])*(n[0]-e[0])-(e[0]-t[0])*(n[1]-e[1]);return r>0?1:0>r?-1:0}function z(t,e){return t[0]===e[0]&&t[1]===e[1]}function E(t,e,n,r){return g(t,e,n)!==g(t,e,r)&&g(n,r,t)!==g(n,r,e)}function b(t,e,n){var r=t;do{var i=r.p,o=r.next.p;if(i!==e&&o!==e&&i!==n&&o!==n&&E(i,o,e,n))return!0;r=r.next}while(r!==t);return!1}function T(t,e){return-1===g(t.prev.p,t.p,t.next.p)?-1!==g(t.p,e.p,t.next.p)&&-1!==g(t.p,t.prev.p,e.p):-1===g(t.p,e.p,t.prev.p)||-1===g(t.p,t.next.p,e.p)}function M(t,e,n){var r=t,i=!1,o=(e[0]+n[0])/2,a=(e[1]+n[1])/2;do{var s=r.p,u=r.next.p;s[1]>a!=u[1]>a&&o<(u[0]-s[0])*(a-s[1])/(u[1]-s[1])+s[0]&&(i=!i),r=r.next}while(r!==t);return i}function w(t,e){return t.p[0]-e.p[0]}function R(t,e){var n=new I(t.p),r=new I(e.p),i=t.next,o=e.prev;return n.source=t,r.source=e,t.next=e,e.prev=t,n.next=i,i.prev=n,r.next=n,n.prev=r,o.next=r,r.prev=o,r}function A(t,e){var n=new I(t);return e?(n.next=e.next,n.prev=e,e.next.prev=n,e.next=n):(n.prev=n,n.next=n),n}function I(t){this.p=t,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.source=null,this.index=null}e.exports=r},{}],20:[function(t,e,n){!function(t,r){"use strict";"object"==typeof n?e.exports=r():"function"==typeof define&&define.amd?define(r):t.MersenneTwister=r()}(this,function(){"use strict";var t=4294967296,e=624,n=397,r=2147483648,i=2147483647,o=2567483615,a=function(t){"undefined"==typeof t&&(t=(new Date).getTime()),this.mt=new Array(e),this.mti=e+1,this.seed(t)};a.prototype.seed=function(t){var n;for(this.mt[0]=t>>>0,this.mti=1;this.mti<e;this.mti++)n=this.mt[this.mti-1]^this.mt[this.mti-1]>>>30,this.mt[this.mti]=(1812433253*((4294901760&n)>>>16)<<16)+1812433253*(65535&n)+this.mti,this.mt[this.mti]>>>=0},a.prototype.seedArray=function(t){var n,r=1,i=0,o=e>t.length?e:t.length;for(this.seed(19650218);o>0;o--)n=this.mt[r-1]^this.mt[r-1]>>>30,this.mt[r]=(this.mt[r]^(1664525*((4294901760&n)>>>16)<<16)+1664525*(65535&n))+t[i]+i,this.mt[r]>>>=0,r++,i++,r>=e&&(this.mt[0]=this.mt[e-1],r=1),i>=t.length&&(i=0);for(o=e-1;o;o--)n=this.mt[r-1]^this.mt[r-1]>>>30,this.mt[r]=(this.mt[r]^(1566083941*((4294901760&n)>>>16)<<16)+1566083941*(65535&n))-r,this.mt[r]>>>=0,r++,r>=e&&(this.mt[0]=this.mt[e-1],r=1);this.mt[0]=2147483648},a.prototype.int=function(){var t,a,s=new Array(0,o);if(this.mti>=e){for(this.mti===e+1&&this.seed(5489),a=0;e-n>a;a++)t=this.mt[a]&r|this.mt[a+1]&i,this.mt[a]=this.mt[a+n]^t>>>1^s[1&t];for(;e-1>a;a++)t=this.mt[a]&r|this.mt[a+1]&i,this.mt[a]=this.mt[a+(n-e)]^t>>>1^s[1&t];t=this.mt[e-1]&r|this.mt[0]&i,this.mt[e-1]=this.mt[n-1]^t>>>1^s[1&t],this.mti=0}return t=this.mt[this.mti++],t^=t>>>11,t^=t<<7&2636928640,t^=t<<15&4022730752,t^=t>>>18,t>>>0},a.prototype.int31=function(){return this.int()>>>1},a.prototype.real=function(){return this.int()*(1/(t-1))},a.prototype.realx=function(){return(this.int()+.5)*(1/t)},a.prototype.rnd=function(){return this.int()*(1/t)},a.prototype.random=a.prototype.rnd,a.prototype.rndHiRes=function(){var t=this.int()>>>5,e=this.int()>>>6;return(67108864*t+e)*(1/9007199254740992)};var s=new a;return a.random=function(){return s.rnd()},a})},{}],21:[function(t,e,n){var r=function(){var t=Date.now(),e=t,n=0,r=1/0,i=0,o=0,a=1/0,s=0,u=0,h=0,l=document.createElement("div");l.id="stats",l.addEventListener("mousedown",function(t){t.preventDefault(),y(++h%2)},!1),l.style.cssText="width:80px;opacity:0.9;cursor:pointer";var c=document.createElement("div");c.id="fps",c.style.cssText="padding:0 0 3px 3px;text-align:left;background-color:#002",l.appendChild(c);var p=document.createElement("div");p.id="fpsText",p.style.cssText="color:#0ff;font-family:Helvetica,Arial,sans-serif;font-size:9px;font-weight:bold;line-height:15px",p.innerHTML="FPS",c.appendChild(p);var x=document.createElement("div");for(x.id="fpsGraph",x.style.cssText="position:relative;width:74px;height:30px;background-color:#0ff",c.appendChild(x);74>x.children.length;){var f=document.createElement("span");f.style.cssText="width:1px;height:30px;float:left;background-color:#113",x.appendChild(f)}var d=document.createElement("div");d.id="ms",d.style.cssText="padding:0 0 3px 3px;text-align:left;background-color:#020;display:none",l.appendChild(d);var v=document.createElement("div");v.id="msText",v.style.cssText="color:#0f0;font-family:Helvetica,Arial,sans-serif;font-size:9px;font-weight:bold;line-height:15px",v.innerHTML="MS",d.appendChild(v);var m=document.createElement("div");for(m.id="msGraph",m.style.cssText="position:relative;width:74px;height:30px;background-color:#0f0",d.appendChild(m);74>m.children.length;)f=document.createElement("span"),f.style.cssText="width:1px;height:30px;float:left;background-color:#131",m.appendChild(f);var y=function(t){switch(h=t){case 0:c.style.display="block",d.style.display="none";break;case 1:c.style.display="none",d.style.display="block"}};return{REVISION:12,domElement:l,setMode:y,begin:function(){t=Date.now()},end:function(){var h=Date.now();n=h-t,r=Math.min(r,n),i=Math.max(i,n),v.textContent=n+" MS ("+r+"-"+i+")";var l=Math.min(30,30-30*(n/200));return m.appendChild(m.firstChild).style.height=l+"px",u++,h>e+1e3&&(o=Math.round(1e3*u/(h-e)),a=Math.min(a,o),s=Math.max(s,o),p.textContent=o+" FPS ("+a+"-"+s+")",l=Math.min(30,30-30*(o/100)),x.appendChild(x.firstChild).style.height=l+"px",e=h,u=0),h},update:function(){t=this.end()}}};"object"==typeof e&&(e.exports=r)},{}],22:[function(t,e,n){var r=t("./../lib/glMatrixSubset"),i=t("./../Context"),o=t("./../lib/Mesh"),a=t("./../lib/QuadTree"),s=t("./../lib/Timeline"),u=t("./../lib/Loader"),h=r.mat4,l=i.gl,c=t("../generators/BuildingSHG.js"),p=t("../generators/City.js"),x=function(t,e,n){return t*(1-n)+e*n},f=function(t,e){for(var n=[],r=[],i=[],a=[],s=[],u=0,h=t.lots.length;h>u;u++){var l,p,x,f,d,v,m,y,g;l=t.lots[u],p=l.height,x=l.angle,l=l.poly,f=d=0,v=y=Number.POSITIVE_INFINITY,m=g=Number.NEGATIVE_INFINITY;for(var z=0,E=l.length;E>z;z++){var b=l[z];f+=b.x,d+=b.y,v=Math.min(v,b.x),m=Math.max(m,b.x),y=Math.min(y,b.y),g=Math.max(g,b.y)}f/=l.length,d/=l.length;for(var T=c.create({x:f,y:d,width:.9*Math.abs(m-v),depth:.9*Math.abs(g-y),angle:x}),M=T.geom,w=T.color,R=0,A=M.length;A>R;R++){var I=M[R];if("light"in I)a.push(I.light);else for(var z=0,E=I.vertices.length;E>z;z++)n.push(I.vertices[z]),r.push(I.uvs[z]),i.push(w[z%3])}s.push({mesh:new o(n,r,i),x:f,y:d,w:Math.max(m-v,g-y)}),n.splice(0),r.splice(0),i.splice(0)}return{meshes:s,lights:a,x:t.x,y:t.y,w:t.w}},d=new p(0),v={quadtree:null,quadtreeLights:null,fixedMeshes:[]},m=document.createElement("pre");m.style.background="white",m.style.color="black",m.style.position="absolute",m.style.right="1rem",m.style.top="7rem",i.canvas.parentElement.appendChild(m),function(){var t,e=[],n=[],r=[],i=[],s=[],h=[],c=0,p=d.blocks.length;!function(){var t=[];d.roads.forEach(function(e){h.push({x:e.x,y:.5,z:e.y}),e.conns.forEach(function(n){-1===t.indexOf(n)&&(h.push({x:x(e.x,n.x,.33),y:.5,z:x(e.y,n.y,.33)}),h.push({x:x(e.x,n.x,.66),y:.5,z:x(e.y,n.y,.66)}))}),t.push(e)})}(),function(){var t=function(){var e=d.blocks.shift(),n=f(e);s.push(n),c++,u.progress("Blocks",c/p),d.blocks.length>0&&setTimeout(t,0)};setTimeout(t,0)}(),u.subscribe("Blocks",function(e,n){return function(){var r,i,o,s;r=i=Number.POSITIVE_INFINITY,o=s=Number.NEGATIVE_INFINITY,n.forEach(function(t){r=Math.min(r,t.x-t.w),o=Math.max(o,t.x+t.w),i=Math.min(i,t.y-t.w),s=Math.max(s,t.y+t.w)});var u=Math.abs(o-r)/2,c=Math.abs(s-i)/2;t=new a(u,c,Math.max(u,c),16),n.forEach(function(e){e.meshes.forEach(function(e){t.insert(e)})}),e.quadtree=t,e.allLights=h,y.lights=e.allLights.reduce(function(t,e){for(var n=0;6>n;n++)t.push(e.x,e.y,e.z);return t},[]),l.bindBuffer(l.ARRAY_BUFFER,y.lightBuf),l.bufferData(l.ARRAY_BUFFER,new Float32Array(y.lights),l.STATIC_DRAW),l.bindBuffer(l.ARRAY_BUFFER,null)}}(v,s)),e.push.apply(e,[-20,-.001,-20,-20,-.001,20,20,-.001,20,-20,-.001,-20,20,-.001,20,20,-.001,-20]),n.push.apply(n,[0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0]),r.push.apply(r,[0,0,3,0,40,3,40,40,3,0,0,3,40,40,3,40,0,3]),i.push.apply(i,[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]);for(var m=d.roadQuads.reduce(function(){var t,e;return t=[0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0],e=[0,0,2,0,1,2,1,1,2,0,0,2,1,1,2,1,0,2],function(n,r){for(var i=r[0],o=r[1],a=Math.atan2(o.y-i.y,o.x-i.x)+Math.PI/2,s=Math.abs(.09*Math.cos(a)),u=Math.abs(.09*Math.sin(a)),h={x:i.x+u,y:i.y+s},l={x:o.x-u,y:o.y-s},c=Math.sqrt(Math.pow(l.y-h.y,2)+Math.pow(l.x-h.x,2)),p=[h.x-s,0,h.y-u,l.x-s,0,l.y-u,l.x+s,0,l.y+u,h.x-s,0,h.y-u,l.x+s,0,l.y+u,h.x+s,0,h.y+u],x=e.map(function(t,e){switch(e%3){case 0:return t;case 1:return t*c;default:return t}return t}),f=0,d=p.length;d>f;f++)n.vertices.push(p[f]),n.normals.push(t[f]),n.uvs.push(x[f]),n.extra.push(0);return n}}(),{vertices:[],normals:[],uvs:[],extra:[]}),g=0,z=m.vertices.length;z>g;g++)e.push(m.vertices[g]),n.push(m.normals[g]),r.push(m.uvs[g]),i.push(m.extra[g]);v.fixedMeshes=[new o(e,r,i)]}();var y={meshes:[],lights:[],lightBuf:l.createBuffer(),lightParameters:[12,0,6,32],view:h.create(),model:h.create(),count:0,texture:l.createTexture()};l.bindTexture(l.TEXTURE_2D,y.texture),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MAG_FILTER,l.NEAREST),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MIN_FILTER,l.NEAREST),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_WRAP_S,l.CLAMP_TO_EDGE),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_WRAP_T,l.CLAMP_TO_EDGE),l.texImage2D(l.TEXTURE_2D,0,l.RGBA,i.w,i.h,0,l.RGBA,l.UNSIGNED_BYTE,null),l.bindTexture(l.TEXTURE_2D,null);var g=0,z=function(t,e){return t.push(e),t},E=2.71,b=.38,T=1.31,M=.26,w=.79,R=0,A=0,I=new s;!function(){var t=I.property("x"),e=I.property("y"),n=I.property("z"),r=I.property("a"),i=I.property("b"),o=I.property("f");o.at(0,0).at(2e3,1,"h01"),t.at(0,1.54).at(2e3,1.54,"no").at(8e3,1.91,"h01"),e.at(0,1.19),n.at(0,.19).at(2e3,.19,"no").at(8e3,.03,"h01"),r.at(0,0).at(2e3,0,"no").at(8e3,.24,"h01"),i.at(0,-3.54).at(2e3,-3.54,"no").at(8e3,-3.45,"h01"),t.at(9e3,.78,"no"),e.at(9e3,.1,"no"),n.at(9e3,2.03,"no"),r.at(9e3,-.75,"no").at(12e3,-.65,"h01"),i.at(9e3,.65,"no").at(12e3,.75,"h01"),t.at(13e3,2.97,"no"),e.at(13e3,1.02,"no").at(4e4,.02,"h01"),n.at(13e3,2.16,"no"),r.at(13e3,.34,"no").at(4e4,-.04,"h01"),i.at(13e3,-3.26,"no").at(4e4,-6.84,"h01"),o.at(39800,1,"no").at(4e4,0,"h01").at(40200,1,"h01"),t.at(4e4,5.45,"no").at(56e3,3.27,"h01").at(7e4,3.27,"out3").at(8e4,3.4,"in3"),e.at(4e4,1.28,"no").at(56e3,.48,"h01").at(7e4,.48,"out3").at(8e4,.425,"in3"),n.at(4e4,.56,"no").at(56e3,2.15,"h01").at(7e4,2.15,"out3").at(8e4,1.83,"in3"),r.at(4e4,.26,"no").at(56e3,-.18,"h01").at(7e4,.05,"out3").at(8e4,0,"in3"),i.at(4e4,-2.72,"no").at(56e3,-2.35,"h01").at(7e4,.21,"out3").at(8e4,0,"in3")}(),window.followTimeline=!0,i.canvas.addEventListener("click",function(t){2===t.which&&(window.followTimeline=!window.followTimeline)}),y.update=function(t){var e,n,r,i,o;if(window.followTimeline){var a=I.update(t);E=e=a.x,b=n=a.y,T=r=a.z,M=i=a.a,w=o=a.b,y.fade=a.f}else E+=(Math.cos(w)*R-Math.sin(w)*A)*Math.cos(M),b+=Math.sin(M)*A,T+=(Math.sin(w)*R+Math.cos(w)*A)*Math.cos(M),e=E,n=b,r=T,i=M,o=w,y.fade=1;m.textContent=[e,n,r,y.fade].map(function(t){return t.toFixed(2)}).join(", ")+" "+i.toFixed(2)+" "+o.toFixed(2),h.identity(y.view),h.rotateX(y.view,y.view,i),h.rotateY(y.view,y.view,o),h.translate(y.view,y.view,[-e,-n,-r]);var s=v.quadtree.query(e,r,4);y.meshes=v.fixedMeshes.reduce(z,[]),y.meshes=s.map(function(t){return t.mesh}).reduce(z,y.meshes),y.lights=v.allLights.reduce(function(t,e){for(var n=0;6>n;n++)t.push(e.x,e.y,e.z);return t},[]),m.textContent+="\nTime: "+t.toFixed(2),m.textContent+="\nVertices: "+y.meshes.reduce(function(t,e){return t+e.count},0),g+=.001,m.textContent+=", Lights: "+y.lights.length/18},document.body.addEventListener("keydown",function(t){switch(t.which){case 87:A=-.008;break;case 83:A=.008;break;case 65:R=-.008;break;case 68:R=.008}}),document.body.addEventListener("keyup",function(t){switch(t.which){case 87:A=0;break;case 83:A=0;break;case 65:R=0;break;case 68:R=0}}),i.canvas.addEventListener("mousedown",function(t){var e,n,r=t.clientX,o=t.clientY;e=function(t){var e=t.clientX-r,n=t.clientY-o;M+=.005*n,w+=.005*e,r=t.clientX,o=t.clientY,m.textContent=[E,b,T].map(function(t){return t.toFixed(2)}).join(", ")+" "+M.toFixed(2)+" "+w.toFixed(2)},n=function(t){i.canvas.removeEventListener("mousemove",e),i.canvas.removeEventListener("mouseup",n)},i.canvas.addEventListener("mousemove",e),i.canvas.addEventListener("mouseup",n)}),e.exports=y},{"../generators/BuildingSHG.js":5,"../generators/City.js":6,"./../Context":1,"./../lib/Loader":12,"./../lib/Mesh":13,"./../lib/QuadTree":14,"./../lib/Timeline":17,"./../lib/glMatrixSubset":18}],23:[function(t,e,n){var r,i,o,a,s,u=t("./../lib/glMatrixSubset"),h=t("./../Context"),l=t("./../lib/Loader"),c=t("./../lib/Mesh"),p=u.vec3,x=u.mat4,f=h.gl,d=t("../generators/RoomSHG.js"),v=t("./../generators/PRNG"),m={meshes:[],lights:[],lightBuf:f.createBuffer(),lightParameters:[6,0,2,.1],view:x.create(),model:x.create(),count:0,texture:f.createTexture()};o=new v(54321),f.bindTexture(f.TEXTURE_2D,m.texture),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MAG_FILTER,f.NEAREST),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MIN_FILTER,f.NEAREST),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,f.CLAMP_TO_EDGE),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,f.CLAMP_TO_EDGE),f.texImage2D(f.TEXTURE_2D,0,f.RGBA,h.w,h.h,0,f.RGBA,f.UNSIGNED_BYTE,null),f.bindTexture(f.TEXTURE_2D,null),m.init=function(){var t=0,e=.25;a=function(t,e){var n=t.vertices,r=(t.normals,t.uvs),i=[];return e=e.reduce(function(t,e){return void 0!==e.door&&t.push(e.door.point),t.push(e.room.roomCentroid),t},[]),i=n.map(function(t,e){return.4}),{room:t,mesh:new c(n,r,i),lampMesh:new c(new Float32Array(t.lamp.vertices),new Float32Array(t.lamp.uvs),new Float32Array(t.lamp.extra)),tableMesh:new c(new Float32Array(t.table.vertices),new Float32Array(t.table.uvs),new Float32Array(t.table.extra)),lights:t.roomsWorld.map(function(t){return{x:t.x,y:t.y+.75,z:t.z}}),path:e}};var n=function(t,e,n){var r,i,o=[t],a=[],s=[],u=[];for(a[n.indexOf(t)]=null;o.length>0&&(r=o.shift(),r!==e);)r.neighbors.forEach(function(t){var e=n.indexOf(t.r);void 0===a[e]&&(o.push(t.r),a[e]=r,s[e]=t.via)});for(r=e;null!==r;)if(i=n.indexOf(r),void 0!==s[i]&&u.unshift({room:r,door:s[i]}),r=a[i],void 0===r)return u;return u};i=d.create([{x:-4,y:0,z:-8},{x:-4,y:0,z:8},{x:4,y:0,z:8},{x:4,y:0,z:-8}]),t+=e,l.progress("Rooms",t);var u=[],h=i.nodes.reduce(function(t,e){return e.isFirst&&(t.first=e),e.isLast&&(t.last=e),t},{first:null,last:null}),v=i.nodes.filter(function(t){return!t.isMonitor});v.sort(function(){var t=o.random()-.5;return t});for(var y=0,g=i.nodes.length;g-1>y;y++)u=u.concat(n(v[y],v[(y+1)%g],v));u=u.concat(n(v[v.length-1],h.first,v)),u=u.concat({door:void 0,room:h.first}),u=u.concat(n(h.first,h.last,i.nodes)),u.push({door:i.monitor.door,
room:i.monitor}),t+=e,l.progress("Rooms",t),r=a(i,u),m.meshes=[r.mesh,r.lampMesh,r.tableMesh],m.lights=r.lights.reduce(function(t,e){for(var n=0;6>n;n++)t.push(e.x,e.y,e.z);return t},[]),f.bindBuffer(f.ARRAY_BUFFER,m.lightBuf),f.bufferData(f.ARRAY_BUFFER,new Float32Array(m.lights),f.STATIC_DRAW),f.bindBuffer(f.ARRAY_BUFFER,null),t+=e,l.progress("Rooms",t),s=function(t,e){for(var n=[],r=0,i=t.length;i-1>r;r++){var o=t[r],a=t[Math.min(r+1,i-1)],s=t[Math.min(r+2,i-1)],u=a.x-o.x,h=a.z-o.z,l=Math.sqrt(u*u+h*h),c=(Math.atan2(-a.z+o.z,a.x-o.x)+3*Math.PI/2)%(2*Math.PI),p=(Math.atan2(-s.z+a.z,s.x-a.x)+3*Math.PI/2)%(2*Math.PI),x=0;for(r>=i-4&&(p=c);p-c>Math.PI;)p-=2*Math.PI;for(;c-p>Math.PI;)c-=2*Math.PI;for(var f=0,d=~~(l/e);d>f;f++)x=f/d,n.push({x:o.x*(1-x)+a.x*x,y:o.y*(1-x)+a.y*x,z:o.z*(1-x)+a.z*x,th:c*(1-x)+p*x})}return function(t){var e=t,r=n.length,i=e*(r-1),o=Math.floor(i),a=i-o,s=n[o],u=n[(o+1)%r];return{x:s.x*(1-a)+u.x*a,y:s.y*(1-a)+u.y*a,z:s.z*(1-a)+u.z*a,th:s.th*(1-a)+u.th*a}}}(r.path,.025),t+=e,l.progress("Rooms",t),x.translate(m.view,m.view,[0,0,-6]),x.rotateX(m.view,m.view,Math.PI/2),x.rotateY(m.view,m.view,Math.PI/2);var z=750*r.path.length;m.meshes.length,2*Math.PI/1e3;m.totalTime=z,m.update=function(t){var e=Math.min(t/z,1),n=s(isNaN(e)?0:e),r=n.x,i=n.z,o=n.th,a=0,u=0,h=0,l=p.fromValues(-.0625,.25,.0625),c=p.fromValues(0,.25,-.25),f=p.fromValues(.0625,.25,.0625),d=x.create();x.translate(d,d,[r,0,i]),x.scale(d,d,[2,1,2]),x.rotateY(d,d,o),p.transformMat4(l,l,d),p.transformMat4(c,c,d),p.transformMat4(f,f,d),x.identity(m.view),x.rotateY(m.view,m.view,-o),x.translate(m.view,m.view,[-r+u,-.75+a,-i+h])}},e.exports=m},{"../generators/RoomSHG.js":10,"./../Context":1,"./../generators/PRNG":8,"./../lib/Loader":12,"./../lib/Mesh":13,"./../lib/glMatrixSubset":18}],24:[function(t,e,n){function r(){0===f&&requestAnimationFrame(r),h.render()}function i(t){(isNaN(i.t0)||void 0===i.t0)&&(i.t0=t),void 0!==i.t1&&!isNaN(i.t1)&&t-i.t1>32&&console.log("WARN",t-i.t1),x.begin();var e=t-i.t0;8e4>e?(c.update(e),u.render(c,!0)):(e-=4e3,e%=76e3+p.totalTime,76e3>e?(c.update(e+4e3),u.render(c,!0)):(c.update(Math.max(0,e-(76e3+p.totalTime)+4e3)),p.update(e-76e3),u.render(c),u.render(p,!0))),x.end(),requestAnimationFrame(i),i.t1=t}var o=t("./Context"),a=o.canvas,s=o.gl,u=t("./Renderer.js"),h=t("./lib/Loader"),l=(t("./lib/Timeline"),t("stats-js")),c=t("./scenes/MainScene.js"),p=t("./scenes/RoomScene.js"),x=new l;x.setMode(0),x.domElement.style.position="absolute",x.domElement.style.right="1rem",x.domElement.style.top="1rem",a.parentNode.appendChild(x.domElement);var f=0,d=0,v=NaN;h.subscribe("Blocks",function(){d+=.5,h.progress("City",d)}),h.subscribe("Rooms",function(){d+=.5,h.progress("City",d)}),h.subscribe("City",function(){console.log("Loading complete"),f=1,v=NaN,u.init(c,p),c.update(0),u.render(c,!0),p.update(0),u.render(p),setTimeout(i,1e3)});var m=0,y=!1;document.addEventListener("keydown",function(t){32===t.keyCode&&(t.preventDefault(),t.stopPropagation(),y=!y)}),document.addEventListener("wheel",function(t){t.preventDefault(),t.stopPropagation(),m+=t.deltaY,m=Math.max(m,0)}),window.JMP=function(t){m=t},s.viewport(0,0,o.w,o.h),p.init(),r()},{"./Context":1,"./Renderer.js":2,"./lib/Loader":12,"./lib/Timeline":17,"./scenes/MainScene.js":22,"./scenes/RoomScene.js":23,"stats-js":21}]},{},[24]);