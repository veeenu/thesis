!function t(n,e,r){function i(a,s){if(!e[a]){if(!n[a]){var u="function"==typeof require&&require;if(!s&&u)return u(a,!0);if(o)return o(a,!0);var h=new Error("Cannot find module '"+a+"'");throw h.code="MODULE_NOT_FOUND",h}var l=e[a]={exports:{}};n[a][0].call(l.exports,function(t){var e=n[a][1][t];return i(e?e:t)},l,l.exports,t,n,e,r)}return e[a].exports}for(var o="function"==typeof require&&require,a=0;a<r.length;a++)i(r[a]);return i}({1:[function(t,n,e){var r=document.getElementById("thesis-canvas"),i=r.getContext("webgl"),o=r.getBoundingClientRect(),a=o.width,s=o.height;r.width=a,r.height=s,r.style.background="black",n.exports={canvas:r,gl:i,w:a,h:s,aspectRatio:a/s}},{}],2:[function(t,n,e){var r,i,o,a,s,u,h,l=(t("./lib/util.js"),t("./lib/glMatrixSubset")),c=(l.vec3,l.mat3),p=l.mat4,f=t("./Context"),x=f.gl,v=(t("./generators/BuildingSHG.js"),x.createProgram()),d=x.createProgram(),y=x.createProgram(),m=x.createShader(x.VERTEX_SHADER),g=x.createShader(x.FRAGMENT_SHADER),E=x.createShader(x.VERTEX_SHADER),b=x.createShader(x.FRAGMENT_SHADER),z=x.createShader(x.VERTEX_SHADER),M=x.createShader(x.FRAGMENT_SHADER);o="uniform mat4 projection, viewmodel;\nuniform mat3 normalM;\n\nattribute vec3 vertex, normal, uv, extra;\n\nvarying vec4 vPosition, clipPosition;\nvarying vec3 texUV, vNormal, vExtra;\n\nvoid main() {\n  \n  vec4 viewPos = viewmodel * vec4(vertex, 1.);\n  clipPosition = gl_Position = projection * viewPos;\n\n  vPosition = viewPos;\n  vNormal = normalize(normalM * normal);\n  vExtra = extra;\n  texUV = uv;\n\n}\n\n",s="#extension GL_OES_standard_derivatives : require\n//#extension GL_EXT_draw_buffers : require\n\nprecision highp float;\n\nvarying vec4 vPosition, clipPosition;\nvarying vec3 texUV, vNormal, vExtra;\n\n////////////////////////////////////////////////////////////////////////////////\n// https://github.com/ashima/webgl-noise/blob/master/src/noise2D.glsl         //\n////////////////////////////////////////////////////////////////////////////////\n\nvec3 mod289(vec3 x) { return x - floor(x * (1.0 / 289.0)) * 289.0; }\nvec2 mod289(vec2 x) { return x - floor(x * (1.0 / 289.0)) * 289.0; }\nvec3 permute(vec3 x) { return mod289(((x*34.0)+1.0)*x); }\nfloat snoise(vec2 v) {\n  const vec4 C = vec4(0.211324865405187,  // (3.0-sqrt(3.0))/6.0\n                      0.366025403784439,  // 0.5*(sqrt(3.0)-1.0)\n                     -0.577350269189626,  // -1.0 + 2.0 * C.x\n                      0.024390243902439); // 1.0 / 41.0\n  vec2 i  = floor(v + dot(v, C.yy) );\n  vec2 x0 = v -   i + dot(i, C.xx);\n  vec2 i1;\n  i1 = (x0.x > x0.y) ? vec2(1.0, 0.0) : vec2(0.0, 1.0);\n  vec4 x12 = x0.xyxy + C.xxzz;\n  x12.xy -= i1;\n  i = mod289(i);\n  vec3 p = permute( permute( i.y + vec3(0.0, i1.y, 1.0 ))\n		+ i.x + vec3(0.0, i1.x, 1.0 ));\n  vec3 m = max(0.5 - vec3(dot(x0,x0), dot(x12.xy,x12.xy), dot(x12.zw,x12.zw)), 0.0);\n  m = m*m ;\n  m = m*m ;\n  vec3 x = 2.0 * fract(p * C.www) - 1.0;\n  vec3 h = abs(x) - 0.5;\n  vec3 ox = floor(x + 0.5);\n  vec3 a0 = x - ox;\n  m *= 1.79284291400159 - 0.85373472095314 * ( a0*a0 + h*h );\n  vec3 g;\n  g.x  = a0.x  * x0.x  + h.x  * x0.y;\n  g.yz = a0.yz * x12.xz + h.yz * x12.yw;\n  return 130.0 * dot(m, g);\n}\n\n////////////////////////////////////////////////////////////////////////////////\n// Procedural textures\n////////////////////////////////////////////////////////////////////////////////\n\nvec3 bumpMap(vec3 fvert, vec3 fnorm, float bump) {\n\n  vec3 bU = dFdx(bump) * cross(fnorm, normalize(dFdy(fvert))),\n       bV = dFdy(bump) * cross(normalize(dFdx(fvert)), fnorm),\n       bD = fnorm + (bU + bV);\n\n  return normalize(bD);\n}\n\nstruct TTextureInfo {\n  vec3 color;\n  vec3 normal;\n};\n\n#define textureBrickI(x, p, notp) ((floor(x)*(p))+max(fract(x)-(notp), 0.0))\nTTextureInfo textureBrick(vec3 fvert, vec3 fnorm, float fdepth, vec2 uv, vec3 brickColor) {\n\n  const float bW  = .03125,\n              bH  = .015625,\n              mS  = 1. / 512.,\n              mWf = mS * .5 / bW,\n              mHf = mS * .5 / bH;\n  //const vec3 mortarColor = vec3(.9, .9, .9);\n  const vec3 mortarColor = vec3(.68, .68, .71);\n\n  float u = uv.s / bW,\n        v = uv.t / bH,\n        brU = floor(u),\n        brV = floor(v);\n\n  if(mod(v * .5, 1.) > .5)\n    u += .5;\n  brU = floor(u);\n\n  float noisev = 1. +\n                 //snoise(uv * 16.) * .0625 +\n                 snoise(uv * 256.) * .125;\n  float brickDamp = 1. + .125 * sin(1.57 * (brU + 1.)) * sin(2. * (brV + 1.));\n\n  vec2 uuv = vec2(u, v),\n       fw = 2. * vec2(fwidth(uuv.x), fwidth(uuv.y)),\n       mortarPct = vec2(mWf, mHf),\n       brickPct = vec2(1., 1.) - mortarPct,\n       ub = (textureBrickI(uuv + fw, brickPct, mortarPct) -\n             textureBrickI(uuv, brickPct, mortarPct)) / fw;\n\n  vec3 color = mix(mortarColor, brickColor * brickDamp, ub.x * ub.y);\n\n  // Adaptive box blur filter. Not perfect but quick and somewhat acceptable\n  vec2 ubSample, ubKernel = 4. * fwidth(ub), noiseKernel = fwidth(uv);\n  float bump = 0., invd = 1. / 11.;\n\n  for(int x = -1; x <= 1; x++) {\n    for(int y = -1; y <= 1; y++) {\n      ubSample = ub + vec2(float(x), float(y)) * ubKernel;\n      bump += .1111111 * ubSample.x * ubSample.y;\n    }\n  }\n\n  // Frequency clamping\n  bump += 4. * (1. - smoothstep(0., .00125, max(noiseKernel.x, noiseKernel.y))) * noisev;\n\n  return TTextureInfo(\n    color,\n    bumpMap(fvert, fnorm, bump)\n  );\n}\n\n/******************************************************************************\\\n * Window texture\n\\******************************************************************************/\n\nTTextureInfo textureWindow(vec3 fvert, vec3 fnorm, float fdepth, vec2 uv, vec3 windowColor) {\n\n  const vec2 patternPct   = vec2(1., 1.),\n             patternStart = vec2(0., 0.), //(1. - patternPct) * .25,\n             patternEnd   = patternStart + patternPct,\n             framePct     = vec2(1. / 32., 1. / 32.),\n             frameStart   = patternStart + framePct,\n             frameEnd     = patternEnd   - framePct;\n  //const vec3 windowColor  = vec3(.8, .94, .99),\n  const vec3 frameColor   = vec3(.5, .5, .5);\n\n  vec2 fk   = fwidth(uv) * 2.,\n       uuv  = mod(uv, .5 - 1. / 64.),\n       patF = (smoothstep(frameEnd, frameEnd + fk, uuv) - smoothstep(frameStart, frameStart + fk, uuv));\n  float noisep = 1. + \n                snoise(-uv * .5) * .25;\n  float noisev = 1. + \n                 snoise(uv * 16.) * .0625 +\n                 abs(snoise(uv * 512.)) * .0625;\n\n  /*vec2 patSample, patKernel = 3. * vec2(fwidth(patF.x), fwidth(patF.y));\n  float bump = 0.;\n\n  for(int x = -1; x <= 1; x++) {\n    for(int y = -1; y <= 1; y++) {\n      patSample = patF + vec2(float(x), float(y)) * patKernel;\n      bump += patSample.x * patSample.y;\n    }\n  }\n  bump *= 1./9.;*/\n\n  float bump = patF.x * patF.y;\n\n  return TTextureInfo(\n    mix(frameColor, windowColor * noisep, patF.x * patF.y),\n    bumpMap(fvert, fnorm, bump)\n  );\n}\n\n/******************************************************************************\\\n * Road texture\n\\******************************************************************************/\n\nvec3 textureRoad(vec2 uuv) {\n  const float padding = 1. / 32.,\n              tapeW   = 1. / 32.,\n              tapeL0  = padding,\n              tapeL1  = padding + tapeW,\n              tapeR1  = 1. - tapeL0,\n              tapeR0  = 1. - tapeL1,\n              tapeC0  = .5 - tapeW * .5,\n              tapeC1  = .5 + tapeW * .5,\n              vertDiv = 4.;\n  const vec3 asphaltColor = vec3(.2, .2, .2),\n             stripColor = vec3(.8, .8, .8);\n\n  vec2 uv = uuv + vec2(0, .5), fk = fwidth(uv);\n  float csSpacing = mod(.25 + uv.t * vertDiv, 1.),\n        q = \n    (\n      smoothstep(tapeL0, tapeL0 + fk.x, uv.s) - \n      smoothstep(tapeL1, tapeL1 + fk.x, uv.s)\n    ) +\n    (\n      smoothstep(tapeR0, tapeR0 + fk.x, uv.s) - \n      smoothstep(tapeR1, tapeR1 + fk.x, uv.s)\n    ) +\n    (\n      smoothstep(tapeC0, tapeC0 + fk.x, uv.s) - \n      smoothstep(tapeC1, tapeC1 + fk.x, uv.s)\n    ) * \n    (\n      smoothstep(.5 - fk.y, .5 + fk.y, csSpacing) *\n      (1. - smoothstep(1. - 2. * fk.y, 1., csSpacing))\n    )\n    ;\n\n  float noiseA = 1. +\n                 abs(snoise(uv * 16.))  * .0625 +\n                 abs(snoise(uv * 32.))  * .0625 +\n                 abs(snoise(uv * 128.)) * .125,\n        noiseS = 1. + \n                 abs(snoise(uv * 128.)) * .125;\n\n  return mix(asphaltColor * noiseA, stripColor * noiseS, q);\n}\n\nvec3 textureAsphalt(vec2 uuv) {\n  const vec3 asphaltColor = vec3(.2, .2, .2);\n\n  vec2 uv = uuv + vec2(0, .5);\n  float noiseA = 1. +\n                 abs(snoise(uv * 16.))  * .0625 +\n                 abs(snoise(uv * 32.))  * .0625 +\n                 abs(snoise(uv * 128.)) * .125;\n  return asphaltColor * 1.5 * noiseA;\n}\n////////////////////////////////////////////////////////////////////////////////\n\nfloat packColor(vec3 v) {\n  const float u = 255. / 256.;\n\n  return fract(v.x * u) + floor(v.y * u * 255.) + floor(v.z * u * 255.) * 255.;\n}\n\nvec2 packNormal(in vec3 normal)\n{\n    const float SCALE = 1.7777;\n    float scalar1 = (normal.z + 1.0) * (SCALE * 2.0);\n    return normal.xy / scalar1 + 0.5;\n}\n\nvoid main() {\n\n  TTextureInfo ti; // = textureBrick(vPosition.xyz, vNormal.xyz, vNormal.w, texUV.st, vExtra.xyz);\n  vec3 color, normal;\n\n  float depth = clipPosition.z / clipPosition.w; //gl_FragCoord.z / gl_FragCoord.w;\n\n  normal = normalize(faceforward(vNormal, gl_FragCoord.xyz, vNormal));\n\n  if(texUV.z > 5.1) {\n    ti = textureBrick(vPosition.xyz, vNormal, gl_FragCoord.z, mod(texUV.xy, 1.), vExtra);\n    color = ti.color;\n    normal = ti.normal;\n  }\n  else if(texUV.z > 4.1) {\n    ti = textureWindow(vPosition.xyz, vNormal, gl_FragCoord.z, mod(texUV.yx, 1.), vec3(1., 1., .7));\n    color = ti.color;\n    normal = ti.normal;\n  }\n  else if(texUV.z > 3.1) {\n    ti = textureWindow(vPosition.xyz, vNormal, gl_FragCoord.z, mod(texUV.yx, 1.), vec3(.3, .3, .3));\n    color = ti.color;\n    normal = ti.normal;\n  }\n  else if(texUV.z > 2.1)\n    color = textureAsphalt(mod(texUV.yx, 1.));\n  else if(texUV.z > 1.1)\n    color = textureRoad(mod(texUV.xy, 1.));\n  else\n    color = textureAsphalt(mod(texUV.yx, 1.)); //textureWindow(uuv, fextra);\n\n  gl_FragColor = vec4(packNormal(normalize(normal)), packColor(clamp(color, 0., 1.)), depth);\n  //gl_FragData[0] = vec4(packNormal(normalize(normal)), packColor(clamp(color, 0., 1.)), depth);\n  //gl_FragData[1] = vec4(normalize(normal), depth);\n  //gl_FragData[2] = vec4(color, pack(clamp(color, 0., 1.)));\n}\n",a="uniform mat4 viewMatrix;\nuniform vec3 lightPos;\n\nattribute vec2 position;\nvarying vec2 sscoord, coord;\n\nvarying vec3 lPos;\n\nvoid main() {\n  gl_Position = vec4(position, 0., 1.);\n  coord = .5 + .5 * position;\n  sscoord = position;\n  //lPos = vec3(0., 0., 0.); \n  lPos = (viewMatrix * vec4(lightPos, 1.)).xyz;\n}\n",u="#extension GL_OES_standard_derivatives : enable\nprecision highp float;\n\nuniform sampler2D target0, depthBuffer;\nuniform mat4 inverseProjection, viewMatrix;\nuniform vec3 lightPos;\n\nvarying vec2 sscoord, coord;\nvarying vec3 lPos;\n\nfloat sample(vec3 p, vec3 n, vec2 uv) {\n  vec3 dstP = texture2D(target0, uv).xyz,\n       posV = dstP - p;\n\n  float intens = max(dot(normalize(posV), n) - .05, 0.),\n        dist = length(posV),\n        att  = 1. / (2. + (5. * dist));\n  return intens * att;\n}\n\nhighp float rand(vec2 co)\n{\n    highp float a = 12.9898;\n    highp float b = 78.233;\n    highp float c = 43758.5453;\n    highp float dt= dot(co.xy ,vec2(a,b));\n    highp float sn= mod(dt,3.14);\n    return fract(sin(sn) * c);\n}\n\nvec3 unpackColor(float d) {\n  vec3 ret;\n\n  ret.x = fract(d);\n  float zi = floor(d / 255.);\n  ret.z = fract(zi / 255.);\n  ret.y = fract( floor( d - ( zi * 255. ) ) / 255.);\n\n  return ret;\n}\n\nvec3 unpackNormal(in vec2 enc)\n{\n	const float SCALE = 1.7777;\n	vec2 nn = enc * (2.0 * SCALE) - SCALE;\n	float g = 2.0 / (dot(nn.xy, nn.xy) + 1.0);\n	vec3 normal;\n	normal.xy = g * nn.xy;\n	normal.z = g - 1.0;\n	return normal;\n}\n\n////////////////////////////////////////////////////////////////////////////////\n// Main\n////////////////////////////////////////////////////////////////////////////////\n\n#define DL 2.399963229728653\n#define EULER 2.718281828459045\n\nvec2 vrand( const vec2 coord ) {\n \n  vec2 noise;\n \n  float nx = dot ( coord, vec2( 12.9898, 78.233 ) );\n  float ny = dot ( coord, vec2( 12.9898, 78.233 ) * 2.0 );\n \n  noise = clamp( fract ( 43758.5453 * sin( vec2( nx, ny ) ) ), 0.0, 1.0 );\n \n  return ( noise * 2.0  - 1.0 ) * .0003;\n \n}\n\nfloat readDepth(const vec2 coord) {\n  return (2. * .001) / (1000.001 - texture2D(target0, coord).w * 999.999);\n}\n\nfloat cmpDepth(const float d1, const float d2, inout int far) {\n\n  float ga = 2., diff = (d1 - d2) * 100.;\n\n  if(diff < .2)\n    ga = .2;\n  else\n    far = 1;\n\n  float dd = diff - .2,\n        gauss = pow(EULER, -2. * dd * dd / (ga * ga));\n  \n  return gauss;\n}\n\nfloat calcAO(float depth, vec2 uv, float dw, float dh) {\n  float dd = 20. - depth * 20.;\n\n  vec2 vv = vec2(dw, dh),\n       coord1 = uv + dd * vv,\n       coord2 = uv - dd * vv;\n\n  int far = 0;\n  float tmp1 = 0., tmp2 = 0.;\n  \n  tmp1 = cmpDepth(depth, readDepth(coord1), far);\n  if(far > 0) {\n    tmp2 = cmpDepth(readDepth(coord2), depth, far);\n    tmp1 += (1. - tmp1) * tmp2;\n  }\n\n  return tmp1;\n}\n\nvoid main() {\n\n  vec4 t0 = texture2D(target0, coord);\n  if(length(t0.xy) == 0.)\n    discard;\n\n  vec3  vertex,\n        normal    = normalize(unpackNormal(t0.xy)),\n        color     = unpackColor(t0.z);\n  float depth     = t0.w;\n\n  vec4 vertexFromDepth = inverseProjection * vec4(sscoord, depth, 1.);\n  vertex = vertexFromDepth.xyz / vertexFromDepth.w;\n\n  vec3 lightDir = lPos - vertex;\n  float lambert = max(dot(faceforward(-normal, lightDir, normal), normalize(lightDir)), 0.),\n        dist = length(lightDir),\n        att = min(1., 1. / (1. + 2.5 * dist + 5. * dist * dist));\n\n  gl_FragColor = vec4(lambert * att * 2.5 * color, 1.);\n}\n",h="#extension GL_OES_standard_derivatives : enable\nprecision highp float;\n\nuniform sampler2D target0, lightBuffer;\n\nvarying vec2 sscoord, coord;\n\n////////////////////////////////////////////////////////////////////////////////\n// Main\n////////////////////////////////////////////////////////////////////////////////\n\n#define DL 2.399963229728653\n#define EULER 2.718281828459045\n\nvec2 vrand( const vec2 coord ) {\n \n  vec2 noise;\n \n  float nx = dot ( coord, vec2( 12.9898, 78.233 ) );\n  float ny = dot ( coord, vec2( 12.9898, 78.233 ) * 2.0 );\n \n  noise = clamp( fract ( 43758.5453 * sin( vec2( nx, ny ) ) ), 0.0, 1.0 );\n \n  return ( noise * 2.0  - 1.0 ) * .0003;\n \n}\n\nfloat readDepth(const vec2 coord) {\n  return (2. * .001) / (1000.001 - texture2D(target0, coord).w * 999.999);\n}\n\nfloat cmpDepth(const float d1, const float d2, inout int far) {\n\n  float ga = 2., diff = (d1 - d2) * 100.;\n\n  if(diff < .2)\n    ga = .2;\n  else\n    far = 1;\n\n  float dd = diff - .2,\n        gauss = pow(EULER, -2. * dd * dd / (ga * ga));\n  \n  return gauss;\n}\n\nfloat calcAO(float depth, vec2 uv, float dw, float dh) {\n  float dd = 20. - depth * 20.;\n\n  vec2 vv = vec2(dw, dh),\n       coord1 = uv + dd * vv,\n       coord2 = uv - dd * vv;\n\n  int far = 0;\n  float tmp1 = 0., tmp2 = 0.;\n  \n  tmp1 = cmpDepth(depth, readDepth(coord1), far);\n  if(far > 0) {\n    tmp2 = cmpDepth(readDepth(coord2), depth, far);\n    tmp1 += (1. - tmp1) * tmp2;\n  }\n\n  return tmp1;\n}\n\nvoid main() {\n\n  //////////////////////////////////////////////////////////////////////////////\n  // SSAO\n  //////////////////////////////////////////////////////////////////////////////\n\n  vec3 color = texture2D(lightBuffer, coord).rgb;\n  float occlusion = 0., vdepth = readDepth(coord);\n  vec2 noisev = vrand(coord);\n\n  float w = (.5 / 1280.) / vdepth + (noisev.x * (1. - noisev.x)),\n        h = (.5 / 800.)  / vdepth + (noisev.y * (1. - noisev.y)),\n        dz = 1. / 16.,\n        z = 1. - dz / 2.,\n        l = 0.;\n  for(int i = 0; i <= 16; i++) {\n    float r = sqrt(1. - z),\n          pw = cos(l) * r,\n          ph = sin(l) * r;\n    occlusion += calcAO(vdepth, coord, pw * w, ph * h);\n    z -= dz;\n    l += DL;\n  }\n\n  occlusion *= dz;\n\n  gl_FragColor = vec4(mix(color, vec3(0.), occlusion), 1.);\n\n  //gl_FragColor = vec4(lambert * att * 2.5 * color, 1.);\n}\n\n",x.clearColor(0,0,0,0),x.depthFunc(x.LESS),x.getExtension("OES_standard_derivatives"),x.getExtension("OES_texture_float"),i=x.getExtension("OES_texture_float_linear"),r=x.getExtension("WEBGL_depth_texture"),x.shaderSource(m,o),x.shaderSource(g,s),x.compileShader(m),x.compileShader(g),x.attachShader(v,m),x.attachShader(v,g),x.linkProgram(v),x.shaderSource(z,a),x.shaderSource(M,h),x.compileShader(z),x.compileShader(M),x.attachShader(d,z),x.attachShader(d,M),x.linkProgram(d),x.shaderSource(E,a),x.shaderSource(b,u),x.compileShader(E),x.compileShader(b),x.attachShader(y,E),x.attachShader(y,b),x.linkProgram(y),console.log("VP:",x.getShaderInfoLog(m),"\nFP:",x.getShaderInfoLog(g),"\nVL:",x.getShaderInfoLog(E),"\nFL:",x.getShaderInfoLog(b),"\nFS:",x.getShaderInfoLog(M));var T=x.createTexture(),w=x.createTexture(),A=x.createTexture(),R=x.createFramebuffer(),F=x.createFramebuffer();x.bindTexture(x.TEXTURE_2D,w),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_MAG_FILTER,x.NEAREST),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_MIN_FILTER,x.NEAREST),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_WRAP_S,x.CLAMP_TO_EDGE),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_WRAP_T,x.CLAMP_TO_EDGE),x.texImage2D(x.TEXTURE_2D,0,x.DEPTH_COMPONENT,f.w,f.h,0,x.DEPTH_COMPONENT,x.UNSIGNED_SHORT,null),x.bindTexture(x.TEXTURE_2D,T),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_MAG_FILTER,null!==i?x.LINEAR:x.NEAREST),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_MIN_FILTER,null!==i?x.LINEAR:x.NEAREST),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_WRAP_S,x.CLAMP_TO_EDGE),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_WRAP_T,x.CLAMP_TO_EDGE),x.texImage2D(x.TEXTURE_2D,0,x.RGBA,f.w,f.h,0,x.RGBA,x.FLOAT,null),x.bindTexture(x.TEXTURE_2D,A),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_MAG_FILTER,null!==i?x.LINEAR:x.NEAREST),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_MIN_FILTER,null!==i?x.LINEAR:x.NEAREST),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_WRAP_S,x.CLAMP_TO_EDGE),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_WRAP_T,x.CLAMP_TO_EDGE),x.texImage2D(x.TEXTURE_2D,0,x.RGBA,f.w,f.h,0,x.RGBA,x.UNSIGNED_BYTE,null),x.bindTexture(x.TEXTURE_2D,null),x.bindFramebuffer(x.FRAMEBUFFER,R),x.framebufferTexture2D(x.FRAMEBUFFER,x.DEPTH_ATTACHMENT,x.TEXTURE_2D,w,0),x.framebufferTexture2D(x.FRAMEBUFFER,x.COLOR_ATTACHMENT0,x.TEXTURE_2D,T,0),x.bindFramebuffer(x.FRAMEBUFFER,F),x.framebufferTexture2D(x.FRAMEBUFFER,x.COLOR_ATTACHMENT0,x.TEXTURE_2D,A,0),x.bindFramebuffer(x.FRAMEBUFFER,null);for(var _=x.createBuffer(),S=(x.createBuffer(),[]),P=p.create(),D=p.create(),I=0;128>I;I++)S.push(1,-1,-1,-1,-1,1,1,-1,-1,1,1,1);x.bindBuffer(x.ARRAY_BUFFER,_),x.bufferData(x.ARRAY_BUFFER,new Float32Array(S),x.STATIC_DRAW),x.bindBuffer(x.ARRAY_BUFFER,null),p.perspective(P,Math.PI/2,f.aspectRatio,.001,1e3),p.invert(D,P),["vertex","normal","uv","extra"].forEach(function(t){v[t]=x.getAttribLocation(v,t)}),["projection","viewmodel","normalM"].forEach(function(t){v[t]=x.getUniformLocation(v,t)}),["position"].forEach(function(t){d[t]=x.getAttribLocation(d,t)}),["target0","lightBuffer"].forEach(function(t){d[t]=x.getUniformLocation(d,t)}),["position","lightPosition"].forEach(function(t){y[t]=x.getAttribLocation(y,t)}),["target0","depthBuffer","inverseProjection","viewMatrix","lightPos"].forEach(function(t){y[t]=x.getUniformLocation(y,t)}),v.activate=function(t){x.useProgram(v),x.bindFramebuffer(x.FRAMEBUFFER,R),x.enable(x.DEPTH_TEST),x.clear(x.COLOR_BUFFER_BIT|x.DEPTH_BUFFER_BIT);var n=p.create(),e=c.create();p.mul(n,t.view,t.model),c.normalFromMat4(e,n),x.uniformMatrix4fv(v.projection,!1,P),x.uniformMatrix4fv(v.viewmodel,!1,n),x.uniformMatrix3fv(v.normalM,!1,e),x.enableVertexAttribArray(v.vertex),x.enableVertexAttribArray(v.normal),x.enableVertexAttribArray(v.uv),x.enableVertexAttribArray(v.extra),t.meshes.forEach(function(t){x.bindBuffer(x.ARRAY_BUFFER,t.vBuf),x.vertexAttribPointer(v.vertex,3,x.FLOAT,!1,0,0),x.bindBuffer(x.ARRAY_BUFFER,t.nBuf),x.vertexAttribPointer(v.normal,3,x.FLOAT,!1,0,0),x.bindBuffer(x.ARRAY_BUFFER,t.uBuf),x.vertexAttribPointer(v.uv,3,x.FLOAT,!1,0,0),x.bindBuffer(x.ARRAY_BUFFER,t.eBuf),x.vertexAttribPointer(v.extra,3,x.FLOAT,!1,0,0),x.drawArrays(x.TRIANGLES,0,t.count)}),x.bindBuffer(x.ARRAY_BUFFER,null)},v.deactivate=function(){x.bindFramebuffer(x.FRAMEBUFFER,null),x.disableVertexAttribArray(v.vertex),x.disableVertexAttribArray(v.normal),x.disableVertexAttribArray(v.uv),x.disableVertexAttribArray(v.extra),x.disable(x.DEPTH_TEST)},d.activate=function(t){x.useProgram(d),x.clear(x.COLOR_BUFFER_BIT),x.activeTexture(x.TEXTURE0),x.bindTexture(x.TEXTURE_2D,T),x.activeTexture(x.TEXTURE1),x.bindTexture(x.TEXTURE_2D,A),x.uniform1i(d.target0,0),x.uniform1i(d.lightBuffer,1),x.bindBuffer(x.ARRAY_BUFFER,_),x.vertexAttribPointer(d.position,2,x.FLOAT,!1,0,0),x.enableVertexAttribArray(d.position),x.drawArrays(x.TRIANGLES,0,6)},d.deactivate=function(){x.disableVertexAttribArray(d.position)},y.activate=function(t){x.useProgram(y),x.bindFramebuffer(x.FRAMEBUFFER,F),x.enable(x.BLEND),x.blendFunc(x.ONE,x.ONE),x.clear(x.COLOR_BUFFER_BIT),x.activeTexture(x.TEXTURE0),x.bindTexture(x.TEXTURE_2D,T),x.uniform1i(y.target0,0),x.uniform1i(y.depthBuffer,3),x.uniformMatrix4fv(y.viewMatrix,!1,t.view),x.uniformMatrix4fv(y.inverseProjection,!1,D),x.bindBuffer(x.ARRAY_BUFFER,_),x.vertexAttribPointer(y.position,2,x.FLOAT,!1,0,0),x.enableVertexAttribArray(y.position);for(var n=0,e=t.lights.length;e>n;n++)x.uniform3fv(y.lightPos,t.lights[n]),x.drawArrays(x.TRIANGLES,0,6)},y.deactivate=function(){x.bindFramebuffer(x.FRAMEBUFFER,null),x.disableVertexAttribArray(y.position),x.disable(x.BLEND)},n.exports={render:function(t){v.activate(t),v.deactivate(),y.activate(t),y.deactivate(),d.activate(t),d.deactivate()}}},{"./Context":1,"./generators/BuildingSHG.js":5,"./lib/glMatrixSubset":15,"./lib/util.js":16}],3:[function(t,n,e){var r=t("./../lib/ShapeGrammar"),i=t("../lib/SHAPE.js"),o=t("./../lib/Geom"),a=(t("./PRNG"),new r),s=new r;a.define("Balcony",null,function(){var t=this.points,n={sym:"BalconyFloor",points:[{x:t[0].x,y:t[0].y,z:t[0].z},{x:t[1].x,y:t[1].y,z:t[1].z},{x:t[2].x,y:t[2].y,z:t[2].z},{x:t[3].x,y:t[3].y,z:t[3].z}],extrudeBorders:this.floorHeight},e={sym:"BalconyFloor",points:[{x:t[0].x,y:t[0].y+this.floorHeight,z:t[0].z},{x:t[1].x,y:t[1].y+this.floorHeight,z:t[1].z},{x:t[2].x,y:t[2].y+this.floorHeight,z:t[2].z},{x:t[3].x,y:t[3].y+this.floorHeight,z:t[3].z}]},r=i.extrudeAll(n.points,this.floorHeight,"TQuad"),o=i.extrudeAll(e.points,this.fenceHeight,"Fence");return o.pop(),r.push.apply(r,o),r.push(n,e),r}),a.define("BalconyFloor",null,function(){var t=i.splitXZ(this,[.8,.15,.05],[.05,.45,.5],"TQuad"),n=t.splice(4,1).shift().points;if("extrudeBorders"in this){var e=i.extrudeAll([{x:n[0].x,y:n[0].y,z:n[0].z},{x:n[1].x,y:n[1].y,z:n[1].z},{x:n[2].x,y:n[2].y,z:n[2].z},{x:n[3].x,y:n[3].y,z:n[3].z}],this.extrudeBorders,"TQuad");t.push.apply(t,e)}return t}),a.define("Fence",null,function(){var t=i.fit("x",this,"StickBase",.25),n=this.points[0],e=this.points[1],r=(this.points[2],this.points[3]),o=r.x-n.x,a=(e.y-n.y,r.z-n.z),s=Math.atan2(a,o)-Math.PI/2,u=(Math.sqrt(o*o+a*a),.05*Math.cos(s)),h=.05*Math.sin(s),l={sym:"TQuad",points:[{x:n.x,y:e.y,z:n.z},{x:n.x+u,y:e.y,z:n.z+h},{x:r.x+u,y:e.y,z:r.z+h},{x:r.x,y:e.y,z:r.z}]},c={sym:"TQuad",points:[{x:n.x,y:e.y+.05,z:n.z},{x:n.x+u,y:e.y+.05,z:n.z+h},{x:r.x+u,y:e.y+.05,z:r.z+h},{x:r.x,y:e.y+.05,z:r.z}]};t.push(l),t.push(c);var p=l.points;return t.push.apply(t,i.extrudeAll([{x:p[0].x,y:p[0].y,z:p[0].z},{x:p[1].x,y:p[1].y,z:p[1].z},{x:p[2].x,y:p[2].y,z:p[2].z},{x:p[3].x,y:p[3].y,z:p[3].z}],.05,"TQuad")),t}),a.define("StickBase",null,function(){var t=i.split(this,[.45,.1,.45],[1],null),n=t[1],e=n.points,r=e[3].x-e[0].x,o=e[1].y-e[0].y,a=e[3].z-e[0].z,s=Math.atan2(a,r)-Math.PI/2,u=Math.sqrt(r*r+a*a),h=Math.abs(o),l=Math.cos(s)*u,c=Math.sin(s)*u;return{sym:"Stick",points:[{x:e[0].x,y:e[0].y,z:e[0].z},{x:e[0].x+l,y:e[0].y,z:e[0].z+c},{x:e[3].x+l,y:e[0].y,z:e[3].z+c},{x:e[3].x,y:e[0].y,z:e[3].z}],stickHeight:h}}),a.define("Stick",null,function(){var t=this.points;return i.extrudeAll([{x:t[0].x,y:t[0].y,z:t[0].z},{x:t[1].x,y:t[1].y,z:t[1].z},{x:t[2].x,y:t[2].y,z:t[2].z},{x:t[3].x,y:t[3].y,z:t[3].z}],this.stickHeight,"TQuad")}),a.define("TQuad",null,function(){var t,n=[],e=[],i=[];this.uvs=this.uvs||[{s:0,t:1},{s:0,t:0},{s:1,t:0},{s:1,t:1}];var a=this.points[0],s=this.points[1],u=this.points[2],h=this.points[3];n=[a.x,a.y,a.z,s.x,s.y,s.z,u.x,u.y,u.z,a.x,a.y,a.z,u.x,u.y,u.z,h.x,h.y,h.z],i=[0,1,2,0,2,3].reduce(function(t,n){return t.push(this.uvs[n].s,this.uvs[n].t,this.texID||0),t}.bind(this),[]),t=o.triToNormal(n);for(var l=0;6>l;l++)e.push.apply(e,t);return{sym:r.TERMINAL,vertices:n,normals:e,uvs:i}}),s.define("Staircase",null,function(){for(var t=this.stairHeight+this.stairSpace,n=this.height/t,e=this.width/n,r=[],i=0;n>=i;i++)r.push({sym:"Stair",x:this.x+e*i,y:this.y+t*i,z:this.z,height:this.stairHeight,width:e,depth:this.stairDepth});return r.push({sym:"TQuad",points:[{x:this.x-e/2,y:this.y,z:this.z-this.stairDepth/2},{x:this.x-e/2+this.width,y:this.y+this.height,z:this.z-this.stairDepth/2},{x:this.x+e/2+this.width,y:this.y+this.height,z:this.z-this.stairDepth/2},{x:this.x+e/2,y:this.y,z:this.z-this.stairDepth/2}]},{sym:"TQuad",points:[{x:this.x-e/2,y:this.y,z:this.z+this.stairDepth/2},{x:this.x-e/2+this.width,y:this.y+this.height,z:this.z+this.stairDepth/2},{x:this.x+e/2+this.width,y:this.y+this.height,z:this.z+this.stairDepth/2},{x:this.x+e/2,y:this.y,z:this.z+this.stairDepth/2}]}),r}),s.define("Stair",null,function(){var t=this.width/2,n=this.height/2,e=this.depth/2,r=[{sym:"TQuad",points:[{x:this.x-t,y:this.y-n,z:this.z-e},{x:this.x-t,y:this.y-n,z:this.z+e},{x:this.x+t,y:this.y-n,z:this.z+e},{x:this.x+t,y:this.y-n,z:this.z-e}]},{sym:"TQuad",points:[{x:this.x-t,y:this.y+n,z:this.z-e},{x:this.x-t,y:this.y+n,z:this.z+e},{x:this.x+t,y:this.y+n,z:this.z+e},{x:this.x+t,y:this.y+n,z:this.z-e}]}];return r.push.apply(r,i.extrudeAll(r[0].points,this.height,"TQuad")),r}),s.define("TQuad",null,function(){var t,n=[],e=[],i=[];this.uvs=this.uvs||[{s:0,t:1},{s:0,t:0},{s:1,t:0},{s:1,t:1}];var a=this.points[0],s=this.points[1],u=this.points[2],h=this.points[3];n=[a.x,a.y,a.z,s.x,s.y,s.z,u.x,u.y,u.z,a.x,a.y,a.z,u.x,u.y,u.z,h.x,h.y,h.z],i=[0,1,2,0,2,3].reduce(function(t,n){return t.push(this.uvs[n].s,this.uvs[n].t,this.texID||0),t}.bind(this),[]),t=o.triToNormal(n);for(var l=0;6>l;l++)e.push.apply(e,t);return{sym:r.TERMINAL,vertices:n,normals:e,uvs:i}});var u,h;u=a.run({sym:"Balcony",points:[{x:-.5,y:0,z:0},{x:-.5,y:0,z:1},{x:.5,y:0,z:1},{x:.5,y:0,z:0}],floorHeight:.025,fenceHeight:.4}).reduce(function(t,n){for(var e=0,r=n.vertices.length;r>e;e++)t.vertices.push(n.vertices[e]),t.normals.push(n.normals[e]),t.uvs.push(n.uvs[e]);return t},{vertices:[],normals:[],uvs:[]}),h=s.run({sym:"Staircase",x:-0.2375,y:.0125,z:.35,height:1,width:.7,stairDepth:.2,stairHeight:.025,stairSpace:.0625}).reduce(function(t,n){for(var e=0,r=n.vertices.length;r>e;e++)t.vertices.push(n.vertices[e]),t.normals.push(n.normals[e]),t.uvs.push(n.uvs[e]);return t},{vertices:u.vertices.slice(),normals:u.normals.slice(),uvs:u.uvs.slice()});var l=function(t){var n=t.vertices,e=t.normals,r=t.uvs;return function(t){for(var i=t.angle,o=Math.cos(i),a=Math.sin(i),s=t.x1-t.x0,u=t.z1-t.z0,h=t.x0+s/2,l=t.z0+u/2,c=t.y,p=t.width,f=t.height,x=t.depth,v=n.length,d=new Float32Array(v),y=new Float32Array(v),m=new Float32Array(r),g=0;v>g;g+=3){var E=n[g]*p,b=n[g+1]*f+c,z=n[g+2]*x;d[g]=E*o+z*a+h,d[g+1]=b,d[g+2]=-E*a+z*o+l,E=e[g],b=e[g+1],z=e[g+2],E=E*o+z*a+h,z=-E*a+z*o+l,y[g]=E,y[g+1]=b,y[g+2]=z}return{vertices:d,normals:y,uvs:m}}};n.exports={createBalcony:l(u),createBalconyWithStairs:l(h)}},{"../lib/SHAPE.js":13,"./../lib/Geom":9,"./../lib/ShapeGrammar":14,"./PRNG":7}],4:[function(t,n,e){var r=t("./PRNG"),i=t("./../lib/Geom"),o=(t("./../lib/ShapeGrammar"),function(t,n,e){return(1-e)*t+e*n}),a=function(t,n,e){var r,a,u,h,l,c,p,f,x,v,d,y,m,g=[],E=[],b=[],z=[];for(f=0,d=t.length;d>f;f++)for(r=(f+1)%d,a=(f+2)%d,u=(f-1+d)%d,h=i.lineIntersection(t[f],t[r],n[u],n[f]),l=i.lineIntersection(t[f],t[r],n[r],n[a]),c=h.x-l.x,p=h.y-l.y,m=Math.sqrt(c*c+p*p),ang=Math.atan2(p,c),v=~~(3*e.random()+2),E.push(v),b.push(ang),x=0;v>x;x++){var M=x/(v-1);px1=o(h.x,l.x,M),py1=o(h.y,l.y,M),px2=o(n[f].x,n[r].x,M),py2=o(n[f].y,n[r].y,M),g.push({x:o(h.x,l.x,M),y:o(h.y,l.y,M)},{x:o(n[f].x,n[r].x,M),y:o(n[f].y,n[r].y,M)})}for(g.push(g[0]),f=0,d=t.length;d>f;f++){for(y=[],x=0;x<E[f];x++)y.push(g.shift()),y.push(g.shift());y.push(t[(f+1)%d]),y.push(g[0]||t[0]);for(var T=0,v=y.length;v-2>T;T+=2)z.push(new s([y[T],y[(T+1)%v],y[(T+3)%v],y[(T+2)%v]],e.random()+.5,b[f]))}return z},s=function(t,n,e){this.poly=t,this.height=n,this.angle=e},u=function(t,n){var e=new r(n);this.poly=t,this.block=i.insetPolygon(this.poly,.05),this.lots=a(i.insetPolygon(this.block,.1),i.insetPolygon(this.block,.8),e);var o=t.reduce(function(t,n){return t.cx+=n.x,t.cy+=n.y,t.xm>n.x&&(t.xm=n.x),t.xM<n.x&&(t.xM=n.x),t.ym>n.y&&(t.ym=n.y),t.yM<n.y&&(t.yM=n.y),t},{xm:Number.POSITIVE_INFINITY,ym:Number.POSITIVE_INFINITY,xM:Number.NEGATIVE_INFINITY,yM:Number.NEGATIVE_INFINITY,cx:0,cy:0});this.x=o.cx/t.length,this.y=o.cy/t.length,this.w=Math.max(Math.abs(o.xM-o.xm),Math.abs(o.yM-o.ym))};n.exports=u},{"./../lib/Geom":9,"./../lib/ShapeGrammar":14,"./PRNG":7}],5:[function(t,n,e){var r=t("./../lib/ShapeGrammar"),i=t("../lib/SHAPE.js"),o=t("earcut"),a=t("./../lib/Geom"),s=t("./PRNG"),u=t("./BalconySHG.js"),h=new r,l=new s(31337),c=new s(31338),p=new s(31339),f=new s(31337);h.define("Building",null,function(){for(var t=[],n=0,e=0,r=this.floorsLayout.length;r>e;e++){var i=this.floorsLayout[e],o={sym:i.type,height:i.height,params:i,points:this.points.map(function(t){return{x:t.x,y:t.y+n,z:t.z}})};"frontFacade"in this&&(o.frontFacade=this.frontFacade),"hasBalcony"in this&&(o.hasBalcony=this.hasBalcony),n+=i.height,t.push(o)}return t}),h.define("FL_GndFloor",null,function(){2*Math.PI;return function(){{var t=i.extrudeAll(this.points,this.height,"Facade",[0,1,0]);this.params.frontSide}switch(this.params.tiles){case"OneDoor":for(var n=0,e=t.length;e>n;n++)t[n].type="Windows";t[this.frontFacade].type="OneDoor"}return t}}()),h.define("FL_Floor",null,function(){for(var t=i.extrudeAll(this.points,this.height,"Facade",[0,1,0]),n=0,e=t.length;e>n;n++)t[n].type="Windows",t[n].windows=this.params.windows;return"hasBalcony"in this&&(t[this.frontFacade].hasBalcony=this.hasBalcony),t}),h.define("FL_Ledge",null,function(){for(var t=[],n=this.height,e=this.points[0].y,r=0,o=this.points.length;o>r;r++){var s=this.points[r],u=this.points[(r+1)%o],l=Math.atan2(u.z-s.z,u.x-s.x),c=l-Math.PI/2;Math.cos(l)+Math.cos(c),Math.sin(l)+Math.sin(c)}t=a.insetPolygon(this.points.map(function(t){return{x:t.x,y:t.z}}),this.params.width).map(function(t){return{x:t.x,y:e,z:t.y}});var p=i.extrudeAll(t,this.height,"Quad",[0,1,0]);return p.forEach(function(t){var e=t.points[3].x-t.points[0].x,r=t.points[1].y-t.points[0].y,i=t.points[3].z-t.points[0].z,o=n/h.UVSCALE,a=o*Math.sqrt(e*e+i*i)/r;t.uvs=[{s:0,t:o},{s:0,t:0},{s:a,t:0},{s:a,t:o}],t.texID=6}),p.push({sym:"Poly",texID:6,points:t}),p.push({sym:"Poly",texID:6,points:t.map(function(t){return{x:t.x,y:t.y+n,z:t.z}})}),p}),h.define("FL_Rooftop",null,function(){for(var t=[],n=this.height,e=this.points[0].y,r=0,o=this.points.length;o>r;r++){var s=this.points[r],u=this.points[(r+1)%o],l=Math.atan2(u.z-s.z,u.x-s.x),c=l-Math.PI/2;Math.cos(l)+Math.cos(c),Math.sin(l)+Math.sin(c)}t=a.insetPolygon(this.points.map(function(t){return{x:t.x,
y:t.z}}),-this.params.width).map(function(t){return{x:t.x,y:e,z:t.y}});for(var p=i.extrudeAll(this.points,this.height,"Quad",[0,1,0]),f=i.extrudeAll(t,this.height,"Quad",[0,1,0]);p.length;)f.push(p.shift());f.forEach(function(t){var e=t.points[3].x-t.points[0].x,r=t.points[1].y-t.points[0].y,i=t.points[3].z-t.points[0].z,o=n/h.UVSCALE,a=o*Math.sqrt(e*e+i*i)/r;t.uvs=[{s:0,t:o},{s:0,t:0},{s:a,t:0},{s:a,t:o}],t.texID=6}),f.push({sym:"Poly",points:t,texID:3});for(var r=0,o=t.length;o>r;r++){var x=(r+1)%o,s=this.points[r],u=t[r],v=t[x],d=this.points[x],y={sym:"Poly",points:[s,u,v,s,v,d].map(function(t){return{x:t.x,y:t.y+n,z:t.z}}),texID:6};f.push(y)}return f}),h.define("Facade",function(){return"OneDoor"===this.type},function(){var t=this.points[3].x-this.points[0].x,n=this.points[1].y-this.points[0].y,e=this.points[3].z-this.points[0].z,r=n/h.UVSCALE,o=r*Math.sqrt(t*t+e*e)/n;this.uvs=[{s:0,t:r},{s:0,t:0},{s:o,t:0},{s:o,t:r}];var a=i.fit("x",this,"Window",1);a[~~(a.length/2)].sym="Door";for(var s=0,u=a.length;u>s;s++)a[s].normal=this.normal;return a}),h.define("Facade",null,function(){var t=this.points[3].x-this.points[0].x,n=this.points[1].y-this.points[0].y,e=this.points[3].z-this.points[0].z,o=Math.sqrt(t*t+e*e),a=n/h.UVSCALE,s=a*o/n,l=null;this.uvs=[{s:0,t:a},{s:0,t:0},{s:s,t:0},{s:s,t:a}];var c=i.fit("x",this,"Window",1);if(this.hasBalcony){var p=(c.length%2===0?2:3)/c.length,f={x0:this.points[0].x,z0:this.points[0].z,x1:this.points[3].x,z1:this.points[3].z,y:this.points[0].y,height:n,width:.9*o*p,depth:.4*o*p,angle:Math.atan2(-e,t)};l=u.createBalconyWithStairs(f),l.sym=r.TERMINAL}for(var x=0,v=c.length;v>x;x++)c[x].normal=this.normal;return null!==l&&c.push(l),c}),h.define("Window",null,function(){{var t=i.split(this,[.3,.4,.3],[1],"Quad"),n=i.split(t[1],[1],[.15,.7,.15],"Quad"),e=n[1];e.uvs}e.uvs=null,e.texID=l.random()>.3?4:5,t[0].texID=t[2].texID=n[0].texID=n[2].texID=6;var r=[t[0],t[2],n[0],n[2]],o=a.triToNormal([e.points[0].x,e.points[0].y,e.points[0].z,e.points[1].x,e.points[1].y,e.points[1].z,e.points[2].x,e.points[2].y,e.points[2].z]),s=i.extrudeAll(e.points,-.005,"Quad",o),u=o[0],h=o[1],c=o[2];u*=.005,h*=.005,c*=.005;for(var p=0,f=e.points.length;f>p;p++){var x=e.points[p];x.x-=u,x.y-=h,x.z-=c}for(var p=0,f=s.length;f>p;p++)s[p].texID=3,r.push(s[p]);return r.push(e),r}),h.define("Door",null,function(){{var t=i.split(this,[.15,.7,.15],[1],"Quad"),n=i.split(t[1],[1],[.7,.3],"Quad"),e=n[0];e.uvs}e.uvs=null,e.texID=l.random()>.3?4:5,t[0].texID=t[2].texID=n[1].texID=6;var r=[t[0],t[2],n[1]],o=a.triToNormal([e.points[0].x,e.points[0].y,e.points[0].z,e.points[1].x,e.points[1].y,e.points[1].z,e.points[2].x,e.points[2].y,e.points[2].z]),s=i.extrudeAll(e.points,-.005,"Quad",o),u=o[0],h=o[1],c=o[2];u*=.005,h*=.005,c*=.005;for(var p=0,f=e.points.length;f>p;p++){var x=e.points[p];x.x-=u,x.y-=h,x.z-=c}for(var p=0,f=s.length;f>p;p++)s[p].texID=3,r.push(s[p]);return r.push(e),r}),h.define("Quad",null,function(){var t=[{s:0,t:1},{s:0,t:0},{s:1,t:0},{s:1,t:1}];return function(){var n,e,i,o,s,u,h,l,c,p,f,x,v=[],d=this.points;c=d[0],p=d[1],f=d[2],x=d[3],n=[c.x,c.y,c.z,p.x,p.y,p.z,f.x,f.y,f.z,c.x,c.y,c.z,f.x,f.y,f.z,x.x,x.y,x.z],i=this.normal||a.triToNormal(n);for(var y=0;6>y;y++)v.push(i[0],i[1],i[2]);return e=this.uvs||t,s=e[0],u=e[1],h=e[2],l=e[3],o=this.texID||0,e=[s.s,s.t,o,u.s,u.t,o,h.s,h.t,o,s.s,s.t,o,h.s,h.t,o,l.s,l.t,o],{sym:r.TERMINAL,vertices:n,normals:v,uvs:e}}}()),h.define("Poly",null,function(){var t,n,e,i,s,u,h,l=this.points.map(function(t){return[t.x,t.z]}),c=this.points[0].y,p=o([l]),f=p.reduce(function(t,n){return t.push(n[0],c,n[1]),t},[]),x=this.normal||a.triToNormal(f),v=[],d=[];t=n=Number.POSITIVE_INFINITY,e=i=Number.NEGATIVE_INFINITY;for(var y=0,m=this.points.length;m>y;y++)h=this.points[y],t>h.x&&(t=h.x),e<h.x&&(e=h.x),n>h.z&&(n=h.z),i<h.z&&(i=h.z);s=e-t,u=i-n;for(var y=0,m=f.length;m>y;y+=3){var g=f[y],E=f[y+2];d.push((g-t)/s,(E-n)/u,this.texID),v.push(x[0],x[1],x[2])}return{sym:r.TERMINAL,vertices:f,normals:v,uvs:d}});var x=[[.9,.65,.48],[.75,.73,.69],[.82,.67,.42],[.6,.39,.33]];h.UVSCALE=.1,n.exports={shg:h,create:function(t){var n=t.width/2,e=t.depth/2,r=t.x-n,i=t.x+n,o=t.y-e,a=t.y+e,s=Math.max(n/e,e/n),u=null,l=!1,v=[];if(1.3>s&&c.random()<.3)for(var d=0;8>d;d++){var y=-t.angle-d*Math.PI/4;v.push({x:t.x+n*Math.cos(y),y:0,z:t.y+e*Math.sin(y)}),u=0}else if(s>1.5&&c.random()<.8){l=!0;var m=2/2.7;n>e?t.angle<.1?(v.push({x:r,y:0,z:o},{x:r,y:0,z:a},{x:r+n*m,y:0,z:a},{x:r+n*m,y:0,z:a-e*m},{x:i-n*m,y:0,z:a-e*m},{x:i-n*m,y:0,z:a},{x:i,y:0,z:a},{x:i,y:0,z:o}),u=3):(v.push({x:r,y:0,z:o},{x:r,y:0,z:a},{x:i,y:0,z:a},{x:i,y:0,z:o},{x:i-n*m,y:0,z:o},{x:i-n*m,y:0,z:o+e*m},{x:r+n*m,y:0,z:o+e*m},{x:r+n*m,y:0,z:o}),u=5):t.angle>0?(v.push({x:r,y:0,z:o},{x:r,y:0,z:o+e*m},{x:r+n*m,y:0,z:o+e*m},{x:r+n*m,y:0,z:a-e*m},{x:r,y:0,z:a-e*m},{x:r,y:0,z:a},{x:i,y:0,z:a},{x:i,y:0,z:o}),u=2):(v.push({x:r,y:0,z:o},{x:r,y:0,z:a},{x:i,y:0,z:a},{x:i,y:0,z:a-e*m},{x:i-n*m,y:0,z:a-e*m},{x:i-n*m,y:0,z:o+e*m},{x:i,y:0,z:o+e*m},{x:i,y:0,z:o}),u=4)}else v.push({x:r,y:0,z:o},{x:r,y:0,z:a},{x:i,y:0,z:a},{x:i,y:0,z:o}),u=n>e?t.angle<.1?1:3:t.angle<0?2:0;var g=[],E=~~(2*p.random());switch(E){case 0:g.push({type:"FL_GndFloor",height:.05,tiles:"OneDoor",frontSide:t.angle},{type:"FL_Ledge",height:.00625,width:.00625});for(var d=0,b=4+~~(20*f.random());b>d;d++)g.push({type:"FL_Floor",height:.05,windows:"Double"});g.push({type:"FL_Ledge",height:.00625,width:.00625},{type:"FL_Floor",height:.0625,windows:"Single"},{type:"FL_Rooftop",height:.00625,width:.00625});break;case 1:g.push({type:"FL_GndFloor",height:.05,tiles:"OneDoor",frontSide:t.angle});for(var d=0,b=4+~~(10*f.random());b>d;d++)g.push({type:"FL_Floor",height:.05,windows:"Double"});g.push({type:"FL_Floor",height:.0625,windows:"Single"},{type:"FL_Rooftop",height:.00625,width:.00625})}var z={sym:"Building",floorsLayout:g,points:v};null!==u&&(z.frontFacade=u),l&&(z.hasBalcony=!0);var M=x[~~(f.random()*x.length)],T=h.run(z);return{geom:T,color:M}},getGeom:function(){return context}}},{"../lib/SHAPE.js":13,"./../lib/Geom":9,"./../lib/ShapeGrammar":14,"./BalconySHG.js":3,"./PRNG":7,earcut:18}],6:[function(t,n,e){var r=new(t("./PRNG")),i=t("./../lib/Geom"),o=t("./Roads.js"),a=t("./Block.js"),s=(t("../lib/ShapeGrammar.js"),function(){var t=2*Math.PI;return function(n,e,r,o){var a,u,h,l=Math.atan2(-e.y+n.y,e.x-n.x),c={th:Number.POSITIVE_INFINITY,vertex:null};"traversed"in n||(n.traversed=[]),"traversed"in e||(e.traversed=[]),n.traversed.push(e);for(var p=0;p<e.conns.length;p++)u=e.conns[p],u===n||-1!==e.traversed.indexOf(u)||o&&u!==o[0]&&-1!==o.indexOf(u)||(a=Math.atan2(-u.y+e.y,u.x-e.x)-l,a>Math.PI?a-=t:a<-Math.PI&&(a+=t),a<c.th&&(c.th=a,c.vertex=e.conns[p]));return null===c.vertex?null:(o&&o.push(e),o&&c.vertex===o[0]?(h=i.isOverlapping(o,r))?null:(e.traversed.push(o[0]),o):(o=s(e,c.vertex,r,o||[n,e]),null===o&&e.traversed.splice(e.traversed.indexOf(c.vertex),1),o||null))}}()),u=function(t){r.seed(t);var n=[];this.roads=o(),this.blocks=[];for(var e=0;e<this.roads.length;e++)for(var u=0;u<this.roads[e].conns.length;u++){"traversed"in this.roads[e]||(this.roads[e].traversed=[]);var h=s(this.roads[e],this.roads[e].conns[u],this.roads);null===h||i.isPolyIn(h,n)||(n.push(h),this.blocks.push(new a(h,65536*r.random())))}this.roads.forEach(function(t){t.traversed=[]});var l=[];this.roads.forEach(function(t){t.conns.forEach(function(n){-1===n.traversed.indexOf(t)&&(l.push([t,n]),t.traversed.push(n),n.traversed.push(t))})}),this.roadQuads=l};n.exports=u},{"../lib/ShapeGrammar.js":14,"./../lib/Geom":9,"./Block.js":4,"./PRNG":7,"./Roads.js":8}],7:[function(t,n,e){var r=t("mersennetwister"),i=function(t){void 0!==t?this.seed(t):this.mt=new r};i.prototype.seed=function(t){this.mt=new r(t)},i.prototype.random=function(){return this.mt.random()},n.exports=i},{mersennetwister:19}],8:[function(t,n,e){var r=t("./PRNG"),i=3,o=0,a=4;n.exports=function(t){for(var n=[],e=new r(t),s=0;i>s;s++)for(var u=0;i>u;u++){var h=n[s*i+u]={x:a*u+o*e.random(),y:a*s+o*e.random(),conns:[]};u>0&&(h.conns.push(n[s*i+u-1]),n[s*i+u-1].conns.push(h)),s>0&&(h.conns.push(n[(s-1)*i+u]),n[(s-1)*i+u].conns.push(h))}return n}},{"./PRNG":7}],9:[function(t,n,e){var r=t("./glMatrixSubset"),i=(r.vec3,{pnpoly:function(t,n,e){var r,i,o,a,s=t.length,u=!1;for(r=0,i=s-1;s>r;i=r++)o=t[r],a=t[i],o.y>e!=a.y>e&&n<(a.x-o.x)*(e-o.y)/(a.y-o.y)+o.x&&(u=!u);return u},isOverlapping:function(t,n){for(var e=n.length-1;e--;)if(i.pnpoly(t,n[e].x,n[e].y)&&-1===t.indexOf(n[e]))return!0;return!1},isPolyIn:function(t,n){for(var e=n.length-1;e>0;e--)if(i.isEqualPoly(t,n[e]))return!0;return!1},isEqualPoly:function(t,n){if(t.length!==n.length)return!1;for(var e=t.length-1;e--;)if(-1===n.indexOf(t[e]))return!1;return!0},insetPolygon:function(t,n){var e,r,o,a=[];r=t[t.length-1];for(var s=0;s<t.length-1;s++)e=r,r=t[s],o=t[s+1],a.push(i.insetCorner(e,r,o,n));return a.push(i.insetCorner(r,o,t[0],n)),a},insetCorner:function(t,n,e,r){var o,a,s,u,h=n.x-t.x,l=t.y-n.y,c=e.x-n.x,p=n.y-e.y,f=Math.sqrt(h*h+l*l),x=Math.sqrt(c*c+p*p),v={x:n.x,y:n.y},d={x:n.x,y:n.y};return 0==f||0==x?null:(o=l/f*r,s=h/f*r,a=p/x*r,u=c/x*r,v.x+=o,v.y+=s,d.x+=a,d.y+=u,v.x===d.x&&v.y===d.y?v:i.lineIntersection({x:t.x+o,y:t.y+s},v,d,{x:e.x+a,y:e.y+u}))},lineIntersection:function(t,n,e,r){var i,o,a,s,u,h={x:t.x,y:t.y},l={x:n.x,y:n.y},c={x:e.x,y:e.y},p={x:r.x,y:r.y};return l.x-=h.x,c.x-=h.x,p.x-=h.x,l.y-=h.y,c.y-=h.y,p.y-=h.y,i=Math.sqrt(l.x*l.x+l.y*l.y),o=l.x/i,a=l.y/i,s=c.x*o+c.y*a,c.y=-c.x*a+c.y*o,c.x=s,s=p.x*o+p.y*a,p.y=-p.x*a+p.y*o,p.x=s,c.y==p.y?null:(u=p.x+(c.x-p.x)*p.y/(p.y-c.y),{x:h.x+u*o,y:h.y+u*a})},triToNormal:function(t){var n=t[0]-t[3],e=t[1]-t[4],r=t[2]-t[5],i=t[6]-t[3],o=t[7]-t[4],a=t[8]-t[5],s=e*a-r*o,u=n*a-r*i,h=n*o-e*i,l=1/Math.sqrt(s*s+u*u+h*h);return s*=l,u*=l,h*=l,[s,u,h]}});n.exports=i},{"./glMatrixSubset":15}],10:[function(t,n,e){var r=t("./../Context"),o={},a=document.createElement("ul");a.style.position="absolute",a.style.top="7rem",a.style.left="1rem",a.style.color="#444",a.style.font='10px "Ubuntu Mono", monospace',a.style.lineHeight="1.5em",a.style.listStyleType="none",r.canvas.parentNode.appendChild(a),n.exports={progress:function(t,n){if(!(t in o)){var e=document.createElement("li");a.appendChild(e),o[t]={fns:[],li:e,value:0}}o[t].value=n,n>=1&&o[t].fns.forEach(function(t){t()})},subscribe:function(t,n){if(!(t in o)){var e=document.createElement("li");a.appendChild(e),o[t]={fns:[],li:e,value:0}}o[t].fns.push(n)},render:function(){for(i in o){for(var t=parseInt(100*o[i].value),n=""+t;n.length<4;)n="_"+n;n=n.replace(/_/g,"&nbsp;"),o[i].li.innerHTML="&nbsp;"+i+": "+n+"%&nbsp;\n";var e="linear-gradient(90deg, #0f0, #0f0 "+t+"%, #0b0 "+t+"%)";o[i].li.style.backgroundImage=e}}}},{"./../Context":1}],11:[function(t,n,e){var r=(t("./glMatrixSubset"),t("./../Context")),i=r.gl,o=function(t,n,e,r){this.vBuf=i.createBuffer(),this.nBuf=i.createBuffer(),this.uBuf=i.createBuffer(),this.eBuf=i.createBuffer(),this.count=t.length/3,i.bindBuffer(i.ARRAY_BUFFER,this.vBuf),i.bufferData(i.ARRAY_BUFFER,new Float32Array(t),i.STATIC_DRAW),i.bindBuffer(i.ARRAY_BUFFER,this.nBuf),i.bufferData(i.ARRAY_BUFFER,new Float32Array(n),i.STATIC_DRAW),i.bindBuffer(i.ARRAY_BUFFER,this.uBuf),i.bufferData(i.ARRAY_BUFFER,new Float32Array(e),i.STATIC_DRAW),i.bindBuffer(i.ARRAY_BUFFER,this.eBuf),i.bufferData(i.ARRAY_BUFFER,new Float32Array(r),i.STATIC_DRAW),i.bindBuffer(i.ARRAY_BUFFER,null)};n.exports=o},{"./../Context":1,"./glMatrixSubset":15}],12:[function(t,n,e){var r=function(t,n,e,r){this.nw=this.sw=this.ne=this.se=null,this.x=t,this.y=n,this.w=e,this.limit=r,this.points=[]};r.prototype.contains=function(t){return Math.abs(t.x-this.x)<this.w&&Math.abs(t.y-this.y)<this.w},r.prototype.insert=function(t){return this.contains(t)?this.points.length<this.limit?(this.points.push(t),!0):(null===this.nw&&this.subdivide(),this.nw.insert(t)||this.ne.insert(t)||this.sw.insert(t)||this.se.insert(t)):!1},r.prototype.subdivide=function(){var t=this.x,n=this.y,e=this.w/2;this.nw=new r(t-e,n-e,e,this.limit),this.sw=new r(t-e,n+e,e,this.limit),this.ne=new r(t+e,n-e,e,this.limit),this.se=new r(t+e,n+e,e,this.limit)},r.prototype.intersect=function(t,n,e){return Math.abs(this.x-t)<this.w+e&&Math.abs(this.y-n)<this.w+e},r.prototype.query=function(t,n,e){var r=[],o=[],a=this.points;if(!this.intersect(t,n,e))return r;for(var s=0,u=a.length;u>s;s++)i(a[s],t,n,e)&&r.push(a[s]);if(null===this.nw)return r;o=this.nw.query(t,n,e);for(var s=0,u=o.length;u>s;s++)r.push(o[s]);o=this.ne.query(t,n,e);for(var s=0,u=o.length;u>s;s++)r.push(o[s]);o=this.sw.query(t,n,e);for(var s=0,u=o.length;u>s;s++)r.push(o[s]);o=this.se.query(t,n,e);for(var s=0,u=o.length;u>s;s++)r.push(o[s]);return r};var i=function(t,n,e,r){return Math.abs(t.x-n)<r&&Math.abs(t.y-e)<r};n.exports=r},{}],13:[function(t,n,e){var r={extrude:function(t,n,e,r,i){var o=0,a=r,s=0;return void 0!==i&&(o=i[0]*r,a=i[1]*r,s=i[2]*r),{sym:t,points:[{x:n.x,y:n.y,z:n.z},{x:n.x+o,y:n.y+a,z:n.z+s},{x:e.x+o,y:e.y+a,z:e.z+s},{x:e.x,y:e.y,z:e.z}]}},extrudeAll:function(t,n,e,i){for(var o=[],a=0,s=t.length;s>a;++a){var u=t[a],h=t[(a+1)%s];o.push(r.extrude(e instanceof Array?e[a]:e,u,h,n,i))}return o},split:function(t,n,e,i){var o=[],a=0,s=i instanceof Array,u=t.points,h=t.uvs,l=u[0],c=u[1],p=u[2],f=u[3],x=l.x,v=(c.x,p.x,f.x),d=l.y,y=c.y,m=(p.y,f.y,l.z),g=(c.z,p.z,f.z),E=1,b=1,z=0,M=0;h instanceof Array&&(E=h[3].s-h[0].s,b=h[1].t-h[0].t,z=h[0].s,M=h[1].t);for(var T=0,w=0,A=e.length;A>w;++w){for(var R=0,F=T+e[w],_=0,S=n.length;S>_;++_){var P=R+n[_],D=r.lerp(x,v,R),I=r.lerp(x,v,P),L=r.lerp(d,y,T),B=r.lerp(d,y,F),N=r.lerp(m,g,R),C=r.lerp(m,g,P);o.push({sym:s?i[a++]:i,points:[{x:D,y:L,z:N},{x:D,y:B,z:N},{x:I,y:B,z:C},{x:I,y:L,z:C}],uvs:[{s:z+E*R,t:M+b*T},{s:z+E*R,t:M+b*F},{s:z+E*P,t:M+b*F},{s:z+E*P,t:M+b*T}]}),R=P}T=F}return o},splitXZ:function(t,n,e,i){for(var o=[],a=0,s=t.points,u=s[0],h=s[1],l=s[2],c=s[3],p=u.x,f=(h.x,l.x,c.x),x=u.y,v=h.y,d=(l.y,c.y,u.z),y=h.z,m=(l.z,c.z,0),g=0,E=e.length;E>g;++g){for(var b=0,z=0,M=n.length;M>z;++z){var T=r.lerp(p,f,b),w=r.lerp(p,f,b+n[z]),A=r.lerp(x,v,b),R=r.lerp(x,v,b+n[z]),F=r.lerp(d,y,m),_=r.lerp(d,y,m+e[g]);o.push({sym:i instanceof Array?i[a++]:i,points:[{x:T,y:A,z:F},{x:T,y:A,z:_},{x:w,y:R,z:_},{x:w,y:R,z:F}]}),b+=n[z]}m+=e[g]}return o},splitZX:function(t,n,e,i){for(var o=[],a=0,s=t.points,u=s[0],h=s[1],l=s[2],c=s[3],p=u.x,f=h.x,x=(l.x,c.x,u.y),v=h.y,d=(l.y,c.y,u.z),y=(h.z,l.z,c.z),m=0,g=0,E=e.length;E>g;++g){for(var b=0,z=0,M=n.length;M>z;++z){var T=r.lerp(p,f,b),w=r.lerp(p,f,b+n[z]),A=r.lerp(x,v,b),R=r.lerp(x,v,b+n[z]),F=r.lerp(d,y,m),_=r.lerp(d,y,m+e[g]);o.push({sym:i instanceof Array?i[a++]:i,points:[{x:T,y:A,z:F},{x:T,y:A,z:_},{x:w,y:R,z:_},{x:w,y:R,z:F}]}),b+=n[z]}m+=e[g]}return o},fit:function(t,n,e,i){i=i||1;var o=n.points,a=o[0],s=o[1],u=o[2],h=o[3],l=a.x,c=(s.x,u.x,h.x),p=a.y,f=s.y,x=(u.y,h.y,a.z),v=s.z,d=(u.z,h.z),y=c-l,m=f-p,g=d-x,E=v-x;if("x"===t){var b=m,z=i*b,M=Math.sqrt(y*y+g*g),T=Math.round(M/z),w=[];z=M/T,T=Math.max(1,Math.abs(T));for(var A=0;T>A;A++)w.push(1/T);return r.split(n,w,[1],e)}if("y"===t){var z=c-l,b=z/i,R=Math.sqrt(m*m+E*E),T=Math.round(R/b),w=[];b=R/T;for(var A=0;T>A;A++)w.push(1/T);return r.split(n,w,[1],e)}},lerp:function(t,n,e){return t*(1-e)+n*e}};n.exports=r},{}],14:[function(t,n,e){var r=(t("./Geom"),t("./SHAPE.js"),t("./glMatrixSubset")),i=(t("earcut"),r.vec3,r.mat4,function(){this.rules=[]});i.prototype.define=function(t,n,e){this.rules.push({lhs:t,cond:n,rhs:e})},i.prototype.run=function(t){var n=[],e=this.rules,r=0;for(t=t instanceof Array?t:[t];t.length;){var o=t.shift();if(o.sym===i.TERMINAL)n.push(o);else for(var a=0,s=e.length;s>a;a++){var u=e[a];if(o.sym===u.lhs&&(null===u.cond||u.cond.call(o))){var h=u.rhs.call(o);h=h instanceof Array?h:[h];for(var l=0,c=h.length;c>l;l++)n.push(h[l]),++r;break}}}return r>0?this.run(n):n},i.TERMINAL="TERMINAL",n.exports=i},{"./Geom":9,"./SHAPE.js":13,"./glMatrixSubset":15,earcut:18}],15:[function(t,n,e){var r=Float32Array,i={};i.create=function(){var t=new r(16);return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},i.clone=function(t){var n=new r(16);return n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[3],n[4]=t[4],n[5]=t[5],n[6]=t[6],n[7]=t[7],n[8]=t[8],n[9]=t[9],n[10]=t[10],n[11]=t[11],n[12]=t[12],n[13]=t[13],n[14]=t[14],n[15]=t[15],n},i.copy=function(t,n){return t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3],t[4]=n[4],t[5]=n[5],t[6]=n[6],t[7]=n[7],t[8]=n[8],t[9]=n[9],t[10]=n[10],t[11]=n[11],t[12]=n[12],t[13]=n[13],t[14]=n[14],t[15]=n[15],t},i.identity=function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},i.transpose=function(t,n){if(t===n){var e=n[1],r=n[2],i=n[3],o=n[6],a=n[7],s=n[11];t[1]=n[4],t[2]=n[8],t[3]=n[12],t[4]=e,t[6]=n[9],t[7]=n[13],t[8]=r,t[9]=o,t[11]=n[14],t[12]=i,t[13]=a,t[14]=s}else t[0]=n[0],t[1]=n[4],t[2]=n[8],t[3]=n[12],t[4]=n[1],t[5]=n[5],t[6]=n[9],t[7]=n[13],t[8]=n[2],t[9]=n[6],t[10]=n[10],t[11]=n[14],t[12]=n[3],t[13]=n[7],t[14]=n[11],t[15]=n[15];return t},i.invert=function(t,n){var e=n[0],r=n[1],i=n[2],o=n[3],a=n[4],s=n[5],u=n[6],h=n[7],l=n[8],c=n[9],p=n[10],f=n[11],x=n[12],v=n[13],d=n[14],y=n[15],m=e*s-r*a,g=e*u-i*a,E=e*h-o*a,b=r*u-i*s,z=r*h-o*s,M=i*h-o*u,T=l*v-c*x,w=l*d-p*x,A=l*y-f*x,R=c*d-p*v,F=c*y-f*v,_=p*y-f*d,S=m*_-g*F+E*R+b*A-z*w+M*T;return S?(S=1/S,t[0]=(s*_-u*F+h*R)*S,t[1]=(i*F-r*_-o*R)*S,t[2]=(v*M-d*z+y*b)*S,t[3]=(p*z-c*M-f*b)*S,t[4]=(u*A-a*_-h*w)*S,t[5]=(e*_-i*A+o*w)*S,t[6]=(d*E-x*M-y*g)*S,t[7]=(l*M-p*E+f*g)*S,t[8]=(a*F-s*A+h*T)*S,t[9]=(r*A-e*F-o*T)*S,t[10]=(x*z-v*E+y*m)*S,t[11]=(c*E-l*z-f*m)*S,t[12]=(s*w-a*R-u*T)*S,t[13]=(e*R-r*w+i*T)*S,t[14]=(v*g-x*b-d*m)*S,t[15]=(l*b-c*g+p*m)*S,t):null},i.adjoint=function(t,n){var e=n[0],r=n[1],i=n[2],o=n[3],a=n[4],s=n[5],u=n[6],h=n[7],l=n[8],c=n[9],p=n[10],f=n[11],x=n[12],v=n[13],d=n[14],y=n[15];return t[0]=s*(p*y-f*d)-c*(u*y-h*d)+v*(u*f-h*p),t[1]=-(r*(p*y-f*d)-c*(i*y-o*d)+v*(i*f-o*p)),t[2]=r*(u*y-h*d)-s*(i*y-o*d)+v*(i*h-o*u),t[3]=-(r*(u*f-h*p)-s*(i*f-o*p)+c*(i*h-o*u)),t[4]=-(a*(p*y-f*d)-l*(u*y-h*d)+x*(u*f-h*p)),t[5]=e*(p*y-f*d)-l*(i*y-o*d)+x*(i*f-o*p),t[6]=-(e*(u*y-h*d)-a*(i*y-o*d)+x*(i*h-o*u)),t[7]=e*(u*f-h*p)-a*(i*f-o*p)+l*(i*h-o*u),t[8]=a*(c*y-f*v)-l*(s*y-h*v)+x*(s*f-h*c),t[9]=-(e*(c*y-f*v)-l*(r*y-o*v)+x*(r*f-o*c)),t[10]=e*(s*y-h*v)-a*(r*y-o*v)+x*(r*h-o*s),t[11]=-(e*(s*f-h*c)-a*(r*f-o*c)+l*(r*h-o*s)),t[12]=-(a*(c*d-p*v)-l*(s*d-u*v)+x*(s*p-u*c)),t[13]=e*(c*d-p*v)-l*(r*d-i*v)+x*(r*p-i*c),t[14]=-(e*(s*d-u*v)-a*(r*d-i*v)+x*(r*u-i*s)),t[15]=e*(s*p-u*c)-a*(r*p-i*c)+l*(r*u-i*s),t},i.determinant=function(t){var n=t[0],e=t[1],r=t[2],i=t[3],o=t[4],a=t[5],s=t[6],u=t[7],h=t[8],l=t[9],c=t[10],p=t[11],f=t[12],x=t[13],v=t[14],d=t[15],y=n*a-e*o,m=n*s-r*o,g=n*u-i*o,E=e*s-r*a,b=e*u-i*a,z=r*u-i*s,M=h*x-l*f,T=h*v-c*f,w=h*d-p*f,A=l*v-c*x,R=l*d-p*x,F=c*d-p*v;return y*F-m*R+g*A+E*w-b*T+z*M},i.multiply=function(t,n,e){var r=n[0],i=n[1],o=n[2],a=n[3],s=n[4],u=n[5],h=n[6],l=n[7],c=n[8],p=n[9],f=n[10],x=n[11],v=n[12],d=n[13],y=n[14],m=n[15],g=e[0],E=e[1],b=e[2],z=e[3];return t[0]=g*r+E*s+b*c+z*v,t[1]=g*i+E*u+b*p+z*d,t[2]=g*o+E*h+b*f+z*y,t[3]=g*a+E*l+b*x+z*m,g=e[4],E=e[5],b=e[6],z=e[7],t[4]=g*r+E*s+b*c+z*v,t[5]=g*i+E*u+b*p+z*d,t[6]=g*o+E*h+b*f+z*y,t[7]=g*a+E*l+b*x+z*m,g=e[8],E=e[9],b=e[10],z=e[11],t[8]=g*r+E*s+b*c+z*v,t[9]=g*i+E*u+b*p+z*d,t[10]=g*o+E*h+b*f+z*y,t[11]=g*a+E*l+b*x+z*m,g=e[12],E=e[13],b=e[14],z=e[15],t[12]=g*r+E*s+b*c+z*v,t[13]=g*i+E*u+b*p+z*d,t[14]=g*o+E*h+b*f+z*y,t[15]=g*a+E*l+b*x+z*m,t},i.mul=i.multiply,i.translate=function(t,n,e){var r,i,o,a,s,u,h,l,c,p,f,x,v=e[0],d=e[1],y=e[2];return n===t?(t[12]=n[0]*v+n[4]*d+n[8]*y+n[12],t[13]=n[1]*v+n[5]*d+n[9]*y+n[13],t[14]=n[2]*v+n[6]*d+n[10]*y+n[14],t[15]=n[3]*v+n[7]*d+n[11]*y+n[15]):(r=n[0],i=n[1],o=n[2],a=n[3],s=n[4],u=n[5],h=n[6],l=n[7],c=n[8],p=n[9],f=n[10],x=n[11],t[0]=r,t[1]=i,t[2]=o,t[3]=a,t[4]=s,t[5]=u,t[6]=h,t[7]=l,t[8]=c,t[9]=p,t[10]=f,t[11]=x,t[12]=r*v+s*d+c*y+n[12],t[13]=i*v+u*d+p*y+n[13],t[14]=o*v+h*d+f*y+n[14],t[15]=a*v+l*d+x*y+n[15]),t},i.scale=function(t,n,e){var r=e[0],i=e[1],o=e[2];return t[0]=n[0]*r,t[1]=n[1]*r,t[2]=n[2]*r,t[3]=n[3]*r,t[4]=n[4]*i,t[5]=n[5]*i,t[6]=n[6]*i,t[7]=n[7]*i,t[8]=n[8]*o,t[9]=n[9]*o,t[10]=n[10]*o,t[11]=n[11]*o,t[12]=n[12],t[13]=n[13],t[14]=n[14],t[15]=n[15],t},i.rotate=function(t,n,e,r){var i,o,a,s,u,h,l,c,p,f,x,v,d,y,m,g,E,b,z,M,T,w,A,R,F=r[0],_=r[1],S=r[2],P=Math.sqrt(F*F+_*_+S*S);return Math.abs(P)<GLMAT_EPSILON?null:(P=1/P,F*=P,_*=P,S*=P,i=Math.sin(e),o=Math.cos(e),a=1-o,s=n[0],u=n[1],h=n[2],l=n[3],c=n[4],p=n[5],f=n[6],x=n[7],v=n[8],d=n[9],y=n[10],m=n[11],g=F*F*a+o,E=_*F*a+S*i,b=S*F*a-_*i,z=F*_*a-S*i,M=_*_*a+o,T=S*_*a+F*i,w=F*S*a+_*i,A=_*S*a-F*i,R=S*S*a+o,t[0]=s*g+c*E+v*b,t[1]=u*g+p*E+d*b,t[2]=h*g+f*E+y*b,t[3]=l*g+x*E+m*b,t[4]=s*z+c*M+v*T,t[5]=u*z+p*M+d*T,t[6]=h*z+f*M+y*T,t[7]=l*z+x*M+m*T,t[8]=s*w+c*A+v*R,t[9]=u*w+p*A+d*R,t[10]=h*w+f*A+y*R,t[11]=l*w+x*A+m*R,n!==t&&(t[12]=n[12],t[13]=n[13],t[14]=n[14],t[15]=n[15]),t)},i.rotateX=function(t,n,e){var r=Math.sin(e),i=Math.cos(e),o=n[4],a=n[5],s=n[6],u=n[7],h=n[8],l=n[9],c=n[10],p=n[11];return n!==t&&(t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3],t[12]=n[12],t[13]=n[13],t[14]=n[14],t[15]=n[15]),t[4]=o*i+h*r,t[5]=a*i+l*r,t[6]=s*i+c*r,t[7]=u*i+p*r,t[8]=h*i-o*r,t[9]=l*i-a*r,t[10]=c*i-s*r,t[11]=p*i-u*r,t},i.rotateY=function(t,n,e){var r=Math.sin(e),i=Math.cos(e),o=n[0],a=n[1],s=n[2],u=n[3],h=n[8],l=n[9],c=n[10],p=n[11];return n!==t&&(t[4]=n[4],t[5]=n[5],t[6]=n[6],t[7]=n[7],t[12]=n[12],t[13]=n[13],t[14]=n[14],t[15]=n[15]),t[0]=o*i-h*r,t[1]=a*i-l*r,t[2]=s*i-c*r,t[3]=u*i-p*r,t[8]=o*r+h*i,t[9]=a*r+l*i,t[10]=s*r+c*i,t[11]=u*r+p*i,t},i.rotateZ=function(t,n,e){var r=Math.sin(e),i=Math.cos(e),o=n[0],a=n[1],s=n[2],u=n[3],h=n[4],l=n[5],c=n[6],p=n[7];return n!==t&&(t[8]=n[8],t[9]=n[9],t[10]=n[10],t[11]=n[11],t[12]=n[12],t[13]=n[13],t[14]=n[14],t[15]=n[15]),t[0]=o*i+h*r,t[1]=a*i+l*r,t[2]=s*i+c*r,t[3]=u*i+p*r,t[4]=h*i-o*r,t[5]=l*i-a*r,t[6]=c*i-s*r,t[7]=p*i-u*r,t},i.fromRotationTranslation=function(t,n,e){var r=n[0],i=n[1],o=n[2],a=n[3],s=r+r,u=i+i,h=o+o,l=r*s,c=r*u,p=r*h,f=i*u,x=i*h,v=o*h,d=a*s,y=a*u,m=a*h;return t[0]=1-(f+v),t[1]=c+m,t[2]=p-y,t[3]=0,t[4]=c-m,t[5]=1-(l+v),t[6]=x+d,t[7]=0,t[8]=p+y,t[9]=x-d,t[10]=1-(l+f),t[11]=0,t[12]=e[0],t[13]=e[1],t[14]=e[2],t[15]=1,t},i.fromQuat=function(t,n){var e=n[0],r=n[1],i=n[2],o=n[3],a=e+e,s=r+r,u=i+i,h=e*a,l=r*a,c=r*s,p=i*a,f=i*s,x=i*u,v=o*a,d=o*s,y=o*u;return t[0]=1-c-x,t[1]=l+y,t[2]=p-d,t[3]=0,t[4]=l-y,t[5]=1-h-x,t[6]=f+v,t[7]=0,t[8]=p+d,t[9]=f-v,t[10]=1-h-c,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},i.frustum=function(t,n,e,r,i,o,a){var s=1/(e-n),u=1/(i-r),h=1/(o-a);return t[0]=2*o*s,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=2*o*u,t[6]=0,t[7]=0,t[8]=(e+n)*s,t[9]=(i+r)*u,t[10]=(a+o)*h,t[11]=-1,t[12]=0,t[13]=0,t[14]=a*o*2*h,t[15]=0,t},i.perspective=function(t,n,e,r,i){var o=1/Math.tan(n/2),a=1/(r-i);return t[0]=o/e,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=o,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=(i+r)*a,t[11]=-1,t[12]=0,t[13]=0,t[14]=2*i*r*a,t[15]=0,t},i.ortho=function(t,n,e,r,i,o,a){var s=1/(n-e),u=1/(r-i),h=1/(o-a);return t[0]=-2*s,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*u,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*h,t[11]=0,t[12]=(n+e)*s,t[13]=(i+r)*u,t[14]=(a+o)*h,t[15]=1,t},i.lookAt=function(t,n,e,r){var o,a,s,u,h,l,c,p,f,x,v=n[0],d=n[1],y=n[2],m=r[0],g=r[1],E=r[2],b=e[0],z=e[1],M=e[2];return Math.abs(v-b)<GLMAT_EPSILON&&Math.abs(d-z)<GLMAT_EPSILON&&Math.abs(y-M)<GLMAT_EPSILON?i.identity(t):(c=v-b,p=d-z,f=y-M,x=1/Math.sqrt(c*c+p*p+f*f),c*=x,p*=x,f*=x,o=g*f-E*p,a=E*c-m*f,s=m*p-g*c,x=Math.sqrt(o*o+a*a+s*s),x?(x=1/x,o*=x,a*=x,s*=x):(o=0,a=0,s=0),u=p*s-f*a,h=f*o-c*s,l=c*a-p*o,x=Math.sqrt(u*u+h*h+l*l),x?(x=1/x,u*=x,h*=x,l*=x):(u=0,h=0,l=0),t[0]=o,t[1]=u,t[2]=c,t[3]=0,t[4]=a,t[5]=h,t[6]=p,t[7]=0,t[8]=s,t[9]=l,t[10]=f,t[11]=0,t[12]=-(o*v+a*d+s*y),t[13]=-(u*v+h*d+l*y),t[14]=-(c*v+p*d+f*y),t[15]=1,t)},i.str=function(t){return"mat4("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+", "+t[9]+", "+t[10]+", "+t[11]+", "+t[12]+", "+t[13]+", "+t[14]+", "+t[15]+")"},i.frob=function(t){return Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2)+Math.pow(t[2],2)+Math.pow(t[3],2)+Math.pow(t[4],2)+Math.pow(t[5],2)+Math.pow(t[6],2)+Math.pow(t[6],2)+Math.pow(t[7],2)+Math.pow(t[8],2)+Math.pow(t[9],2)+Math.pow(t[10],2)+Math.pow(t[11],2)+Math.pow(t[12],2)+Math.pow(t[13],2)+Math.pow(t[14],2)+Math.pow(t[15],2))},"undefined"!=typeof e&&(e.mat4=i);var o={};o.create=function(){var t=new r(3);return t[0]=0,t[1]=0,t[2]=0,t},o.clone=function(t){var n=new r(3);return n[0]=t[0],n[1]=t[1],n[2]=t[2],n},o.fromValues=function(t,n,e){var i=new r(3);return i[0]=t,i[1]=n,i[2]=e,i},o.copy=function(t,n){return t[0]=n[0],t[1]=n[1],t[2]=n[2],t},o.set=function(t,n,e,r){return t[0]=n,t[1]=e,t[2]=r,t},o.add=function(t,n,e){return t[0]=n[0]+e[0],t[1]=n[1]+e[1],t[2]=n[2]+e[2],t},o.subtract=function(t,n,e){return t[0]=n[0]-e[0],t[1]=n[1]-e[1],t[2]=n[2]-e[2],t},o.sub=o.subtract,o.multiply=function(t,n,e){return t[0]=n[0]*e[0],t[1]=n[1]*e[1],t[2]=n[2]*e[2],t},o.mul=o.multiply,o.divide=function(t,n,e){return t[0]=n[0]/e[0],t[1]=n[1]/e[1],t[2]=n[2]/e[2],t},o.div=o.divide,o.min=function(t,n,e){return t[0]=Math.min(n[0],e[0]),t[1]=Math.min(n[1],e[1]),t[2]=Math.min(n[2],e[2]),t},o.max=function(t,n,e){return t[0]=Math.max(n[0],e[0]),t[1]=Math.max(n[1],e[1]),t[2]=Math.max(n[2],e[2]),t},o.scale=function(t,n,e){return t[0]=n[0]*e,t[1]=n[1]*e,t[2]=n[2]*e,t},o.scaleAndAdd=function(t,n,e,r){return t[0]=n[0]+e[0]*r,t[1]=n[1]+e[1]*r,t[2]=n[2]+e[2]*r,t},o.distance=function(t,n){var e=n[0]-t[0],r=n[1]-t[1],i=n[2]-t[2];return Math.sqrt(e*e+r*r+i*i)},o.dist=o.distance,o.squaredDistance=function(t,n){var e=n[0]-t[0],r=n[1]-t[1],i=n[2]-t[2];return e*e+r*r+i*i},o.sqrDist=o.squaredDistance,o.length=function(t){var n=t[0],e=t[1],r=t[2];return Math.sqrt(n*n+e*e+r*r)},o.len=o.length,o.squaredLength=function(t){var n=t[0],e=t[1],r=t[2];return n*n+e*e+r*r},o.sqrLen=o.squaredLength,o.negate=function(t,n){return t[0]=-n[0],t[1]=-n[1],t[2]=-n[2],t},o.normalize=function(t,n){var e=n[0],r=n[1],i=n[2],o=e*e+r*r+i*i;return o>0&&(o=1/Math.sqrt(o),t[0]=n[0]*o,t[1]=n[1]*o,t[2]=n[2]*o),t},o.dot=function(t,n){return t[0]*n[0]+t[1]*n[1]+t[2]*n[2]},o.cross=function(t,n,e){var r=n[0],i=n[1],o=n[2],a=e[0],s=e[1],u=e[2];return t[0]=i*u-o*s,t[1]=o*a-r*u,t[2]=r*s-i*a,t},o.lerp=function(t,n,e,r){var i=n[0],o=n[1],a=n[2];return t[0]=i+r*(e[0]-i),t[1]=o+r*(e[1]-o),t[2]=a+r*(e[2]-a),t},o.random=function(t,n){n=n||1;var e=2*GLMAT_RANDOM()*Math.PI,r=2*GLMAT_RANDOM()-1,i=Math.sqrt(1-r*r)*n;return t[0]=Math.cos(e)*i,t[1]=Math.sin(e)*i,t[2]=r*n,t},o.transformMat4=function(t,n,e){var r=n[0],i=n[1],o=n[2];return t[0]=e[0]*r+e[4]*i+e[8]*o+e[12],t[1]=e[1]*r+e[5]*i+e[9]*o+e[13],t[2]=e[2]*r+e[6]*i+e[10]*o+e[14],t},o.transformMat3=function(t,n,e){var r=n[0],i=n[1],o=n[2];return t[0]=r*e[0]+i*e[3]+o*e[6],t[1]=r*e[1]+i*e[4]+o*e[7],t[2]=r*e[2]+i*e[5]+o*e[8],t},o.transformQuat=function(t,n,e){var r=n[0],i=n[1],o=n[2],a=e[0],s=e[1],u=e[2],h=e[3],l=h*r+s*o-u*i,c=h*i+u*r-a*o,p=h*o+a*i-s*r,f=-a*r-s*i-u*o;return t[0]=l*h+f*-a+c*-u-p*-s,t[1]=c*h+f*-s+p*-a-l*-u,t[2]=p*h+f*-u+l*-s-c*-a,t},o.rotateX=function(t,n,e,r){var i=[],o=[];return i[0]=n[0]-e[0],i[1]=n[1]-e[1],i[2]=n[2]-e[2],o[0]=i[0],o[1]=i[1]*Math.cos(r)-i[2]*Math.sin(r),o[2]=i[1]*Math.sin(r)+i[2]*Math.cos(r),t[0]=o[0]+e[0],t[1]=o[1]+e[1],t[2]=o[2]+e[2],t},o.rotateY=function(t,n,e,r){var i=[],o=[];return i[0]=n[0]-e[0],i[1]=n[1]-e[1],i[2]=n[2]-e[2],o[0]=i[2]*Math.sin(r)+i[0]*Math.cos(r),o[1]=i[1],o[2]=i[2]*Math.cos(r)-i[0]*Math.sin(r),t[0]=o[0]+e[0],t[1]=o[1]+e[1],t[2]=o[2]+e[2],t},o.rotateZ=function(t,n,e,r){var i=[],o=[];return i[0]=n[0]-e[0],i[1]=n[1]-e[1],i[2]=n[2]-e[2],o[0]=i[0]*Math.cos(r)-i[1]*Math.sin(r),o[1]=i[0]*Math.sin(r)+i[1]*Math.cos(r),o[2]=i[2],t[0]=o[0]+e[0],t[1]=o[1]+e[1],t[2]=o[2]+e[2],t},o.forEach=function(){var t=o.create();return function(n,e,r,i,o,a){var s,u;for(e||(e=3),r||(r=0),u=i?Math.min(i*e+r,n.length):n.length,s=r;u>s;s+=e)t[0]=n[s],t[1]=n[s+1],t[2]=n[s+2],o(t,t,a),n[s]=t[0],n[s+1]=t[1],n[s+2]=t[2];return n}}(),o.str=function(t){return"vec3("+t[0]+", "+t[1]+", "+t[2]+")"},"undefined"!=typeof e&&(e.vec3=o);var a={};a.create=function(){var t=new r(9);return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t},a.fromMat4=function(t,n){return t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[4],t[4]=n[5],t[5]=n[6],t[6]=n[8],t[7]=n[9],t[8]=n[10],t},a.clone=function(t){var n=new r(9);return n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[3],n[4]=t[4],n[5]=t[5],n[6]=t[6],n[7]=t[7],n[8]=t[8],n},a.copy=function(t,n){return t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3],t[4]=n[4],t[5]=n[5],t[6]=n[6],t[7]=n[7],t[8]=n[8],t},a.identity=function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t},a.transpose=function(t,n){if(t===n){var e=n[1],r=n[2],i=n[5];t[1]=n[3],t[2]=n[6],t[3]=e,t[5]=n[7],t[6]=r,t[7]=i}else t[0]=n[0],t[1]=n[3],t[2]=n[6],t[3]=n[1],t[4]=n[4],t[5]=n[7],t[6]=n[2],t[7]=n[5],t[8]=n[8];return t},a.invert=function(t,n){var e=n[0],r=n[1],i=n[2],o=n[3],a=n[4],s=n[5],u=n[6],h=n[7],l=n[8],c=l*a-s*h,p=-l*o+s*u,f=h*o-a*u,x=e*c+r*p+i*f;return x?(x=1/x,t[0]=c*x,t[1]=(-l*r+i*h)*x,t[2]=(s*r-i*a)*x,t[3]=p*x,t[4]=(l*e-i*u)*x,t[5]=(-s*e+i*o)*x,t[6]=f*x,t[7]=(-h*e+r*u)*x,t[8]=(a*e-r*o)*x,t):null},a.adjoint=function(t,n){var e=n[0],r=n[1],i=n[2],o=n[3],a=n[4],s=n[5],u=n[6],h=n[7],l=n[8];return t[0]=a*l-s*h,t[1]=i*h-r*l,t[2]=r*s-i*a,t[3]=s*u-o*l,t[4]=e*l-i*u,t[5]=i*o-e*s,t[6]=o*h-a*u,t[7]=r*u-e*h,t[8]=e*a-r*o,t},a.determinant=function(t){var n=t[0],e=t[1],r=t[2],i=t[3],o=t[4],a=t[5],s=t[6],u=t[7],h=t[8];return n*(h*o-a*u)+e*(-h*i+a*s)+r*(u*i-o*s)},a.multiply=function(t,n,e){var r=n[0],i=n[1],o=n[2],a=n[3],s=n[4],u=n[5],h=n[6],l=n[7],c=n[8],p=e[0],f=e[1],x=e[2],v=e[3],d=e[4],y=e[5],m=e[6],g=e[7],E=e[8];return t[0]=p*r+f*a+x*h,t[1]=p*i+f*s+x*l,t[2]=p*o+f*u+x*c,t[3]=v*r+d*a+y*h,t[4]=v*i+d*s+y*l,t[5]=v*o+d*u+y*c,t[6]=m*r+g*a+E*h,t[7]=m*i+g*s+E*l,t[8]=m*o+g*u+E*c,t},a.mul=a.multiply,a.translate=function(t,n,e){var r=n[0],i=n[1],o=n[2],a=n[3],s=n[4],u=n[5],h=n[6],l=n[7],c=n[8],p=e[0],f=e[1];return t[0]=r,t[1]=i,t[2]=o,t[3]=a,t[4]=s,t[5]=u,t[6]=p*r+f*a+h,t[7]=p*i+f*s+l,t[8]=p*o+f*u+c,t},a.rotate=function(t,n,e){var r=n[0],i=n[1],o=n[2],a=n[3],s=n[4],u=n[5],h=n[6],l=n[7],c=n[8],p=Math.sin(e),f=Math.cos(e);return t[0]=f*r+p*a,t[1]=f*i+p*s,t[2]=f*o+p*u,t[3]=f*a-p*r,t[4]=f*s-p*i,t[5]=f*u-p*o,t[6]=h,t[7]=l,t[8]=c,t},a.scale=function(t,n,e){var r=e[0],i=e[1];return t[0]=r*n[0],t[1]=r*n[1],t[2]=r*n[2],t[3]=i*n[3],t[4]=i*n[4],t[5]=i*n[5],t[6]=n[6],t[7]=n[7],t[8]=n[8],t},a.fromMat2d=function(t,n){return t[0]=n[0],t[1]=n[1],t[2]=0,t[3]=n[2],t[4]=n[3],t[5]=0,t[6]=n[4],t[7]=n[5],t[8]=1,t},a.fromQuat=function(t,n){var e=n[0],r=n[1],i=n[2],o=n[3],a=e+e,s=r+r,u=i+i,h=e*a,l=r*a,c=r*s,p=i*a,f=i*s,x=i*u,v=o*a,d=o*s,y=o*u;return t[0]=1-c-x,t[3]=l-y,t[6]=p+d,t[1]=l+y,t[4]=1-h-x,t[7]=f-v,t[2]=p-d,t[5]=f+v,t[8]=1-h-c,t},a.normalFromMat4=function(t,n){var e=n[0],r=n[1],i=n[2],o=n[3],a=n[4],s=n[5],u=n[6],h=n[7],l=n[8],c=n[9],p=n[10],f=n[11],x=n[12],v=n[13],d=n[14],y=n[15],m=e*s-r*a,g=e*u-i*a,E=e*h-o*a,b=r*u-i*s,z=r*h-o*s,M=i*h-o*u,T=l*v-c*x,w=l*d-p*x,A=l*y-f*x,R=c*d-p*v,F=c*y-f*v,_=p*y-f*d,S=m*_-g*F+E*R+b*A-z*w+M*T;return S?(S=1/S,t[0]=(s*_-u*F+h*R)*S,t[1]=(u*A-a*_-h*w)*S,t[2]=(a*F-s*A+h*T)*S,t[3]=(i*F-r*_-o*R)*S,t[4]=(e*_-i*A+o*w)*S,t[5]=(r*A-e*F-o*T)*S,t[6]=(v*M-d*z+y*b)*S,t[7]=(d*E-x*M-y*g)*S,t[8]=(x*z-v*E+y*m)*S,t):null},a.str=function(t){return"mat3("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+")"},a.frob=function(t){return Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2)+Math.pow(t[2],2)+Math.pow(t[3],2)+Math.pow(t[4],2)+Math.pow(t[5],2)+Math.pow(t[6],2)+Math.pow(t[7],2)+Math.pow(t[8],2))},"undefined"!=typeof e&&(e.mat3=a),n.exports={mat4:i,mat3:a,vec3:o}},{}],16:[function(t,n,e){n.exports={hsl2rgb:function(t,n,e){var r,i,o,a,s,u;return isFinite(t)||(t=0),isFinite(n)||(n=0),isFinite(e)||(e=0),t/=60,0>t&&(t=6- -t%6),t%=6,n=Math.max(0,Math.min(1,n/100)),e=Math.max(0,Math.min(1,e/100)),s=(1-Math.abs(2*e-1))*n,u=s*(1-Math.abs(t%2-1)),1>t?(r=s,i=u,
o=0):2>t?(r=u,i=s,o=0):3>t?(r=0,i=s,o=u):4>t?(r=0,i=u,o=s):5>t?(r=u,i=0,o=s):(r=s,i=0,o=u),a=e-s/2,r=Math.round(255*(r+a)),i=Math.round(255*(i+a)),o=Math.round(255*(o+a)),{r:r,g:i,b:o}}}},{}],17:[function(t,n,e){function r(){0===f&&requestAnimationFrame(r),h.render()}function i(t){isNaN(i.t0)&&(i.t0=t),p.begin(),u.render(c),c.update(t-i.t0),p.end(),requestAnimationFrame(i)}var o=(t("./lib/glMatrixSubset"),t("./Context")),a=o.canvas,s=o.gl,u=t("./Renderer.js"),h=t("./lib/Loader"),l=(t("./generators/City.js"),t("stats-js")),c=t("./scenes/MainScene.js"),p=new l;p.setMode(0),p.domElement.style.position="absolute",p.domElement.style.right="1rem",p.domElement.style.top="1rem",a.parentNode.appendChild(p.domElement);var f=0,x=0/0;h.subscribe("Blocks",function(){console.log("Loading complete"),f=1,x=0/0,i()}),s.viewport(0,0,o.w,o.h),r()},{"./Context":1,"./Renderer.js":2,"./generators/City.js":6,"./lib/Loader":10,"./lib/glMatrixSubset":15,"./scenes/MainScene.js":21,"stats-js":20}],18:[function(t,n,e){"use strict";function r(t,n){var e=o(i(t[0],!0)),r=n?{vertices:[],indices:[]}:[];if(!e)return r;var s,u,h,l,p,f,x,v,d,y=80;for(d=0;y>=0&&d<t.length;d++)y-=t[d].length;if(0>y){s=e.next,u=l=s.p[0],h=p=s.p[1];do f=s.p[0],x=s.p[1],u>f&&(u=f),h>x&&(h=x),f>l&&(l=f),x>p&&(p=x),s=s.next;while(s!==e);v=Math.max(l-u,p-h)}return t.length>1&&(e=c(t,e)),a(e,r,u,h,v),r}function i(t,n){var e,r,i,o,a,s=0,u=t.length;for(e=0,r=u-1;u>e;r=e++)i=t[e],o=t[r],s+=(o[0]-i[0])*(i[1]+o[1]);if(n===s>0)for(e=0;u>e;e++)a=R(t[e],a);else for(e=u-1;e>=0;e--)a=R(t[e],a);return a}function o(t,n){n||(n=t);var e,r=t;do if(e=!1,E(r.p,r.next.p)||0===g(r.prev.p,r.p,r.next.p)){if(r.prev.next=r.next,r.next.prev=r.prev,r.prevZ&&(r.prevZ.nextZ=r.nextZ),r.nextZ&&(r.nextZ.prevZ=r.prevZ),r=n=r.prev,r===r.next)return null;e=!0}else r=r.next;while(e||r!==n);return n}function a(t,n,e,r,i,c){if(t){var p=void 0!==n.vertices;c||void 0===e||x(t,e,r,i);for(var f,v,d=t;t.prev!==t.next;)if(f=t.prev,v=t.next,u(t,e,r,i))p?(s(n,f),s(n,t),s(n,v)):(n.push(f.p),n.push(t.p),n.push(v.p)),v.prev=f,f.next=v,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ),t=v.next,d=v.next;else if(t=v,t===d){c?1===c?(t=h(t,n),a(t,n,e,r,i,2)):2===c&&l(t,n,e,r,i):a(o(t),n,e,r,i,1);break}}}function s(t,n){n.source&&(n=n.source);var e=n.index;if(null===e){var r=n.p.length,i=t.vertices;n.index=e=i.length/r;for(var o=0;r>o;o++)i.push(n.p[o])}t.indices.push(e)}function u(t,n,e,r){var i=t.prev.p,o=t.p,a=t.next.p,s=i[0],u=o[0],h=a[0],l=i[1],c=o[1],p=a[1],f=s*c-l*u,x=s*p-l*h,v=h*c-p*u,y=f-x-v;if(0>=y)return!1;var m,g,E,b,z,M,T,w=p-l,A=s-h,R=l-c,F=u-s;if(void 0!==n){var _=u>s?h>s?s:h:h>u?u:h,S=c>l?p>l?l:p:p>c?c:p,P=s>u?s>h?s:h:u>h?u:h,D=l>c?l>p?l:p:c>p?c:p,I=d(_,S,n,e,r),L=d(P,D,n,e,r);for(T=t.nextZ;T&&T.z<=L;)if(m=T.p,T=T.nextZ,m!==i&&m!==a&&(g=m[0],E=m[1],b=w*g+A*E-x,b>=0&&(z=R*g+F*E+f,z>=0&&(M=y-b-z,M>=0&&(b&&z||b&&M||z&&M)))))return!1;for(T=t.prevZ;T&&T.z>=I;)if(m=T.p,T=T.prevZ,m!==i&&m!==a&&(g=m[0],E=m[1],b=w*g+A*E-x,b>=0&&(z=R*g+F*E+f,z>=0&&(M=y-b-z,M>=0&&(b&&z||b&&M||z&&M)))))return!1}else for(T=t.next.next;T!==t.prev;)if(m=T.p,T=T.next,g=m[0],E=m[1],b=w*g+A*E-x,b>=0&&(z=R*g+F*E+f,z>=0&&(M=y-b-z,M>=0&&(b&&z||b&&M||z&&M))))return!1;return!0}function h(t,n){var e=!!n.vertices,r=t;do{var i=r.prev,o=r.next.next;if(i.p!==o.p&&b(i.p,r.p,r.next.p,o.p)&&M(i,o)&&M(o,i)){e?(s(n,i),s(n,r),s(n,o)):(n.push(i.p),n.push(r.p),n.push(o.p)),i.next=o,o.prev=i;var a=r.prevZ,u=r.nextZ&&r.nextZ.nextZ;a&&(a.nextZ=u),u&&(u.prevZ=a),r=t=o}r=r.next}while(r!==t);return r}function l(t,n,e,r,i){var s=t;do{for(var u=s.next.next;u!==s.prev;){if(s.p!==u.p&&m(s,u)){var h=A(s,u);return s=o(s,s.next),h=o(h,h.next),a(s,n,e,r,i),void a(h,n,e,r,i)}u=u.next}s=s.next}while(s!==t)}function c(t,n){for(var e=t.length,r=[],a=1;e>a;a++){var s=o(i(t[a],!1));s&&r.push(y(s))}for(r.sort(w),a=0;a<r.length;a++)p(r[a],n),n=o(n,n.next);return n}function p(t,n){if(n=f(t,n)){var e=A(n,t);o(e,e.next)}}function f(t,n){var e,r,i,o=n,a=t.p,s=a[0],u=a[1],h=-(1/0);do{if(r=o.p,i=o.next.p,u<=r[1]&&u>=i[1]){var l=r[0]+(u-r[1])*(i[0]-r[0])/(i[1]-r[1]);s>=l&&l>h&&(h=l,e=r[0]<i[0]?o:o.next)}o=o.next}while(o!==n);if(!e)return null;var c,p,f,x,v,d,y=e.p[0],m=e.p[1],g=s*m-u*y,E=s*u-u*h,b=u-u,z=s-h,T=u-m,w=y-s,A=g-E-(h*m-u*y),R=0>=A?-1:1,F=e,_=1/0;for(o=e.next;o!==F;)c=o.p[0],p=o.p[1],f=s-c,f>=0&&c>=y&&(x=(b*c+z*p-E)*R,x>=0&&(v=(T*c+w*p+g)*R,v>=0&&A*R-x-v>=0&&(d=Math.abs(u-p)/f,_>d&&M(o,t)&&(e=o,_=d)))),o=o.next;return e}function x(t,n,e,r){var i=t;do null===i.z&&(i.z=d(i.p[0],i.p[1],n,e,r)),i.prevZ=i.prev,i.nextZ=i.next,i=i.next;while(i!==t);i.prevZ.nextZ=null,i.prevZ=null,v(i)}function v(t){for(var n,e,r,i,o,a,s,u,h=1;;){for(e=t,t=null,o=null,a=0;e;){for(a++,r=e,s=0,n=0;h>n&&(s++,r=r.nextZ,r);n++);for(u=h;s>0||u>0&&r;)0===s?(i=r,r=r.nextZ,u--):0!==u&&r?e.z<=r.z?(i=e,e=e.nextZ,s--):(i=r,r=r.nextZ,u--):(i=e,e=e.nextZ,s--),o?o.nextZ=i:t=i,i.prevZ=o,o=i;e=r}if(o.nextZ=null,1>=a)return t;h*=2}}function d(t,n,e,r,i){return t=1e3*(t-e)/i,t=16711935&(t|t<<8),t=252645135&(t|t<<4),t=858993459&(t|t<<2),t=1431655765&(t|t<<1),n=1e3*(n-r)/i,n=16711935&(n|n<<8),n=252645135&(n|n<<4),n=858993459&(n|n<<2),n=1431655765&(n|n<<1),t|n<<1}function y(t){var n=t,e=t;do n.p[0]<e.p[0]&&(e=n),n=n.next;while(n!==t);return e}function m(t,n){return!z(t,t.p,n.p)&&M(t,n)&&M(n,t)&&T(t,t.p,n.p)}function g(t,n,e){var r=(n[1]-t[1])*(e[0]-n[0])-(n[0]-t[0])*(e[1]-n[1]);return r>0?1:0>r?-1:0}function E(t,n){return t[0]===n[0]&&t[1]===n[1]}function b(t,n,e,r){return g(t,n,e)!==g(t,n,r)&&g(e,r,t)!==g(e,r,n)}function z(t,n,e){var r=t;do{var i=r.p,o=r.next.p;if(i!==n&&o!==n&&i!==e&&o!==e&&b(i,o,n,e))return!0;r=r.next}while(r!==t);return!1}function M(t,n){return-1===g(t.prev.p,t.p,t.next.p)?-1!==g(t.p,n.p,t.next.p)&&-1!==g(t.p,t.prev.p,n.p):-1===g(t.p,n.p,t.prev.p)||-1===g(t.p,t.next.p,n.p)}function T(t,n,e){var r=t,i=!1,o=(n[0]+e[0])/2,a=(n[1]+e[1])/2;do{var s=r.p,u=r.next.p;s[1]>a!=u[1]>a&&o<(u[0]-s[0])*(a-s[1])/(u[1]-s[1])+s[0]&&(i=!i),r=r.next}while(r!==t);return i}function w(t,n){return t.p[0]-n.p[0]}function A(t,n){var e=new F(t.p),r=new F(n.p),i=t.next,o=n.prev;return e.source=t,r.source=n,t.next=n,n.prev=t,e.next=i,i.prev=e,r.next=e,e.prev=r,o.next=r,r.prev=o,r}function R(t,n){var e=new F(t);return n?(e.next=n.next,e.prev=n,n.next.prev=e,n.next=e):(e.prev=e,e.next=e),e}function F(t){this.p=t,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.source=null,this.index=null}n.exports=r},{}],19:[function(t,n,e){!function(t,r){"use strict";"object"==typeof e?n.exports=r():"function"==typeof define&&define.amd?define(r):t.MersenneTwister=r()}(this,function(){"use strict";var t=4294967296,n=624,e=397,r=2147483648,i=2147483647,o=2567483615,a=function(t){"undefined"==typeof t&&(t=(new Date).getTime()),this.mt=new Array(n),this.mti=n+1,this.seed(t)};a.prototype.seed=function(t){var e;for(this.mt[0]=t>>>0,this.mti=1;this.mti<n;this.mti++)e=this.mt[this.mti-1]^this.mt[this.mti-1]>>>30,this.mt[this.mti]=(1812433253*((4294901760&e)>>>16)<<16)+1812433253*(65535&e)+this.mti,this.mt[this.mti]>>>=0},a.prototype.seedArray=function(t){var e,r=1,i=0,o=n>t.length?n:t.length;for(this.seed(19650218);o>0;o--)e=this.mt[r-1]^this.mt[r-1]>>>30,this.mt[r]=(this.mt[r]^(1664525*((4294901760&e)>>>16)<<16)+1664525*(65535&e))+t[i]+i,this.mt[r]>>>=0,r++,i++,r>=n&&(this.mt[0]=this.mt[n-1],r=1),i>=t.length&&(i=0);for(o=n-1;o;o--)e=this.mt[r-1]^this.mt[r-1]>>>30,this.mt[r]=(this.mt[r]^(1566083941*((4294901760&e)>>>16)<<16)+1566083941*(65535&e))-r,this.mt[r]>>>=0,r++,r>=n&&(this.mt[0]=this.mt[n-1],r=1);this.mt[0]=2147483648},a.prototype.int=function(){var t,a,s=new Array(0,o);if(this.mti>=n){for(this.mti===n+1&&this.seed(5489),a=0;n-e>a;a++)t=this.mt[a]&r|this.mt[a+1]&i,this.mt[a]=this.mt[a+e]^t>>>1^s[1&t];for(;n-1>a;a++)t=this.mt[a]&r|this.mt[a+1]&i,this.mt[a]=this.mt[a+(e-n)]^t>>>1^s[1&t];t=this.mt[n-1]&r|this.mt[0]&i,this.mt[n-1]=this.mt[e-1]^t>>>1^s[1&t],this.mti=0}return t=this.mt[this.mti++],t^=t>>>11,t^=t<<7&2636928640,t^=t<<15&4022730752,t^=t>>>18,t>>>0},a.prototype.int31=function(){return this.int()>>>1},a.prototype.real=function(){return this.int()*(1/(t-1))},a.prototype.realx=function(){return(this.int()+.5)*(1/t)},a.prototype.rnd=function(){return this.int()*(1/t)},a.prototype.random=a.prototype.rnd,a.prototype.rndHiRes=function(){var t=this.int()>>>5,n=this.int()>>>6;return(67108864*t+n)*(1/9007199254740992)};var s=new a;return a.random=function(){return s.rnd()},a})},{}],20:[function(t,n,e){var r=function(){var t=Date.now(),n=t,e=0,r=1/0,i=0,o=0,a=1/0,s=0,u=0,h=0,l=document.createElement("div");l.id="stats",l.addEventListener("mousedown",function(t){t.preventDefault(),m(++h%2)},!1),l.style.cssText="width:80px;opacity:0.9;cursor:pointer";var c=document.createElement("div");c.id="fps",c.style.cssText="padding:0 0 3px 3px;text-align:left;background-color:#002",l.appendChild(c);var p=document.createElement("div");p.id="fpsText",p.style.cssText="color:#0ff;font-family:Helvetica,Arial,sans-serif;font-size:9px;font-weight:bold;line-height:15px",p.innerHTML="FPS",c.appendChild(p);var f=document.createElement("div");for(f.id="fpsGraph",f.style.cssText="position:relative;width:74px;height:30px;background-color:#0ff",c.appendChild(f);74>f.children.length;){var x=document.createElement("span");x.style.cssText="width:1px;height:30px;float:left;background-color:#113",f.appendChild(x)}var v=document.createElement("div");v.id="ms",v.style.cssText="padding:0 0 3px 3px;text-align:left;background-color:#020;display:none",l.appendChild(v);var d=document.createElement("div");d.id="msText",d.style.cssText="color:#0f0;font-family:Helvetica,Arial,sans-serif;font-size:9px;font-weight:bold;line-height:15px",d.innerHTML="MS",v.appendChild(d);var y=document.createElement("div");for(y.id="msGraph",y.style.cssText="position:relative;width:74px;height:30px;background-color:#0f0",v.appendChild(y);74>y.children.length;)x=document.createElement("span"),x.style.cssText="width:1px;height:30px;float:left;background-color:#131",y.appendChild(x);var m=function(t){switch(h=t){case 0:c.style.display="block",v.style.display="none";break;case 1:c.style.display="none",v.style.display="block"}};return{REVISION:12,domElement:l,setMode:m,begin:function(){t=Date.now()},end:function(){var h=Date.now();e=h-t,r=Math.min(r,e),i=Math.max(i,e),d.textContent=e+" MS ("+r+"-"+i+")";var l=Math.min(30,30-30*(e/200));return y.appendChild(y.firstChild).style.height=l+"px",u++,h>n+1e3&&(o=Math.round(1e3*u/(h-n)),a=Math.min(a,o),s=Math.max(s,o),p.textContent=o+" FPS ("+a+"-"+s+")",l=Math.min(30,30-30*(o/100)),f.appendChild(f.firstChild).style.height=l+"px",n=h,u=0),h},update:function(){t=this.end()}}};"object"==typeof n&&(n.exports=r)},{}],21:[function(t,n,e){var r=t("./../lib/glMatrixSubset"),i=t("./../Context"),o=t("./../lib/Mesh"),a=(t("./../lib/Geom"),t("./../lib/QuadTree")),s=t("./../lib/Loader"),u=r.vec3,h=r.mat4,l=(i.gl,t("../generators/BuildingSHG.js")),c=t("../generators/City.js"),p=function(t,n,e){return t*(1-e)+n*e},f=function(t,n){for(var e=[],r=[],i=[],a=[],s=[],u=0,h=t.lots.length;h>u;u++){var c,p,f,x,v,d,y,m,g;c=t.lots[u],p=c.height,f=c.angle,c=c.poly,x=v=0,d=m=Number.POSITIVE_INFINITY,y=g=Number.NEGATIVE_INFINITY;for(var E=0,b=c.length;b>E;E++){var z=c[E];x+=z.x,v+=z.y,d=Math.min(d,z.x),y=Math.max(y,z.x),m=Math.min(m,z.y),g=Math.max(g,z.y)}x/=c.length,v/=c.length;for(var M=l.create({x:x,y:v,width:.9*Math.abs(y-d),depth:.9*Math.abs(g-m),angle:f}),T=M.geom,w=M.color,A=0,R=T.length;R>A;A++){var F=T[A];if("LIGHT"===F.sym)s.push(F.lightPos);else for(var E=0,b=F.vertices.length;b>E;E++)e.push(F.vertices[E]),r.push(F.normals[E]),i.push(F.uvs[E]),a.push(w[E%3]);T[A]=null}}return{mesh:new o(e,r,i,a),lights:s,x:t.x,y:t.y,w:t.w}},x=new c(0),v={quadtree:null,quadtreeLights:null,fixedMeshes:[]},d=document.createElement("pre");d.style.background="white",d.style.color="black",d.style.position="absolute",d.style.right="1rem",d.style.top="7rem",i.canvas.parentElement.appendChild(d),function(){var t,n,e,r=[],i=[],u=[],h=[],l=[],c=[],d=0,y=x.blocks.length;for(function(){var t=[];x.roads.forEach(function(n){c.push({x:n.x,y:.05,z:n.y}),n.conns.forEach(function(e){-1===t.indexOf(e)&&c.push({x:p(n.x,e.x,.5),y:.05,z:p(n.y,e.y,.5)})}),t.push(n)})}();x.blocks.length;)t=x.blocks.shift(),setTimeout(function(){var t=f(this);l.push(t),d++,s.progress("Blocks",d/y)}.bind(t),0);s.subscribe("Blocks",function(t,r){return function(){var i,o,s,u;i=o=Number.POSITIVE_INFINITY,s=u=Number.NEGATIVE_INFINITY,r.forEach(function(t){i=Math.min(i,t.x-t.w),s=Math.max(s,t.x+t.w),o=Math.min(o,t.y-t.w),u=Math.max(u,t.y+t.w)});var h=Math.abs(s-i)/2,l=Math.abs(u-o)/2;n=new a(h,l,Math.max(h,l),4),e=new a(h,l,Math.min(h,l),4),r.forEach(function(t){n.insert(t)}),c.forEach(function(t){e.insert({x:t.x,y:t.z,l:t})}),console.log(e,c),t.quadtree=n,t.quadtreeLights=e,t.allLights=c}}(v,l)),r.push.apply(r,[-20,-.001,-20,-20,-.001,20,20,-.001,20,-20,-.001,-20,20,-.001,20,20,-.001,-20]),i.push.apply(i,[0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0]),u.push.apply(u,[0,0,3,0,40,3,40,40,3,0,0,3,40,40,3,40,0,3]),h.push.apply(h,[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]);for(var m=x.roadQuads.reduce(function(){var t,n;return t=[0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0],n=[0,0,2,0,1,2,1,1,2,0,0,2,1,1,2,1,0,2],function(e,r){for(var i=r[0],o=r[1],a=Math.atan2(o.y-i.y,o.x-i.x)+Math.PI/2,s=Math.abs(.09*Math.cos(a)),u=Math.abs(.09*Math.sin(a)),h={x:i.x+u,y:i.y+s},l={x:o.x-u,y:o.y-s},c=Math.sqrt(Math.pow(l.y-h.y,2)+Math.pow(l.x-h.x,2)),p=[h.x-s,0,h.y-u,l.x-s,0,l.y-u,l.x+s,0,l.y+u,h.x-s,0,h.y-u,l.x+s,0,l.y+u,h.x+s,0,h.y+u],f=n.map(function(t,n){switch(n%3){case 0:return t;case 1:return t*c;default:return t}return t}),x=0,v=p.length;v>x;x++)e.vertices.push(p[x]),e.normals.push(t[x]),e.uvs.push(f[x]),e.extra.push(0);return e}}(),{vertices:[],normals:[],uvs:[],extra:[]}),g=0,E=m.vertices.length;E>g;g++)r.push(m.vertices[g]),i.push(m.normals[g]),u.push(m.uvs[g]),h.push(m.extra[g]);v.fixedMeshes=[new o(r,i,u,h)]}();var y={meshes:[],lights:[],lightPos:u.create(),view:h.create(),model:h.create(),count:0},m=0,g=function(t,n){return t.push(n),t},E=2,b=.19,z=1.8,M=0,T=0,w=0,A=0;y.update=function(t){E+=(Math.cos(T)*w-Math.sin(T)*A)*Math.cos(M),b+=Math.sin(M)*A,z+=(Math.sin(T)*w+Math.cos(T)*A)*Math.cos(M),d.textContent=[E,b,z].map(function(t){return t.toFixed(2)}).join(", ")+" "+(Math.PI/M).toFixed(2)+" "+(Math.PI/T).toFixed(2),u.set(y.lightPos,5,.05,6),h.identity(y.view),h.rotateX(y.view,y.view,M),h.rotateY(y.view,y.view,T),h.translate(y.view,y.view,[-E,-b,-z]),y.meshes=v.fixedMeshes.reduce(g,[]),y.meshes=v.quadtree.query(E,z,4).map(function(t){return t.mesh}).reduce(g,y.meshes),d.textContent+="\nVertices: "+y.meshes.reduce(function(t,n){return t+n.count},0),y.lights=v.allLights.map(function(t){return[t.x,t.y,t.z]}),m+=.001,d.textContent+="\nLights: "+y.lights.length},document.body.addEventListener("keydown",function(t){switch(t.which){case 87:A=-.008;break;case 83:A=.008;break;case 65:w=-.008;break;case 68:w=.008}}),document.body.addEventListener("keyup",function(t){switch(t.which){case 87:A=0;break;case 83:A=0;break;case 65:w=0;break;case 68:w=0}}),i.canvas.addEventListener("mousedown",function(t){var n,e,r=t.clientX,o=t.clientY;n=function(t){var n=t.clientX-r,e=t.clientY-o;M+=.005*e,T+=.005*n,r=t.clientX,o=t.clientY,d.textContent=[E,b,z].map(function(t){return t.toFixed(2)}).join(", ")+" "+(Math.PI/M).toFixed(2)+" "+(Math.PI/T).toFixed(2)},e=function(t){i.canvas.removeEventListener("mousemove",n),i.canvas.removeEventListener("mouseup",e)},i.canvas.addEventListener("mousemove",n),i.canvas.addEventListener("mouseup",e)}),n.exports=y},{"../generators/BuildingSHG.js":5,"../generators/City.js":6,"./../Context":1,"./../lib/Geom":9,"./../lib/Loader":10,"./../lib/Mesh":11,"./../lib/QuadTree":12,"./../lib/glMatrixSubset":15}]},{},[17]);