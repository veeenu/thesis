!function t(n,e,r){function i(a,s){if(!e[a]){if(!n[a]){var u="function"==typeof require&&require;if(!s&&u)return u(a,!0);if(o)return o(a,!0);var h=new Error("Cannot find module '"+a+"'");throw h.code="MODULE_NOT_FOUND",h}var l=e[a]={exports:{}};n[a][0].call(l.exports,function(t){var e=n[a][1][t];return i(e?e:t)},l,l.exports,t,n,e,r)}return e[a].exports}for(var o="function"==typeof require&&require,a=0;a<r.length;a++)i(r[a]);return i}({1:[function(t,n,e){var r=document.getElementById("thesis-canvas"),i=r.getContext("webgl"),o=r.getBoundingClientRect(),a=o.width,s=o.height;r.width=a,r.height=s,r.style.background="black",n.exports={canvas:r,gl:i,w:a,h:s,aspectRatio:a/s}},{}],2:[function(t,n,e){var r,i,o,a,s,u,h,l=(t("./lib/util.js"),t("./lib/glMatrixSubset")),c=(l.vec3,l.mat3),x=l.mat4,p=t("./Context"),f=p.gl,d=(t("./generators/BuildingSHG.js"),f.createProgram()),v=f.createProgram(),m=f.createProgram(),y=f.createProgram(),g=f.createShader(f.VERTEX_SHADER),z=f.createShader(f.FRAGMENT_SHADER),b=f.createShader(f.VERTEX_SHADER),E=f.createShader(f.FRAGMENT_SHADER),M=f.createShader(f.VERTEX_SHADER),T=f.createShader(f.FRAGMENT_SHADER),w=f.createShader(f.VERTEX_SHADER),R=f.createShader(f.FRAGMENT_SHADER);r="uniform mat4 projection, viewmodel;\nuniform mat3 normalM;\n\nattribute vec3 vertex, normal, uv, extra;\n\nvarying vec4 vPosition, clipPosition;\nvarying vec3 texUV, vNormal, vExtra;\n\nvoid main() {\n  \n  vec4 viewPos = viewmodel * vec4(vertex, 1.);\n  clipPosition = projection * viewPos;\n  gl_Position = clipPosition;\n\n  vPosition = viewPos;\n  vNormal = normalM * normal;\n  vExtra = extra;\n  texUV = uv;\n\n}\n\n",o="#extension GL_OES_standard_derivatives : require\n\nprecision highp float;\n\nuniform sampler2D mainScene, roomScene;\n\nvarying vec4 vPosition, clipPosition;\nvarying vec3 texUV, vNormal, vExtra;\n\n////////////////////////////////////////////////////////////////////////////////\n// https://github.com/ashima/webgl-noise/blob/master/src/noise2D.glsl         //\n////////////////////////////////////////////////////////////////////////////////\n\nvec3 mod289(vec3 x) { return x - floor(x * (1.0 / 289.0)) * 289.0; }\nvec2 mod289(vec2 x) { return x - floor(x * (1.0 / 289.0)) * 289.0; }\nvec3 permute(vec3 x) { return mod289(((x*34.0)+1.0)*x); }\nfloat snoise(vec2 v) {\n  const vec4 C = vec4(0.211324865405187,  // (3.0-sqrt(3.0))/6.0\n                      0.366025403784439,  // 0.5*(sqrt(3.0)-1.0)\n                     -0.577350269189626,  // -1.0 + 2.0 * C.x\n                      0.024390243902439); // 1.0 / 41.0\n  vec2 i  = floor(v + dot(v, C.yy) );\n  vec2 x0 = v -   i + dot(i, C.xx);\n  vec2 i1;\n  i1 = (x0.x > x0.y) ? vec2(1.0, 0.0) : vec2(0.0, 1.0);\n  vec4 x12 = x0.xyxy + C.xxzz;\n  x12.xy -= i1;\n  i = mod289(i);\n  vec3 p = permute( permute( i.y + vec3(0.0, i1.y, 1.0 ))\n		+ i.x + vec3(0.0, i1.x, 1.0 ));\n  vec3 m = max(0.5 - vec3(dot(x0,x0), dot(x12.xy,x12.xy), dot(x12.zw,x12.zw)), 0.0);\n  m = m*m ;\n  m = m*m ;\n  vec3 x = 2.0 * fract(p * C.www) - 1.0;\n  vec3 h = abs(x) - 0.5;\n  vec3 ox = floor(x + 0.5);\n  vec3 a0 = x - ox;\n  m *= 1.79284291400159 - 0.85373472095314 * ( a0*a0 + h*h );\n  vec3 g;\n  g.x  = a0.x  * x0.x  + h.x  * x0.y;\n  g.yz = a0.yz * x12.xz + h.yz * x12.yw;\n  return 130.0 * dot(m, g);\n}\n\n////////////////////////////////////////////////////////////////////////////////\n// Procedural textures\n////////////////////////////////////////////////////////////////////////////////\n\nvec3 bumpMap(vec3 fvert, vec3 fnorm, float bump) {\n\n  vec3 ddx = normalize(dFdx(fvert)),\n       ddy = normalize(dFdy(fvert)),\n       bU = dFdx(bump) * cross(fnorm, ddy),\n       bV = dFdy(bump) * cross(ddx, fnorm),\n       bD = fnorm + (bU + bV);\n\n  return normalize(bD);\n}\n\nstruct TTextureInfo {\n  vec3 color;\n  vec3 normal;\n};\n\n#define textureBrickI(x, p, notp) ((floor(x)*(p))+max(fract(x)-(notp), 0.0))\nTTextureInfo textureBrick(vec3 fvert, vec3 fnorm, float fdepth, vec2 uv, vec3 brickColor) {\n\n  const float bW  = .0625,\n              bH  = .03125,\n              mS  = 1. / 256.,\n              mWf = mS * .5 / bW,\n              mHf = mS * .5 / bH;\n  const vec3 mortarColor = vec3(.68, .68, .71);\n\n  float u = uv.s / bW,\n        v = uv.t / bH,\n        brU = floor(u),\n        brV = floor(v);\n\n  if(mod(v * .5, 1.) > .5)\n    u += .5;\n  brU = floor(u);\n\n  float noisev = 1. +\n                 snoise(uv * 256.) * .125;\n  float brickDamp = 1. + .125 * sin(1.57 * (brU + 1.)) * sin(2. * (brV + 1.));\n\n  vec2 uuv = vec2(u, v),\n       fw = 2. * vec2(fwidth(uuv.x), fwidth(uuv.y)),\n       mortarPct = vec2(mWf, mHf),\n       brickPct = vec2(1., 1.) - mortarPct,\n       ub = (textureBrickI(uuv + fw, brickPct, mortarPct) -\n             textureBrickI(uuv, brickPct, mortarPct)) / fw;\n\n  vec3 color = mix(mortarColor, brickColor * brickDamp, ub.x * ub.y);\n\n  // Adaptive box blur filter. Not perfect but quick and somewhat acceptable\n  vec2 ubSample, ubKernel = 4. * fwidth(ub), noiseKernel = fwidth(uv);\n  float bump = 0., invd = 1. / 11.;\n\n  for(int x = -1; x <= 1; x++) {\n    for(int y = -1; y <= 1; y++) {\n      ubSample = ub + vec2(float(x), float(y)) * ubKernel;\n      bump += .1111111 * ubSample.x * ubSample.y;\n    }\n  }\n\n  bump *= 1.75;\n\n  // Frequency clamping\n  bump -= 8. * (1. - smoothstep(0., .00125, max(noiseKernel.x, noiseKernel.y))) * noisev;\n\n  return TTextureInfo(\n    color,\n    bumpMap(fvert, fnorm, bump)\n  );\n}\n\n/******************************************************************************\\\n * Window texture\n\\******************************************************************************/\n\nTTextureInfo textureWindow(vec3 fvert, vec3 fnorm, float fdepth, vec2 uv, vec3 windowColor) {\n\n  const vec2 patternPct   = vec2(1., 1.),\n             patternStart = vec2(0., 0.), //(1. - patternPct) * .25,\n             patternEnd   = patternStart + patternPct,\n             framePct     = vec2(1. / 32., 1. / 32.),\n             frameStart   = patternStart + framePct,\n             frameEnd     = patternEnd   - framePct;\n  //const vec3 windowColor  = vec3(.8, .94, .99),\n  const vec3 frameColor   = vec3(.5, .5, .5);\n\n  vec2 fk   = fwidth(uv) * 2.,\n       uuv  = mod(uv, .5 - 1. / 64.),\n       patF = (smoothstep(frameEnd, frameEnd + fk, uuv) - smoothstep(frameStart, frameStart + fk, uuv));\n  float noisep = 1. + \n                snoise(-uv * .5) * .25;\n  float noisev = 1. + \n                 snoise(uv * 16.) * .0625 +\n                 abs(snoise(uv * 512.)) * .0625;\n\n  float bump = patF.x * patF.y;\n\n  return TTextureInfo(\n    mix(frameColor, windowColor * noisep, patF.x * patF.y),\n    bumpMap(fvert, fnorm, bump)\n  );\n}\n\n/******************************************************************************\\\n * Road texture\n\\******************************************************************************/\n\nvec3 textureRoad(vec2 uuv) {\n  const float padding = 1. / 32.,\n              tapeW   = 1. / 32.,\n              tapeL0  = padding,\n              tapeL1  = padding + tapeW,\n              tapeR1  = 1. - tapeL0,\n              tapeR0  = 1. - tapeL1,\n              tapeC0  = .5 - tapeW * .5,\n              tapeC1  = .5 + tapeW * .5,\n              vertDiv = 4.;\n  const vec3 asphaltColor = vec3(.2, .2, .2),\n             stripColor = vec3(.8, .8, .8);\n\n  vec2 uv = uuv + vec2(0, .5), fk = fwidth(uv);\n  float csSpacing = mod(.25 + uv.t * vertDiv, 1.),\n        q = \n    (\n      smoothstep(tapeL0, tapeL0 + fk.x, uv.s) - \n      smoothstep(tapeL1, tapeL1 + fk.x, uv.s)\n    ) +\n    (\n      smoothstep(tapeR0, tapeR0 + fk.x, uv.s) - \n      smoothstep(tapeR1, tapeR1 + fk.x, uv.s)\n    ) +\n    (\n      smoothstep(tapeC0, tapeC0 + fk.x, uv.s) - \n      smoothstep(tapeC1, tapeC1 + fk.x, uv.s)\n    ) * \n    (\n      smoothstep(.5 - fk.y, .5 + fk.y, csSpacing) *\n      (1. - smoothstep(1. - 2. * fk.y, 1., csSpacing))\n    )\n    ;\n\n  float noiseA = 1. +\n                 abs(snoise(uv * 16.))  * .0625 +\n                 abs(snoise(uv * 32.))  * .0625 +\n                 abs(snoise(uv * 128.)) * .125,\n        noiseS = 1. + \n                 abs(snoise(uv * 128.)) * .125;\n\n  return mix(asphaltColor * noiseA, stripColor * noiseS, q);\n}\n\nvec3 textureAsphalt(vec2 uuv) {\n  const vec3 asphaltColor = vec3(.2, .2, .2);\n\n  vec2 uv = uuv + vec2(0, .5);\n  float noiseA = 1. +\n                 abs(snoise(uv * 16.))  * .0625 +\n                 abs(snoise(uv * 32.))  * .0625 +\n                 abs(snoise(uv * 128.)) * .125;\n  return asphaltColor * 2.5 * noiseA;\n}\n\nvec3 textureWood(vec3 str) {\n  const vec3 color0 = vec3(.64, .48, .11),\n             color1 = vec3(.49, .34, .08);\n\n  float noise = \n    .5 * snoise(str.xz * .125) * snoise(str.xy * .125) +\n    .25 * (snoise(str.xz * .25) * snoise(str.xy * .25)) +\n    .125 * (snoise(str.xz * .5) * snoise(str.xy * .5)) +\n    .0625 * (snoise(str.xz) * snoise(str.xy));\n\n  return mix(color0, color1, mod(length(str.xz) + noise, 1.));\n}\n\n////////////////////////////////////////////////////////////////////////////////\n\nfloat packColor(vec3 v) {\n  const float u = 255. / 256.;\n\n  return fract(v.x * u) + floor(v.y * u * 255.) + floor(v.z * u * 255.) * 255.;\n}\n\nvec2 packNormal(in vec3 normal)\n{\n    const float SCALE = 1.7777;\n    float scalar1 = (normal.z + 1.0) * (SCALE * 2.0);\n    return normal.xy / scalar1 + 0.5;\n}\n\nvoid main() {\n\n  TTextureInfo ti;\n  vec3 color, normal;\n\n  float depth = clipPosition.z / clipPosition.w;\n\n  normal = normalize(faceforward(vNormal, gl_FragCoord.xyz, vNormal));\n\n  if(texUV.z > 7.1) {\n    color = texture2D(mainScene, texUV.xy).rgb;\n  }\n  else if(texUV.z > 6.1) {\n    color = textureWood(8. * (vExtra - .5));\n  }\n  else if(texUV.z > 5.1) {\n    ti = textureBrick(vPosition.xyz, vNormal, gl_FragCoord.z, mod(texUV.xy, 1.), vExtra);\n    color = ti.color;\n    normal = ti.normal;\n  }\n  else if(texUV.z > 4.1) {\n    ti = textureWindow(vPosition.xyz, vNormal, gl_FragCoord.z, mod(texUV.yx, 1.), vec3(1., 1., .7));\n    color = ti.color;\n    normal = ti.normal;\n  }\n  else if(texUV.z > 3.1) {\n    ti = textureWindow(vPosition.xyz, vNormal, gl_FragCoord.z, mod(texUV.yx, 1.), vec3(.3, .3, .3));\n    color = ti.color;\n    normal = ti.normal;\n  }\n  else if(texUV.z > 2.1)\n    color = textureAsphalt(mod(texUV.yx, 1.));\n  else if(texUV.z > 1.1)\n    color = textureRoad(mod(texUV.xy, 1.));\n  else\n    color = textureAsphalt(mod(texUV.yx, 1.));\n\n  color = clamp(.2 * color, 0., 1.);\n\n  gl_FragColor = vec4(packNormal(normalize(normal)), packColor(color), depth);\n}\n",i="uniform mat4 viewMatrix;\n\nattribute vec3 lightPos;\nattribute vec2 position;\nvarying vec2 sscoord, coord;\n\nvarying vec3 lPos;\n\nvoid main() {\n  gl_Position = vec4(position, 0., 1.);\n  coord = .5 + .5 * position;\n  sscoord = position;\n  lPos = (viewMatrix * vec4(lightPos, 1.)).xyz;\n}\n",a="#extension GL_OES_standard_derivatives : enable\nprecision highp float;\n\nuniform sampler2D target0;\nuniform mat4 inverseProjection, viewMatrix;\nuniform vec4 lightParameters;\n\nvarying vec2 sscoord, coord;\nvarying vec3 lPos;\n\nvec3 unpackColor(float d) {\n  vec3 ret;\n\n  ret.x = fract(d);\n  float zi = floor(d / 255.);\n  ret.z = fract(zi / 255.);\n  ret.y = fract( floor( d - ( zi * 255. ) ) / 255.);\n\n  return ret;\n}\n\nvec3 unpackNormal(in vec2 enc)\n{\n	const float SCALE = 1.7777;\n	vec2 nn = enc * (2.0 * SCALE) - SCALE;\n	float g = 2.0 / (dot(nn.xy, nn.xy) + 1.0);\n	vec3 normal;\n	normal.xy = g * nn.xy;\n	normal.z = g - 1.0;\n	return normal;\n}\n\n////////////////////////////////////////////////////////////////////////////////\n// Main\n////////////////////////////////////////////////////////////////////////////////\n\nvoid main() {\n\n  vec4 t0 = texture2D(target0, coord);\n  /*if(length(t0.xy) == 0.)\n    discard;*/\n\n  float depth = t0.w;\n\n  vec4 vertexFromDepth = inverseProjection * vec4(sscoord, depth, 1.);\n  vec3 vertex = vertexFromDepth.xyz / vertexFromDepth.w;\n  vec3 lightDir = lPos - vertex;\n\n  float dist = length(lightDir);\n  //if(dist > 2.)\n  //  discard;\n\n  vec3 normal = -normalize(unpackNormal(t0.xy)),\n       color  = unpackColor(t0.z);\n\n  float lambert = max(dot(faceforward(-normal, lightDir, normal), normalize(lightDir)), 0.),\n        att = lightParameters.x * min(1.,\n                1. /\n                (\n                  lightParameters.y + \n                  lightParameters.z * dist + \n                  lightParameters.w * dist * dist\n                )\n              );\n\n  gl_FragColor = vec4(lambert * att * color, 1.);\n  //gl_FragColor = vec4(color, 1.);\n\n}\n",vsrcSSAO="uniform mat4 viewMatrix;\n\nattribute vec2 position;\nvarying vec2 coord;\n\nvoid main() {\n  gl_Position = vec4(position, 0., 1.);\n  coord = .5 + .5 * position;\n}\n",s="#extension GL_OES_standard_derivatives : enable\nprecision highp float;\n\nuniform sampler2D target0, lightBuffer;\n\nvarying vec2 coord;\n\n#define DL 2.399963229728653\n#define EULER 2.718281828459045\n\nvec2 vrand( const vec2 coord ) {\n \n  vec2 noise;\n \n  float nx = dot ( coord, vec2( 12.9898, 78.233 ) );\n  float ny = dot ( coord, vec2( 12.9898, 78.233 ) * 2.0 );\n \n  noise = clamp( fract ( 43758.5453 * sin( vec2( nx, ny ) ) ), 0.0, 1.0 );\n \n  return ( noise * 2.0  - 1.0 ) * .0003;\n \n}\n\nfloat readDepth(const vec2 coord) {\n  return (96. * .001) / (1000.001 - texture2D(target0, coord).w * 999.999);\n}\n\nfloat cmpDepth(const float d1, const float d2, inout int far) {\n\n  float ga = 2., diff = (d1 - d2) * 100.;\n\n  if(diff < .4)\n    ga = .3;\n  else\n    far = 1;\n\n  float dd = diff - .4,\n        gauss = pow(EULER, -2. * dd * dd / (ga * ga));\n  \n  return gauss;\n}\n\nfloat calcAO(float depth, vec2 uv, float dw, float dh) {\n  float dd = 5. - depth * 5.;\n\n  vec2 vv = vec2(dw, dh),\n       coord1 = uv + dd * vv,\n       coord2 = uv - dd * vv;\n\n  int far = 0;\n  float tmp1 = 0., tmp2 = 0.;\n  \n  tmp1 = cmpDepth(depth, readDepth(coord1), far);\n  if(far > 0) {\n    tmp2 = cmpDepth(readDepth(coord2), depth, far);\n    tmp1 += (1. - tmp1) * tmp2;\n  }\n\n  return tmp1;\n}\n\nvoid main() {\n\n  vec3 color = texture2D(lightBuffer, coord).rgb;\n  float occlusion = 0., \n        vdepth = readDepth(coord),\n        tt = clamp(vdepth, .5, 1.);\n  vec2 noisev = vrand(coord);\n\n  float w = (1. / 1280.) / tt + (noisev.x * (1. - noisev.x)),\n        h = (1. / 800.)  / tt + (noisev.y * (1. - noisev.y)),\n        dz = 1. / 16.,\n        z = 1. - dz * .5,\n        l = 0.;\n  for(int i = 0; i < 16; i++) {\n    float r = sqrt(1. - z),\n          pw = cos(l) * r,\n          ph = sin(l) * r;\n    occlusion += calcAO(vdepth, coord, pw * w, ph * h);\n    z -= dz;\n    l += DL;\n  }\n\n  occlusion *= dz;\n\n  color = mix(color, vec3(0.), occlusion);\n  //color = pow(color, vec3(1. / 2.2));\n\n  gl_FragColor = vec4(color, 1.);\n\n  //gl_FragColor = vec4(lambert * att * 2.5 * color, 1.);\n}\n\n",u="attribute vec2 position;\nvarying vec2 coord;\n\nvoid main() {\n  gl_Position = vec4(position, 0., 1.);\n  coord = .5 + .5 * position;\n}\n",h="precision highp float;\n\nuniform sampler2D tex;\nvarying vec2 coord;\n\nvoid main() {\n\n  vec3 color = texture2D(tex, coord).rgb;\n\n  gl_FragColor = vec4(color, 1.);\n\n}\n\n",f.clearColor(0,0,0,0),f.depthFunc(f.LESS),f.blendFunc(f.ONE,f.ONE);var A,I;A=f.getExtension("OES_standard_derivatives"),I=f.getExtension("OES_texture_float"),f.shaderSource(g,r),f.shaderSource(z,o),f.compileShader(g),f.compileShader(z),f.attachShader(d,g),f.attachShader(d,z),f.linkProgram(d),f.shaderSource(M,vsrcSSAO),f.shaderSource(T,s),f.compileShader(M),f.compileShader(T),f.attachShader(m,M),f.attachShader(m,T),f.linkProgram(m),f.shaderSource(b,i),f.shaderSource(E,a),f.compileShader(b),f.compileShader(E),f.attachShader(v,b),f.attachShader(v,E),f.linkProgram(v),f.shaderSource(w,u),f.shaderSource(R,h),f.compileShader(w),f.compileShader(R),f.attachShader(y,w),f.attachShader(y,R),f.linkProgram(y);var F=document.createElement("pre");F.textContent=["VP:",f.getShaderInfoLog(g),"\nFP:",f.getShaderInfoLog(z),"\nLP:",f.getProgramInfoLog(d),"\nVL:",f.getShaderInfoLog(b),"\nFL:",f.getShaderInfoLog(E),"\nLL:",f.getProgramInfoLog(v),"\nVS:",f.getShaderInfoLog(M),"\nFS:",f.getShaderInfoLog(T),"\nLS:",f.getProgramInfoLog(m),"\nVT:",f.getShaderInfoLog(w),"\nFT:",f.getShaderInfoLog(R),"\nLT:",f.getProgramInfoLog(y),"\nExt:",null!==A?"OES_standard derivatives":"",null!==I?"OES_texture_float":""].join(" "),document.body.appendChild(F);var S=f.createTexture(),_=f.createTexture(),P=f.createRenderbuffer(),N=f.createFramebuffer(),D=f.createFramebuffer(),L=f.createFramebuffer();f.bindRenderbuffer(f.RENDERBUFFER,P),f.renderbufferStorage(f.RENDERBUFFER,f.DEPTH_COMPONENT16,p.w,p.h),f.bindTexture(f.TEXTURE_2D,S),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MAG_FILTER,f.NEAREST),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MIN_FILTER,f.NEAREST),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,f.CLAMP_TO_EDGE),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,f.CLAMP_TO_EDGE),f.texImage2D(f.TEXTURE_2D,0,f.RGBA,p.w,p.h,0,f.RGBA,f.FLOAT,null),f.bindTexture(f.TEXTURE_2D,_),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MAG_FILTER,f.NEAREST),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MIN_FILTER,f.NEAREST),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,f.CLAMP_TO_EDGE),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,f.CLAMP_TO_EDGE),f.texImage2D(f.TEXTURE_2D,0,f.RGBA,p.w,p.h,0,f.RGBA,f.UNSIGNED_BYTE,null),f.bindTexture(f.TEXTURE_2D,null),f.bindFramebuffer(f.FRAMEBUFFER,N),f.framebufferRenderbuffer(f.FRAMEBUFFER,f.DEPTH_ATTACHMENT,f.RENDERBUFFER,P),f.framebufferTexture2D(f.FRAMEBUFFER,f.COLOR_ATTACHMENT0,f.TEXTURE_2D,S,0),f.bindFramebuffer(f.FRAMEBUFFER,D),f.framebufferTexture2D(f.FRAMEBUFFER,f.COLOR_ATTACHMENT0,f.TEXTURE_2D,_,0),f.bindFramebuffer(f.FRAMEBUFFER,null);for(var C=f.createBuffer(),B=f.createBuffer(),U=new Float32Array(9216),G=[],X=x.create(),k=x.create(),O=0;512>O;O++)G.push(1,-1,-1,-1,-1,1,1,-1,-1,1,1,1);f.bindBuffer(f.ARRAY_BUFFER,C),f.bufferData(f.ARRAY_BUFFER,new Float32Array(G),f.STATIC_DRAW),f.bindBuffer(f.ARRAY_BUFFER,B),f.bufferData(f.ARRAY_BUFFER,U,f.STREAM_DRAW),f.bindBuffer(f.ARRAY_BUFFER,null),x.perspective(X,Math.PI/2,p.aspectRatio,.001,1e3),x.invert(k,X),["vertex","normal","uv","extra"].forEach(function(t){d[t]=f.getAttribLocation(d,t)}),["projection","viewmodel","normalM","mainScene","roomScene"].forEach(function(t){d[t]=f.getUniformLocation(d,t)}),["position","lightPos"].forEach(function(t){v[t]=f.getAttribLocation(v,t)}),["target0","lightParameters","inverseProjection","viewMatrix"].forEach(function(t){v[t]=f.getUniformLocation(v,t)}),["position"].forEach(function(t){y[t]=f.getAttribLocation(y,t)}),["tex"].forEach(function(t){y[t]=f.getUniformLocation(y,t)}),["position"].forEach(function(t){m[t]=f.getAttribLocation(m,t)}),["target0","lightBuffer"].forEach(function(t){m[t]=f.getUniformLocation(m,t)}),d.activate=function(t){f.useProgram(d),f.bindFramebuffer(f.FRAMEBUFFER,N),f.enable(f.DEPTH_TEST),f.clear(f.COLOR_BUFFER_BIT|f.DEPTH_BUFFER_BIT);var n=x.create(),e=c.create();x.mul(n,t.view,t.model),c.normalFromMat4(e,n),f.activeTexture(f.TEXTURE0),f.bindTexture(f.TEXTURE_2D,d.textures.mainScene),f.activeTexture(f.TEXTURE1),f.bindTexture(f.TEXTURE_2D,d.textures.roomScene),f.uniform1i(d.mainScene,0),f.uniform1i(d.roomScene,1),f.uniformMatrix4fv(d.projection,!1,X),f.uniformMatrix4fv(d.viewmodel,!1,n),f.uniformMatrix3fv(d.normalM,!1,e),f.enableVertexAttribArray(d.vertex),f.enableVertexAttribArray(d.normal),f.enableVertexAttribArray(d.uv),f.enableVertexAttribArray(d.extra),t.meshes.forEach(function(t){f.bindBuffer(f.ARRAY_BUFFER,t.vBuf),f.vertexAttribPointer(d.vertex,3,f.FLOAT,!1,0,0),f.bindBuffer(f.ARRAY_BUFFER,t.nBuf),f.vertexAttribPointer(d.normal,3,f.FLOAT,!1,0,0),f.bindBuffer(f.ARRAY_BUFFER,t.uBuf),f.vertexAttribPointer(d.uv,3,f.FLOAT,!1,0,0),f.bindBuffer(f.ARRAY_BUFFER,t.eBuf),f.vertexAttribPointer(d.extra,3,f.FLOAT,!1,0,0),f.drawArrays(f.TRIANGLES,0,t.count)})},d.deactivate=function(){f.bindFramebuffer(f.FRAMEBUFFER,null),f.disableVertexAttribArray(d.vertex),f.disableVertexAttribArray(d.normal),f.disableVertexAttribArray(d.uv),f.disableVertexAttribArray(d.extra),f.disable(f.DEPTH_TEST)},v.activate=function(t){f.useProgram(v),f.bindFramebuffer(f.FRAMEBUFFER,D),f.enable(f.BLEND),f.clear(f.COLOR_BUFFER_BIT),f.activeTexture(f.TEXTURE0),f.bindTexture(f.TEXTURE_2D,S),f.uniform1i(v.target0,0),f.uniform4fv(v.lightParameters,t.lightParameters),f.uniformMatrix4fv(v.viewMatrix,!1,t.view),f.uniformMatrix4fv(v.inverseProjection,!1,k),f.bindBuffer(f.ARRAY_BUFFER,C),f.vertexAttribPointer(v.position,2,f.FLOAT,!1,0,0),f.bindBuffer(f.ARRAY_BUFFER,B),f.vertexAttribPointer(v.lightPos,3,f.FLOAT,!1,0,0);var n=Math.min(t.lights.length,U.length),e=U.subarray(0,n);e.set(t.lights),f.bufferSubData(f.ARRAY_BUFFER,0,e),f.enableVertexAttribArray(v.position),f.enableVertexAttribArray(v.lightPos),f.drawArrays(f.TRIANGLES,0,n/3),f.enableVertexAttribArray(v.lightPosition)},v.deactivate=function(){f.bindFramebuffer(f.FRAMEBUFFER,null),f.disableVertexAttribArray(v.position),f.disableVertexAttribArray(v.lightPos),f.disable(f.BLEND)},m.activate=function(t){f.useProgram(m),f.bindFramebuffer(f.FRAMEBUFFER,L),f.framebufferTexture2D(f.FRAMEBUFFER,f.COLOR_ATTACHMENT0,f.TEXTURE_2D,t.texture,0),f.clear(f.COLOR_BUFFER_BIT),f.activeTexture(f.TEXTURE0),f.bindTexture(f.TEXTURE_2D,S),f.activeTexture(f.TEXTURE1),f.bindTexture(f.TEXTURE_2D,_),f.uniform1i(m.target0,0),f.uniform1i(m.lightBuffer,1),f.bindBuffer(f.ARRAY_BUFFER,C),f.vertexAttribPointer(m.position,2,f.FLOAT,!1,0,0),f.enableVertexAttribArray(m.position),f.drawArrays(f.TRIANGLES,0,6)},m.deactivate=function(){f.disableVertexAttribArray(m.position),f.bindFramebuffer(f.FRAMEBUFFER,null)},y.activate=function(t){f.useProgram(y),f.clear(f.COLOR_BUFFER_BIT),f.activeTexture(f.TEXTURE0),f.bindTexture(f.TEXTURE_2D,t),f.uniform1i(y.tex,0),f.bindBuffer(f.ARRAY_BUFFER,C),f.vertexAttribPointer(y.position,2,f.FLOAT,!1,0,0),f.enableVertexAttribArray(y.position),f.drawArrays(f.TRIANGLES,0,6)},n.exports={init:function(t,n){d.textures={mainScene:t.texture,roomScene:n.texture}},render:function(t){d.activate(t),d.deactivate(),v.activate(t),v.deactivate(),m.activate(t),m.deactivate(),y.activate(t.texture)}}},{"./Context":1,"./generators/BuildingSHG.js":5,"./lib/glMatrixSubset":17,"./lib/util.js":18}],3:[function(t,n,e){var r=t("./../lib/ShapeGrammar"),i=t("../lib/SHAPE.js"),o=t("./../lib/Geom"),a=(t("./PRNG"),new r),s=new r;a.define("Balcony",null,function(){var t=this.points,n={sym:"BalconyFloor",points:[{x:t[0].x,y:t[0].y,z:t[0].z},{x:t[1].x,y:t[1].y,z:t[1].z},{x:t[2].x,y:t[2].y,z:t[2].z},{x:t[3].x,y:t[3].y,z:t[3].z}],extrudeBorders:this.floorHeight},e={sym:"BalconyFloor",points:[{x:t[0].x,y:t[0].y+this.floorHeight,z:t[0].z},{x:t[1].x,y:t[1].y+this.floorHeight,z:t[1].z},{x:t[2].x,y:t[2].y+this.floorHeight,z:t[2].z},{x:t[3].x,y:t[3].y+this.floorHeight,z:t[3].z}]},r=i.extrudeAll(n.points,this.floorHeight,"TQuad"),o=i.extrudeAll(e.points,this.fenceHeight,"Fence");return o.pop(),r.push.apply(r,o),r.push(n,e),r}),a.define("BalconyFloor",null,function(){var t=i.splitXZ(this,[.8,.15,.05],[.05,.45,.5],"TQuad"),n=t.splice(4,1).shift().points;if("extrudeBorders"in this){var e=i.extrudeAll([{x:n[0].x,y:n[0].y,z:n[0].z},{x:n[1].x,y:n[1].y,z:n[1].z},{x:n[2].x,y:n[2].y,z:n[2].z},{x:n[3].x,y:n[3].y,z:n[3].z}],this.extrudeBorders,"TQuad");t.push.apply(t,e)}return t}),a.define("Fence",null,function(){var t=i.fit("x",this,"StickBase",.25),n=this.points[0],e=this.points[1],r=(this.points[2],this.points[3]),o=r.x-n.x,a=(e.y-n.y,r.z-n.z),s=Math.atan2(a,o)-Math.PI/2,u=(Math.sqrt(o*o+a*a),.05*Math.cos(s)),h=.05*Math.sin(s),l={sym:"TQuad",points:[{x:n.x,y:e.y,z:n.z},{x:n.x+u,y:e.y,z:n.z+h},{x:r.x+u,y:e.y,z:r.z+h},{x:r.x,y:e.y,z:r.z}]},c={sym:"TQuad",points:[{x:n.x,y:e.y+.05,z:n.z},{x:n.x+u,y:e.y+.05,z:n.z+h},{x:r.x+u,y:e.y+.05,z:r.z+h},{x:r.x,y:e.y+.05,z:r.z}]};t.push(l),t.push(c);var x=l.points;return t.push.apply(t,i.extrudeAll([{x:x[0].x,y:x[0].y,z:x[0].z},{x:x[1].x,y:x[1].y,z:x[1].z},{x:x[2].x,y:x[2].y,z:x[2].z},{x:x[3].x,y:x[3].y,z:x[3].z}],.05,"TQuad")),t}),a.define("StickBase",null,function(){var t=i.split(this,[.45,.1,.45],[1],null),n=t[1],e=n.points,r=e[3].x-e[0].x,o=e[1].y-e[0].y,a=e[3].z-e[0].z,s=Math.atan2(a,r)-Math.PI/2,u=Math.sqrt(r*r+a*a),h=Math.abs(o),l=Math.cos(s)*u,c=Math.sin(s)*u;return{sym:"Stick",points:[{x:e[0].x,y:e[0].y,z:e[0].z},{x:e[0].x+l,y:e[0].y,z:e[0].z+c},{x:e[3].x+l,y:e[0].y,z:e[3].z+c},{x:e[3].x,y:e[0].y,z:e[3].z}],stickHeight:h}}),a.define("Stick",null,function(){var t=this.points;return i.extrudeAll([{x:t[0].x,y:t[0].y,z:t[0].z},{x:t[1].x,y:t[1].y,z:t[1].z},{x:t[2].x,y:t[2].y,z:t[2].z},{x:t[3].x,y:t[3].y,z:t[3].z}],this.stickHeight,"TQuad")}),a.define("TQuad",null,function(){var t,n=[],e=[],i=[];this.uvs=this.uvs||[{s:0,t:1},{s:0,t:0},{s:1,t:0},{s:1,t:1}];var a=this.points[0],s=this.points[1],u=this.points[2],h=this.points[3];n=[a.x,a.y,a.z,s.x,s.y,s.z,u.x,u.y,u.z,a.x,a.y,a.z,u.x,u.y,u.z,h.x,h.y,h.z],i=[0,1,2,0,2,3].reduce(function(t,n){return t.push(this.uvs[n].s,this.uvs[n].t,this.texID||0),t}.bind(this),[]),t=o.triToNormal(n);for(var l=0;6>l;l++)e.push.apply(e,t);return{sym:r.TERMINAL,vertices:n,normals:e,uvs:i}}),s.define("Staircase",null,function(){for(var t=this.stairHeight+this.stairSpace,n=this.height/t,e=this.width/n,r=[],i=0;n>=i;i++)r.push({sym:"Stair",x:this.x+e*i,y:this.y+t*i,z:this.z,height:this.stairHeight,width:e,depth:this.stairDepth});return r.push({sym:"TQuad",points:[{x:this.x-e/2,y:this.y,z:this.z-this.stairDepth/2},{x:this.x-e/2+this.width,y:this.y+this.height,z:this.z-this.stairDepth/2},{x:this.x+e/2+this.width,y:this.y+this.height,z:this.z-this.stairDepth/2},{x:this.x+e/2,y:this.y,z:this.z-this.stairDepth/2}]},{sym:"TQuad",points:[{x:this.x-e/2,y:this.y,z:this.z+this.stairDepth/2},{x:this.x-e/2+this.width,y:this.y+this.height,z:this.z+this.stairDepth/2},{x:this.x+e/2+this.width,y:this.y+this.height,z:this.z+this.stairDepth/2},{x:this.x+e/2,y:this.y,z:this.z+this.stairDepth/2}]}),r}),s.define("Stair",null,function(){var t=this.width/2,n=this.height/2,e=this.depth/2,r=[{sym:"TQuad",points:[{x:this.x-t,y:this.y-n,z:this.z-e},{x:this.x-t,y:this.y-n,z:this.z+e},{x:this.x+t,y:this.y-n,z:this.z+e},{x:this.x+t,y:this.y-n,z:this.z-e}]},{sym:"TQuad",points:[{x:this.x-t,y:this.y+n,z:this.z-e},{x:this.x-t,y:this.y+n,z:this.z+e},{x:this.x+t,y:this.y+n,z:this.z+e},{x:this.x+t,y:this.y+n,z:this.z-e}]}];return r.push.apply(r,i.extrudeAll(r[0].points,this.height,"TQuad")),r}),s.define("TQuad",null,function(){var t,n=[],e=[],i=[];this.uvs=this.uvs||[{s:0,t:1},{s:0,t:0},{s:1,t:0},{s:1,t:1}];var a=this.points[0],s=this.points[1],u=this.points[2],h=this.points[3];n=[a.x,a.y,a.z,s.x,s.y,s.z,u.x,u.y,u.z,a.x,a.y,a.z,u.x,u.y,u.z,h.x,h.y,h.z],i=[0,1,2,0,2,3].reduce(function(t,n){return t.push(this.uvs[n].s,this.uvs[n].t,this.texID||0),t}.bind(this),[]),t=o.triToNormal(n);for(var l=0;6>l;l++)e.push.apply(e,t);return{sym:r.TERMINAL,vertices:n,normals:e,uvs:i}});var u,h;u=a.run({sym:"Balcony",points:[{x:-.5,y:0,z:0},{x:-.5,y:0,z:1},{x:.5,y:0,z:1},{x:.5,y:0,z:0}],floorHeight:.025,fenceHeight:.4}).reduce(function(t,n){for(var e=0,r=n.vertices.length;r>e;e++)t.vertices.push(n.vertices[e]),t.normals.push(n.normals[e]),t.uvs.push(n.uvs[e]);return t},{vertices:[],normals:[],uvs:[]}),h=s.run({sym:"Staircase",x:-0.2375,y:.0125,z:.35,height:1,width:.7,stairDepth:.2,stairHeight:.025,stairSpace:.0625}).reduce(function(t,n){for(var e=0,r=n.vertices.length;r>e;e++)t.vertices.push(n.vertices[e]),t.normals.push(n.normals[e]),t.uvs.push(n.uvs[e]);return t},{vertices:u.vertices.slice(),normals:u.normals.slice(),uvs:u.uvs.slice()});var l=function(t){var n=t.vertices,e=t.normals,r=t.uvs;return function(t){for(var i=t.angle,o=Math.cos(i),a=Math.sin(i),s=t.x1-t.x0,u=t.z1-t.z0,h=t.x0+s/2,l=t.z0+u/2,c=t.y,x=t.width,p=t.height,f=t.depth,d=n.length,v=new Float32Array(d),m=new Float32Array(d),y=new Float32Array(r),g=0;d>g;g+=3){var z=n[g]*x,b=n[g+1]*p+c,E=n[g+2]*f;v[g]=z*o+E*a+h,v[g+1]=b,v[g+2]=-z*a+E*o+l,z=e[g],b=e[g+1],E=e[g+2],z=z*o+E*a+h,E=-z*a+E*o+l,m[g]=z,m[g+1]=b,m[g+2]=E}return{vertices:v,normals:m,uvs:y}}};n.exports={createBalcony:l(u),createBalconyWithStairs:l(h)}},{"../lib/SHAPE.js":15,"./../lib/Geom":11,"./../lib/ShapeGrammar":16,"./PRNG":8}],4:[function(t,n,e){var r=t("./PRNG"),i=t("./../lib/Geom"),o=(t("./../lib/ShapeGrammar"),function(t,n,e){return(1-e)*t+e*n}),a=function(t,n,e){var r,a,u,h,l,c,x,p,f,d,v,m,y,g=[],z=[],b=[],E=[];for(p=0,v=t.length;v>p;p++)for(r=(p+1)%v,a=(p+2)%v,u=(p-1+v)%v,h=i.lineIntersection(t[p],t[r],n[u],n[p]),l=i.lineIntersection(t[p],t[r],n[r],n[a]),c=h.x-l.x,x=h.y-l.y,y=Math.sqrt(c*c+x*x),ang=Math.atan2(x,c),d=2,z.push(d),b.push(ang),f=0;d>f;f++){var M=f/(d-1);px1=o(h.x,l.x,M),py1=o(h.y,l.y,M),px2=o(n[p].x,n[r].x,M),py2=o(n[p].y,n[r].y,M),g.push({x:o(h.x,l.x,M),y:o(h.y,l.y,M)},{x:o(n[p].x,n[r].x,M),y:o(n[p].y,n[r].y,M)})}for(g.push(g[0]),p=0,v=t.length;v>p;p++){for(m=[],f=0;f<z[p];f++)m.push(g.shift()),m.push(g.shift());m.push(t[(p+1)%v]),m.push(g[0]||t[0]);for(var T=0,d=m.length;d-2>T;T+=2)E.push(new s([m[T],m[(T+1)%d],m[(T+3)%d],m[(T+2)%d]],e.random()+.5,b[p]))}return E},s=function(t,n,e){this.poly=t,this.height=n,this.angle=e},u=function(t,n){var e=new r(n);this.poly=t,this.block=i.insetPolygon(this.poly,.05),this.lots=a(i.insetPolygon(this.block,.1),i.insetPolygon(this.block,.6),e);var o=t.reduce(function(t,n){return t.cx+=n.x,t.cy+=n.y,t.xm>n.x&&(t.xm=n.x),t.xM<n.x&&(t.xM=n.x),t.ym>n.y&&(t.ym=n.y),t.yM<n.y&&(t.yM=n.y),t},{xm:Number.POSITIVE_INFINITY,ym:Number.POSITIVE_INFINITY,xM:Number.NEGATIVE_INFINITY,yM:Number.NEGATIVE_INFINITY,cx:0,cy:0});this.x=o.cx/t.length,this.y=o.cy/t.length,this.w=Math.max(Math.abs(o.xM-o.xm),Math.abs(o.yM-o.ym))};n.exports=u},{"./../lib/Geom":11,"./../lib/ShapeGrammar":16,"./PRNG":8}],5:[function(t,n,e){var r=t("./../lib/ShapeGrammar"),i=t("../lib/SHAPE.js"),o=t("earcut"),a=t("./../lib/Geom"),s=t("./PRNG"),u=t("./BalconySHG.js"),h=new r,l=new s(31337),c=new s(31338),x=new s(31339),p=new s(31337);h.define("Building",null,function(){for(var t=[],n=0,e=0,r=this.floorsLayout.length;r>e;e++){var i=this.floorsLayout[e],o={sym:i.type,height:i.height,params:i,points:this.points.map(function(t){return{x:t.x,y:t.y+n,z:t.z}}),facadeLayout:this.facadeLayout};"frontFacade"in this&&(o.frontFacade=this.frontFacade),"hasBalcony"in this&&(o.hasBalcony=this.hasBalcony),n+=i.height,t.push(o)}return t}),h.define("FL_GndFloor",null,function(){2*Math.PI;return function(){var t=i.extrudeAll(this.points,this.height,"Facade",[0,1,0]);this.params.frontSide;switch(this.params.tiles){case"OneDoor":for(var n=0,e=t.length;e>n;n++)t[n].type=this.facadeLayout[n]||"Windows";t[this.frontFacade].type="OneDoor"}return t}}()),h.define("FL_Floor",null,function(){for(var t=i.extrudeAll(this.points,this.height,"Facade",[0,1,0]),n=0,e=t.length;e>n;n++)t[n].type=this.facadeLayout[n]||"Windows",t[n].windows=this.params.windows;return"hasBalcony"in this&&(t[this.frontFacade].hasBalcony=this.hasBalcony),t}),h.define("FL_Ledge",null,function(){for(var t=[],n=this.height,e=this.points[0].y,r=0,o=this.points.length;o>r;r++){var s=this.points[r],u=this.points[(r+1)%o],l=Math.atan2(u.z-s.z,u.x-s.x),c=l-Math.PI/2;Math.cos(l)+Math.cos(c),Math.sin(l)+Math.sin(c)}t=a.insetPolygon(this.points.map(function(t){return{x:t.x,y:t.z}}),this.params.width).map(function(t){return{x:t.x,y:e,z:t.y}});var x=i.extrudeAll(t,this.height,"Quad",[0,1,0]);return x.forEach(function(t){var e=t.points[3].x-t.points[0].x,r=t.points[1].y-t.points[0].y,i=t.points[3].z-t.points[0].z,o=n/h.UVSCALE,a=o*Math.sqrt(e*e+i*i)/r;t.uvs=[{s:0,t:o},{s:0,t:0},{s:a,t:0},{s:a,t:o}],t.texID=6}),x.push({sym:"Poly",texID:6,points:t}),x.push({sym:"Poly",texID:6,points:t.map(function(t){return{x:t.x,y:t.y+n,z:t.z}})}),x}),h.define("FL_Rooftop",null,function(){for(var t=[],n=this.height,e=this.points[0].y,r=0,o=this.points.length;o>r;r++){var s=this.points[r],u=this.points[(r+1)%o],l=Math.atan2(u.z-s.z,u.x-s.x),c=l-Math.PI/2;
Math.cos(l)+Math.cos(c),Math.sin(l)+Math.sin(c)}t=a.insetPolygon(this.points.map(function(t){return{x:t.x,y:t.z}}),-this.params.width).map(function(t){return{x:t.x,y:e,z:t.y}});for(var x=i.extrudeAll(this.points,this.height,"Quad",[0,1,0]),p=i.extrudeAll(t,this.height,"Quad",[0,1,0]);x.length;)p.push(x.shift());p.forEach(function(t){var e=t.points[3].x-t.points[0].x,r=t.points[1].y-t.points[0].y,i=t.points[3].z-t.points[0].z,o=n/h.UVSCALE,a=o*Math.sqrt(e*e+i*i)/r;t.uvs=[{s:0,t:o},{s:0,t:0},{s:a,t:0},{s:a,t:o}],t.texID=6}),p.push({sym:"Poly",points:t,texID:3});for(var r=0,o=t.length;o>r;r++){var f=(r+1)%o,s=this.points[r],u=t[r],d=t[f],v=this.points[f],m={sym:"Poly",points:[s,u,d,s,d,v].map(function(t){return{x:t.x,y:t.y+n,z:t.z}}),texID:6};p.push(m)}return p}),h.define("Facade",function(){return"OneDoor"===this.type},function(){var t=this.points[3].x-this.points[0].x,n=this.points[1].y-this.points[0].y,e=this.points[3].z-this.points[0].z,r=n/h.UVSCALE,o=r*Math.sqrt(t*t+e*e)/n;this.uvs=[{s:0,t:r},{s:0,t:0},{s:o,t:0},{s:o,t:r}];var a=i.fit("x",this,"Window",1);a[~~(a.length/2)].sym="Door";for(var s=0,u=a.length;u>s;s++)a[s].normal=this.normal;return a}),h.define("Facade",null,function(){var t=this.points[3].x-this.points[0].x,n=this.points[1].y-this.points[0].y,e=this.points[3].z-this.points[0].z,o=Math.sqrt(t*t+e*e),a=n/h.UVSCALE,s=a*o/n,l=null,c=this.normal;this.uvs=[{s:0,t:a},{s:0,t:0},{s:s,t:0},{s:s,t:a}];var x=i.fit("x",this,"Window",1).map(function(t){return t.normal=c,t});if("Window"===this.type);else if("function"==typeof this.type)for(var p=0,f=x.length;f>p;p++)this.type(p)||(x[p].sym="Quad",x[p].texID=6);if(this.hasBalcony){var d=(x.length%2===0?2:3)/x.length,v={x0:this.points[0].x,z0:this.points[0].z,x1:this.points[3].x,z1:this.points[3].z,y:this.points[0].y,height:n,width:.9*o*d,depth:.4*o*d,angle:Math.atan2(-e,t)};l=u.createBalconyWithStairs(v),l.sym=r.TERMINAL}for(var p=0,f=x.length;f>p;p++)x[p].normal=this.normal;return null!==l&&x.push(l),x}),h.define("Window",null,function(){var t=i.split(this,[.3,.4,.3],[1],"Quad"),n=i.split(t[1],[1],[.15,.7,.15],"Quad"),e=n[1],r=l.random()>.8;e.uvs;e.uvs=null,e.texID=r?5:4,t[0].texID=t[2].texID=n[0].texID=n[2].texID=6;var o=[t[0],t[2],n[0],n[2]],s=this.normal||a.triToNormal([e.points[0].x,e.points[0].y,e.points[0].z,e.points[1].x,e.points[1].y,e.points[1].z,e.points[2].x,e.points[2].y,e.points[2].z]),u=i.extrudeAll(e.points,-.005,"Quad",s),h=s[0],c=s[1],x=s[2];h*=.005,c*=.005,x*=.005;for(var p=0,f=e.points.length;f>p;p++){var d=e.points[p];d.x-=h,d.y-=c,d.z-=x}for(var p=0,f=u.length;f>p;p++)u[p].texID=3,o.push(u[p]);return o.push(e),o}),h.define("Door",null,function(){var t=i.split(this,[.15,.7,.15],[1],"Quad"),n=i.split(t[1],[1],[.7,.3],"Quad"),e=n[0];e.uvs;e.uvs=null,e.texID=l.random()>.3?4:5,t[0].texID=t[2].texID=n[1].texID=6;var r=[t[0],t[2],n[1]],o=a.triToNormal([e.points[0].x,e.points[0].y,e.points[0].z,e.points[1].x,e.points[1].y,e.points[1].z,e.points[2].x,e.points[2].y,e.points[2].z]),s=i.extrudeAll(e.points,-.005,"Quad",o),u=o[0],h=o[1],c=o[2];u*=.005,h*=.005,c*=.005;for(var x=0,p=e.points.length;p>x;x++){var f=e.points[x];f.x-=u,f.y-=h,f.z-=c}for(var x=0,p=s.length;p>x;x++)s[x].texID=3,r.push(s[x]);return r.push(e),r}),h.define("Quad",null,function(){var t=[{s:0,t:1},{s:0,t:0},{s:1,t:0},{s:1,t:1}];return function(){var n,e,i,o,s,u,h,l,c,x,p,f,d=[],v=this.points;c=v[0],x=v[1],p=v[2],f=v[3],n=[c.x,c.y,c.z,x.x,x.y,x.z,p.x,p.y,p.z,c.x,c.y,c.z,p.x,p.y,p.z,f.x,f.y,f.z],i=this.normal||a.triToNormal(n);for(var m=0;6>m;m++)d.push(i[0],i[1],i[2]);return e=this.uvs||t,s=e[0],u=e[1],h=e[2],l=e[3],o=this.texID||0,e=[s.s,s.t,o,u.s,u.t,o,h.s,h.t,o,s.s,s.t,o,h.s,h.t,o,l.s,l.t,o],{sym:r.TERMINAL,vertices:n,normals:d,uvs:e}}}()),h.define("Poly",null,function(){var t,n,e,i,s,u,h,l=this.points.map(function(t){return[t.x,t.z]}),c=this.points[0].y,x=o([l]),p=x.reduce(function(t,n){return t.push(n[0],c,n[1]),t},[]),f=this.normal||a.triToNormal(p),d=[],v=[];t=n=Number.POSITIVE_INFINITY,e=i=Number.NEGATIVE_INFINITY;for(var m=0,y=this.points.length;y>m;m++)h=this.points[m],t>h.x&&(t=h.x),e<h.x&&(e=h.x),n>h.z&&(n=h.z),i<h.z&&(i=h.z);s=e-t,u=i-n;for(var m=0,y=p.length;y>m;m+=3){var g=p[m],z=p[m+2];v.push((g-t)/s,(z-n)/u,this.texID),d.push(f[0],f[1],f[2])}return{sym:r.TERMINAL,vertices:p,normals:d,uvs:v}});var f=[[.9,.65,.48],[.75,.73,.69],[.82,.67,.42],[.6,.39,.33]];h.UVSCALE=.1,n.exports={shg:h,create:function(t){var n=t.width/2,e=t.depth/2,r=t.x-n,i=t.x+n,o=t.y-e,a=t.y+e,s=Math.max(n/e,e/n),u=null,l=!1,d=[];if(1.3>s&&c.random()<.3)for(var v=0;8>v;v++){var m=-t.angle-v*Math.PI/4;d.push({x:t.x+n*Math.cos(m),y:0,z:t.y+e*Math.sin(m)}),u=0}else if(s>1.1&&c.random()<.8){l=!0;var y=2/2.7;n>e?t.angle<.1?(d.push({x:r,y:0,z:o},{x:r,y:0,z:a},{x:r+n*y,y:0,z:a},{x:r+n*y,y:0,z:a-e*y},{x:i-n*y,y:0,z:a-e*y},{x:i-n*y,y:0,z:a},{x:i,y:0,z:a},{x:i,y:0,z:o}),u=3):(d.push({x:r,y:0,z:o},{x:r,y:0,z:a},{x:i,y:0,z:a},{x:i,y:0,z:o},{x:i-n*y,y:0,z:o},{x:i-n*y,y:0,z:o+e*y},{x:r+n*y,y:0,z:o+e*y},{x:r+n*y,y:0,z:o}),u=5):t.angle>0?(d.push({x:r,y:0,z:o},{x:r,y:0,z:o+e*y},{x:r+n*y,y:0,z:o+e*y},{x:r+n*y,y:0,z:a-e*y},{x:r,y:0,z:a-e*y},{x:r,y:0,z:a},{x:i,y:0,z:a},{x:i,y:0,z:o}),u=2):(d.push({x:r,y:0,z:o},{x:r,y:0,z:a},{x:i,y:0,z:a},{x:i,y:0,z:a-e*y},{x:i-n*y,y:0,z:a-e*y},{x:i-n*y,y:0,z:o+e*y},{x:i,y:0,z:o+e*y},{x:i,y:0,z:o}),u=4)}else d.push({x:r,y:0,z:o},{x:r,y:0,z:a},{x:i,y:0,z:a},{x:i,y:0,z:o}),u=n>e?t.angle<.1?1:3:t.angle<0?2:0;var g=[],z=~~(2*x.random()),b=[];switch(z){case 0:g.push({type:"FL_GndFloor",height:.05,tiles:"OneDoor",frontSide:t.angle},{type:"FL_Ledge",height:.00625,width:.00625});for(var v=0,E=4+~~(20*p.random());E>v;v++)g.push({type:"FL_Floor",height:.05,windows:"Double"});g.push({type:"FL_Ledge",height:.00625,width:.00625},{type:"FL_Floor",height:.0625,windows:"Single"},{type:"FL_Rooftop",height:.00625,width:.00625});break;case 1:g.push({type:"FL_GndFloor",height:.05,tiles:"OneDoor",frontSide:t.angle});for(var v=0,E=4+~~(10*p.random());E>v;v++)g.push({type:"FL_Floor",height:.05,windows:"Double"});g.push({type:"FL_Floor",height:.05,windows:"Single"},{type:"FL_Rooftop",height:.00625,width:.00625})}for(var v=0,E=d.length;E>v;v++){var M=~~(3*p.random());switch(M){case 0:b[v]="Windows";break;case 1:b[v]=function(t){return!(t%3===0)};break;case 2:b[v]=function(t){return t%2===0}}}var T={sym:"Building",floorsLayout:g,facadeLayout:b,points:d};null!==u&&(T.frontFacade=u),l&&(T.hasBalcony=!0);var w=f[~~(p.random()*f.length)],R=h.run(T);return{geom:R,color:w}},getGeom:function(){return context}}},{"../lib/SHAPE.js":15,"./../lib/Geom":11,"./../lib/ShapeGrammar":16,"./BalconySHG.js":3,"./PRNG":8,earcut:20}],6:[function(t,n,e){var r=new(t("./PRNG")),i=t("./../lib/Geom"),o=t("./Roads.js"),a=t("./Block.js"),s=(t("../lib/ShapeGrammar.js"),function(){var t=2*Math.PI;return function(n,e,r,o){var a,u,h,l=Math.atan2(-e.y+n.y,e.x-n.x),c={th:Number.POSITIVE_INFINITY,vertex:null};"traversed"in n||(n.traversed=[]),"traversed"in e||(e.traversed=[]),n.traversed.push(e);for(var x=0;x<e.conns.length;x++)u=e.conns[x],u===n||-1!==e.traversed.indexOf(u)||o&&u!==o[0]&&-1!==o.indexOf(u)||(a=Math.atan2(-u.y+e.y,u.x-e.x)-l,a>Math.PI?a-=t:a<-Math.PI&&(a+=t),a<c.th&&(c.th=a,c.vertex=e.conns[x]));return null===c.vertex?null:(o&&o.push(e),o&&c.vertex===o[0]?(h=i.isOverlapping(o,r))?null:(e.traversed.push(o[0]),o):(o=s(e,c.vertex,r,o||[n,e]),null===o&&e.traversed.splice(e.traversed.indexOf(c.vertex),1),o||null))}}()),u=function(t){r.seed(t);var n=[];this.roads=o(),this.blocks=[];for(var e=0;e<this.roads.length;e++)for(var u=0;u<this.roads[e].conns.length;u++){"traversed"in this.roads[e]||(this.roads[e].traversed=[]);var h=s(this.roads[e],this.roads[e].conns[u],this.roads);null===h||i.isPolyIn(h,n)||(n.push(h),this.blocks.push(new a(h,65536*r.random())))}this.roads.forEach(function(t){t.traversed=[]});var l=[];this.roads.forEach(function(t){t.conns.forEach(function(n){-1===n.traversed.indexOf(t)&&(l.push([t,n]),t.traversed.push(n),n.traversed.push(t))})}),this.roadQuads=l};n.exports=u},{"../lib/ShapeGrammar.js":16,"./../lib/Geom":11,"./Block.js":4,"./PRNG":8,"./Roads.js":9}],7:[function(t,n,e){var r=t("./../lib/ShapeGrammar"),i=t("../lib/SHAPE.js"),o=(t("earcut"),t("./../lib/Geom")),a=(t("./PRNG"),new r),s=function(t){return function(n,e){return n=n.concat(i.extrudeAll(e,t,"Quad",[0,-1,0])),n.push({sym:"Quad",points:e}),n.push({sym:"Quad",points:e.map(function(n){return{x:n.x,y:n.y-t,z:n.z}})}),n}},u=function(t){var n=t.vertices.reduce(function(t,n,e){var r=e%3;switch(r){case 0:t.mX=Math.min(t.mX,n),t.MX=Math.max(t.MX,n);break;case 1:t.mY=Math.min(t.mY,n),t.MY=Math.max(t.MY,n);break;case 2:t.mZ=Math.min(t.mZ,n),t.MZ=Math.max(t.MZ,n)}return t},{mX:Number.POSITIVE_INFINITY,MX:Number.NEGATIVE_INFINITY,mY:Number.POSITIVE_INFINITY,MY:Number.NEGATIVE_INFINITY,mZ:Number.POSITIVE_INFINITY,MZ:Number.NEGATIVE_INFINITY});n.lX=n.MX-n.mX,n.lY=n.MY-n.mY,n.lZ=n.MZ-n.mZ;for(var e=t.extra,r=t.vertices,i=0,o=t.vertices.length;o>i;i+=3)e[i]=(r[i]-n.mX)/n.lX,e[i+1]=(r[i+1]-n.mY)/n.lY,e[i+2]=(r[i+2]-n.mZ)/n.lZ;return t};a.define("Chair",null,function(){var t=this.woodThk,n=this.width,e=this.height,r=2*t-.5,i=-r,o=this.cy,a=n/2,u=e/2,h=2*t,l=[{x:r,z:r},{x:r,z:i},{x:i,z:i},{x:i,z:r}].map(function(e){return[{x:n*e.x-t,y:o,z:n*e.z-t},{x:n*e.x-t,y:o,z:n*e.z+t},{x:n*e.x+t,y:o,z:n*e.z+t},{x:n*e.x+t,y:o,z:n*e.z-t}]}),c=[];return c=l.reduce(s(u),c),c=s(-h).call(null,c,[{x:-a,y:o,z:a},{x:-a,y:o,z:-a},{x:a,y:o,z:-a},{x:a,y:o,z:a}]),c=s(-u).call(null,c,[{x:-a,y:h+o,z:-a+h},{x:-a,y:h+o,z:-a},{x:a,y:h+o,z:-a},{x:a,y:h+o,z:-a+h}]).map(function(t){return t.texID=7,t})}),a.define("Table",null,function(){var t=this.woodThk,n=this.width,e=this.height,r=2*t-.5,i=-r,o=this.cy,a=n/2,u=2*t,h=[{x:r,z:r},{x:r,z:i},{x:i,z:i},{x:i,z:r}].map(function(e){return[{x:n*e.x-t,y:o,z:n*e.z-t},{x:n*e.x-t,y:o,z:n*e.z+t},{x:n*e.x+t,y:o,z:n*e.z+t},{x:n*e.x+t,y:o,z:n*e.z-t}]}),l=[];return l=h.reduce(s(e),l),l=s(-u).call(null,l,[{x:-a,y:o,z:a},{x:-a,y:o,z:-a},{x:a,y:o,z:-a},{x:a,y:o,z:a}]).map(function(t){return t.texID=7,t})}),a.define("Lamp",null,function(){for(var t=this.rings,n=this.sectors,e=null,r=[],i=[],o=0;t>o;o++){for(var a=0;n>a;a++){var s=Math.sin(.5*Math.PI*(o+1)/t)*this.radius;r.push({x:Math.cos(2*Math.PI*a/n)*s,z:Math.sin(2*Math.PI*a/n)*s,y:-o/t*this.height})}if(null!==e)for(var a=0;n>a;a++){var u=r[a],h=e[a],l=e[(a+1)%n],c=r[(a+1)%n];i.push({sym:"Quad",texID:7,points:[{x:u.x,y:u.y,z:u.z},{x:h.x,y:h.y,z:h.z},{x:l.x,y:l.y,z:l.z},{x:c.x,y:c.y,z:c.z}]})}e=r,r=[]}return i}),a.define("Quad",null,function(){var t=[{s:0,t:1},{s:0,t:0},{s:1,t:0},{s:1,t:1}];return function(){var n,e,i,a,s,u,h,l,c,x,p,f,d=[],v=this.points;c=v[0],x=v[1],p=v[2],f=v[3],n=[c.x,c.y,c.z,x.x,x.y,x.z,p.x,p.y,p.z,c.x,c.y,c.z,p.x,p.y,p.z,f.x,f.y,f.z],i=this.normal||o.triToNormal(n);for(var m=0;6>m;m++)d.push(i[0],i[1],i[2]);return e=this.uvs||t,s=e[0],u=e[1],h=e[2],l=e[3],a=this.texID||0,e=[s.s,s.t,a,u.s,u.t,a,h.s,h.t,a,s.s,s.t,a,h.s,h.t,a,l.s,l.t,a],{sym:r.TERMINAL,vertices:n,normals:d,uvs:e}}}());var h=a.run({sym:"Table",cy:.4,width:.75,height:.4,woodThk:.025}).reduce(function(t,n){for(var e=0,r=n.vertices.length;r>e;e++)t.vertices.push(n.vertices[e]),t.normals.push(n.normals[e]),t.uvs.push(n.uvs[e]);return t},{vertices:[],normals:[],uvs:[],extra:[]}),l=a.run({sym:"Chair",cy:-.5,width:.5,height:1,woodThk:.03125}).reduce(function(t,n){for(var e=0,r=n.vertices.length;r>e;e++)t.vertices.push(n.vertices[e]),t.normals.push(n.normals[e]),t.uvs.push(n.uvs[e]);return t},{vertices:[],normals:[],uvs:[],extra:[]}),c=a.run({sym:"Lamp",rings:8,sectors:16,radius:.125,height:.25}).reduce(function(t,n){for(var e=0,r=n.vertices.length;r>e;e++)t.vertices.push(n.vertices[e]),t.normals.push(n.normals[e]),t.uvs.push(n.uvs[e]);return t},{vertices:[],normals:[],uvs:[],extra:[]});c=u(c),l=u(l),h=u(h);var x=function(t){return function(n,e,r){return{vertices:t.vertices.map(function(t,i){switch(i%3){case 0:return t+n;case 1:return t+e;case 2:return t+r}}),normals:t.normals,uvs:t.uvs,extra:t.extra}}};n.exports={lamp:x(c),table:x(h),chair:x(l)}},{"../lib/SHAPE.js":15,"./../lib/Geom":11,"./../lib/ShapeGrammar":16,"./PRNG":8,earcut:20}],8:[function(t,n,e){var r=t("mersennetwister"),i=function(t){void 0!==t?this.seed(t):this.mt=new r};i.prototype.seed=function(t){this.mt=new r(t)},i.prototype.random=function(){return this.mt.random()},n.exports=i},{mersennetwister:21}],9:[function(t,n,e){var r=t("./PRNG"),i=3,o=0,a=2;n.exports=function(t){for(var n=[],e=new r(t),s=0;i>s;s++)for(var u=0;i>u;u++){var h=n[s*i+u]={x:a*u+o*e.random(),y:a*s+o*e.random(),conns:[]};u>0&&(h.conns.push(n[s*i+u-1]),n[s*i+u-1].conns.push(h)),s>0&&(h.conns.push(n[(s-1)*i+u]),n[(s-1)*i+u].conns.push(h))}return n}},{"./PRNG":8}],10:[function(t,n,e){var r=t("./../lib/ShapeGrammar"),i=t("./../Context"),o=t("../lib/SHAPE.js"),a=(t("earcut"),t("./../lib/Geom")),s=t("./PRNG"),u=t("./FurnitureSHG.js"),h=new r,l=new s(12345);h.define("Apartment",null,function(){var t=o.extrudeAll(this.points,h.floorHeight,"Quad",[0,1,0]);return t.push({sym:"Room",points:this.points}),t}),h.define("Room",function(){var t=o.bounds(this);return t.width>t.depth&&(t.width>h.minWidth&&l.random()<h.density||t.width>h.maxWidth)},function(){var t=o.splitXZ(this,[h.ratio,1-h.ratio],[1],"Room");return t}),h.define("Room",function(){var t=o.bounds(this);return t.width<=t.depth&&(t.depth>h.minWidth&&l.random()<h.density||t.width>h.maxWidth)},function(){var t=o.splitXZ(this,[1],[h.ratio,1-h.ratio],"Room");return t}),h.define("Room",null,function(t){for(var n=this.points,e=[],r=o.inset(this.points,.05),i=o.bounds(this),e=[],a=0,s=n.length;s>a;a++){var u,l,c=r[a],x=r[(a+1)%s],p=x.x-c.x,f=x.z-c.z,d=Math.atan2(f,p),v=d+Math.PI/2,m=Math.sin(d),y=Math.cos(d),g=Math.sin(v),z=Math.cos(v);u={x:c.x+.3*y,y:c.y,z:c.z+.3*m},l={x:x.x-.3*y,y:x.y,z:x.z-.3*m},e.push({sym:"Wall",points:[n[a],n[(a+1)%s]],p0:u,p1:l,boundaries:[{x:u.x-.1*z,z:u.z-.1*g},{x:u.x+.1*z,z:u.z+.1*g},{x:l.x+.1*z,z:l.z+.1*g},{x:l.x-.1*z,z:l.z-.1*g}].reduce(function(t,n){return{maxX:Math.max(t.maxX,n.x),maxZ:Math.max(t.maxZ,n.z),minX:Math.min(t.minX,n.x),minZ:Math.min(t.minZ,n.z)}},{maxX:Number.NEGATIVE_INFINITY,maxZ:Number.NEGATIVE_INFINITY,minX:Number.POSITIVE_INFINITY,minZ:Number.POSITIVE_INFINITY}),length:Math.sqrt(p*p+f*f),angle:d})}e.push({sym:"Quad",points:this.points});var b=1/n.length,E={sym:"GraphNode",isTerminal:!0,neighbors:[],width:i.width,depth:i.depth,roomCentroid:this.points.reduce(function(t,n){return t.x+=b*n.x,t.y+=b*n.y,t.z+=b*n.z,t},{x:0,y:0,z:0})};return e.forEach(function(t){"Wall"===t.sym&&(t.room=E)}),e.push({sym:"LastRoomCandidate",node:E,points:n}),e.push({sym:"Lamp",isTerminal:!0,point:{x:E.roomCentroid.x,y:this.points[0].y+h.floorHeight,z:E.roomCentroid.z}}),i.width*i.depth>10&&e.push({sym:"Table",isTerminal:!0,point:{x:E.roomCentroid.x+.7*i.width*(Math.random()-.5),y:this.points[0].y,z:E.roomCentroid.z+.7*i.depth*(Math.random()-.5)}}),e}),h.define("LastRoomCandidate",function(t){return t.filter(function(t){return"Room"===t.sym}).length>0},function(t){return this}),h.define("LastRoomCandidate",function(t){return 0===t.filter(function(t){return"LastRoomCandidate"===t.sym}).indexOf(this)},function(t){return this.node.isFirst=!0,this.node}),h.define("LastRoomCandidate",function(t){return 0===t.filter(function(t){return"LastRoomCandidate"===t.sym}).reverse().indexOf(this)},function(t){return this.node.isLast=!0,[this.node,{sym:"LastRoom",node:this.node}]}),h.define("LastRoomCandidate",null,function(t){return this.node}),h.define("LastRoom",function(t){return t.filter(function(t){return"OccludedWall"===t.sym}).length>0},function(){return this}),h.define("LastRoom",null,function(){console.log(this.node);var t,n=this.node.neighbors.map(function(t){return t.r.roomCentroid}),e=this.node.roomCentroid,r=.99*this.node.width/2,o=.99*this.node.depth/2;t=[{x:e.x,y:e.y,z:e.z+o,mdd:Number.POSITIVE_INFINITY,th:Math.atan2(o,0)},{x:e.x,y:e.y,z:e.z-o,mdd:Number.POSITIVE_INFINITY,th:Math.atan2(-o,0)},{x:e.x+r,y:e.y,z:e.z,mdd:Number.POSITIVE_INFINITY,th:Math.atan2(0,r)},{x:e.x-r,y:e.y,z:e.z,mdd:Number.POSITIVE_INFINITY,th:Math.atan2(0,-r)}],t.forEach(function(t){n.forEach(function(n){var e=n.x-t.x,r=n.z-t.z;t.mdd=Math.min(t.mdd,e*e+r*r)})});var a=t.sort(function(t,n){return t.mdd>n.mdd?-1:n.mdd>t.mdd?1:0}).shift(),s=.025,u=Math.sin(a.th)*s*i.aspectRatio,h=Math.cos(a.th)*s*i.aspectRatio,l={sym:"Quad",texID:8,points:[{x:a.x+u,y:a.y+.75+s,z:a.z-h},{x:a.x+u,y:a.y+.75-s,z:a.z-h},{x:a.x-u,y:a.y+.75-s,z:a.z+h},{x:a.x-u,y:a.y+.75+s,z:a.z+h}]},c={sym:"GraphFinalNode",isTerminal:!0,roomCentroid:a,neighbors:[this.node],isMonitor:!0,door:{angle:a.th,point:e}};return this.node.neighbors.push({r:c,via:c.door}),console.log(l),[l,c]}),h.define("Wall",function(t){return!t.reduce(function(t,n){return t||"Room"===n.sym},!1)},function(t){var n=this.boundaries.maxX,e=this.boundaries.maxZ,r=this.boundaries.minX,i=this.boundaries.minZ,o=this,a=this.length,s=t.reduce(function(t,s){if(t.occluded||s===o||"Wall"!==s.sym)return t;var u=s.boundaries;return s.length>=a&&!(n<u.minX||u.maxX<r||e<u.minZ||u.maxZ<i)&&(t.occluded=!0,t.by=s.room),t},{occluded:!1,by:null});return s.occluded?(this.occluded=!0,{sym:"OccludedWall",points:this.points,angle:this.angle,connects:[this.room,s.by],length:this.length}):[]}),h.define("Wall",null,function(){return this}),h.define("OccludedWall",null,function(){var t,n=this.angle+Math.PI/2,e=Math.sin(n)*h.wallDepth/2,r=Math.cos(n)*h.wallDepth/2,i=this.points[0],a=this.points[1],s={x:i.x+r,y:i.y,z:i.z+e},u={x:a.x+r,y:a.y,z:a.z+e},l={x:i.x-r,y:i.y,z:i.z-e},c={x:a.x-r,y:a.y,z:a.z-e},x=o.extrude("OccludedWall",s,u,h.floorHeight,[0,1,0]),p=o.extrude("OccludedWall",l,c,h.floorHeight,[0,1,0]),f=.5/this.length,d=(1-f)/2,v=o.split(x,[d,f,d],[1],"Quad"),m=o.split(v[1],[1],[.7,.3],"Quad"),y=o.split(p,[d,f,d],[1],"Quad"),g=o.split(y[1],[1],[.7,.3],"Quad"),z=m[0],b=g[0],E=(1-f/8)/2,M=E+f/8,T={x:o.lerp(i.x,a.x,E),y:o.lerp(i.y,a.y,E),z:o.lerp(i.z,a.z,E)},w={x:o.lerp(i.x,a.x,M),y:o.lerp(i.y,a.y,M),z:o.lerp(i.z,a.z,M)};return t={sym:"Door",angle:n,point:{x:.5*(i.x+a.x),y:.5*(i.y+a.y),z:.5*(i.z+a.z)}},this.connects[0].neighbors.push({r:this.connects[1],via:t}),this.connects[1].neighbors.push({r:this.connects[0],via:t}),[v[0],v[2],m[1],y[0],y[2],g[1],{sym:"Quad",points:[b.points[1],b.points[0],z.points[0],z.points[1]]},{sym:"Quad",points:[b.points[3],b.points[2],z.points[2],z.points[3]]},{sym:"Quad",points:[b.points[2],b.points[1],z.points[1],z.points[2]]},t,{sym:"WallSegment",points:[i,T]},{sym:"WallSegment",points:[w,a]}]}),h.define("Quad",null,function(){var t=[{s:0,t:1},{s:0,t:0},{s:1,t:0},{s:1,t:1}];return function(){var n,e,r,i,o,s,u,h,l,c,x,p,f=[],d=this.points;l=d[0],c=d[1],x=d[2],p=d[3],n=[l.x,l.y,l.z,c.x,c.y,c.z,x.x,x.y,x.z,l.x,l.y,l.z,x.x,x.y,x.z,p.x,p.y,p.z],r=this.normal||a.triToNormal(n);for(var v=0;6>v;v++)f.push(r[0],r[1],r[2]);return e=this.uvs||t,o=e[0],s=e[1],u=e[2],h=e[3],i=this.texID||3,e=[o.s,o.t,i,s.s,s.t,i,u.s,u.t,i,o.s,o.t,i,u.s,u.t,i,h.s,h.t,i],{sym:"Quad",isTerminal:!0,vertices:n,normals:f,uvs:e}}}()),h.define("Door",null,function(){return{sym:"Door",isTerminal:!0,point:this.point,angle:this.angle}}),h.define("WallSegment",null,function(){return{sym:"Wall",isTerminal:!0,p0:this.points[0],p1:this.points[1]}}),h.minWidth=4,h.maxWidth=7,h.density=.8,h.ratio=.61,h.floorHeight=1.5,h.wallDepth=.2,n.exports={shg:h,create:function(t){var n=h.run({sym:"Apartment",points:t}).reduce(function(t,n){switch(n.sym){case"Quad":for(var e=0,r=n.vertices.length;r>e;e++)t.vertices.push(n.vertices[e]),t.normals.push(n.normals[e]),t.uvs.push(n.uvs[e]);break;case"Lamp":for(var i=u.lamp(n.point.x,n.point.y,n.point.z),e=0,r=i.vertices.length;r>e;e++)t.lamp.vertices.push(i.vertices[e]),t.lamp.normals.push(i.normals[e]),t.lamp.uvs.push(i.uvs[e]),t.lamp.extra.push(i.extra[e]);break;case"Table":for(var o=u.table(n.point.x,n.point.y,n.point.z),e=0,r=o.vertices.length;r>e;e++)t.table.vertices.push(o.vertices[e]),t.table.normals.push(o.normals[e]),t.table.uvs.push(o.uvs[e]),t.table.extra.push(o.extra[e]);break;case"Chair":for(var a=u.chair(n.point.x,n.point.y,n.point.z),e=0,r=a.vertices.length;r>e;e++)t.chair.vertices.push(a.vertices[e]),t.chair.normals.push(a.normals[e]),t.chair.uvs.push(a.uvs[e]),t.chair.extra.push(a.extra[e]);break;case"Wall":t.walls.push(n);break;case"Door":t.doors.push(n);break;case"GraphNode":t.rooms.push(n),t.nodes.push(n);break;case"GraphFinalNode":t.monitor=n}return t},{vertices:[],normals:[],uvs:[],walls:[],rooms:[],nodes:[],arcs:[],doors:[],lamp:{vertices:[],normals:[],uvs:[],extra:[]},table:{vertices:[],normals:[],uvs:[],extra:[]},chair:{vertices:[],normals:[],uvs:[],extra:[]},monitor:null}),e=t.reduce(function(t,n){return t.minX=Math.min(n.x,t.minX),t.minZ=Math.min(n.z,t.minZ),t.maxX=Math.max(n.x,t.maxX),t.maxZ=Math.max(n.z,t.maxZ),t},{minX:Number.POSITIVE_INFINITY,maxX:Number.NEGATIVE_INFINITY,minZ:Number.POSITIVE_INFINITY,maxZ:Number.NEGATIVE_INFINITY});return e.lenX=e.maxX-e.minX,e.lenZ=e.maxZ-e.minZ,n.lines=n.walls.reduce(function(t,n){return t.push((n.p0.x-e.minX)/e.lenX,(n.p0.z-e.minZ)/e.lenZ,(n.p1.x-e.minX)/e.lenX,(n.p1.z-e.minZ)/e.lenZ),t},[]),n.roomsWorld=n.rooms.map(function(t){return t.roomCentroid}),n.rooms=n.rooms.reduce(function(t,n){return t.push({x:(n.roomCentroid.x-e.minX)/e.lenX,y:(n.roomCentroid.y-e.minY)/e.lenY,z:(n.roomCentroid.z-e.minZ)/e.lenZ}),t},[]),n.width=e.lenX,n.height=e.lenZ,n.bbox=e,n}}},{"../lib/SHAPE.js":15,"./../Context":1,"./../lib/Geom":11,"./../lib/ShapeGrammar":16,"./FurnitureSHG.js":7,"./PRNG":8,earcut:20}],11:[function(t,n,e){var r=t("./glMatrixSubset"),i=(r.vec3,{pnpoly:function(t,n,e){var r,i,o,a,s=t.length,u=!1;for(r=0,i=s-1;s>r;i=r++)o=t[r],a=t[i],o.y>e!=a.y>e&&n<(a.x-o.x)*(e-o.y)/(a.y-o.y)+o.x&&(u=!u);return u},isOverlapping:function(t,n){for(var e=n.length-1;e--;)if(i.pnpoly(t,n[e].x,n[e].y)&&-1===t.indexOf(n[e]))return!0;return!1},isPolyIn:function(t,n){for(var e=n.length-1;e>0;e--)if(i.isEqualPoly(t,n[e]))return!0;return!1},isEqualPoly:function(t,n){if(t.length!==n.length)return!1;for(var e=t.length-1;e--;)if(-1===n.indexOf(t[e]))return!1;return!0},insetPolygon:function(t,n){var e,r,o,a=[];r=t[t.length-1];for(var s=0;s<t.length-1;s++)e=r,r=t[s],o=t[s+1],a.push(i.insetCorner(e,r,o,n));return a.push(i.insetCorner(r,o,t[0],n)),a},insetCorner:function(t,n,e,r){var o,a,s,u,h=n.x-t.x,l=t.y-n.y,c=e.x-n.x,x=n.y-e.y,p=Math.sqrt(h*h+l*l),f=Math.sqrt(c*c+x*x),d={x:n.x,y:n.y},v={x:n.x,y:n.y};return 0==p||0==f?null:(o=l/p*r,s=h/p*r,a=x/f*r,u=c/f*r,d.x+=o,d.y+=s,v.x+=a,v.y+=u,d.x===v.x&&d.y===v.y?d:i.lineIntersection({x:t.x+o,y:t.y+s},d,v,{x:e.x+a,y:e.y+u}))},lineIntersection:function(t,n,e,r){var i,o,a,s,u,h={x:t.x,y:t.y},l={x:n.x,y:n.y},c={x:e.x,y:e.y},x={x:r.x,y:r.y};return l.x-=h.x,c.x-=h.x,x.x-=h.x,l.y-=h.y,c.y-=h.y,x.y-=h.y,i=Math.sqrt(l.x*l.x+l.y*l.y),o=l.x/i,a=l.y/i,s=c.x*o+c.y*a,c.y=-c.x*a+c.y*o,c.x=s,s=x.x*o+x.y*a,x.y=-x.x*a+x.y*o,x.x=s,c.y==x.y?null:(u=x.x+(c.x-x.x)*x.y/(x.y-c.y),{x:h.x+u*o,y:h.y+u*a})},triToNormal:function(t){var n=t[0]-t[3],e=t[1]-t[4],r=t[2]-t[5],i=t[6]-t[3],o=t[7]-t[4],a=t[8]-t[5],s=e*a-r*o,u=n*a-r*i,h=n*o-e*i,l=1/Math.sqrt(s*s+u*u+h*h);return s*=l,u*=l,h*=l,[s,u,h]}});n.exports=i},{"./glMatrixSubset":17}],12:[function(t,n,e){var r=t("./../Context"),o={},a=document.createElement("ul");a.style.position="absolute",a.style.top="7rem",a.style.left="1rem",a.style.color="#444",a.style.font='10px "Ubuntu Mono", monospace',a.style.lineHeight="1.5em",a.style.listStyleType="none",r.canvas.parentNode.appendChild(a),n.exports={progress:function(t,n){if(!(t in o)){var e=document.createElement("li");a.appendChild(e),o[t]={fns:[],li:e,value:0}}o[t].value=n,n>=1&&o[t].fns.forEach(function(t){t()})},subscribe:function(t,n){if(!(t in o)){var e=document.createElement("li");a.appendChild(e),o[t]={fns:[],li:e,value:0}}o[t].fns.push(n)},render:function(){for(i in o){for(var t=parseInt(100*o[i].value),n=""+t;n.length<4;)n="_"+n;n=n.replace(/_/g,"&nbsp;"),o[i].li.innerHTML="&nbsp;"+i+": "+n+"%&nbsp;\n";var e="linear-gradient(90deg, #0f0, #0f0 "+t+"%, #0b0 "+t+"%)";o[i].li.style.backgroundImage=e}}}},{"./../Context":1}],13:[function(t,n,e){var r=(t("./glMatrixSubset"),t("./../Context")),i=r.gl,o=function(t,n,e,r){this.vBuf=i.createBuffer(),this.nBuf=i.createBuffer(),this.uBuf=i.createBuffer(),this.eBuf=i.createBuffer(),this.count=t.length/3,i.bindBuffer(i.ARRAY_BUFFER,this.vBuf),i.bufferData(i.ARRAY_BUFFER,new Float32Array(t),i.STATIC_DRAW),i.bindBuffer(i.ARRAY_BUFFER,this.nBuf),i.bufferData(i.ARRAY_BUFFER,new Float32Array(n),i.STATIC_DRAW),i.bindBuffer(i.ARRAY_BUFFER,this.uBuf),i.bufferData(i.ARRAY_BUFFER,new Float32Array(e),i.STATIC_DRAW),i.bindBuffer(i.ARRAY_BUFFER,this.eBuf),i.bufferData(i.ARRAY_BUFFER,new Float32Array(r),i.STATIC_DRAW),i.bindBuffer(i.ARRAY_BUFFER,null)};n.exports=o},{"./../Context":1,"./glMatrixSubset":17}],14:[function(t,n,e){var r=function(t,n,e,r){this.nw=this.sw=this.ne=this.se=null,this.x=t,this.y=n,this.w=Math.abs(e),this.limit=r,this.points=[]};r.prototype.contains=function(t){return Math.abs(t.x-this.x)<this.w&&Math.abs(t.y-this.y)<this.w},r.prototype.insert=function(t){return this.contains(t)?this.points.length<this.limit?(this.points.push(t),!0):(null===this.nw&&this.subdivide(),this.nw.insert(t)||this.ne.insert(t)||this.sw.insert(t)||this.se.insert(t)):!1},r.prototype.subdivide=function(){var t=this.x,n=this.y,e=this.w/2;this.nw=new r(t-e,n-e,e,this.limit),this.sw=new r(t-e,n+e,e,this.limit),this.ne=new r(t+e,n-e,e,this.limit),this.se=new r(t+e,n+e,e,this.limit)},r.prototype.intersect=function(t,n,e){return Math.abs(this.x-t)<this.w+e&&Math.abs(this.y-n)<this.w+e},r.prototype.query=function(t,n,e){var r=[],o=[],a=this.points;if(!this.intersect(t,n,e))return r;for(var s=0,u=a.length;u>s;s++)i(a[s],t,n,e)&&r.push(a[s]);if(null===this.nw)return r;o=this.nw.query(t,n,e);for(var s=0,u=o.length;u>s;s++)r.push(o[s]);o=this.ne.query(t,n,e);for(var s=0,u=o.length;u>s;s++)r.push(o[s]);o=this.sw.query(t,n,e);for(var s=0,u=o.length;u>s;s++)r.push(o[s]);o=this.se.query(t,n,e);for(var s=0,u=o.length;u>s;s++)r.push(o[s]);return r};var i=function(t,n,e,r){return Math.abs(t.x-n)<r&&Math.abs(t.y-e)<r};n.exports=r},{}],15:[function(t,n,e){var r=t("./Geom"),i={extrude:function(t,n,e,r,i){var o=0,a=r,s=0;return void 0!==i&&(o=i[0]*r,a=i[1]*r,s=i[2]*r),{sym:t,points:[{x:n.x,y:n.y,z:n.z},{x:n.x+o,y:n.y+a,z:n.z+s},{x:e.x+o,y:e.y+a,z:e.z+s},{x:e.x,y:e.y,z:e.z}]}},extrudeAll:function(t,n,e,r){for(var o=[],a=0,s=t.length;s>a;++a){var u=t[a],h=t[(a+1)%s];o.push(i.extrude(e instanceof Array?e[a]:e,u,h,n,r))}return o},split:function(t,n,e,r){var o=[],a=0,s=r instanceof Array,u=t.points,h=t.uvs,l=u[0],c=u[1],x=u[2],p=u[3],f=l.x,d=(c.x,x.x,p.x),v=l.y,m=c.y,y=(x.y,p.y,l.z),g=(c.z,x.z,p.z),z=1,b=1,E=0,M=0;h instanceof Array&&(z=h[3].s-h[0].s,b=h[1].t-h[0].t,E=h[0].s,M=h[1].t);for(var T=0,w=0,R=e.length;R>w;++w){for(var A=0,I=T+e[w],F=0,S=n.length;S>F;++F){var _=A+n[F],P=i.lerp(f,d,A),N=i.lerp(f,d,_),D=i.lerp(v,m,T),L=i.lerp(v,m,I),C=i.lerp(y,g,A),B=i.lerp(y,g,_);o.push({sym:s?r[a++]:r,points:[{x:P,y:D,z:C},{x:P,y:L,z:C},{x:N,y:L,z:B},{x:N,y:D,z:B}],uvs:[{s:E+z*A,t:M+b*T},{s:E+z*A,t:M+b*I},{s:E+z*_,t:M+b*I},{s:E+z*_,t:M+b*T}]}),A=_}T=I}return o},splitXZ:function(t,n,e,r){for(var o=[],a=0,s=t.points,u=s[0],h=s[1],l=s[2],c=s[3],x=u.x,p=(h.x,l.x,c.x),f=u.y,d=h.y,v=(l.y,c.y,u.z),m=h.z,y=(l.z,c.z,0),g=0,z=e.length;z>g;++g){for(var b=0,E=0,M=n.length;M>E;++E){var T=i.lerp(x,p,b),w=i.lerp(x,p,b+n[E]),R=i.lerp(f,d,b),A=i.lerp(f,d,b+n[E]),I=i.lerp(v,m,y),F=i.lerp(v,m,y+e[g]);o.push({sym:r instanceof Array?r[a++]:r,points:[{x:T,y:R,z:I},{x:T,y:R,z:F},{x:w,y:A,z:F},{x:w,y:A,z:I}]}),b+=n[E]}y+=e[g]}return o},splitZX:function(t,n,e,r){for(var o=[],a=0,s=t.points,u=s[0],h=s[1],l=s[2],c=s[3],x=u.x,p=h.x,f=(l.x,c.x,u.y),d=h.y,v=(l.y,c.y,u.z),m=(h.z,l.z,c.z),y=0,g=0,z=e.length;z>g;++g){for(var b=0,E=0,M=n.length;M>E;++E){var T=i.lerp(x,p,b),w=i.lerp(x,p,b+n[E]),R=i.lerp(f,d,b),A=i.lerp(f,d,b+n[E]),I=i.lerp(v,m,y),F=i.lerp(v,m,y+e[g]);o.push({sym:r instanceof Array?r[a++]:r,points:[{x:T,y:R,z:I},{x:T,y:R,z:F},{x:w,y:A,z:F},{x:w,y:A,z:I}]}),b+=n[E]}y+=e[g]}return o},fit:function(t,n,e,r){r=r||1;var o=n.points,a=o[0],s=o[1],u=o[2],h=o[3],l=a.x,c=(s.x,u.x,h.x),x=a.y,p=s.y,f=(u.y,h.y,a.z),d=s.z,v=(u.z,h.z),m=c-l,y=p-x,g=v-f,z=d-f;if("x"===t){var b=y,E=r*b,M=Math.sqrt(m*m+g*g),T=Math.round(M/E),w=[];E=M/T,T=Math.max(1,Math.abs(T));for(var R=0;T>R;R++)w.push(1/T);return i.split(n,w,[1],e)}if("y"===t){var E=c-l,b=E/r,A=Math.sqrt(y*y+z*z),T=Math.round(A/b),w=[];b=A/T;for(var R=0;T>R;R++)w.push(1/T);return i.split(n,w,[1],e)}},bounds:function(t){var n,e,r,i,o=t.points;n=e=Number.POSITIVE_INFINITY,r=i=Number.NEGATIVE_INFINITY;for(var a=0,s=o.length;s>a;a++){var u=o[a];n=Math.min(u.x,n),e=Math.min(u.z,e),r=Math.max(u.x,r),i=Math.max(u.z,i)}return{width:r-n,depth:i-e}},inset:function(t,n){return r.insetPolygon(t.map(function(t){return{x:t.x,y:t.z}}),-n).map(function(n){return{x:n.x,y:t[0].y,z:n.y}})},lerp:function(t,n,e){return t*(1-e)+n*e}};n.exports=i},{"./Geom":11}],16:[function(t,n,e){var r=(t("./Geom"),t("./SHAPE.js"),t("./glMatrixSubset")),i=(t("earcut"),r.vec3,r.mat4,function(){this.rules=[]});i.prototype.define=function(t,n,e){this.rules.push({lhs:t,cond:n,rhs:e})},i.prototype.run=function(t){var n=[],e=this.rules,r=0;t=t instanceof Array?t:[t];for(var o=0,a=t.length;a>o;o++){var s=t[o];if(s.sym===i.TERMINAL||s.isTerminal)n.push(s);else for(var u=0,h=e.length;h>u;u++){var l=e[u];if(s.sym===l.lhs&&(null===l.cond||l.cond.call(s,t))){var c=l.rhs.call(s,t);c=c instanceof Array?c:[c];for(var x=0,p=c.length;p>x;x++)n.push(c[x]),++r;break}}}return r>0?this.run(n):n},i.TERMINAL="TERMINAL",n.exports=i},{"./Geom":11,"./SHAPE.js":15,"./glMatrixSubset":17,earcut:20}],17:[function(t,n,e){var r=Float32Array,i={};i.create=function(){var t=new r(16);return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},i.clone=function(t){var n=new r(16);return n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[3],n[4]=t[4],n[5]=t[5],n[6]=t[6],n[7]=t[7],n[8]=t[8],n[9]=t[9],n[10]=t[10],n[11]=t[11],n[12]=t[12],n[13]=t[13],n[14]=t[14],n[15]=t[15],n},i.copy=function(t,n){return t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3],t[4]=n[4],t[5]=n[5],t[6]=n[6],t[7]=n[7],t[8]=n[8],t[9]=n[9],t[10]=n[10],t[11]=n[11],t[12]=n[12],t[13]=n[13],t[14]=n[14],t[15]=n[15],t},i.identity=function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},i.transpose=function(t,n){if(t===n){var e=n[1],r=n[2],i=n[3],o=n[6],a=n[7],s=n[11];t[1]=n[4],t[2]=n[8],t[3]=n[12],t[4]=e,t[6]=n[9],t[7]=n[13],t[8]=r,t[9]=o,t[11]=n[14],t[12]=i,t[13]=a,t[14]=s}else t[0]=n[0],t[1]=n[4],t[2]=n[8],t[3]=n[12],t[4]=n[1],t[5]=n[5],t[6]=n[9],t[7]=n[13],t[8]=n[2],t[9]=n[6],t[10]=n[10],t[11]=n[14],t[12]=n[3],t[13]=n[7],t[14]=n[11],t[15]=n[15];return t},i.invert=function(t,n){var e=n[0],r=n[1],i=n[2],o=n[3],a=n[4],s=n[5],u=n[6],h=n[7],l=n[8],c=n[9],x=n[10],p=n[11],f=n[12],d=n[13],v=n[14],m=n[15],y=e*s-r*a,g=e*u-i*a,z=e*h-o*a,b=r*u-i*s,E=r*h-o*s,M=i*h-o*u,T=l*d-c*f,w=l*v-x*f,R=l*m-p*f,A=c*v-x*d,I=c*m-p*d,F=x*m-p*v,S=y*F-g*I+z*A+b*R-E*w+M*T;return S?(S=1/S,t[0]=(s*F-u*I+h*A)*S,t[1]=(i*I-r*F-o*A)*S,t[2]=(d*M-v*E+m*b)*S,t[3]=(x*E-c*M-p*b)*S,t[4]=(u*R-a*F-h*w)*S,t[5]=(e*F-i*R+o*w)*S,t[6]=(v*z-f*M-m*g)*S,t[7]=(l*M-x*z+p*g)*S,t[8]=(a*I-s*R+h*T)*S,t[9]=(r*R-e*I-o*T)*S,t[10]=(f*E-d*z+m*y)*S,t[11]=(c*z-l*E-p*y)*S,t[12]=(s*w-a*A-u*T)*S,t[13]=(e*A-r*w+i*T)*S,t[14]=(d*g-f*b-v*y)*S,t[15]=(l*b-c*g+x*y)*S,t):null},i.adjoint=function(t,n){var e=n[0],r=n[1],i=n[2],o=n[3],a=n[4],s=n[5],u=n[6],h=n[7],l=n[8],c=n[9],x=n[10],p=n[11],f=n[12],d=n[13],v=n[14],m=n[15];return t[0]=s*(x*m-p*v)-c*(u*m-h*v)+d*(u*p-h*x),t[1]=-(r*(x*m-p*v)-c*(i*m-o*v)+d*(i*p-o*x)),t[2]=r*(u*m-h*v)-s*(i*m-o*v)+d*(i*h-o*u),t[3]=-(r*(u*p-h*x)-s*(i*p-o*x)+c*(i*h-o*u)),t[4]=-(a*(x*m-p*v)-l*(u*m-h*v)+f*(u*p-h*x)),t[5]=e*(x*m-p*v)-l*(i*m-o*v)+f*(i*p-o*x),t[6]=-(e*(u*m-h*v)-a*(i*m-o*v)+f*(i*h-o*u)),t[7]=e*(u*p-h*x)-a*(i*p-o*x)+l*(i*h-o*u),
t[8]=a*(c*m-p*d)-l*(s*m-h*d)+f*(s*p-h*c),t[9]=-(e*(c*m-p*d)-l*(r*m-o*d)+f*(r*p-o*c)),t[10]=e*(s*m-h*d)-a*(r*m-o*d)+f*(r*h-o*s),t[11]=-(e*(s*p-h*c)-a*(r*p-o*c)+l*(r*h-o*s)),t[12]=-(a*(c*v-x*d)-l*(s*v-u*d)+f*(s*x-u*c)),t[13]=e*(c*v-x*d)-l*(r*v-i*d)+f*(r*x-i*c),t[14]=-(e*(s*v-u*d)-a*(r*v-i*d)+f*(r*u-i*s)),t[15]=e*(s*x-u*c)-a*(r*x-i*c)+l*(r*u-i*s),t},i.determinant=function(t){var n=t[0],e=t[1],r=t[2],i=t[3],o=t[4],a=t[5],s=t[6],u=t[7],h=t[8],l=t[9],c=t[10],x=t[11],p=t[12],f=t[13],d=t[14],v=t[15],m=n*a-e*o,y=n*s-r*o,g=n*u-i*o,z=e*s-r*a,b=e*u-i*a,E=r*u-i*s,M=h*f-l*p,T=h*d-c*p,w=h*v-x*p,R=l*d-c*f,A=l*v-x*f,I=c*v-x*d;return m*I-y*A+g*R+z*w-b*T+E*M},i.multiply=function(t,n,e){var r=n[0],i=n[1],o=n[2],a=n[3],s=n[4],u=n[5],h=n[6],l=n[7],c=n[8],x=n[9],p=n[10],f=n[11],d=n[12],v=n[13],m=n[14],y=n[15],g=e[0],z=e[1],b=e[2],E=e[3];return t[0]=g*r+z*s+b*c+E*d,t[1]=g*i+z*u+b*x+E*v,t[2]=g*o+z*h+b*p+E*m,t[3]=g*a+z*l+b*f+E*y,g=e[4],z=e[5],b=e[6],E=e[7],t[4]=g*r+z*s+b*c+E*d,t[5]=g*i+z*u+b*x+E*v,t[6]=g*o+z*h+b*p+E*m,t[7]=g*a+z*l+b*f+E*y,g=e[8],z=e[9],b=e[10],E=e[11],t[8]=g*r+z*s+b*c+E*d,t[9]=g*i+z*u+b*x+E*v,t[10]=g*o+z*h+b*p+E*m,t[11]=g*a+z*l+b*f+E*y,g=e[12],z=e[13],b=e[14],E=e[15],t[12]=g*r+z*s+b*c+E*d,t[13]=g*i+z*u+b*x+E*v,t[14]=g*o+z*h+b*p+E*m,t[15]=g*a+z*l+b*f+E*y,t},i.mul=i.multiply,i.translate=function(t,n,e){var r,i,o,a,s,u,h,l,c,x,p,f,d=e[0],v=e[1],m=e[2];return n===t?(t[12]=n[0]*d+n[4]*v+n[8]*m+n[12],t[13]=n[1]*d+n[5]*v+n[9]*m+n[13],t[14]=n[2]*d+n[6]*v+n[10]*m+n[14],t[15]=n[3]*d+n[7]*v+n[11]*m+n[15]):(r=n[0],i=n[1],o=n[2],a=n[3],s=n[4],u=n[5],h=n[6],l=n[7],c=n[8],x=n[9],p=n[10],f=n[11],t[0]=r,t[1]=i,t[2]=o,t[3]=a,t[4]=s,t[5]=u,t[6]=h,t[7]=l,t[8]=c,t[9]=x,t[10]=p,t[11]=f,t[12]=r*d+s*v+c*m+n[12],t[13]=i*d+u*v+x*m+n[13],t[14]=o*d+h*v+p*m+n[14],t[15]=a*d+l*v+f*m+n[15]),t},i.scale=function(t,n,e){var r=e[0],i=e[1],o=e[2];return t[0]=n[0]*r,t[1]=n[1]*r,t[2]=n[2]*r,t[3]=n[3]*r,t[4]=n[4]*i,t[5]=n[5]*i,t[6]=n[6]*i,t[7]=n[7]*i,t[8]=n[8]*o,t[9]=n[9]*o,t[10]=n[10]*o,t[11]=n[11]*o,t[12]=n[12],t[13]=n[13],t[14]=n[14],t[15]=n[15],t},i.rotate=function(t,n,e,r){var i,o,a,s,u,h,l,c,x,p,f,d,v,m,y,g,z,b,E,M,T,w,R,A,I=r[0],F=r[1],S=r[2],_=Math.sqrt(I*I+F*F+S*S);return Math.abs(_)<GLMAT_EPSILON?null:(_=1/_,I*=_,F*=_,S*=_,i=Math.sin(e),o=Math.cos(e),a=1-o,s=n[0],u=n[1],h=n[2],l=n[3],c=n[4],x=n[5],p=n[6],f=n[7],d=n[8],v=n[9],m=n[10],y=n[11],g=I*I*a+o,z=F*I*a+S*i,b=S*I*a-F*i,E=I*F*a-S*i,M=F*F*a+o,T=S*F*a+I*i,w=I*S*a+F*i,R=F*S*a-I*i,A=S*S*a+o,t[0]=s*g+c*z+d*b,t[1]=u*g+x*z+v*b,t[2]=h*g+p*z+m*b,t[3]=l*g+f*z+y*b,t[4]=s*E+c*M+d*T,t[5]=u*E+x*M+v*T,t[6]=h*E+p*M+m*T,t[7]=l*E+f*M+y*T,t[8]=s*w+c*R+d*A,t[9]=u*w+x*R+v*A,t[10]=h*w+p*R+m*A,t[11]=l*w+f*R+y*A,n!==t&&(t[12]=n[12],t[13]=n[13],t[14]=n[14],t[15]=n[15]),t)},i.rotateX=function(t,n,e){var r=Math.sin(e),i=Math.cos(e),o=n[4],a=n[5],s=n[6],u=n[7],h=n[8],l=n[9],c=n[10],x=n[11];return n!==t&&(t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3],t[12]=n[12],t[13]=n[13],t[14]=n[14],t[15]=n[15]),t[4]=o*i+h*r,t[5]=a*i+l*r,t[6]=s*i+c*r,t[7]=u*i+x*r,t[8]=h*i-o*r,t[9]=l*i-a*r,t[10]=c*i-s*r,t[11]=x*i-u*r,t},i.rotateY=function(t,n,e){var r=Math.sin(e),i=Math.cos(e),o=n[0],a=n[1],s=n[2],u=n[3],h=n[8],l=n[9],c=n[10],x=n[11];return n!==t&&(t[4]=n[4],t[5]=n[5],t[6]=n[6],t[7]=n[7],t[12]=n[12],t[13]=n[13],t[14]=n[14],t[15]=n[15]),t[0]=o*i-h*r,t[1]=a*i-l*r,t[2]=s*i-c*r,t[3]=u*i-x*r,t[8]=o*r+h*i,t[9]=a*r+l*i,t[10]=s*r+c*i,t[11]=u*r+x*i,t},i.rotateZ=function(t,n,e){var r=Math.sin(e),i=Math.cos(e),o=n[0],a=n[1],s=n[2],u=n[3],h=n[4],l=n[5],c=n[6],x=n[7];return n!==t&&(t[8]=n[8],t[9]=n[9],t[10]=n[10],t[11]=n[11],t[12]=n[12],t[13]=n[13],t[14]=n[14],t[15]=n[15]),t[0]=o*i+h*r,t[1]=a*i+l*r,t[2]=s*i+c*r,t[3]=u*i+x*r,t[4]=h*i-o*r,t[5]=l*i-a*r,t[6]=c*i-s*r,t[7]=x*i-u*r,t},i.fromRotationTranslation=function(t,n,e){var r=n[0],i=n[1],o=n[2],a=n[3],s=r+r,u=i+i,h=o+o,l=r*s,c=r*u,x=r*h,p=i*u,f=i*h,d=o*h,v=a*s,m=a*u,y=a*h;return t[0]=1-(p+d),t[1]=c+y,t[2]=x-m,t[3]=0,t[4]=c-y,t[5]=1-(l+d),t[6]=f+v,t[7]=0,t[8]=x+m,t[9]=f-v,t[10]=1-(l+p),t[11]=0,t[12]=e[0],t[13]=e[1],t[14]=e[2],t[15]=1,t},i.fromQuat=function(t,n){var e=n[0],r=n[1],i=n[2],o=n[3],a=e+e,s=r+r,u=i+i,h=e*a,l=r*a,c=r*s,x=i*a,p=i*s,f=i*u,d=o*a,v=o*s,m=o*u;return t[0]=1-c-f,t[1]=l+m,t[2]=x-v,t[3]=0,t[4]=l-m,t[5]=1-h-f,t[6]=p+d,t[7]=0,t[8]=x+v,t[9]=p-d,t[10]=1-h-c,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},i.frustum=function(t,n,e,r,i,o,a){var s=1/(e-n),u=1/(i-r),h=1/(o-a);return t[0]=2*o*s,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=2*o*u,t[6]=0,t[7]=0,t[8]=(e+n)*s,t[9]=(i+r)*u,t[10]=(a+o)*h,t[11]=-1,t[12]=0,t[13]=0,t[14]=a*o*2*h,t[15]=0,t},i.perspective=function(t,n,e,r,i){var o=1/Math.tan(n/2),a=1/(r-i);return t[0]=o/e,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=o,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=(i+r)*a,t[11]=-1,t[12]=0,t[13]=0,t[14]=2*i*r*a,t[15]=0,t},i.ortho=function(t,n,e,r,i,o,a){var s=1/(n-e),u=1/(r-i),h=1/(o-a);return t[0]=-2*s,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*u,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*h,t[11]=0,t[12]=(n+e)*s,t[13]=(i+r)*u,t[14]=(a+o)*h,t[15]=1,t},i.lookAt=function(t,n,e,r){var o,a,s,u,h,l,c,x,p,f,d=n[0],v=n[1],m=n[2],y=r[0],g=r[1],z=r[2],b=e[0],E=e[1],M=e[2];return Math.abs(d-b)<GLMAT_EPSILON&&Math.abs(v-E)<GLMAT_EPSILON&&Math.abs(m-M)<GLMAT_EPSILON?i.identity(t):(c=d-b,x=v-E,p=m-M,f=1/Math.sqrt(c*c+x*x+p*p),c*=f,x*=f,p*=f,o=g*p-z*x,a=z*c-y*p,s=y*x-g*c,f=Math.sqrt(o*o+a*a+s*s),f?(f=1/f,o*=f,a*=f,s*=f):(o=0,a=0,s=0),u=x*s-p*a,h=p*o-c*s,l=c*a-x*o,f=Math.sqrt(u*u+h*h+l*l),f?(f=1/f,u*=f,h*=f,l*=f):(u=0,h=0,l=0),t[0]=o,t[1]=u,t[2]=c,t[3]=0,t[4]=a,t[5]=h,t[6]=x,t[7]=0,t[8]=s,t[9]=l,t[10]=p,t[11]=0,t[12]=-(o*d+a*v+s*m),t[13]=-(u*d+h*v+l*m),t[14]=-(c*d+x*v+p*m),t[15]=1,t)},i.str=function(t){return"mat4("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+", "+t[9]+", "+t[10]+", "+t[11]+", "+t[12]+", "+t[13]+", "+t[14]+", "+t[15]+")"},i.frob=function(t){return Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2)+Math.pow(t[2],2)+Math.pow(t[3],2)+Math.pow(t[4],2)+Math.pow(t[5],2)+Math.pow(t[6],2)+Math.pow(t[6],2)+Math.pow(t[7],2)+Math.pow(t[8],2)+Math.pow(t[9],2)+Math.pow(t[10],2)+Math.pow(t[11],2)+Math.pow(t[12],2)+Math.pow(t[13],2)+Math.pow(t[14],2)+Math.pow(t[15],2))},"undefined"!=typeof e&&(e.mat4=i);var o={};o.create=function(){var t=new r(3);return t[0]=0,t[1]=0,t[2]=0,t},o.clone=function(t){var n=new r(3);return n[0]=t[0],n[1]=t[1],n[2]=t[2],n},o.fromValues=function(t,n,e){var i=new r(3);return i[0]=t,i[1]=n,i[2]=e,i},o.copy=function(t,n){return t[0]=n[0],t[1]=n[1],t[2]=n[2],t},o.set=function(t,n,e,r){return t[0]=n,t[1]=e,t[2]=r,t},o.add=function(t,n,e){return t[0]=n[0]+e[0],t[1]=n[1]+e[1],t[2]=n[2]+e[2],t},o.subtract=function(t,n,e){return t[0]=n[0]-e[0],t[1]=n[1]-e[1],t[2]=n[2]-e[2],t},o.sub=o.subtract,o.multiply=function(t,n,e){return t[0]=n[0]*e[0],t[1]=n[1]*e[1],t[2]=n[2]*e[2],t},o.mul=o.multiply,o.divide=function(t,n,e){return t[0]=n[0]/e[0],t[1]=n[1]/e[1],t[2]=n[2]/e[2],t},o.div=o.divide,o.min=function(t,n,e){return t[0]=Math.min(n[0],e[0]),t[1]=Math.min(n[1],e[1]),t[2]=Math.min(n[2],e[2]),t},o.max=function(t,n,e){return t[0]=Math.max(n[0],e[0]),t[1]=Math.max(n[1],e[1]),t[2]=Math.max(n[2],e[2]),t},o.scale=function(t,n,e){return t[0]=n[0]*e,t[1]=n[1]*e,t[2]=n[2]*e,t},o.scaleAndAdd=function(t,n,e,r){return t[0]=n[0]+e[0]*r,t[1]=n[1]+e[1]*r,t[2]=n[2]+e[2]*r,t},o.distance=function(t,n){var e=n[0]-t[0],r=n[1]-t[1],i=n[2]-t[2];return Math.sqrt(e*e+r*r+i*i)},o.dist=o.distance,o.squaredDistance=function(t,n){var e=n[0]-t[0],r=n[1]-t[1],i=n[2]-t[2];return e*e+r*r+i*i},o.sqrDist=o.squaredDistance,o.length=function(t){var n=t[0],e=t[1],r=t[2];return Math.sqrt(n*n+e*e+r*r)},o.len=o.length,o.squaredLength=function(t){var n=t[0],e=t[1],r=t[2];return n*n+e*e+r*r},o.sqrLen=o.squaredLength,o.negate=function(t,n){return t[0]=-n[0],t[1]=-n[1],t[2]=-n[2],t},o.normalize=function(t,n){var e=n[0],r=n[1],i=n[2],o=e*e+r*r+i*i;return o>0&&(o=1/Math.sqrt(o),t[0]=n[0]*o,t[1]=n[1]*o,t[2]=n[2]*o),t},o.dot=function(t,n){return t[0]*n[0]+t[1]*n[1]+t[2]*n[2]},o.cross=function(t,n,e){var r=n[0],i=n[1],o=n[2],a=e[0],s=e[1],u=e[2];return t[0]=i*u-o*s,t[1]=o*a-r*u,t[2]=r*s-i*a,t},o.lerp=function(t,n,e,r){var i=n[0],o=n[1],a=n[2];return t[0]=i+r*(e[0]-i),t[1]=o+r*(e[1]-o),t[2]=a+r*(e[2]-a),t},o.random=function(t,n){n=n||1;var e=2*GLMAT_RANDOM()*Math.PI,r=2*GLMAT_RANDOM()-1,i=Math.sqrt(1-r*r)*n;return t[0]=Math.cos(e)*i,t[1]=Math.sin(e)*i,t[2]=r*n,t},o.transformMat4=function(t,n,e){var r=n[0],i=n[1],o=n[2];return t[0]=e[0]*r+e[4]*i+e[8]*o+e[12],t[1]=e[1]*r+e[5]*i+e[9]*o+e[13],t[2]=e[2]*r+e[6]*i+e[10]*o+e[14],t},o.transformMat3=function(t,n,e){var r=n[0],i=n[1],o=n[2];return t[0]=r*e[0]+i*e[3]+o*e[6],t[1]=r*e[1]+i*e[4]+o*e[7],t[2]=r*e[2]+i*e[5]+o*e[8],t},o.transformQuat=function(t,n,e){var r=n[0],i=n[1],o=n[2],a=e[0],s=e[1],u=e[2],h=e[3],l=h*r+s*o-u*i,c=h*i+u*r-a*o,x=h*o+a*i-s*r,p=-a*r-s*i-u*o;return t[0]=l*h+p*-a+c*-u-x*-s,t[1]=c*h+p*-s+x*-a-l*-u,t[2]=x*h+p*-u+l*-s-c*-a,t},o.rotateX=function(t,n,e,r){var i=[],o=[];return i[0]=n[0]-e[0],i[1]=n[1]-e[1],i[2]=n[2]-e[2],o[0]=i[0],o[1]=i[1]*Math.cos(r)-i[2]*Math.sin(r),o[2]=i[1]*Math.sin(r)+i[2]*Math.cos(r),t[0]=o[0]+e[0],t[1]=o[1]+e[1],t[2]=o[2]+e[2],t},o.rotateY=function(t,n,e,r){var i=[],o=[];return i[0]=n[0]-e[0],i[1]=n[1]-e[1],i[2]=n[2]-e[2],o[0]=i[2]*Math.sin(r)+i[0]*Math.cos(r),o[1]=i[1],o[2]=i[2]*Math.cos(r)-i[0]*Math.sin(r),t[0]=o[0]+e[0],t[1]=o[1]+e[1],t[2]=o[2]+e[2],t},o.rotateZ=function(t,n,e,r){var i=[],o=[];return i[0]=n[0]-e[0],i[1]=n[1]-e[1],i[2]=n[2]-e[2],o[0]=i[0]*Math.cos(r)-i[1]*Math.sin(r),o[1]=i[0]*Math.sin(r)+i[1]*Math.cos(r),o[2]=i[2],t[0]=o[0]+e[0],t[1]=o[1]+e[1],t[2]=o[2]+e[2],t},o.forEach=function(){var t=o.create();return function(n,e,r,i,o,a){var s,u;for(e||(e=3),r||(r=0),u=i?Math.min(i*e+r,n.length):n.length,s=r;u>s;s+=e)t[0]=n[s],t[1]=n[s+1],t[2]=n[s+2],o(t,t,a),n[s]=t[0],n[s+1]=t[1],n[s+2]=t[2];return n}}(),o.str=function(t){return"vec3("+t[0]+", "+t[1]+", "+t[2]+")"},"undefined"!=typeof e&&(e.vec3=o);var a={};a.create=function(){var t=new r(9);return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t},a.fromMat4=function(t,n){return t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[4],t[4]=n[5],t[5]=n[6],t[6]=n[8],t[7]=n[9],t[8]=n[10],t},a.clone=function(t){var n=new r(9);return n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[3],n[4]=t[4],n[5]=t[5],n[6]=t[6],n[7]=t[7],n[8]=t[8],n},a.copy=function(t,n){return t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3],t[4]=n[4],t[5]=n[5],t[6]=n[6],t[7]=n[7],t[8]=n[8],t},a.identity=function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t},a.transpose=function(t,n){if(t===n){var e=n[1],r=n[2],i=n[5];t[1]=n[3],t[2]=n[6],t[3]=e,t[5]=n[7],t[6]=r,t[7]=i}else t[0]=n[0],t[1]=n[3],t[2]=n[6],t[3]=n[1],t[4]=n[4],t[5]=n[7],t[6]=n[2],t[7]=n[5],t[8]=n[8];return t},a.invert=function(t,n){var e=n[0],r=n[1],i=n[2],o=n[3],a=n[4],s=n[5],u=n[6],h=n[7],l=n[8],c=l*a-s*h,x=-l*o+s*u,p=h*o-a*u,f=e*c+r*x+i*p;return f?(f=1/f,t[0]=c*f,t[1]=(-l*r+i*h)*f,t[2]=(s*r-i*a)*f,t[3]=x*f,t[4]=(l*e-i*u)*f,t[5]=(-s*e+i*o)*f,t[6]=p*f,t[7]=(-h*e+r*u)*f,t[8]=(a*e-r*o)*f,t):null},a.adjoint=function(t,n){var e=n[0],r=n[1],i=n[2],o=n[3],a=n[4],s=n[5],u=n[6],h=n[7],l=n[8];return t[0]=a*l-s*h,t[1]=i*h-r*l,t[2]=r*s-i*a,t[3]=s*u-o*l,t[4]=e*l-i*u,t[5]=i*o-e*s,t[6]=o*h-a*u,t[7]=r*u-e*h,t[8]=e*a-r*o,t},a.determinant=function(t){var n=t[0],e=t[1],r=t[2],i=t[3],o=t[4],a=t[5],s=t[6],u=t[7],h=t[8];return n*(h*o-a*u)+e*(-h*i+a*s)+r*(u*i-o*s)},a.multiply=function(t,n,e){var r=n[0],i=n[1],o=n[2],a=n[3],s=n[4],u=n[5],h=n[6],l=n[7],c=n[8],x=e[0],p=e[1],f=e[2],d=e[3],v=e[4],m=e[5],y=e[6],g=e[7],z=e[8];return t[0]=x*r+p*a+f*h,t[1]=x*i+p*s+f*l,t[2]=x*o+p*u+f*c,t[3]=d*r+v*a+m*h,t[4]=d*i+v*s+m*l,t[5]=d*o+v*u+m*c,t[6]=y*r+g*a+z*h,t[7]=y*i+g*s+z*l,t[8]=y*o+g*u+z*c,t},a.mul=a.multiply,a.translate=function(t,n,e){var r=n[0],i=n[1],o=n[2],a=n[3],s=n[4],u=n[5],h=n[6],l=n[7],c=n[8],x=e[0],p=e[1];return t[0]=r,t[1]=i,t[2]=o,t[3]=a,t[4]=s,t[5]=u,t[6]=x*r+p*a+h,t[7]=x*i+p*s+l,t[8]=x*o+p*u+c,t},a.rotate=function(t,n,e){var r=n[0],i=n[1],o=n[2],a=n[3],s=n[4],u=n[5],h=n[6],l=n[7],c=n[8],x=Math.sin(e),p=Math.cos(e);return t[0]=p*r+x*a,t[1]=p*i+x*s,t[2]=p*o+x*u,t[3]=p*a-x*r,t[4]=p*s-x*i,t[5]=p*u-x*o,t[6]=h,t[7]=l,t[8]=c,t},a.scale=function(t,n,e){var r=e[0],i=e[1];return t[0]=r*n[0],t[1]=r*n[1],t[2]=r*n[2],t[3]=i*n[3],t[4]=i*n[4],t[5]=i*n[5],t[6]=n[6],t[7]=n[7],t[8]=n[8],t},a.fromMat2d=function(t,n){return t[0]=n[0],t[1]=n[1],t[2]=0,t[3]=n[2],t[4]=n[3],t[5]=0,t[6]=n[4],t[7]=n[5],t[8]=1,t},a.fromQuat=function(t,n){var e=n[0],r=n[1],i=n[2],o=n[3],a=e+e,s=r+r,u=i+i,h=e*a,l=r*a,c=r*s,x=i*a,p=i*s,f=i*u,d=o*a,v=o*s,m=o*u;return t[0]=1-c-f,t[3]=l-m,t[6]=x+v,t[1]=l+m,t[4]=1-h-f,t[7]=p-d,t[2]=x-v,t[5]=p+d,t[8]=1-h-c,t},a.normalFromMat4=function(t,n){var e=n[0],r=n[1],i=n[2],o=n[3],a=n[4],s=n[5],u=n[6],h=n[7],l=n[8],c=n[9],x=n[10],p=n[11],f=n[12],d=n[13],v=n[14],m=n[15],y=e*s-r*a,g=e*u-i*a,z=e*h-o*a,b=r*u-i*s,E=r*h-o*s,M=i*h-o*u,T=l*d-c*f,w=l*v-x*f,R=l*m-p*f,A=c*v-x*d,I=c*m-p*d,F=x*m-p*v,S=y*F-g*I+z*A+b*R-E*w+M*T;return S?(S=1/S,t[0]=(s*F-u*I+h*A)*S,t[1]=(u*R-a*F-h*w)*S,t[2]=(a*I-s*R+h*T)*S,t[3]=(i*I-r*F-o*A)*S,t[4]=(e*F-i*R+o*w)*S,t[5]=(r*R-e*I-o*T)*S,t[6]=(d*M-v*E+m*b)*S,t[7]=(v*z-f*M-m*g)*S,t[8]=(f*E-d*z+m*y)*S,t):null},a.str=function(t){return"mat3("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+")"},a.frob=function(t){return Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2)+Math.pow(t[2],2)+Math.pow(t[3],2)+Math.pow(t[4],2)+Math.pow(t[5],2)+Math.pow(t[6],2)+Math.pow(t[7],2)+Math.pow(t[8],2))},"undefined"!=typeof e&&(e.mat3=a),n.exports={mat4:i,mat3:a,vec3:o}},{}],18:[function(t,n,e){n.exports={hsl2rgb:function(t,n,e){var r,i,o,a,s,u;return isFinite(t)||(t=0),isFinite(n)||(n=0),isFinite(e)||(e=0),t/=60,0>t&&(t=6- -t%6),t%=6,n=Math.max(0,Math.min(1,n/100)),e=Math.max(0,Math.min(1,e/100)),s=(1-Math.abs(2*e-1))*n,u=s*(1-Math.abs(t%2-1)),1>t?(r=s,i=u,o=0):2>t?(r=u,i=s,o=0):3>t?(r=0,i=s,o=u):4>t?(r=0,i=u,o=s):5>t?(r=u,i=0,o=s):(r=s,i=0,o=u),a=e-s/2,r=Math.round(255*(r+a)),i=Math.round(255*(i+a)),o=Math.round(255*(o+a)),{r:r,g:i,b:o}}}},{}],19:[function(t,n,e){n.exports=function(t,n,e,r){n="number"==typeof n?n:.5,e=e?e:25;var i,o,a,s,u,h,l,c=1,x=t.length,p=0,f=(x-2)*e+2+(r?2*e:0),d=new Float32Array(f),v=new Float32Array(4*(e+2)),m=4;for(i=t.slice(0),r?(i.unshift(t[x-1]),i.unshift(t[x-2]),i.push(t[0],t[1])):(i.unshift(t[1]),i.unshift(t[0]),i.push(t[x-2],t[x-1])),v[0]=1;e>c;c++)o=c/e,a=o*o,s=a*o,u=2*s,h=3*a,v[m++]=u-h+1,v[m++]=h-u,v[m++]=s-2*a+o,v[m++]=s-a;return v[++m]=1,l=function(t,r,i){var o,a,s,u,h,l,c,x,f,v,m,y,g,z,b=2;for(b;i>b;b+=2)for(a=t[b],s=t[b+1],u=t[b+2],h=t[b+3],l=(u-t[b-2])*n,c=(h-t[b-1])*n,x=(t[b+4]-a)*n,f=(t[b+5]-s)*n,o=0;e>o;o++)v=o<<2,m=r[v],y=r[v+1],g=r[v+2],z=r[v+3],d[p++]=m*a+y*u+g*l+z*x,d[p++]=m*s+y*h+g*c+z*f},l(i,v,x),r&&(i=[],i.push(t[x-4],t[x-3],t[x-2],t[x-1]),i.push(t[0],t[1],t[2],t[3]),l(i,v,4)),x=r?0:t.length-2,d[p++]=t[x],d[p]=t[x+1],d}},{}],20:[function(t,n,e){"use strict";function r(t,n){var e=o(i(t[0],!0)),r=n?{vertices:[],indices:[]}:[];if(!e)return r;var s,u,h,l,x,p,f,d,v,m=80;for(v=0;m>=0&&v<t.length;v++)m-=t[v].length;if(0>m){s=e.next,u=l=s.p[0],h=x=s.p[1];do p=s.p[0],f=s.p[1],u>p&&(u=p),h>f&&(h=f),p>l&&(l=p),f>x&&(x=f),s=s.next;while(s!==e);d=Math.max(l-u,x-h)}return t.length>1&&(e=c(t,e)),a(e,r,u,h,d),r}function i(t,n){var e,r,i,o,a,s=0,u=t.length;for(e=0,r=u-1;u>e;r=e++)i=t[e],o=t[r],s+=(o[0]-i[0])*(i[1]+o[1]);if(n===s>0)for(e=0;u>e;e++)a=A(t[e],a);else for(e=u-1;e>=0;e--)a=A(t[e],a);return a}function o(t,n){n||(n=t);var e,r=t;do if(e=!1,z(r.p,r.next.p)||0===g(r.prev.p,r.p,r.next.p)){if(r.prev.next=r.next,r.next.prev=r.prev,r.prevZ&&(r.prevZ.nextZ=r.nextZ),r.nextZ&&(r.nextZ.prevZ=r.prevZ),r=n=r.prev,r===r.next)return null;e=!0}else r=r.next;while(e||r!==n);return n}function a(t,n,e,r,i,c){if(t){var x=void 0!==n.vertices;c||void 0===e||f(t,e,r,i);for(var p,d,v=t;t.prev!==t.next;)if(p=t.prev,d=t.next,u(t,e,r,i))x?(s(n,p),s(n,t),s(n,d)):(n.push(p.p),n.push(t.p),n.push(d.p)),d.prev=p,p.next=d,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ),t=d.next,v=d.next;else if(t=d,t===v){c?1===c?(t=h(t,n),a(t,n,e,r,i,2)):2===c&&l(t,n,e,r,i):a(o(t),n,e,r,i,1);break}}}function s(t,n){n.source&&(n=n.source);var e=n.index;if(null===e){var r=n.p.length,i=t.vertices;n.index=e=i.length/r;for(var o=0;r>o;o++)i.push(n.p[o])}t.indices.push(e)}function u(t,n,e,r){var i=t.prev.p,o=t.p,a=t.next.p,s=i[0],u=o[0],h=a[0],l=i[1],c=o[1],x=a[1],p=s*c-l*u,f=s*x-l*h,d=h*c-x*u,m=p-f-d;if(0>=m)return!1;var y,g,z,b,E,M,T,w=x-l,R=s-h,A=l-c,I=u-s;if(void 0!==n){var F=u>s?h>s?s:h:h>u?u:h,S=c>l?x>l?l:x:x>c?c:x,_=s>u?s>h?s:h:u>h?u:h,P=l>c?l>x?l:x:c>x?c:x,N=v(F,S,n,e,r),D=v(_,P,n,e,r);for(T=t.nextZ;T&&T.z<=D;)if(y=T.p,T=T.nextZ,y!==i&&y!==a&&(g=y[0],z=y[1],b=w*g+R*z-f,b>=0&&(E=A*g+I*z+p,E>=0&&(M=m-b-E,M>=0&&(b&&E||b&&M||E&&M)))))return!1;for(T=t.prevZ;T&&T.z>=N;)if(y=T.p,T=T.prevZ,y!==i&&y!==a&&(g=y[0],z=y[1],b=w*g+R*z-f,b>=0&&(E=A*g+I*z+p,E>=0&&(M=m-b-E,M>=0&&(b&&E||b&&M||E&&M)))))return!1}else for(T=t.next.next;T!==t.prev;)if(y=T.p,T=T.next,g=y[0],z=y[1],b=w*g+R*z-f,b>=0&&(E=A*g+I*z+p,E>=0&&(M=m-b-E,M>=0&&(b&&E||b&&M||E&&M))))return!1;return!0}function h(t,n){var e=!!n.vertices,r=t;do{var i=r.prev,o=r.next.next;if(i.p!==o.p&&b(i.p,r.p,r.next.p,o.p)&&M(i,o)&&M(o,i)){e?(s(n,i),s(n,r),s(n,o)):(n.push(i.p),n.push(r.p),n.push(o.p)),i.next=o,o.prev=i;var a=r.prevZ,u=r.nextZ&&r.nextZ.nextZ;a&&(a.nextZ=u),u&&(u.prevZ=a),r=t=o}r=r.next}while(r!==t);return r}function l(t,n,e,r,i){var s=t;do{for(var u=s.next.next;u!==s.prev;){if(s.p!==u.p&&y(s,u)){var h=R(s,u);return s=o(s,s.next),h=o(h,h.next),a(s,n,e,r,i),void a(h,n,e,r,i)}u=u.next}s=s.next}while(s!==t)}function c(t,n){for(var e=t.length,r=[],a=1;e>a;a++){var s=o(i(t[a],!1));s&&r.push(m(s))}for(r.sort(w),a=0;a<r.length;a++)x(r[a],n),n=o(n,n.next);return n}function x(t,n){if(n=p(t,n)){var e=R(n,t);o(e,e.next)}}function p(t,n){var e,r,i,o=n,a=t.p,s=a[0],u=a[1],h=-(1/0);do{if(r=o.p,i=o.next.p,u<=r[1]&&u>=i[1]){var l=r[0]+(u-r[1])*(i[0]-r[0])/(i[1]-r[1]);s>=l&&l>h&&(h=l,e=r[0]<i[0]?o:o.next)}o=o.next}while(o!==n);if(!e)return null;var c,x,p,f,d,v,m=e.p[0],y=e.p[1],g=s*y-u*m,z=s*u-u*h,b=u-u,E=s-h,T=u-y,w=m-s,R=g-z-(h*y-u*m),A=0>=R?-1:1,I=e,F=1/0;for(o=e.next;o!==I;)c=o.p[0],x=o.p[1],p=s-c,p>=0&&c>=m&&(f=(b*c+E*x-z)*A,f>=0&&(d=(T*c+w*x+g)*A,d>=0&&R*A-f-d>=0&&(v=Math.abs(u-x)/p,F>v&&M(o,t)&&(e=o,F=v)))),o=o.next;return e}function f(t,n,e,r){var i=t;do null===i.z&&(i.z=v(i.p[0],i.p[1],n,e,r)),i.prevZ=i.prev,i.nextZ=i.next,i=i.next;while(i!==t);i.prevZ.nextZ=null,i.prevZ=null,d(i)}function d(t){for(var n,e,r,i,o,a,s,u,h=1;;){for(e=t,t=null,o=null,a=0;e;){for(a++,r=e,s=0,n=0;h>n&&(s++,r=r.nextZ,r);n++);for(u=h;s>0||u>0&&r;)0===s?(i=r,r=r.nextZ,u--):0!==u&&r?e.z<=r.z?(i=e,e=e.nextZ,s--):(i=r,r=r.nextZ,u--):(i=e,e=e.nextZ,s--),o?o.nextZ=i:t=i,i.prevZ=o,o=i;e=r}if(o.nextZ=null,1>=a)return t;h*=2}}function v(t,n,e,r,i){return t=1e3*(t-e)/i,t=16711935&(t|t<<8),t=252645135&(t|t<<4),t=858993459&(t|t<<2),t=1431655765&(t|t<<1),n=1e3*(n-r)/i,n=16711935&(n|n<<8),n=252645135&(n|n<<4),n=858993459&(n|n<<2),n=1431655765&(n|n<<1),t|n<<1}function m(t){var n=t,e=t;do n.p[0]<e.p[0]&&(e=n),n=n.next;while(n!==t);return e}function y(t,n){return!E(t,t.p,n.p)&&M(t,n)&&M(n,t)&&T(t,t.p,n.p)}function g(t,n,e){var r=(n[1]-t[1])*(e[0]-n[0])-(n[0]-t[0])*(e[1]-n[1]);return r>0?1:0>r?-1:0}function z(t,n){return t[0]===n[0]&&t[1]===n[1]}function b(t,n,e,r){return g(t,n,e)!==g(t,n,r)&&g(e,r,t)!==g(e,r,n)}function E(t,n,e){var r=t;do{var i=r.p,o=r.next.p;if(i!==n&&o!==n&&i!==e&&o!==e&&b(i,o,n,e))return!0;r=r.next}while(r!==t);return!1}function M(t,n){return-1===g(t.prev.p,t.p,t.next.p)?-1!==g(t.p,n.p,t.next.p)&&-1!==g(t.p,t.prev.p,n.p):-1===g(t.p,n.p,t.prev.p)||-1===g(t.p,t.next.p,n.p)}function T(t,n,e){var r=t,i=!1,o=(n[0]+e[0])/2,a=(n[1]+e[1])/2;do{var s=r.p,u=r.next.p;s[1]>a!=u[1]>a&&o<(u[0]-s[0])*(a-s[1])/(u[1]-s[1])+s[0]&&(i=!i),r=r.next}while(r!==t);return i}function w(t,n){return t.p[0]-n.p[0]}function R(t,n){var e=new I(t.p),r=new I(n.p),i=t.next,o=n.prev;return e.source=t,r.source=n,t.next=n,n.prev=t,e.next=i,i.prev=e,r.next=e,e.prev=r,o.next=r,r.prev=o,r}function A(t,n){var e=new I(t);return n?(e.next=n.next,e.prev=n,n.next.prev=e,n.next=e):(e.prev=e,e.next=e),e}function I(t){this.p=t,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.source=null,this.index=null}n.exports=r},{}],21:[function(t,n,e){!function(t,r){"use strict";"object"==typeof e?n.exports=r():"function"==typeof define&&define.amd?define(r):t.MersenneTwister=r()}(this,function(){"use strict";var t=4294967296,n=624,e=397,r=2147483648,i=2147483647,o=2567483615,a=function(t){"undefined"==typeof t&&(t=(new Date).getTime()),this.mt=new Array(n),this.mti=n+1,this.seed(t)};a.prototype.seed=function(t){var e;for(this.mt[0]=t>>>0,this.mti=1;this.mti<n;this.mti++)e=this.mt[this.mti-1]^this.mt[this.mti-1]>>>30,this.mt[this.mti]=(1812433253*((4294901760&e)>>>16)<<16)+1812433253*(65535&e)+this.mti,this.mt[this.mti]>>>=0},a.prototype.seedArray=function(t){var e,r=1,i=0,o=n>t.length?n:t.length;for(this.seed(19650218);o>0;o--)e=this.mt[r-1]^this.mt[r-1]>>>30,this.mt[r]=(this.mt[r]^(1664525*((4294901760&e)>>>16)<<16)+1664525*(65535&e))+t[i]+i,this.mt[r]>>>=0,r++,i++,r>=n&&(this.mt[0]=this.mt[n-1],r=1),i>=t.length&&(i=0);for(o=n-1;o;o--)e=this.mt[r-1]^this.mt[r-1]>>>30,this.mt[r]=(this.mt[r]^(1566083941*((4294901760&e)>>>16)<<16)+1566083941*(65535&e))-r,this.mt[r]>>>=0,r++,r>=n&&(this.mt[0]=this.mt[n-1],r=1);this.mt[0]=2147483648},a.prototype.int=function(){var t,a,s=new Array(0,o);if(this.mti>=n){for(this.mti===n+1&&this.seed(5489),a=0;n-e>a;a++)t=this.mt[a]&r|this.mt[a+1]&i,this.mt[a]=this.mt[a+e]^t>>>1^s[1&t];for(;n-1>a;a++)t=this.mt[a]&r|this.mt[a+1]&i,this.mt[a]=this.mt[a+(e-n)]^t>>>1^s[1&t];t=this.mt[n-1]&r|this.mt[0]&i,this.mt[n-1]=this.mt[e-1]^t>>>1^s[1&t],this.mti=0}return t=this.mt[this.mti++],t^=t>>>11,t^=t<<7&2636928640,t^=t<<15&4022730752,t^=t>>>18,t>>>0},a.prototype.int31=function(){return this.int()>>>1},a.prototype.real=function(){return this.int()*(1/(t-1))},a.prototype.realx=function(){return(this.int()+.5)*(1/t)},a.prototype.rnd=function(){return this.int()*(1/t)},a.prototype.random=a.prototype.rnd,a.prototype.rndHiRes=function(){var t=this.int()>>>5,n=this.int()>>>6;return(67108864*t+n)*(1/9007199254740992)};var s=new a;return a.random=function(){return s.rnd()},a})},{}],22:[function(t,n,e){var r=function(){var t=Date.now(),n=t,e=0,r=1/0,i=0,o=0,a=1/0,s=0,u=0,h=0,l=document.createElement("div");l.id="stats",l.addEventListener("mousedown",function(t){t.preventDefault(),y(++h%2)},!1),l.style.cssText="width:80px;opacity:0.9;cursor:pointer";var c=document.createElement("div");c.id="fps",c.style.cssText="padding:0 0 3px 3px;text-align:left;background-color:#002",l.appendChild(c);var x=document.createElement("div");x.id="fpsText",x.style.cssText="color:#0ff;font-family:Helvetica,Arial,sans-serif;font-size:9px;font-weight:bold;line-height:15px",x.innerHTML="FPS",c.appendChild(x);var p=document.createElement("div");for(p.id="fpsGraph",p.style.cssText="position:relative;width:74px;height:30px;background-color:#0ff",c.appendChild(p);74>p.children.length;){var f=document.createElement("span");f.style.cssText="width:1px;height:30px;float:left;background-color:#113",p.appendChild(f)}var d=document.createElement("div");d.id="ms",d.style.cssText="padding:0 0 3px 3px;text-align:left;background-color:#020;display:none",l.appendChild(d);var v=document.createElement("div");v.id="msText",v.style.cssText="color:#0f0;font-family:Helvetica,Arial,sans-serif;font-size:9px;font-weight:bold;line-height:15px",v.innerHTML="MS",d.appendChild(v);var m=document.createElement("div");for(m.id="msGraph",m.style.cssText="position:relative;width:74px;height:30px;background-color:#0f0",d.appendChild(m);74>m.children.length;)f=document.createElement("span"),f.style.cssText="width:1px;height:30px;float:left;background-color:#131",m.appendChild(f);var y=function(t){switch(h=t){case 0:c.style.display="block",d.style.display="none";break;case 1:c.style.display="none",d.style.display="block"}};return{REVISION:12,domElement:l,setMode:y,begin:function(){t=Date.now()},end:function(){var h=Date.now();e=h-t,r=Math.min(r,e),i=Math.max(i,e),v.textContent=e+" MS ("+r+"-"+i+")";var l=Math.min(30,30-30*(e/200));return m.appendChild(m.firstChild).style.height=l+"px",u++,h>n+1e3&&(o=Math.round(1e3*u/(h-n)),a=Math.min(a,o),s=Math.max(s,o),x.textContent=o+" FPS ("+a+"-"+s+")",l=Math.min(30,30-30*(o/100)),p.appendChild(p.firstChild).style.height=l+"px",n=h,u=0),h},update:function(){t=this.end()}}};"object"==typeof n&&(n.exports=r)},{}],23:[function(t,n,e){var r=t("./../lib/glMatrixSubset"),i=t("./../Context"),o=t("./../lib/Mesh"),a=(t("./../lib/Geom"),t("./../lib/QuadTree")),s=t("./../lib/Loader"),u=(r.vec3,r.mat4),h=i.gl,l=t("../generators/BuildingSHG.js"),c=t("../generators/City.js"),x=function(t,n,e){return t*(1-e)+n*e},p=function(t,n){for(var e=[],r=[],i=[],a=[],s=[],u=0,h=t.lots.length;h>u;u++){var c,x,p,f,d,v,m,y,g;c=t.lots[u],x=c.height,p=c.angle,c=c.poly,f=d=0,v=y=Number.POSITIVE_INFINITY,m=g=Number.NEGATIVE_INFINITY;for(var z=0,b=c.length;b>z;z++){var E=c[z];f+=E.x,d+=E.y,v=Math.min(v,E.x),m=Math.max(m,E.x),y=Math.min(y,E.y),g=Math.max(g,E.y)}f/=c.length,d/=c.length;for(var M=l.create({x:f,y:d,width:.9*Math.abs(m-v),depth:.9*Math.abs(g-y),angle:p}),T=M.geom,w=M.color,R=0,A=T.length;A>R;R++){var I=T[R];if("light"in I)s.push(I.light);else for(var z=0,b=I.vertices.length;b>z;z++)e.push(I.vertices[z]),r.push(I.normals[z]),i.push(I.uvs[z]),a.push(w[z%3]);T[R]=null}}return{mesh:new o(e,r,i,a),lights:s,x:t.x,y:t.y,w:t.w}},f=new c(0),d={quadtree:null,quadtreeLights:null,fixedMeshes:[]},v=document.createElement("pre");v.style.background="white",v.style.color="black",v.style.position="absolute",v.style.right="1rem",v.style.top="7rem",i.canvas.parentElement.appendChild(v),function(){var t,n,e=[],r=[],i=[],u=[],h=[],l=[],c=0,v=f.blocks.length;for(function(){var t=[];f.roads.forEach(function(n){l.push({x:n.x,y:.25,z:n.y}),n.conns.forEach(function(e){-1===t.indexOf(e)&&l.push({x:x(n.x,e.x,.5),y:.25,z:x(n.y,e.y,.5)})}),t.push(n)})}();f.blocks.length;)t=f.blocks.shift(),setTimeout(function(){var t=p(this);h.push(t),c++,s.progress("Blocks",c/v)}.bind(t),0);s.subscribe("Blocks",function(t,e){return function(){var r,i,o,s;r=i=Number.POSITIVE_INFINITY,o=s=Number.NEGATIVE_INFINITY,e.forEach(function(t){r=Math.min(r,t.x-t.w),o=Math.max(o,t.x+t.w),i=Math.min(i,t.y-t.w),s=Math.max(s,t.y+t.w)});var u=Math.abs(o-r)/2,h=Math.abs(s-i)/2;n=new a(u,h,Math.max(u,h),4),e.forEach(function(t){n.insert(t)}),console.log(e),t.quadtree=n,t.allLights=l}}(d,h)),e.push.apply(e,[-20,-.001,-20,-20,-.001,20,20,-.001,20,-20,-.001,-20,20,-.001,20,20,-.001,-20]),r.push.apply(r,[0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0]),i.push.apply(i,[0,0,3,0,40,3,40,40,3,0,0,3,40,40,3,40,0,3]),u.push.apply(u,[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]);for(var m=f.roadQuads.reduce(function(){var t,n;return t=[0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0],n=[0,0,2,0,1,2,1,1,2,0,0,2,1,1,2,1,0,2],function(e,r){for(var i=r[0],o=r[1],a=Math.atan2(o.y-i.y,o.x-i.x)+Math.PI/2,s=Math.abs(.09*Math.cos(a)),u=Math.abs(.09*Math.sin(a)),h={x:i.x+u,y:i.y+s},l={x:o.x-u,y:o.y-s},c=Math.sqrt(Math.pow(l.y-h.y,2)+Math.pow(l.x-h.x,2)),x=[h.x-s,0,h.y-u,l.x-s,0,l.y-u,l.x+s,0,l.y+u,h.x-s,0,h.y-u,l.x+s,0,l.y+u,h.x+s,0,h.y+u],p=n.map(function(t,n){switch(n%3){case 0:return t;case 1:return t*c;default:return t}return t}),f=0,d=x.length;d>f;f++)e.vertices.push(x[f]),e.normals.push(t[f]),e.uvs.push(p[f]),e.extra.push(0);return e}}(),{vertices:[],normals:[],uvs:[],extra:[]}),y=0,g=m.vertices.length;g>y;y++)e.push(m.vertices[y]),r.push(m.normals[y]),i.push(m.uvs[y]),u.push(m.extra[y]);d.fixedMeshes=[new o(e,r,i,u)]}();var m={meshes:[],lights:[],lightParameters:[16,0,8,64],view:u.create(),model:u.create(),count:0,texture:h.createTexture()};h.bindTexture(h.TEXTURE_2D,m.texture),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MAG_FILTER,h.NEAREST),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MIN_FILTER,h.NEAREST),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_S,h.CLAMP_TO_EDGE),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_T,h.CLAMP_TO_EDGE),h.texImage2D(h.TEXTURE_2D,0,h.RGBA,i.w,i.h,0,h.RGBA,h.UNSIGNED_BYTE,null),h.bindTexture(h.TEXTURE_2D,null);var y=0,g=function(t,n){return t.push(n),t},z=2,b=.19,E=1.8,M=0,T=0,w=0,R=0;m.update=function(t){z+=(Math.cos(T)*w-Math.sin(T)*R)*Math.cos(M),b+=Math.sin(M)*R,E+=(Math.sin(T)*w+Math.cos(T)*R)*Math.cos(M),v.textContent=[z,b,E].map(function(t){return t.toFixed(2)}).join(", ")+" "+(Math.PI/M).toFixed(2)+" "+(Math.PI/T).toFixed(2),u.identity(m.view),u.rotateX(m.view,m.view,M),u.rotateY(m.view,m.view,T),u.translate(m.view,m.view,[-z,-b,-E]);var n;n=d.quadtree.query(z,E,4),m.meshes=d.fixedMeshes.reduce(g,[]),m.meshes=n.map(function(t){return t.mesh}).reduce(g,m.meshes),m.lights=d.allLights.reduce(function(t,n){for(var e=0;6>e;e++)t.push(n.x,n.y,n.z);return t},[]),v.textContent+="\nVertices: "+m.meshes.reduce(function(t,n){return t+n.count},0),y+=.001,v.textContent+="\nLights: "+m.lights.length/18},document.body.addEventListener("keydown",function(t){switch(t.which){case 87:R=-.008;break;case 83:R=.008;break;case 65:w=-.008;break;case 68:w=.008}}),document.body.addEventListener("keyup",function(t){switch(t.which){case 87:R=0;break;case 83:R=0;break;case 65:w=0;break;case 68:w=0}}),i.canvas.addEventListener("mousedown",function(t){var n,e,r=t.clientX,o=t.clientY;n=function(t){var n=t.clientX-r,e=t.clientY-o;M+=.005*e,T+=.005*n,r=t.clientX,o=t.clientY,v.textContent=[z,b,E].map(function(t){return t.toFixed(2)}).join(", ")+" "+(Math.PI/M).toFixed(2)+" "+(Math.PI/T).toFixed(2)},e=function(t){i.canvas.removeEventListener("mousemove",n),i.canvas.removeEventListener("mouseup",e)},i.canvas.addEventListener("mousemove",n),i.canvas.addEventListener("mouseup",e)}),n.exports=m},{"../generators/BuildingSHG.js":5,"../generators/City.js":6,"./../Context":1,"./../lib/Geom":11,"./../lib/Loader":12,"./../lib/Mesh":13,"./../lib/QuadTree":14,"./../lib/glMatrixSubset":17}],24:[function(t,n,e){var r,i,o=t("./../lib/glMatrixSubset"),a=t("./../Context"),s=t("./../lib/Mesh"),u=(t("./../lib/Geom"),t("cardinal-spline"),t("./../lib/QuadTree"),t("./../lib/Loader"),o.vec3),h=o.mat4,l=a.gl,c=t("../generators/RoomSHG.js"),x=t("./../generators/PRNG"),p={meshes:[],lights:[],lightParameters:[6,0,2,.1],view:h.create(),model:h.create(),count:0,texture:l.createTexture()},f=new x(54321);l.bindTexture(l.TEXTURE_2D,p.texture),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MAG_FILTER,l.NEAREST),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MIN_FILTER,l.NEAREST),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_WRAP_S,l.CLAMP_TO_EDGE),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_WRAP_T,l.CLAMP_TO_EDGE),l.texImage2D(l.TEXTURE_2D,0,l.RGBA,a.w,a.h,0,l.RGBA,l.UNSIGNED_BYTE,null),l.bindTexture(l.TEXTURE_2D,null);var d=function(t,n){var e=t.vertices,r=t.normals,i=t.uvs,o=[];return n=n.reduce(function(t,n){return void 0!==n.door&&t.push(n.door.point),t.push(n.room.roomCentroid),t},[]),o=e.map(function(t,n){return.4}),{room:t,mesh:new s(e,r,i,o),lampMesh:new s(new Float32Array(t.lamp.vertices),new Float32Array(t.lamp.normals),new Float32Array(t.lamp.uvs),new Float32Array(t.lamp.extra)),tableMesh:new s(new Float32Array(t.table.vertices),new Float32Array(t.table.normals),new Float32Array(t.table.uvs),new Float32Array(t.table.extra)),lights:t.roomsWorld.map(function(t){return{x:t.x,y:t.y+.75,z:t.z}}),path:n}},v=function(t,n,e){var r,i,o=[t],a=[],s=[],u=[];for(a[e.indexOf(t)]=null;o.length>0&&(r=o.shift(),r!==n);)r.neighbors.forEach(function(t){var n=e.indexOf(t.r);void 0===a[n]&&(o.push(t.r),a[n]=r,s[n]=t.via)});for(r=n;null!==r;)i=e.indexOf(r),void 0!==s[i]&&u.unshift({room:r,door:s[i]}),r=a[i];return u};i=c.create([{x:-4,y:0,z:-8},{x:-4,y:0,z:8},{x:4,y:0,z:8},{x:4,y:0,z:-8}]);var m=[],y=i.nodes.reduce(function(t,n){return n.isFirst&&(t.first=n),n.isLast&&(t.last=n),t},{first:null,last:null}),g=i.nodes.filter(function(t){return!t.isMonitor});g.sort(function(){var t=f.random()-.5;return t});for(var z=0,b=i.nodes.length;b-1>z;z++)m=m.concat(v(g[z],g[(z+1)%b],g));
m=m.concat(v(g[g.length-1],y.first,g)),m=m.concat(v(y.first,y.last,i.nodes)),m.push({door:i.monitor.door,room:i.monitor}),r=d(i,m);r.room.bbox;p.meshes=[r.mesh,r.lampMesh,r.tableMesh],p.lights=r.lights.reduce(function(t,n){for(var e=0;6>e;e++)t.push(n.x,n.y,n.z);return t},[]);var E=function(t,n){for(var e=[],r=0,i=t.length;i-1>r;r++){var o=t[r],a=t[Math.min(r+1,i-1)],s=t[Math.min(r+2,i-1)],u=a.x-o.x,h=a.z-o.z,l=(s.x-a.x,s.z-a.z,Math.sqrt(u*u+h*h)),c=(Math.atan2(-a.z+o.z,a.x-o.x)+3*Math.PI/2)%(2*Math.PI),x=(Math.atan2(-s.z+a.z,s.x-a.x)+3*Math.PI/2)%(2*Math.PI),p=0;for(r>=i-4&&(x=c);x-c>Math.PI;)x-=2*Math.PI;for(;c-x>Math.PI;)c-=2*Math.PI;for(var f=0,d=~~(l/n);d>f;f++)p=f/d,e.push({x:o.x*(1-p)+a.x*p,y:o.y*(1-p)+a.y*p,z:o.z*(1-p)+a.z*p,th:c*(1-p)+x*p})}return function(t){var n=t,r=e.length,i=n*(r-1),o=Math.floor(i),a=i-o,s=e[o],u=e[(o+1)%r];return{x:s.x*(1-a)+u.x*a,y:s.y*(1-a)+u.y*a,z:s.z*(1-a)+u.z*a,th:s.th*(1-a)+u.th*a}}}(r.path,.025);h.translate(p.view,p.view,[0,0,-8]),h.rotateX(p.view,p.view,Math.PI/2),h.rotateY(p.view,p.view,Math.PI/2);var M=(p.meshes.length,500*r.path.length);2*Math.PI/1e3;p.update=function(t){var n=Math.min(t/M,1),e=E(isNaN(n)?0:n),r=e.x,i=e.z,o=e.th,a=0,s=0,l=0,c=u.fromValues(-.0625,.25,.0625),x=u.fromValues(0,.25,-.25),f=u.fromValues(.0625,.25,.0625),d=h.create();h.translate(d,d,[r,0,i]),h.scale(d,d,[2,1,2]),h.rotateY(d,d,o),u.transformMat4(c,c,d),u.transformMat4(x,x,d),u.transformMat4(f,f,d),h.identity(p.view),h.rotateY(p.view,p.view,-o),h.translate(p.view,p.view,[-r+s,-.75+a,-i+l])},n.exports=p},{"../generators/RoomSHG.js":10,"./../Context":1,"./../generators/PRNG":8,"./../lib/Geom":11,"./../lib/Loader":12,"./../lib/Mesh":13,"./../lib/QuadTree":14,"./../lib/glMatrixSubset":17,"cardinal-spline":19}],25:[function(t,n,e){function r(){0===f&&requestAnimationFrame(r),h.render()}function i(t){isNaN(i.t0)&&(i.t0=t),p.begin(),u.render(c),c.update(t-i.t0),u.render(x),x.update(t-i.t0),p.end(),window.STAHP!==!0&&requestAnimationFrame(i)}var o=(t("./lib/glMatrixSubset"),t("./Context")),a=o.canvas,s=o.gl,u=t("./Renderer.js"),h=t("./lib/Loader"),l=(t("./generators/City.js"),t("stats-js")),c=t("./scenes/MainScene.js"),x=t("./scenes/RoomScene.js"),p=new l;p.setMode(0),p.domElement.style.position="absolute",p.domElement.style.right="1rem",p.domElement.style.top="1rem",a.parentNode.appendChild(p.domElement);var f=0,d=NaN;h.subscribe("Blocks",function(){console.log("Loading complete"),f=1,d=NaN,u.init(c,x),i()}),s.viewport(0,0,o.w,o.h),r()},{"./Context":1,"./Renderer.js":2,"./generators/City.js":6,"./lib/Loader":12,"./lib/glMatrixSubset":17,"./scenes/MainScene.js":23,"./scenes/RoomScene.js":24,"stats-js":22}]},{},[25]);