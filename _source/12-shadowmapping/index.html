---
layout: proto
title: "Variance shadow mapping"
---
<script type='application/x-vertex-shader' id='vertex-shader'>
attribute vec3 vertex, normal;

uniform mat4 projection, view, model, ltransf;

varying vec4 position, luv;
varying vec3 vnormal;

void main() {

  gl_Position = projection * view * model * vec4(vertex, 1.);
  
  position = vec4(model * vec4(vertex, 1.));
  vnormal = normalize(vec4(model * vec4(normal, 1.)).xyz);
  luv = (mat4(
      .5, .0, .0, .0,
      .0, .5, .0, .0,
      .0, .0, .5, .0,
      .5, .5, .5, 1.
    ) * ltransf * position);
}

</script>
<script type='application/x-fragment-shader' id='fragment-shader'> 
precision highp float;

varying vec4 position, luv;
varying vec3 vnormal;

uniform vec3 lightPos;
uniform sampler2D texture;

float chebyshevIneq(vec2 moments, float t) {
  if(t <= moments.x)
    return 1.;

  float variance = max(moments.y - (moments.x * moments.x), .005);
  float d = t - moments.x;
  return variance / (variance + d * d);
}

float unpack(vec2 color) {
  return color.x + (color.y / 255.);
}

void main() {

  vec4 color = vec4(0.2, 0.2, 0.8, 1.);
  vec3 depth = luv.xyz / luv.w;

  float diffuse = max(dot(normalize(lightPos), vnormal), 0.);
  vec4 sample = texture2D(texture, depth.xy);

  float illum = chebyshevIneq(vec2(unpack(sample.rg), unpack(sample.ba)), depth.z);

  gl_FragColor = mix(vec4(0., 0., 0., 1.), color, .2 + .8 * diffuse * illum);
}

</script>

<script type='application/x-vertex-shader' id='vertex-shadow'>
attribute vec3 vertex, normal;

uniform mat4 projection, view, model;

void main() {
  
  gl_Position = projection * view * model * vec4(vertex, 1.);
}

</script>
<script type='application/x-fragment-shader' id='fragment-shadow'> 
precision highp float;

vec2 pack(float depth) {
  const vec2 bias = vec2(1. / 255., 0.);
  vec2 col = vec2(depth, fract(depth * 255.));

  return col - (col.yy * bias);
}

void main() {
  float moment = gl_FragCoord.z; 
  gl_FragColor = vec4(pack(moment), pack(moment * moment));
}

</script>

<script type='application/x-obj' id='cube'>
v 1.000000 -1.000000 -1.000000
v 1.000000 -1.000000 1.000000
v -1.000000 -1.000000 1.000000
v -1.000000 -1.000000 -1.000000
v 1.000000 1.000000 -0.999999
v 0.999999 1.000000 1.000001
v -1.000000 1.000000 1.000000
v -1.000000 1.000000 -1.000000
vn 0.000000 -1.000000 0.000000
vn 0.000000 1.000000 0.000000
vn 1.000000 -0.000000 0.000000
vn -0.000000 -0.000000 1.000000
vn -1.000000 -0.000000 -0.000000
vn 0.000000 0.000000 -1.000000
f 2//1 3//1 4//1
f 8//2 7//2 6//2
f 1//3 5//3 6//3
f 2//4 6//4 7//4
f 7//5 8//5 4//5
f 1//6 4//6 8//6
f 1//1 2//1 4//1
f 5//2 8//2 6//2
f 2//3 1//3 6//3
f 3//4 2//4 7//4
f 3//5 7//5 4//5
f 5//6 1//6 8//6
</script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/gl-matrix/2.2.1/gl-matrix-min.js'></script>
